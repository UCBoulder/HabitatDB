import { isLazyTransactionWriteItemListLoader, } from './is-lazy-transaction-write-item-list-loader';
import { isTransactionAddDeleteItem, isTransactionAddGetItem, isTransactionAddUpdateItem, isWriteTransactionItemList, } from './../transaction/type-guards';
import { InvalidTransactionReadItemError, InvalidTransactionWriteItemError, TRANSFORM_TRANSACTION_TYPE, } from '@typedorm/common';
import { LowOrderTransformers } from './low-order-transformers';
import { isTransactionAddCreateItem } from '../transaction/type-guards';
import { dropProp } from '../../helpers/drop-prop';
export class DocumentClientTransactionTransformer extends LowOrderTransformers {
    constructor(connection) {
        super(connection);
    }
    toDynamoWriteTransactionItems(writeTransaction, metadataOptions) {
        const { items } = writeTransaction;
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TRANSACTION_TYPE.TRANSACTION_WRITE,
            prefix: 'Before',
            body: items,
        });
        const transformed = this.innerTransformTransactionWriteItems(items);
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TRANSACTION_TYPE.TRANSACTION_WRITE,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    toDynamoReadTransactionItems(readTransaction, metadataOptions) {
        const { items } = readTransaction;
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TRANSACTION_TYPE.TRANSACTION_READ,
            prefix: 'Before',
            body: items,
        });
        const transformed = this.innerTransformTransactionReadItems(items);
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TRANSACTION_TYPE.TRANSACTION_READ,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    /**
     * Parse each item in the request to be in one of the following collections
     * - transactionItemList: items that must be processed in a transaction
     */
    innerTransformTransactionReadItems(transactionItems, metadataOptions) {
        return transactionItems.reduce((acc, transactionItem) => {
            if (isTransactionAddGetItem(transactionItem)) {
                const { get: { item, primaryKey, options }, } = transactionItem;
                const dynamoGetItemInput = this.toDynamoGetItem(item, primaryKey, options, metadataOptions);
                acc.transactionItemList.push({
                    Get: dynamoGetItemInput,
                });
            }
            else {
                throw new InvalidTransactionReadItemError(transactionItem);
            }
            return acc;
        }, {
            transactionItemList: [],
        });
    }
    /**
     * Parse each item in the request to be in one of the following collections
     * - transactionItemList: items that must be processed in a transaction
     * - lazyTransactionWriteItemListLoaderItems: items that are must be processed in transaction but also requires other requests to be made first (i.e delete of unique items)
     */
    innerTransformTransactionWriteItems(transactionItems, metadataOptions) {
        return transactionItems.reduce((acc, transactionItem) => {
            if (isTransactionAddCreateItem(transactionItem)) {
                const { create: { item, options }, } = transactionItem;
                const dynamoPutItemInput = this.toDynamoPutItem(item, options, metadataOptions); // update
                if (!isWriteTransactionItemList(dynamoPutItemInput)) {
                    acc.transactionItemList.push({
                        Put: dynamoPutItemInput,
                    });
                }
                else {
                    acc.transactionItemList.push(...dynamoPutItemInput);
                }
            }
            else if (isTransactionAddUpdateItem(transactionItem)) {
                const { update: { item, primaryKey, body, options }, } = transactionItem;
                const dynamoUpdateItemInput = this.toDynamoUpdateItem(item, primaryKey, body, options, metadataOptions);
                if (!isLazyTransactionWriteItemListLoader(dynamoUpdateItemInput)) {
                    acc.transactionItemList.push({
                        Update: dropProp(dynamoUpdateItemInput, 'ReturnValues'),
                    });
                }
                else {
                    acc.lazyTransactionWriteItemListLoader.push(dynamoUpdateItemInput);
                }
            }
            else if (isTransactionAddDeleteItem(transactionItem)) {
                const { delete: { item, primaryKey, options }, } = transactionItem;
                const dynamoDeleteItemInput = this.toDynamoDeleteItem(item, primaryKey, options, metadataOptions);
                if (!isLazyTransactionWriteItemListLoader(dynamoDeleteItemInput)) {
                    acc.transactionItemList.push({
                        Delete: dynamoDeleteItemInput,
                    });
                }
                else {
                    acc.lazyTransactionWriteItemListLoader.push(dynamoDeleteItemInput);
                }
            }
            else {
                throw new InvalidTransactionWriteItemError(transactionItem);
            }
            return acc;
        }, {
            transactionItemList: [],
            lazyTransactionWriteItemListLoader: [],
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LXRyYW5zYWN0aW9uLXRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy90cmFuc2Zvcm1lci9kb2N1bWVudC1jbGllbnQtdHJhbnNhY3Rpb24tdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUVMLG9DQUFvQyxHQUNyQyxNQUFNLDhDQUE4QyxDQUFDO0FBQ3RELE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIsdUJBQXVCLEVBQ3ZCLDBCQUEwQixFQUMxQiwwQkFBMEIsR0FDM0IsTUFBTSw4QkFBOEIsQ0FBQztBQUN0QyxPQUFPLEVBQ0wsK0JBQStCLEVBQy9CLGdDQUFnQyxFQUNoQywwQkFBMEIsR0FDM0IsTUFBTSxrQkFBa0IsQ0FBQztBQU0xQixPQUFPLEVBQUMsb0JBQW9CLEVBQUMsTUFBTSwwQkFBMEIsQ0FBQztBQUM5RCxPQUFPLEVBQUMsMEJBQTBCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RSxPQUFPLEVBQUMsUUFBUSxFQUFDLE1BQU0seUJBQXlCLENBQUM7QUFRakQsTUFBTSxPQUFPLG9DQUFxQyxTQUFRLG9CQUFvQjtJQUM1RSxZQUFZLFVBQXNCO1FBQ2hDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBRUQsNkJBQTZCLENBQzNCLGdCQUFrQyxFQUNsQyxlQUFpQztRQUVqQyxNQUFNLEVBQUMsS0FBSyxFQUFDLEdBQUcsZ0JBQWdCLENBQUM7UUFFakMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsdUJBQXVCLENBQUM7WUFDN0MsU0FBUyxFQUFFLGVBQWUsRUFBRSxTQUFTO1lBQ3JDLFNBQVMsRUFBRSwwQkFBMEIsQ0FBQyxpQkFBaUI7WUFDdkQsTUFBTSxFQUFFLFFBQVE7WUFDaEIsSUFBSSxFQUFFLEtBQUs7U0FDWixDQUFD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QUFxQixDQUFDLENBQUM7aUJBQ3BFO2FBQ0Y7aUJBQU07Z0JBQ0wsTUFBTSxJQUFJLGdDQUFnQyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2FBQzdEO1lBQ0QsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQ0Q7WUFDRSxtQkFBbUIsRUFBRSxFQUErQztZQUNwRSxrQ0FBa0MsRUFDaEMsRUFBMEM7U0FDN0MsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcixcbiAgaXNMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyLFxufSBmcm9tICcuL2lzLWxhenktdHJhbnNhY3Rpb24td3JpdGUtaXRlbS1saXN0LWxvYWRlcic7XG5pbXBvcnQge1xuICBpc1RyYW5zYWN0aW9uQWRkRGVsZXRlSXRlbSxcbiAgaXNUcmFuc2FjdGlvbkFkZEdldEl0ZW0sXG4gIGlzVHJhbnNhY3Rpb25BZGRVcGRhdGVJdGVtLFxuICBpc1dyaXRlVHJhbnNhY3Rpb25JdGVtTGlzdCxcbn0gZnJvbSAnLi8uLi90cmFuc2FjdGlvbi90eXBlLWd1YXJkcyc7XG5pbXBvcnQge1xuICBJbnZhbGlkVHJhbnNhY3Rpb25SZWFkSXRlbUVycm9yLFxuICBJbnZhbGlkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1FcnJvcixcbiAgVFJBTlNGT1JNX1RSQU5TQUNUSU9OX1RZUEUsXG59IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtcbiAgV3JpdGVUcmFuc2FjdGlvbixcbiAgV3JpdGVUcmFuc2FjdGlvbkl0ZW0sXG59IGZyb20gJy4vLi4vdHJhbnNhY3Rpb24vd3JpdGUtdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHtDb25uZWN0aW9ufSBmcm9tICcuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24nO1xuaW1wb3J0IHtMb3dPcmRlclRyYW5zZm9ybWVyc30gZnJvbSAnLi9sb3ctb3JkZXItdHJhbnNmb3JtZXJzJztcbmltcG9ydCB7aXNUcmFuc2FjdGlvbkFkZENyZWF0ZUl0ZW19IGZyb20gJy4uL3RyYW5zYWN0aW9uL3R5cGUtZ3VhcmRzJztcbmltcG9ydCB7ZHJvcFByb3B9IGZyb20gJy4uLy4uL2hlbHBlcnMvZHJvcC1wcm9wJztcbmltcG9ydCB7XG4gIFJlYWRUcmFuc2FjdGlvbixcbiAgUmVhZFRyYW5zYWN0aW9uSXRlbSxcbn0gZnJvbSAnLi4vdHJhbnNhY3Rpb24vcmVhZC10cmFuc2FjdGlvbic7XG5pbXBvcnQge01ldGFkYXRhT3B0aW9uc30gZnJvbSAnLi9iYXNlLXRyYW5zZm9ybWVyJztcbmltcG9ydCB7RG9jdW1lbnRDbGllbnRUeXBlc30gZnJvbSAnQHR5cGVkb3JtL2RvY3VtZW50LWNsaWVudCc7XG5cbmV4cG9ydCBjbGFzcyBEb2N1bWVudENsaWVudFRyYW5zYWN0aW9uVHJhbnNmb3JtZXIgZXh0ZW5kcyBMb3dPcmRlclRyYW5zZm9ybWVycyB7XG4gIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb246IENvbm5lY3Rpb24pIHtcbiAgICBzdXBlcihjb25uZWN0aW9uKTtcbiAgfVxuXG4gIHRvRHluYW1vV3JpdGVUcmFuc2FjdGlvbkl0ZW1zKFxuICAgIHdyaXRlVHJhbnNhY3Rpb246IFdyaXRlVHJhbnNhY3Rpb24sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIGNvbnN0IHtpdGVtc30gPSB3cml0ZVRyYW5zYWN0aW9uO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1UcmFuc2FjdGlvbih7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFJBTlNBQ1RJT05fVFlQRS5UUkFOU0FDVElPTl9XUklURSxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBib2R5OiBpdGVtcyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRyYW5zZm9ybWVkID0gdGhpcy5pbm5lclRyYW5zZm9ybVRyYW5zYWN0aW9uV3JpdGVJdGVtcyhpdGVtcyk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybVRyYW5zYWN0aW9uKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UUkFOU0FDVElPTl9UWVBFLlRSQU5TQUNUSU9OX1dSSVRFLFxuICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgYm9keTogdHJhbnNmb3JtZWQsXG4gICAgfSk7XG4gICAgcmV0dXJuIHRyYW5zZm9ybWVkO1xuICB9XG5cbiAgdG9EeW5hbW9SZWFkVHJhbnNhY3Rpb25JdGVtcyhcbiAgICByZWFkVHJhbnNhY3Rpb246IFJlYWRUcmFuc2FjdGlvbixcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnNcbiAgKSB7XG4gICAgY29uc3Qge2l0ZW1zfSA9IHJlYWRUcmFuc2FjdGlvbjtcblxuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtVHJhbnNhY3Rpb24oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RSQU5TQUNUSU9OX1RZUEUuVFJBTlNBQ1RJT05fUkVBRCxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBib2R5OiBpdGVtcyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRyYW5zZm9ybWVkID0gdGhpcy5pbm5lclRyYW5zZm9ybVRyYW5zYWN0aW9uUmVhZEl0ZW1zKGl0ZW1zKTtcblxuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtVHJhbnNhY3Rpb24oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RSQU5TQUNUSU9OX1RZUEUuVFJBTlNBQ1RJT05fUkVBRCxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGJvZHk6IHRyYW5zZm9ybWVkLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRyYW5zZm9ybWVkO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIGVhY2ggaXRlbSBpbiB0aGUgcmVxdWVzdCB0byBiZSBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBjb2xsZWN0aW9uc1xuICAgKiAtIHRyYW5zYWN0aW9uSXRlbUxpc3Q6IGl0ZW1zIHRoYXQgbXVzdCBiZSBwcm9jZXNzZWQgaW4gYSB0cmFuc2FjdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBpbm5lclRyYW5zZm9ybVRyYW5zYWN0aW9uUmVhZEl0ZW1zKFxuICAgIHRyYW5zYWN0aW9uSXRlbXM6IFJlYWRUcmFuc2FjdGlvbkl0ZW08YW55LCBhbnk+W10sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIHJldHVybiB0cmFuc2FjdGlvbkl0ZW1zLnJlZHVjZShcbiAgICAgIChhY2MsIHRyYW5zYWN0aW9uSXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXNUcmFuc2FjdGlvbkFkZEdldEl0ZW0odHJhbnNhY3Rpb25JdGVtKSkge1xuICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIGdldDoge2l0ZW0sIHByaW1hcnlLZXksIG9wdGlvbnN9LFxuICAgICAgICAgIH0gPSB0cmFuc2FjdGlvbkl0ZW07XG5cbiAgICAgICAgICBjb25zdCBkeW5hbW9HZXRJdGVtSW5wdXQgPSB0aGlzLnRvRHluYW1vR2V0SXRlbShcbiAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICBwcmltYXJ5S2V5LFxuICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICAgICAgICk7XG5cbiAgICAgICAgICBhY2MudHJhbnNhY3Rpb25JdGVtTGlzdC5wdXNoKHtcbiAgICAgICAgICAgIEdldDogZHluYW1vR2V0SXRlbUlucHV0LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkVHJhbnNhY3Rpb25SZWFkSXRlbUVycm9yKHRyYW5zYWN0aW9uSXRlbSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHRyYW5zYWN0aW9uSXRlbUxpc3Q6IFtdIGFzIERvY3VtZW50Q2xpZW50VHlwZXMuVHJhbnNhY3RHZXRJdGVtTGlzdCxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIGVhY2ggaXRlbSBpbiB0aGUgcmVxdWVzdCB0byBiZSBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBjb2xsZWN0aW9uc1xuICAgKiAtIHRyYW5zYWN0aW9uSXRlbUxpc3Q6IGl0ZW1zIHRoYXQgbXVzdCBiZSBwcm9jZXNzZWQgaW4gYSB0cmFuc2FjdGlvblxuICAgKiAtIGxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXJJdGVtczogaXRlbXMgdGhhdCBhcmUgbXVzdCBiZSBwcm9jZXNzZWQgaW4gdHJhbnNhY3Rpb24gYnV0IGFsc28gcmVxdWlyZXMgb3RoZXIgcmVxdWVzdHMgdG8gYmUgbWFkZSBmaXJzdCAoaS5lIGRlbGV0ZSBvZiB1bmlxdWUgaXRlbXMpXG4gICAqL1xuICBwcml2YXRlIGlubmVyVHJhbnNmb3JtVHJhbnNhY3Rpb25Xcml0ZUl0ZW1zKFxuICAgIHRyYW5zYWN0aW9uSXRlbXM6IFdyaXRlVHJhbnNhY3Rpb25JdGVtPGFueSwgYW55LCBhbnk+W10sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIHJldHVybiB0cmFuc2FjdGlvbkl0ZW1zLnJlZHVjZShcbiAgICAgIChhY2MsIHRyYW5zYWN0aW9uSXRlbSkgPT4ge1xuICAgICAgICBpZiAoaXNUcmFuc2FjdGlvbkFkZENyZWF0ZUl0ZW0odHJhbnNhY3Rpb25JdGVtKSkge1xuICAgICAgICAgIGNvbnN0IHtcbiAgICAgICAgICAgIGNyZWF0ZToge2l0ZW0sIG9wdGlvbnN9LFxuICAgICAgICAgIH0gPSB0cmFuc2FjdGlvbkl0ZW07XG5cbiAgICAgICAgICBjb25zdCBkeW5hbW9QdXRJdGVtSW5wdXQgPSB0aGlzLnRvRHluYW1vUHV0SXRlbShcbiAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zXG4gICAgICAgICAgKTsgLy8gdXBkYXRlXG5cbiAgICAgICAgICBpZiAoIWlzV3JpdGVUcmFuc2FjdGlvbkl0ZW1MaXN0KGR5bmFtb1B1dEl0ZW1JbnB1dCkpIHtcbiAgICAgICAgICAgIGFjYy50cmFuc2FjdGlvbkl0ZW1MaXN0LnB1c2goe1xuICAgICAgICAgICAgICBQdXQ6IGR5bmFtb1B1dEl0ZW1JbnB1dCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY2MudHJhbnNhY3Rpb25JdGVtTGlzdC5wdXNoKC4uLmR5bmFtb1B1dEl0ZW1JbnB1dCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGlzVHJhbnNhY3Rpb25BZGRVcGRhdGVJdGVtKHRyYW5zYWN0aW9uSXRlbSkpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICB1cGRhdGU6IHtpdGVtLCBwcmltYXJ5S2V5LCBib2R5LCBvcHRpb25zfSxcbiAgICAgICAgICB9ID0gdHJhbnNhY3Rpb25JdGVtO1xuXG4gICAgICAgICAgY29uc3QgZHluYW1vVXBkYXRlSXRlbUlucHV0ID0gdGhpcy50b0R5bmFtb1VwZGF0ZUl0ZW0oXG4gICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgICAgIGJvZHksXG4gICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoIWlzTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcihkeW5hbW9VcGRhdGVJdGVtSW5wdXQpKSB7XG4gICAgICAgICAgICBhY2MudHJhbnNhY3Rpb25JdGVtTGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgVXBkYXRlOiBkcm9wUHJvcChcbiAgICAgICAgICAgICAgICBkeW5hbW9VcGRhdGVJdGVtSW5wdXQsXG4gICAgICAgICAgICAgICAgJ1JldHVyblZhbHVlcydcbiAgICAgICAgICAgICAgKSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlVwZGF0ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY2MubGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlci5wdXNoKGR5bmFtb1VwZGF0ZUl0ZW1JbnB1dCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKGlzVHJhbnNhY3Rpb25BZGREZWxldGVJdGVtKHRyYW5zYWN0aW9uSXRlbSkpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBkZWxldGU6IHtpdGVtLCBwcmltYXJ5S2V5LCBvcHRpb25zfSxcbiAgICAgICAgICB9ID0gdHJhbnNhY3Rpb25JdGVtO1xuXG4gICAgICAgICAgY29uc3QgZHluYW1vRGVsZXRlSXRlbUlucHV0ID0gdGhpcy50b0R5bmFtb0RlbGV0ZUl0ZW0oXG4gICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICAgICAgICApO1xuICAgICAgICAgIGlmICghaXNMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyKGR5bmFtb0RlbGV0ZUl0ZW1JbnB1dCkpIHtcbiAgICAgICAgICAgIGFjYy50cmFuc2FjdGlvbkl0ZW1MaXN0LnB1c2goe1xuICAgICAgICAgICAgICBEZWxldGU6IGR5bmFtb0RlbGV0ZUl0ZW1JbnB1dCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhY2MubGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlci5wdXNoKGR5bmFtb0RlbGV0ZUl0ZW1JbnB1dCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1FcnJvcih0cmFuc2FjdGlvbkl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0cmFuc2FjdGlvbkl0ZW1MaXN0OiBbXSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtTGlzdCxcbiAgICAgICAgbGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcjpcbiAgICAgICAgICBbXSBhcyBMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyW10sXG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuIl19