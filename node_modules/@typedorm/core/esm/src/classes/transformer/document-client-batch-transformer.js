import { BATCH_READ_ITEMS_LIMIT, BATCH_WRITE_ITEMS_LIMIT, InvalidBatchWriteItemError, TRANSFORM_BATCH_TYPE, } from '@typedorm/common';
import { v4 } from 'uuid';
import { getHashedIdForInput } from '../../helpers/get-hashed-id-for-input';
import { isBatchAddCreateItem, isBatchAddDeleteItem } from '../batch/type-guards';
import { isWriteTransactionItemList } from '../transaction/type-guards';
import { isLazyTransactionWriteItemListLoader, } from './is-lazy-transaction-write-item-list-loader';
import { LowOrderTransformers } from './low-order-transformers';
export class DocumentClientBatchTransformer extends LowOrderTransformers {
    constructor(connection) {
        super(connection);
    }
    toDynamoWriteBatchItems(writeBatch, metadataOptions) {
        const { items } = writeBatch;
        this.connection.logger.logTransformBatch({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_BATCH_TYPE.BATCH_WRITE,
            prefix: 'Before',
            body: items,
        });
        const { lazyTransactionWriteItemListLoaderItems, simpleBatchRequestItems, transactionListItems, metadata, } = this.innerTransformBatchWriteItems(items, metadataOptions);
        // organize all requests in "tableName - requestItem" format
        const sorted = this.getWriteRequestsSortedByTable(simpleBatchRequestItems);
        // divide sorted requests in multiple batch items requests, as there are max
        // 25 items are allowed in a single batch operation
        const batchWriteRequestItems = this.mapTableWriteItemsToBatchWriteItems(sorted);
        const transformed = {
            batchWriteRequestMapItems: batchWriteRequestItems,
            transactionListItems,
            lazyTransactionWriteItemListLoaderItems,
            metadata,
        };
        this.connection.logger.logTransformBatch({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_BATCH_TYPE.BATCH_WRITE,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    toDynamoReadBatchItems(readBatch, metadataOptions) {
        const { items } = readBatch;
        this.connection.logger.logTransformBatch({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_BATCH_TYPE.BATCH_READ,
            prefix: 'Before',
            body: items,
        });
        const { metadata, batchReadRequestItems } = this.transformBatchReadItems(items);
        // organize all requests in "tableName - requestItem" format
        const sortedByTableName = this.getReadRequestsSortedByTable(batchReadRequestItems);
        // divide sorted requests in multiple batch items requests, as there are max
        // 100 items are allowed in a single batch read operation
        const batchRequestItemsList = this.mapTableReadItemsToBatchReadItems(sortedByTableName);
        const transformed = {
            batchRequestItemsList,
            metadata,
        };
        this.connection.logger.logTransformBatch({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_BATCH_TYPE.BATCH_READ,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    mapTableWriteItemsToBatchWriteItems(requestsSortedByTable) {
        let currentFillingIndex = 0;
        let totalItemsAtCurrentFillingIndex = 0;
        const multiBatchItems = Object.entries(requestsSortedByTable).reduce((acc, [tableName, perTableItems]) => {
            // separate requests into multiple batch items, if there are more than allowed items to process in batch
            while (perTableItems.length) {
                if (!acc[currentFillingIndex]) {
                    acc[currentFillingIndex] = {};
                }
                if (!acc[currentFillingIndex][tableName]) {
                    acc[currentFillingIndex][tableName] = [];
                }
                acc[currentFillingIndex][tableName].push(perTableItems.shift());
                ++totalItemsAtCurrentFillingIndex;
                // batch write request has limit of 25 items per batch so once we hit that limit,
                // separate remaining items as new batch request
                if (totalItemsAtCurrentFillingIndex === BATCH_WRITE_ITEMS_LIMIT) {
                    ++currentFillingIndex;
                    totalItemsAtCurrentFillingIndex = 0;
                }
            }
            return acc;
        }, []);
        return multiBatchItems;
    }
    mapTableReadItemsToBatchReadItems(requestsSortedByTable) {
        let currentFillingIndex = 0;
        let totalItemsAtCurrentFillingIndex = 0;
        const multiBatchItems = Object.entries(requestsSortedByTable).reduce((acc, [tableName, perTableItems]) => {
            // separate requests into multiple batch items, if there are more than allowed items to process in batch
            while (perTableItems.Keys.length) {
                if (!acc[currentFillingIndex]) {
                    acc[currentFillingIndex] = {};
                }
                if (!acc[currentFillingIndex][tableName]) {
                    acc[currentFillingIndex][tableName] = {
                        Keys: [],
                    };
                }
                acc[currentFillingIndex][tableName].Keys?.push(perTableItems.Keys.shift());
                ++totalItemsAtCurrentFillingIndex;
                // batch read request has limit of max 100 items per batch so once we hit that limit,
                // separate remaining items as new batch request
                if (totalItemsAtCurrentFillingIndex === BATCH_READ_ITEMS_LIMIT) {
                    ++currentFillingIndex;
                    totalItemsAtCurrentFillingIndex = 0;
                }
            }
            return acc;
        }, []);
        return multiBatchItems;
    }
    /**
     * Reverse transforms batch write item request to write batch item
     */
    toWriteBatchInputList(requestMap, { namespaceId, itemTransformHashMap, }) {
        return Object.entries(requestMap).flatMap(([, writeRequests]) => {
            return this.toRawBatchInputItem(writeRequests, {
                namespaceId,
                itemTransformHashMap,
            });
        });
    }
    /**
     * Reverse transforms batch read item request to read batch item
     */
    toReadBatchInputList(requestMap, { namespaceId, itemTransformHashMap, }) {
        return Object.entries(requestMap).flatMap(([, readRequests]) => {
            return this.toRawBatchInputItem(readRequests.Keys, {
                namespaceId,
                itemTransformHashMap,
            });
        });
    }
    /**
     * Converts batch item input to pre transformed item input
     */
    toRawBatchInputItem(transformedItems, { namespaceId, itemTransformHashMap, }) {
        return transformedItems.map(transformedItem => {
            const hashId = getHashedIdForInput(namespaceId, transformedItem);
            const originalItem = itemTransformHashMap.get(hashId);
            return originalItem;
        });
    }
    /**
     * Parse each item in the request to be in one of the following collections
     * - simpleBatchRequestItems: simple items that can be processed in batch (i.e no uniques)
     * - transactionListItems: items that must be processed in a transaction instead of batch (i.e items with unique attributes)
     * - LazyTransactionWriteItemListLoaderItems: items that are must be processed in transaction but also requires other requests to be made first (i.e delete of unique items)
     */
    innerTransformBatchWriteItems(batchItems, metadataOptions) {
        const namespaceId = v4();
        const itemTransformHashMap = new Map();
        return batchItems.reduce((acc, batchItem) => {
            // is create
            if (isBatchAddCreateItem(batchItem)) {
                // transform put item
                const dynamoPutItem = this.toDynamoPutItem(batchItem.create.item, undefined, metadataOptions);
                if (!isWriteTransactionItemList(dynamoPutItem)) {
                    const transformedWriteRequest = {
                        PutRequest: {
                            Item: dynamoPutItem.Item,
                        },
                    };
                    acc.simpleBatchRequestItems.push({
                        writeRequest: transformedWriteRequest,
                        tableName: dynamoPutItem.TableName,
                    });
                    // store transformed and original items as hash key/value
                    const itemHashId = getHashedIdForInput(namespaceId, transformedWriteRequest);
                    itemTransformHashMap.set(itemHashId, batchItem);
                }
                else {
                    acc.transactionListItems.push({
                        rawInput: batchItem,
                        transformedInput: dynamoPutItem,
                    });
                }
                // is delete
            }
            else if (isBatchAddDeleteItem(batchItem)) {
                const { delete: { item, primaryKey }, } = batchItem;
                // transform delete item
                const itemToRemove = this.toDynamoDeleteItem(item, primaryKey, undefined, metadataOptions);
                if (!isLazyTransactionWriteItemListLoader(itemToRemove)) {
                    const transformedItemRequest = {
                        DeleteRequest: {
                            Key: itemToRemove.Key,
                        },
                    };
                    acc.simpleBatchRequestItems.push({
                        writeRequest: transformedItemRequest,
                        tableName: itemToRemove.TableName,
                    });
                    // store transformed and original items as hash key/value
                    const itemHashId = getHashedIdForInput(namespaceId, transformedItemRequest);
                    itemTransformHashMap.set(itemHashId, batchItem);
                }
                else {
                    acc.lazyTransactionWriteItemListLoaderItems.push({
                        rawInput: batchItem,
                        transformedInput: itemToRemove,
                    });
                }
            }
            else {
                throw new InvalidBatchWriteItemError(batchItem);
            }
            return acc;
        }, {
            simpleBatchRequestItems: [],
            transactionListItems: [],
            lazyTransactionWriteItemListLoaderItems: [],
            metadata: {
                namespaceId,
                itemTransformHashMap,
            },
        });
    }
    transformBatchReadItems(batchItems, metadataOptions) {
        const namespaceId = v4();
        const itemTransformHashMap = new Map();
        return batchItems.reduce((acc, batchItem) => {
            const { item, primaryKey } = batchItem;
            // TODO: add read options support
            const itemToGet = this.toDynamoGetItem(item, primaryKey, undefined, metadataOptions);
            acc.batchReadRequestItems.push({
                readRequest: itemToGet.Key,
                tableName: itemToGet.TableName,
            });
            // store batch item input and it's transform in map, for reverse transform later
            const transformedItemHashId = getHashedIdForInput(namespaceId, itemToGet.Key);
            itemTransformHashMap.set(transformedItemHashId, batchItem);
            return acc;
        }, {
            batchReadRequestItems: [],
            metadata: {
                namespaceId,
                itemTransformHashMap,
            },
        });
    }
    getWriteRequestsSortedByTable(allRequestItems) {
        return allRequestItems.reduce((acc, requestItemWithMeta) => {
            if (!acc[requestItemWithMeta.tableName]) {
                acc[requestItemWithMeta.tableName] = [];
            }
            acc[requestItemWithMeta.tableName].push(requestItemWithMeta.writeRequest);
            return acc;
        }, {});
    }
    getReadRequestsSortedByTable(allRequestItems) {
        return allRequestItems.reduce((acc, requestItemWithMeta) => {
            if (!acc[requestItemWithMeta.tableName]) {
                acc[requestItemWithMeta.tableName] = {
                    Keys: [],
                };
            }
            acc[requestItemWithMeta.tableName].Keys?.push(requestItemWithMeta.readRequest);
            return acc;
        }, {});
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LWJhdGNoLXRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy90cmFuc2Zvcm1lci9kb2N1bWVudC1jbGllbnQtYmF0Y2gtdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUNMLHNCQUFzQixFQUN0Qix1QkFBdUIsRUFDdkIsMEJBQTBCLEVBQzFCLG9CQUFvQixHQUNyQixNQUFNLGtCQUFrQixDQUFDO0FBQzFCLE9BQU8sRUFBQyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFFMUUsT0FBTyxFQUFDLG9CQUFvQixFQUFFLG9CQUFvQixFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFHaEYsT0FBTyxFQUFDLDBCQUEwQixFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFFdEUsT0FBTyxFQUNMLG9DQUFvQyxHQUVyQyxNQUFNLDhDQUE4QyxDQUFDO0FBQ3RELE9BQU8sRUFBQyxvQkFBb0IsRUFBQyxNQUFNLDBCQUEwQixDQUFDO0FBcUI5RCxNQUFNLE9BQU8sOEJBQStCLFNBQVEsb0JBQW9CO0lBQ3RFLFlBQVksVUFBc0I7UUFDaEMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUFFRCx1QkFBdUIsQ0FDckIsVUFBc0IsRUFDdEIsZUFBaUM7UUFVakMsTUFBTSxFQUFDLEtBQUssRUFBQyxHQUFHLFVBQVUsQ0FBQztRQUMzQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQztZQUN2QyxTQUFTLEVBQUUsZUFBZSxFQUFFLFNBQVM7WUFDckMsU0FBUyxFQUFFLG9CQUFvQixDQUFDLFdBQVc7WUFDM0MsTUFBTSxFQUFFLFFBQVE7WUFDaEIsSUFBSSxFQUFFLEtB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UixXQUFXO2dCQUNYLG9CQUFvQjthQUNyQjtTQUNGLENBQ0YsQ0FBQztJQUNKLENBQUM7SUFFTyw2QkFBNkIsQ0FDbkMsZUFBdUM7UUFFdkMsT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBUSxFQUFFLG1CQUFtQixFQUFFLEVBQUU7WUFDOUQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDdkMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQzthQUN6QztZQUVELEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDMUUsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDVCxDQUFDO0lBRU8sNEJBQTRCLENBQUMsZUFBc0M7UUFDekUsT0FBTyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLG1CQUFtQixFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsRUFBRTtnQkFDdkMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxHQUFHO29CQUNuQyxJQUFJLEVBQUUsRUFBRTtpQkFDVCxDQUFDO2FBQ0g7WUFFRCxHQUFHLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksQ0FDM0MsbUJBQW1CLENBQUMsV0FBVyxDQUNoQyxDQUFDO1lBQ0YsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsRUFBNEMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RG9jdW1lbnRDbGllbnRUeXBlc30gZnJvbSAnQHR5cGVkb3JtL2RvY3VtZW50LWNsaWVudCc7XG5pbXBvcnQge1xuICBCQVRDSF9SRUFEX0lURU1TX0xJTUlULFxuICBCQVRDSF9XUklURV9JVEVNU19MSU1JVCxcbiAgSW52YWxpZEJhdGNoV3JpdGVJdGVtRXJyb3IsXG4gIFRSQU5TRk9STV9CQVRDSF9UWVBFLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7djR9IGZyb20gJ3V1aWQnO1xuaW1wb3J0IHtnZXRIYXNoZWRJZEZvcklucHV0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC1oYXNoZWQtaWQtZm9yLWlucHV0JztcbmltcG9ydCB7UmVhZEJhdGNoLCBSZWFkQmF0Y2hJdGVtfSBmcm9tICcuLi9iYXRjaC9yZWFkLWJhdGNoJztcbmltcG9ydCB7aXNCYXRjaEFkZENyZWF0ZUl0ZW0sIGlzQmF0Y2hBZGREZWxldGVJdGVtfSBmcm9tICcuLi9iYXRjaC90eXBlLWd1YXJkcyc7XG5pbXBvcnQge1dyaXRlQmF0Y2hJdGVtLCBXcml0ZUJhdGNofSBmcm9tICcuLi9iYXRjaC93cml0ZS1iYXRjaCc7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge2lzV3JpdGVUcmFuc2FjdGlvbkl0ZW1MaXN0fSBmcm9tICcuLi90cmFuc2FjdGlvbi90eXBlLWd1YXJkcyc7XG5pbXBvcnQge01ldGFkYXRhT3B0aW9uc30gZnJvbSAnLi9iYXNlLXRyYW5zZm9ybWVyJztcbmltcG9ydCB7XG4gIGlzTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcixcbiAgTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcixcbn0gZnJvbSAnLi9pcy1sYXp5LXRyYW5zYWN0aW9uLXdyaXRlLWl0ZW0tbGlzdC1sb2FkZXInO1xuaW1wb3J0IHtMb3dPcmRlclRyYW5zZm9ybWVyc30gZnJvbSAnLi9sb3ctb3JkZXItdHJhbnNmb3JtZXJzJztcblxuZXhwb3J0IHR5cGUgV3JpdGVSZXF1ZXN0V2l0aE1ldGEgPSB7XG4gIHRhYmxlTmFtZTogc3RyaW5nO1xuICB3cml0ZVJlcXVlc3Q6IERvY3VtZW50Q2xpZW50VHlwZXMuV3JpdGVSZXF1ZXN0O1xufTtcblxuZXhwb3J0IHR5cGUgUmVhZFJlcXVlc3RXaXRoTWV0YSA9IHtcbiAgdGFibGVOYW1lOiBzdHJpbmc7XG4gIHJlYWRSZXF1ZXN0OiBEb2N1bWVudENsaWVudFR5cGVzLktleTtcbn07XG5cbmV4cG9ydCB0eXBlIEJhdGNoV3JpdGVJdGVtVHJhbnNmb3JtPFRyYW5zZm9ybWVkPiA9IHtcbiAgcmF3SW5wdXQ6IGFueTtcbiAgdHJhbnNmb3JtZWRJbnB1dDogVHJhbnNmb3JtZWQ7XG59O1xuXG5leHBvcnQgdHlwZSBCYXRjaFdyaXRlSXRlbVJlcXVlc3RNYXBUcmFuc2Zvcm08VHJhbnNmb3JtZWQ+ID0ge1xuICBba2V5OiBzdHJpbmddOiBCYXRjaFdyaXRlSXRlbVRyYW5zZm9ybTxUcmFuc2Zvcm1lZD5bXTtcbn07XG5cbmV4cG9ydCBjbGFzcyBEb2N1bWVudENsaWVudEJhdGNoVHJhbnNmb3JtZXIgZXh0ZW5kcyBMb3dPcmRlclRyYW5zZm9ybWVycyB7XG4gIGNvbnN0cnVjdG9yKGNvbm5lY3Rpb246IENvbm5lY3Rpb24pIHtcbiAgICBzdXBlcihjb25uZWN0aW9uKTtcbiAgfVxuXG4gIHRvRHluYW1vV3JpdGVCYXRjaEl0ZW1zKFxuICAgIHdyaXRlQmF0Y2g6IFdyaXRlQmF0Y2gsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICk6IHtcbiAgICBiYXRjaFdyaXRlUmVxdWVzdE1hcEl0ZW1zOiBEb2N1bWVudENsaWVudFR5cGVzLkJhdGNoV3JpdGVJdGVtUmVxdWVzdE1hcExpc3Q7XG4gICAgdHJhbnNhY3Rpb25MaXN0SXRlbXM6IEJhdGNoV3JpdGVJdGVtVHJhbnNmb3JtPERvY3VtZW50Q2xpZW50VHlwZXMuVHJhbnNhY3RXcml0ZUl0ZW1MaXN0PltdO1xuICAgIGxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXJJdGVtczogQmF0Y2hXcml0ZUl0ZW1UcmFuc2Zvcm08TGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcj5bXTtcbiAgICBtZXRhZGF0YToge1xuICAgICAgbmFtZXNwYWNlSWQ6IHN0cmluZztcbiAgICAgIGl0ZW1UcmFuc2Zvcm1IYXNoTWFwOiBNYXA8c3RyaW5nLCBXcml0ZUJhdGNoSXRlbTxhbnksIGFueT4+O1xuICAgIH07XG4gIH0ge1xuICAgIGNvbnN0IHtpdGVtc30gPSB3cml0ZUJhdGNoO1xuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtQmF0Y2goe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX0JBVENIX1RZUEUuQkFUQ0hfV1JJVEUsXG4gICAgICBwcmVmaXg6ICdCZWZvcmUnLFxuICAgICAgYm9keTogaXRlbXMsXG4gICAgfSk7XG5cbiAgICBjb25zdCB7XG4gICAgICBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVySXRlbXMsXG4gICAgICBzaW1wbGVCYXRjaFJlcXVlc3RJdGVtcyxcbiAgICAgIHRyYW5zYWN0aW9uTGlzdEl0ZW1zLFxuICAgICAgbWV0YWRhdGEsXG4gICAgfSA9IHRoaXMuaW5uZXJUcmFuc2Zvcm1CYXRjaFdyaXRlSXRlbXMoaXRlbXMsIG1ldGFkYXRhT3B0aW9ucyk7XG5cbiAgICAvLyBvcmdhbml6ZSBhbGwgcmVxdWVzdHMgaW4gXCJ0YWJsZU5hbWUgLSByZXF1ZXN0SXRlbVwiIGZvcm1hdFxuICAgIGNvbnN0IHNvcnRlZCA9IHRoaXMuZ2V0V3JpdGVSZXF1ZXN0c1NvcnRlZEJ5VGFibGUoc2ltcGxlQmF0Y2hSZXF1ZXN0SXRlbXMpO1xuXG4gICAgLy8gZGl2aWRlIHNvcnRlZCByZXF1ZXN0cyBpbiBtdWx0aXBsZSBiYXRjaCBpdGVtcyByZXF1ZXN0cywgYXMgdGhlcmUgYXJlIG1heFxuICAgIC8vIDI1IGl0ZW1zIGFyZSBhbGxvd2VkIGluIGEgc2luZ2xlIGJhdGNoIG9wZXJhdGlvblxuICAgIGNvbnN0IGJhdGNoV3JpdGVSZXF1ZXN0SXRlbXMgPVxuICAgICAgdGhpcy5tYXBUYWJsZVdyaXRlSXRlbXNUb0JhdGNoV3JpdGVJdGVtcyhzb3J0ZWQpO1xuXG4gICAgY29uc3QgdHJhbnNmb3JtZWQgPSB7XG4gICAgICBiYXRjaFdyaXRlUmVxdWVzdE1hcEl0ZW1zOiBiYXRjaFdyaXRlUmVxdWVzdEl0ZW1zLFxuICAgICAgdHJhbnNhY3Rpb25MaXN0SXRlbXMsXG4gICAgICBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVySXRlbXMsXG4gICAgICBtZXRhZGF0YSxcbiAgICB9O1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1CYXRjaCh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fQkFUQ0hfVFlQRS5CQVRDSF9XUklURSxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGJvZHk6IHRyYW5zZm9ybWVkLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRyYW5zZm9ybWVkO1xuICB9XG5cbiAgdG9EeW5hbW9SZWFkQmF0Y2hJdGVtcyhcbiAgICByZWFkQmF0Y2g6IFJlYWRCYXRjaCxcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnNcbiAgKToge1xuICAgIGJhdGNoUmVxdWVzdEl0ZW1zTGlzdDogRG9jdW1lbnRDbGllbnRUeXBlcy5CYXRjaEdldFJlcXVlc3RNYXBMaXN0O1xuICAgIG1ldGFkYXRhOiB7XG4gICAgICBuYW1lc3BhY2VJZDogc3RyaW5nO1xuICAgICAgaXRlbVRyYW5zZm9ybUhhc2hNYXA6IE1hcDxzdHJpbmcsIFJlYWRCYXRjaEl0ZW08YW55LCBhbnk+PjtcbiAgICB9O1xuICB9IHtcbiAgICBjb25zdCB7aXRlbXN9ID0gcmVhZEJhdGNoO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1CYXRjaCh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fQkFUQ0hfVFlQRS5CQVRDSF9SRUFELFxuICAgICAgcHJlZml4OiAnQmVmb3JlJyxcbiAgICAgIGJvZHk6IGl0ZW1zLFxuICAgIH0pO1xuXG4gICAgY29uc3Qge21ldGFkYXRhLCBiYXRjaFJlYWRSZXF1ZXN0SXRlbXN9ID1cbiAgICAgIHRoaXMudHJhbnNmb3JtQmF0Y2hSZWFkSXRlbXMoaXRlbXMpO1xuXG4gICAgLy8gb3JnYW5pemUgYWxsIHJlcXVlc3RzIGluIFwidGFibGVOYW1lIC0gcmVxdWVzdEl0ZW1cIiBmb3JtYXRcbiAgICBjb25zdCBzb3J0ZWRCeVRhYmxlTmFtZSA9IHRoaXMuZ2V0UmVhZFJlcXVlc3RzU29ydGVkQnlUYWJsZShcbiAgICAgIGJhdGNoUmVhZFJlcXVlc3RJdGVtc1xuICAgICk7XG5cbiAgICAvLyBkaXZpZGUgc29ydGVkIHJlcXVlc3RzIGluIG11bHRpcGxlIGJhdGNoIGl0ZW1zIHJlcXVlc3RzLCBhcyB0aGVyZSBhcmUgbWF4XG4gICAgLy8gMTAwIGl0ZW1zIGFyZSBhbGxvd2VkIGluIGEgc2luZ2xlIGJhdGNoIHJlYWQgb3BlcmF0aW9uXG4gICAgY29uc3QgYmF0Y2hSZXF1ZXN0SXRlbXNMaXN0ID1cbiAgICAgIHRoaXMubWFwVGFibGVSZWFkSXRlbXNUb0JhdGNoUmVhZEl0ZW1zKHNvcnRlZEJ5VGFibGVOYW1lKTtcblxuICAgIGNvbnN0IHRyYW5zZm9ybWVkID0ge1xuICAgICAgYmF0Y2hSZXF1ZXN0SXRlbXNMaXN0LFxuICAgICAgbWV0YWRhdGEsXG4gICAgfTtcblxuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtQmF0Y2goe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX0JBVENIX1RZUEUuQkFUQ0hfUkVBRCxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGJvZHk6IHRyYW5zZm9ybWVkLFxuICAgIH0pO1xuICAgIHJldHVybiB0cmFuc2Zvcm1lZDtcbiAgfVxuXG4gIG1hcFRhYmxlV3JpdGVJdGVtc1RvQmF0Y2hXcml0ZUl0ZW1zKFxuICAgIHJlcXVlc3RzU29ydGVkQnlUYWJsZTogRG9jdW1lbnRDbGllbnRUeXBlcy5CYXRjaFdyaXRlSXRlbVJlcXVlc3RNYXBcbiAgKSB7XG4gICAgbGV0IGN1cnJlbnRGaWxsaW5nSW5kZXggPSAwO1xuICAgIGxldCB0b3RhbEl0ZW1zQXRDdXJyZW50RmlsbGluZ0luZGV4ID0gMDtcbiAgICBjb25zdCBtdWx0aUJhdGNoSXRlbXMgPSBPYmplY3QuZW50cmllcyhyZXF1ZXN0c1NvcnRlZEJ5VGFibGUpLnJlZHVjZShcbiAgICAgIChhY2MsIFt0YWJsZU5hbWUsIHBlclRhYmxlSXRlbXNdKSA9PiB7XG4gICAgICAgIC8vIHNlcGFyYXRlIHJlcXVlc3RzIGludG8gbXVsdGlwbGUgYmF0Y2ggaXRlbXMsIGlmIHRoZXJlIGFyZSBtb3JlIHRoYW4gYWxsb3dlZCBpdGVtcyB0byBwcm9jZXNzIGluIGJhdGNoXG4gICAgICAgIHdoaWxlIChwZXJUYWJsZUl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgIGlmICghYWNjW2N1cnJlbnRGaWxsaW5nSW5kZXhdKSB7XG4gICAgICAgICAgICBhY2NbY3VycmVudEZpbGxpbmdJbmRleF0gPSB7fTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoIWFjY1tjdXJyZW50RmlsbGluZ0luZGV4XVt0YWJsZU5hbWVdKSB7XG4gICAgICAgICAgICBhY2NbY3VycmVudEZpbGxpbmdJbmRleF1bdGFibGVOYW1lXSA9IFtdO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGFjY1tjdXJyZW50RmlsbGluZ0luZGV4XVt0YWJsZU5hbWVdLnB1c2gocGVyVGFibGVJdGVtcy5zaGlmdCgpISk7XG4gICAgICAgICAgKyt0b3RhbEl0ZW1zQXRDdXJyZW50RmlsbGluZ0luZGV4O1xuXG4gICAgICAgICAgLy8gYmF0Y2ggd3JpdGUgcmVxdWVzdCBoYXMgbGltaXQgb2YgMjUgaXRlbXMgcGVyIGJhdGNoIHNvIG9uY2Ugd2UgaGl0IHRoYXQgbGltaXQsXG4gICAgICAgICAgLy8gc2VwYXJhdGUgcmVtYWluaW5nIGl0ZW1zIGFzIG5ldyBiYXRjaCByZXF1ZXN0XG4gICAgICAgICAgaWYgKHRvdGFsSXRlbXNBdEN1cnJlbnRGaWxsaW5nSW5kZXggPT09IEJBVENIX1dSSVRFX0lURU1TX0xJTUlUKSB7XG4gICAgICAgICAgICArK2N1cnJlbnRGaWxsaW5nSW5kZXg7XG4gICAgICAgICAgICB0b3RhbEl0ZW1zQXRDdXJyZW50RmlsbGluZ0luZGV4ID0gMDtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICBbXSBhcyBEb2N1bWVudENsaWVudFR5cGVzLkJhdGNoV3JpdGVJdGVtUmVxdWVzdE1hcExpc3RcbiAgICApO1xuICAgIHJldHVybiBtdWx0aUJhdGNoSXRlbXM7XG4gIH1cblxuICBtYXBUYWJsZVJlYWRJdGVtc1RvQmF0Y2hSZWFkSXRlbXMoXG4gICAgcmVxdWVzdHNTb3J0ZWRCeVRhYmxlOiBEb2N1bWVudENsaWVudFR5cGVzLkJhdGNoR2V0UmVxdWVzdE1hcFxuICApIHtcbiAgICBsZXQgY3VycmVudEZpbGxpbmdJbmRleCA9IDA7XG4gICAgbGV0IHRvdGFsSXRlbXNBdEN1cnJlbnRGaWxsaW5nSW5kZXggPSAwO1xuICAgIGNvbnN0IG11bHRpQmF0Y2hJdGVtcyA9IE9iamVjdC5lbnRyaWVzKHJlcXVlc3RzU29ydGVkQnlUYWJsZSkucmVkdWNlKFxuICAgICAgKGFjYywgW3RhYmxlTmFtZSwgcGVyVGFibGVJdGVtc10pID0+IHtcbiAgICAgICAgLy8gc2VwYXJhdGUgcmVxdWVzdHMgaW50byBtdWx0aXBsZSBiYXRjaCBpdGVtcywgaWYgdGhlcmUgYXJlIG1vcmUgdGhhbiBhbGxvd2VkIGl0ZW1zIHRvIHByb2Nlc3MgaW4gYmF0Y2hcbiAgICAgICAgd2hpbGUgKHBlclRhYmxlSXRlbXMuS2V5cy5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAoIWFjY1tjdXJyZW50RmlsbGluZ0luZGV4XSkge1xuICAgICAgICAgICAgYWNjW2N1cnJlbnRGaWxsaW5nSW5kZXhdID0ge307XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKCFhY2NbY3VycmVudEZpbGxpbmdJbmRleF1bdGFibGVOYW1lXSkge1xuICAgICAgICAgICAgYWNjW2N1cnJlbnRGaWxsaW5nSW5kZXhdW3RhYmxlTmFtZV0gPSB7XG4gICAgICAgICAgICAgIEtleXM6IFtdLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBhY2NbY3VycmVudEZpbGxpbmdJbmRleF1bdGFibGVOYW1lXS5LZXlzPy5wdXNoKFxuICAgICAgICAgICAgcGVyVGFibGVJdGVtcy5LZXlzLnNoaWZ0KCkhXG4gICAgICAgICAgKTtcbiAgICAgICAgICArK3RvdGFsSXRlbXNBdEN1cnJlbnRGaWxsaW5nSW5kZXg7XG5cbiAgICAgICAgICAvLyBiYXRjaCByZWFkIHJlcXVlc3QgaGFzIGxpbWl0IG9mIG1heCAxMDAgaXRlbXMgcGVyIGJhdGNoIHNvIG9uY2Ugd2UgaGl0IHRoYXQgbGltaXQsXG4gICAgICAgICAgLy8gc2VwYXJhdGUgcmVtYWluaW5nIGl0ZW1zIGFzIG5ldyBiYXRjaCByZXF1ZXN0XG4gICAgICAgICAgaWYgKHRvdGFsSXRlbXNBdEN1cnJlbnRGaWxsaW5nSW5kZXggPT09IEJBVENIX1JFQURfSVRFTVNfTElNSVQpIHtcbiAgICAgICAgICAgICsrY3VycmVudEZpbGxpbmdJbmRleDtcbiAgICAgICAgICAgIHRvdGFsSXRlbXNBdEN1cnJlbnRGaWxsaW5nSW5kZXggPSAwO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIFtdIGFzIERvY3VtZW50Q2xpZW50VHlwZXMuQmF0Y2hHZXRSZXF1ZXN0TWFwTGlzdFxuICAgICk7XG4gICAgcmV0dXJuIG11bHRpQmF0Y2hJdGVtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXZlcnNlIHRyYW5zZm9ybXMgYmF0Y2ggd3JpdGUgaXRlbSByZXF1ZXN0IHRvIHdyaXRlIGJhdGNoIGl0ZW1cbiAgICovXG4gIHRvV3JpdGVCYXRjaElucHV0TGlzdChcbiAgICByZXF1ZXN0TWFwOiBEb2N1bWVudENsaWVudFR5cGVzLkJhdGNoV3JpdGVJdGVtUmVxdWVzdE1hcCxcbiAgICB7XG4gICAgICBuYW1lc3BhY2VJZCxcbiAgICAgIGl0ZW1UcmFuc2Zvcm1IYXNoTWFwLFxuICAgIH06IHtcbiAgICAgIG5hbWVzcGFjZUlkOiBzdHJpbmc7XG4gICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcDogTWFwPHN0cmluZywgV3JpdGVCYXRjaEl0ZW08YW55LCBhbnk+PjtcbiAgICB9XG4gICkge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhyZXF1ZXN0TWFwKS5mbGF0TWFwKChbLCB3cml0ZVJlcXVlc3RzXSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudG9SYXdCYXRjaElucHV0SXRlbTxcbiAgICAgICAgRG9jdW1lbnRDbGllbnRUeXBlcy5Xcml0ZVJlcXVlc3QsXG4gICAgICAgIFdyaXRlQmF0Y2hJdGVtPGFueSwgYW55PlxuICAgICAgPih3cml0ZVJlcXVlc3RzLCB7XG4gICAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldmVyc2UgdHJhbnNmb3JtcyBiYXRjaCByZWFkIGl0ZW0gcmVxdWVzdCB0byByZWFkIGJhdGNoIGl0ZW1cbiAgICovXG4gIHRvUmVhZEJhdGNoSW5wdXRMaXN0KFxuICAgIHJlcXVlc3RNYXA6IERvY3VtZW50Q2xpZW50VHlwZXMuQmF0Y2hHZXRSZXF1ZXN0TWFwLFxuICAgIHtcbiAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgaXRlbVRyYW5zZm9ybUhhc2hNYXAsXG4gICAgfToge1xuICAgICAgbmFtZXNwYWNlSWQ6IHN0cmluZztcbiAgICAgIGl0ZW1UcmFuc2Zvcm1IYXNoTWFwOiBNYXA8c3RyaW5nLCBSZWFkQmF0Y2hJdGVtPGFueSwgYW55Pj47XG4gICAgfVxuICApIHtcbiAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMocmVxdWVzdE1hcCkuZmxhdE1hcCgoWywgcmVhZFJlcXVlc3RzXSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudG9SYXdCYXRjaElucHV0SXRlbTxcbiAgICAgICAgRG9jdW1lbnRDbGllbnRUeXBlcy5LZXksXG4gICAgICAgIFJlYWRCYXRjaEl0ZW08YW55LCBhbnk+XG4gICAgICA+KHJlYWRSZXF1ZXN0cy5LZXlzLCB7XG4gICAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIGJhdGNoIGl0ZW0gaW5wdXQgdG8gcHJlIHRyYW5zZm9ybWVkIGl0ZW0gaW5wdXRcbiAgICovXG4gIHByaXZhdGUgdG9SYXdCYXRjaElucHV0SXRlbTxJbnB1dCwgT3V0cHV0PihcbiAgICB0cmFuc2Zvcm1lZEl0ZW1zOiBJbnB1dFtdLFxuICAgIHtcbiAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgaXRlbVRyYW5zZm9ybUhhc2hNYXAsXG4gICAgfToge1xuICAgICAgbmFtZXNwYWNlSWQ6IHN0cmluZztcbiAgICAgIGl0ZW1UcmFuc2Zvcm1IYXNoTWFwOiBNYXA8c3RyaW5nLCBPdXRwdXQ+O1xuICAgIH1cbiAgKTogT3V0cHV0W10ge1xuICAgIHJldHVybiB0cmFuc2Zvcm1lZEl0ZW1zLm1hcCh0cmFuc2Zvcm1lZEl0ZW0gPT4ge1xuICAgICAgY29uc3QgaGFzaElkID0gZ2V0SGFzaGVkSWRGb3JJbnB1dChcbiAgICAgICAgbmFtZXNwYWNlSWQsXG4gICAgICAgIHRyYW5zZm9ybWVkSXRlbSBhcyBvYmplY3RcbiAgICAgICk7XG4gICAgICBjb25zdCBvcmlnaW5hbEl0ZW0gPSBpdGVtVHJhbnNmb3JtSGFzaE1hcC5nZXQoaGFzaElkKTtcbiAgICAgIHJldHVybiBvcmlnaW5hbEl0ZW0hO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBhcnNlIGVhY2ggaXRlbSBpbiB0aGUgcmVxdWVzdCB0byBiZSBpbiBvbmUgb2YgdGhlIGZvbGxvd2luZyBjb2xsZWN0aW9uc1xuICAgKiAtIHNpbXBsZUJhdGNoUmVxdWVzdEl0ZW1zOiBzaW1wbGUgaXRlbXMgdGhhdCBjYW4gYmUgcHJvY2Vzc2VkIGluIGJhdGNoIChpLmUgbm8gdW5pcXVlcylcbiAgICogLSB0cmFuc2FjdGlvbkxpc3RJdGVtczogaXRlbXMgdGhhdCBtdXN0IGJlIHByb2Nlc3NlZCBpbiBhIHRyYW5zYWN0aW9uIGluc3RlYWQgb2YgYmF0Y2ggKGkuZSBpdGVtcyB3aXRoIHVuaXF1ZSBhdHRyaWJ1dGVzKVxuICAgKiAtIExhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXJJdGVtczogaXRlbXMgdGhhdCBhcmUgbXVzdCBiZSBwcm9jZXNzZWQgaW4gdHJhbnNhY3Rpb24gYnV0IGFsc28gcmVxdWlyZXMgb3RoZXIgcmVxdWVzdHMgdG8gYmUgbWFkZSBmaXJzdCAoaS5lIGRlbGV0ZSBvZiB1bmlxdWUgaXRlbXMpXG4gICAqL1xuICBwcml2YXRlIGlubmVyVHJhbnNmb3JtQmF0Y2hXcml0ZUl0ZW1zKFxuICAgIGJhdGNoSXRlbXM6IFdyaXRlQmF0Y2hJdGVtPGFueSwgYW55PltdLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCBuYW1lc3BhY2VJZCA9IHY0KCk7XG4gICAgY29uc3QgaXRlbVRyYW5zZm9ybUhhc2hNYXAgPSBuZXcgTWFwPHN0cmluZywgV3JpdGVCYXRjaEl0ZW08YW55LCBhbnk+PigpO1xuXG4gICAgcmV0dXJuIGJhdGNoSXRlbXMucmVkdWNlKFxuICAgICAgKGFjYywgYmF0Y2hJdGVtKSA9PiB7XG4gICAgICAgIC8vIGlzIGNyZWF0ZVxuICAgICAgICBpZiAoaXNCYXRjaEFkZENyZWF0ZUl0ZW0oYmF0Y2hJdGVtKSkge1xuICAgICAgICAgIC8vIHRyYW5zZm9ybSBwdXQgaXRlbVxuICAgICAgICAgIGNvbnN0IGR5bmFtb1B1dEl0ZW0gPSB0aGlzLnRvRHluYW1vUHV0SXRlbShcbiAgICAgICAgICAgIGJhdGNoSXRlbS5jcmVhdGUuaXRlbSxcbiAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKCFpc1dyaXRlVHJhbnNhY3Rpb25JdGVtTGlzdChkeW5hbW9QdXRJdGVtKSkge1xuICAgICAgICAgICAgY29uc3QgdHJhbnNmb3JtZWRXcml0ZVJlcXVlc3QgPSB7XG4gICAgICAgICAgICAgIFB1dFJlcXVlc3Q6IHtcbiAgICAgICAgICAgICAgICBJdGVtOiBkeW5hbW9QdXRJdGVtLkl0ZW0sXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYWNjLnNpbXBsZUJhdGNoUmVxdWVzdEl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICB3cml0ZVJlcXVlc3Q6IHRyYW5zZm9ybWVkV3JpdGVSZXF1ZXN0LFxuICAgICAgICAgICAgICB0YWJsZU5hbWU6IGR5bmFtb1B1dEl0ZW0uVGFibGVOYW1lIGFzIHN0cmluZyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gc3RvcmUgdHJhbnNmb3JtZWQgYW5kIG9yaWdpbmFsIGl0ZW1zIGFzIGhhc2gga2V5L3ZhbHVlXG5cbiAgICAgICAgICAgIGNvbnN0IGl0ZW1IYXNoSWQgPSBnZXRIYXNoZWRJZEZvcklucHV0KFxuICAgICAgICAgICAgICBuYW1lc3BhY2VJZCxcbiAgICAgICAgICAgICAgdHJhbnNmb3JtZWRXcml0ZVJlcXVlc3RcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcC5zZXQoaXRlbUhhc2hJZCwgYmF0Y2hJdGVtKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWNjLnRyYW5zYWN0aW9uTGlzdEl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICByYXdJbnB1dDogYmF0Y2hJdGVtLFxuICAgICAgICAgICAgICB0cmFuc2Zvcm1lZElucHV0OiBkeW5hbW9QdXRJdGVtLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIC8vIGlzIGRlbGV0ZVxuICAgICAgICB9IGVsc2UgaWYgKGlzQmF0Y2hBZGREZWxldGVJdGVtKGJhdGNoSXRlbSkpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBkZWxldGU6IHtpdGVtLCBwcmltYXJ5S2V5fSxcbiAgICAgICAgICB9ID0gYmF0Y2hJdGVtO1xuICAgICAgICAgIC8vIHRyYW5zZm9ybSBkZWxldGUgaXRlbVxuICAgICAgICAgIGNvbnN0IGl0ZW1Ub1JlbW92ZSA9IHRoaXMudG9EeW5hbW9EZWxldGVJdGVtKFxuICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgIHByaW1hcnlLZXksXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICAgICAgICApO1xuICAgICAgICAgIGlmICghaXNMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyKGl0ZW1Ub1JlbW92ZSkpIHtcbiAgICAgICAgICAgIGNvbnN0IHRyYW5zZm9ybWVkSXRlbVJlcXVlc3QgPSB7XG4gICAgICAgICAgICAgIERlbGV0ZVJlcXVlc3Q6IHtcbiAgICAgICAgICAgICAgICBLZXk6IGl0ZW1Ub1JlbW92ZS5LZXksXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYWNjLnNpbXBsZUJhdGNoUmVxdWVzdEl0ZW1zLnB1c2goe1xuICAgICAgICAgICAgICB3cml0ZVJlcXVlc3Q6IHRyYW5zZm9ybWVkSXRlbVJlcXVlc3QsXG4gICAgICAgICAgICAgIHRhYmxlTmFtZTogaXRlbVRvUmVtb3ZlLlRhYmxlTmFtZSBhcyBzdHJpbmcsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIC8vIHN0b3JlIHRyYW5zZm9ybWVkIGFuZCBvcmlnaW5hbCBpdGVtcyBhcyBoYXNoIGtleS92YWx1ZVxuICAgICAgICAgICAgY29uc3QgaXRlbUhhc2hJZCA9IGdldEhhc2hlZElkRm9ySW5wdXQoXG4gICAgICAgICAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgICAgICAgICB0cmFuc2Zvcm1lZEl0ZW1SZXF1ZXN0XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaXRlbVRyYW5zZm9ybUhhc2hNYXAuc2V0KGl0ZW1IYXNoSWQsIGJhdGNoSXRlbSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGFjYy5sYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVySXRlbXMucHVzaCh7XG4gICAgICAgICAgICAgIHJhd0lucHV0OiBiYXRjaEl0ZW0sXG4gICAgICAgICAgICAgIHRyYW5zZm9ybWVkSW5wdXQ6IGl0ZW1Ub1JlbW92ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEJhdGNoV3JpdGVJdGVtRXJyb3IoYmF0Y2hJdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgc2ltcGxlQmF0Y2hSZXF1ZXN0SXRlbXM6IFtdIGFzIFdyaXRlUmVxdWVzdFdpdGhNZXRhW10sXG4gICAgICAgIHRyYW5zYWN0aW9uTGlzdEl0ZW1zOlxuICAgICAgICAgIFtdIGFzIEJhdGNoV3JpdGVJdGVtVHJhbnNmb3JtPERvY3VtZW50Q2xpZW50VHlwZXMuVHJhbnNhY3RXcml0ZUl0ZW1MaXN0PltdLFxuICAgICAgICBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVySXRlbXM6XG4gICAgICAgICAgW10gYXMgQmF0Y2hXcml0ZUl0ZW1UcmFuc2Zvcm08TGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcj5bXSxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBuYW1lc3BhY2VJZCxcbiAgICAgICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcCxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmFuc2Zvcm1CYXRjaFJlYWRJdGVtcyhcbiAgICBiYXRjaEl0ZW1zOiBSZWFkQmF0Y2hJdGVtPGFueSwgYW55PltdLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCBuYW1lc3BhY2VJZCA9IHY0KCk7XG4gICAgY29uc3QgaXRlbVRyYW5zZm9ybUhhc2hNYXAgPSBuZXcgTWFwPHN0cmluZywgUmVhZEJhdGNoSXRlbTxhbnksIGFueT4+KCk7XG4gICAgcmV0dXJuIGJhdGNoSXRlbXMucmVkdWNlKFxuICAgICAgKGFjYywgYmF0Y2hJdGVtKSA9PiB7XG4gICAgICAgIGNvbnN0IHtpdGVtLCBwcmltYXJ5S2V5fSA9IGJhdGNoSXRlbTtcblxuICAgICAgICAvLyBUT0RPOiBhZGQgcmVhZCBvcHRpb25zIHN1cHBvcnRcbiAgICAgICAgY29uc3QgaXRlbVRvR2V0ID0gdGhpcy50b0R5bmFtb0dldEl0ZW0oXG4gICAgICAgICAgaXRlbSxcbiAgICAgICAgICBwcmltYXJ5S2V5LFxuICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICAgICAgKTtcbiAgICAgICAgYWNjLmJhdGNoUmVhZFJlcXVlc3RJdGVtcy5wdXNoKHtcbiAgICAgICAgICByZWFkUmVxdWVzdDogaXRlbVRvR2V0LktleSBhcyBEb2N1bWVudENsaWVudFR5cGVzLktleSxcbiAgICAgICAgICB0YWJsZU5hbWU6IGl0ZW1Ub0dldC5UYWJsZU5hbWUgYXMgc3RyaW5nLFxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBzdG9yZSBiYXRjaCBpdGVtIGlucHV0IGFuZCBpdCdzIHRyYW5zZm9ybSBpbiBtYXAsIGZvciByZXZlcnNlIHRyYW5zZm9ybSBsYXRlclxuICAgICAgICBjb25zdCB0cmFuc2Zvcm1lZEl0ZW1IYXNoSWQgPSBnZXRIYXNoZWRJZEZvcklucHV0KFxuICAgICAgICAgIG5hbWVzcGFjZUlkLFxuICAgICAgICAgIGl0ZW1Ub0dldC5LZXkgYXMgb2JqZWN0XG4gICAgICAgICk7XG4gICAgICAgIGl0ZW1UcmFuc2Zvcm1IYXNoTWFwLnNldCh0cmFuc2Zvcm1lZEl0ZW1IYXNoSWQsIGJhdGNoSXRlbSk7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBiYXRjaFJlYWRSZXF1ZXN0SXRlbXM6IFtdIGFzIFJlYWRSZXF1ZXN0V2l0aE1ldGFbXSxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBuYW1lc3BhY2VJZCxcbiAgICAgICAgICBpdGVtVHJhbnNmb3JtSGFzaE1hcCxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRXcml0ZVJlcXVlc3RzU29ydGVkQnlUYWJsZShcbiAgICBhbGxSZXF1ZXN0SXRlbXM6IFdyaXRlUmVxdWVzdFdpdGhNZXRhW11cbiAgKSB7XG4gICAgcmV0dXJuIGFsbFJlcXVlc3RJdGVtcy5yZWR1Y2UoKGFjYzogYW55LCByZXF1ZXN0SXRlbVdpdGhNZXRhKSA9PiB7XG4gICAgICBpZiAoIWFjY1tyZXF1ZXN0SXRlbVdpdGhNZXRhLnRhYmxlTmFtZV0pIHtcbiAgICAgICAgYWNjW3JlcXVlc3RJdGVtV2l0aE1ldGEudGFibGVOYW1lXSA9IFtdO1xuICAgICAgfVxuXG4gICAgICBhY2NbcmVxdWVzdEl0ZW1XaXRoTWV0YS50YWJsZU5hbWVdLnB1c2gocmVxdWVzdEl0ZW1XaXRoTWV0YS53cml0ZVJlcXVlc3QpO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSk7XG4gIH1cblxuICBwcml2YXRlIGdldFJlYWRSZXF1ZXN0c1NvcnRlZEJ5VGFibGUoYWxsUmVxdWVzdEl0ZW1zOiBSZWFkUmVxdWVzdFdpdGhNZXRhW10pIHtcbiAgICByZXR1cm4gYWxsUmVxdWVzdEl0ZW1zLnJlZHVjZSgoYWNjLCByZXF1ZXN0SXRlbVdpdGhNZXRhKSA9PiB7XG4gICAgICBpZiAoIWFjY1tyZXF1ZXN0SXRlbVdpdGhNZXRhLnRhYmxlTmFtZV0pIHtcbiAgICAgICAgYWNjW3JlcXVlc3RJdGVtV2l0aE1ldGEudGFibGVOYW1lXSA9IHtcbiAgICAgICAgICBLZXlzOiBbXSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgYWNjW3JlcXVlc3RJdGVtV2l0aE1ldGEudGFibGVOYW1lXS5LZXlzPy5wdXNoKFxuICAgICAgICByZXF1ZXN0SXRlbVdpdGhNZXRhLnJlYWRSZXF1ZXN0XG4gICAgICApO1xuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSBhcyBEb2N1bWVudENsaWVudFR5cGVzLkJhdGNoR2V0UmVxdWVzdE1hcCk7XG4gIH1cbn1cbiJdfQ==