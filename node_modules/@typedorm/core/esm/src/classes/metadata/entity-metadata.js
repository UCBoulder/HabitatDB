import { INDEX_TYPE, INTERNAL_ENTITY_ATTRIBUTE, } from '@typedorm/common';
import { buildPrimaryKeySchema } from '../../helpers/build-primary-key-schema';
import { getInterpolatedKeys } from '../../helpers/get-interpolated-keys';
import { validateKey } from '../../helpers/validate-key';
import { BaseMetadata } from './base-metadata';
import { InternalAttributeMetadata } from './internal-attribute-metadata';
export class EntityMetadata extends BaseMetadata {
    name;
    table;
    target;
    attributes;
    internalAttributes;
    schema;
    constructor({ connection, table, name, target, primaryKey, indexes, attributes, }) {
        super(connection);
        this.name = name;
        this.target = target;
        this.attributes = attributes;
        this.table = table;
        // auto persist internal attributes
        this.internalAttributes = [
            new InternalAttributeMetadata({
                name: INTERNAL_ENTITY_ATTRIBUTE.ENTITY_NAME,
                type: 'String',
                value: this.name,
            }),
        ];
        // validate attributes and key type pair
        const attributesKeyTypePair = this.attributes.reduce((acc, attr) => {
            this.validateAttributeMetadata(attr);
            acc[attr.name] = attr.type;
            return acc;
        }, {});
        this.schema = {
            primaryKey: buildPrimaryKeySchema({
                table: this.table,
                primaryKey,
                attributes: attributesKeyTypePair,
            }),
            indexes: this.buildIndexesSchema({
                table: this.table,
                indexes: { ...indexes },
                attributes: attributesKeyTypePair,
            }),
        };
    }
    validateAttributeMetadata(attributeToValidate) {
        this.internalAttributes.forEach(internalAttr => {
            if (attributeToValidate.name === internalAttr.name) {
                throw new Error(`Attribute name "${attributeToValidate.name}" is reserved by TypeDORM and cannot be used.`);
            }
        });
    }
    buildIndexesSchema({ table, indexes, attributes, }) {
        return Object.keys(indexes).reduce((acc, key) => {
            const tableIndexSignature = table.getIndexByKey(key);
            if (!tableIndexSignature) {
                throw new Error(`No matching index signature found for index "${key}" in table "${table.name}"`);
            }
            const currentIndex = indexes[key];
            validateKey(currentIndex.sortKey, attributes, this.name);
            // validates and gets and fill set indexes interpolations of sort key
            const sortKeyInterpolations = getInterpolatedKeys(currentIndex.sortKey);
            if (tableIndexSignature.type === INDEX_TYPE.LSI) {
                if (currentIndex.type !== INDEX_TYPE.LSI) {
                    throw new Error('Index signature mismatch.');
                }
                acc[key] = {
                    attributes: {
                        [tableIndexSignature.sortKey]: currentIndex.sortKey,
                    },
                    metadata: {
                        type: tableIndexSignature.type,
                        isSparse: currentIndex.isSparse === undefined ||
                            currentIndex.isSparse === null
                            ? true // by default all indexes are sparse
                            : !!currentIndex.isSparse,
                        _name: key,
                        _interpolations: {
                            [tableIndexSignature.sortKey]: sortKeyInterpolations,
                        },
                    },
                };
                return acc;
            }
            else {
                if (currentIndex.type !== INDEX_TYPE.GSI) {
                    throw new Error('Index signature mismatch.');
                }
                validateKey(currentIndex.partitionKey, attributes);
                // validates and gets and fill set indexes interpolations of partition key
                const partitionKeyInterpolations = getInterpolatedKeys(currentIndex.partitionKey);
                acc[key] = {
                    attributes: {
                        [tableIndexSignature.partitionKey]: currentIndex.partitionKey,
                        [tableIndexSignature.sortKey]: currentIndex.sortKey,
                    },
                    metadata: {
                        isSparse: currentIndex.isSparse === undefined ||
                            currentIndex.isSparse === null
                            ? true // by default all indexes are sparse
                            : !!currentIndex.isSparse,
                        type: tableIndexSignature.type,
                        _name: key,
                        // remove any duplicates from partition or sort keys
                        _interpolations: {
                            [tableIndexSignature.partitionKey]: partitionKeyInterpolations,
                            [tableIndexSignature.sortKey]: sortKeyInterpolations,
                        },
                    },
                };
                return acc;
            }
        }, {});
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LW1ldGFkYXRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy9tZXRhZGF0YS9lbnRpdHktbWV0YWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUlMLFVBQVUsRUFDVix5QkFBeUIsR0FFMUIsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSx3Q0FBd0MsQ0FBQztBQUM3RSxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUN4RSxPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sNEJBQTRCLENBQUM7QUFJdkQsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzdDLE9BQU8sRUFBQyx5QkFBeUIsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBdUN4RSxNQUFNLE9BQU8sY0FBZSxTQUFRLFlBQVk7SUFDckMsSUFBSSxDQUFTO0lBQ2IsS0FBSyxDQUFRO0lBQ2IsTUFBTSxDQUFvQjtJQUMxQixVQUFVLENBQTBCO0lBQ3BDLGtCQUFrQixDQUE4QjtJQUNoRCxNQUFNLENBQXFCO0lBQ3BDLFlBQVksRUFDVixVQUFVLEVBQ1YsS0FBSyxFQUNMLElBQUksRUFDSixNQUFNLEVBQ04sVUFBVSxFQUNWLE9BQU8sRUFDUCxVQUFVLEdBQ1k7UUFDdEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLG1DQUFtQztRQUNuQyxJQUFJLENBQUMsa0JBQWtCLEdBQUc7WUFDeEIsSUFBSSx5QkFB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QUFPLENBQUMsRUFBRSxxQkFBcUI7eUJBQ3JEO3FCQUNGO2lCQUNGLENBQUM7Z0JBQ0YsT0FBTyxHQUFHLENBQUM7YUFDWjtRQUNILENBQUMsRUFBRSxFQUErQixDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRW50aXR5UmF3TWV0YWRhdGFPcHRpb25zLFxuICBFbnRpdHlUYXJnZXQsXG4gIEluZGV4ZXMsXG4gIElOREVYX1RZUEUsXG4gIElOVEVSTkFMX0VOVElUWV9BVFRSSUJVVEUsXG4gIFRhYmxlLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7YnVpbGRQcmltYXJ5S2V5U2NoZW1hfSBmcm9tICcuLi8uLi9oZWxwZXJzL2J1aWxkLXByaW1hcnkta2V5LXNjaGVtYSc7XG5pbXBvcnQge2dldEludGVycG9sYXRlZEtleXN9IGZyb20gJy4uLy4uL2hlbHBlcnMvZ2V0LWludGVycG9sYXRlZC1rZXlzJztcbmltcG9ydCB7dmFsaWRhdGVLZXl9IGZyb20gJy4uLy4uL2hlbHBlcnMvdmFsaWRhdGUta2V5JztcbmltcG9ydCB7Q29ubmVjdGlvbn0gZnJvbSAnLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uJztcbmltcG9ydCB7QXR0cmlidXRlTWV0YWRhdGF9IGZyb20gJy4vYXR0cmlidXRlLW1ldGFkYXRhJztcbmltcG9ydCB7QXV0b0dlbmVyYXRlZEF0dHJpYnV0ZU1ldGFkYXRhfSBmcm9tICcuL2F1dG8tZ2VuZXJhdGVkLWF0dHJpYnV0ZS1tZXRhZGF0YSc7XG5pbXBvcnQge0Jhc2VNZXRhZGF0YX0gZnJvbSAnLi9iYXNlLW1ldGFkYXRhJztcbmltcG9ydCB7SW50ZXJuYWxBdHRyaWJ1dGVNZXRhZGF0YX0gZnJvbSAnLi9pbnRlcm5hbC1hdHRyaWJ1dGUtbWV0YWRhdGEnO1xuXG5leHBvcnQgdHlwZSBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5ID0ge1xuICBhdHRyaWJ1dGVzOiB7W2tleTogc3RyaW5nXTogYW55fTtcbiAgbWV0YWRhdGE6IHtcbiAgICBfaW50ZXJwb2xhdGlvbnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nW119O1xuICB9O1xufTtcbmV4cG9ydCB0eXBlIER5bmFtb0VudGl0eUluZGV4ZXNTY2hlbWEgPSB7XG4gIFtrZXk6IHN0cmluZ106IHtcbiAgICBhdHRyaWJ1dGVzOiB7W2tleTogc3RyaW5nXTogYW55fTtcbiAgICBtZXRhZGF0YTogRHluYW1vRW50aXR5SW5kZXhTY2hlbWE7XG4gIH07XG59O1xuXG5leHBvcnQgdHlwZSBEeW5hbW9FbnRpdHlJbmRleFNjaGVtYSA9IHtcbiAgLy8gYXV0byBnZW5lcmF0ZWRcbiAgX25hbWU/OiBzdHJpbmc7XG4gIC8vIGZvciBMU0ksIG9ubHkgY29udGFpbnMgaW50ZXJwb2xhdGlvbnMgZm9yIHNvcnQga2V5XG4gIF9pbnRlcnBvbGF0aW9ucz86IHtba2V5OiBzdHJpbmddOiBzdHJpbmdbXX07XG4gIGlzU3BhcnNlOiBib29sZWFuO1xuICB0eXBlOiBJTkRFWF9UWVBFO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBEeW5hbW9FbnRpdHlTY2hlbWEge1xuICBwcmltYXJ5S2V5OiBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5O1xuICBpbmRleGVzPzogRHluYW1vRW50aXR5SW5kZXhlc1NjaGVtYTtcbn1cblxuZXhwb3J0IHR5cGUgQXR0cmlidXRlTWV0YWRhdGFUeXBlID1cbiAgfCBBdHRyaWJ1dGVNZXRhZGF0YVxuICB8IEF1dG9HZW5lcmF0ZWRBdHRyaWJ1dGVNZXRhZGF0YTtcblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlNZXRhZGF0YU9wdGlvbnMgZXh0ZW5kcyBFbnRpdHlSYXdNZXRhZGF0YU9wdGlvbnMge1xuICB0YWJsZTogVGFibGU7XG4gIGNvbm5lY3Rpb246IENvbm5lY3Rpb247XG4gIGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZU1ldGFkYXRhVHlwZVtdO1xufVxuXG5leHBvcnQgY2xhc3MgRW50aXR5TWV0YWRhdGEgZXh0ZW5kcyBCYXNlTWV0YWRhdGEge1xuICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHRhYmxlOiBUYWJsZTtcbiAgcmVhZG9ubHkgdGFyZ2V0OiBFbnRpdHlUYXJnZXQ8YW55PjtcbiAgcmVhZG9ubHkgYXR0cmlidXRlczogQXR0cmlidXRlTWV0YWRhdGFUeXBlW107XG4gIHJlYWRvbmx5IGludGVybmFsQXR0cmlidXRlczogSW50ZXJuYWxBdHRyaWJ1dGVNZXRhZGF0YVtdO1xuICByZWFkb25seSBzY2hlbWE6IER5bmFtb0VudGl0eVNjaGVtYTtcbiAgY29uc3RydWN0b3Ioe1xuICAgIGNvbm5lY3Rpb24sXG4gICAgdGFibGUsXG4gICAgbmFtZSxcbiAgICB0YXJnZXQsXG4gICAgcHJpbWFyeUtleSxcbiAgICBpbmRleGVzLFxuICAgIGF0dHJpYnV0ZXMsXG4gIH06IEVudGl0eU1ldGFkYXRhT3B0aW9ucykge1xuICAgIHN1cGVyKGNvbm5lY3Rpb24pO1xuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7XG4gICAgdGhpcy5hdHRyaWJ1dGVzID0gYXR0cmlidXRlcztcbiAgICB0aGlzLnRhYmxlID0gdGFibGU7XG5cbiAgICAvLyBhdXRvIHBlcnNpc3QgaW50ZXJuYWwgYXR0cmlidXRlc1xuICAgIHRoaXMuaW50ZXJuYWxBdHRyaWJ1dGVzID0gW1xuICAgICAgbmV3IEludGVybmFsQXR0cmlidXRlTWV0YWRhdGEoe1xuICAgICAgICBuYW1lOiBJTlRFUk5BTF9FTlRJVFlfQVRUUklCVVRFLkVOVElUWV9OQU1FLFxuICAgICAgICB0eXBlOiAnU3RyaW5nJyxcbiAgICAgICAgdmFsdWU6IHRoaXMubmFtZSxcbiAgICAgIH0pLFxuICAgIF07XG5cbiAgICAvLyB2YWxpZGF0ZSBhdHRyaWJ1dGVzIGFuZCBrZXkgdHlwZSBwYWlyXG4gICAgY29uc3QgYXR0cmlidXRlc0tleVR5cGVQYWlyID0gdGhpcy5hdHRyaWJ1dGVzLnJlZHVjZSgoYWNjLCBhdHRyKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRlQXR0cmlidXRlTWV0YWRhdGEoYXR0cik7XG4gICAgICBhY2NbYXR0ci5uYW1lXSA9IGF0dHIudHlwZTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30gYXMge1trZXk6IHN0cmluZ106IHN0cmluZ30pO1xuXG4gICAgdGhpcy5zY2hlbWEgPSB7XG4gICAgICBwcmltYXJ5S2V5OiBidWlsZFByaW1hcnlLZXlTY2hlbWEoe1xuICAgICAgICB0YWJsZTogdGhpcy50YWJsZSxcbiAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgYXR0cmlidXRlczogYXR0cmlidXRlc0tleVR5cGVQYWlyLFxuICAgICAgfSksXG4gICAgICBpbmRleGVzOiB0aGlzLmJ1aWxkSW5kZXhlc1NjaGVtYSh7XG4gICAgICAgIHRhYmxlOiB0aGlzLnRhYmxlLFxuICAgICAgICBpbmRleGVzOiB7Li4uaW5kZXhlc30sXG4gICAgICAgIGF0dHJpYnV0ZXM6IGF0dHJpYnV0ZXNLZXlUeXBlUGFpcixcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlQXR0cmlidXRlTWV0YWRhdGEoXG4gICAgYXR0cmlidXRlVG9WYWxpZGF0ZTogQXR0cmlidXRlTWV0YWRhdGFUeXBlXG4gICkge1xuICAgIHRoaXMuaW50ZXJuYWxBdHRyaWJ1dGVzLmZvckVhY2goaW50ZXJuYWxBdHRyID0+IHtcbiAgICAgIGlmIChhdHRyaWJ1dGVUb1ZhbGlkYXRlLm5hbWUgPT09IGludGVybmFsQXR0ci5uYW1lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgQXR0cmlidXRlIG5hbWUgXCIke2F0dHJpYnV0ZVRvVmFsaWRhdGUubmFtZX1cIiBpcyByZXNlcnZlZCBieSBUeXBlRE9STSBhbmQgY2Fubm90IGJlIHVzZWQuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEluZGV4ZXNTY2hlbWEoe1xuICAgIHRhYmxlLFxuICAgIGluZGV4ZXMsXG4gICAgYXR0cmlidXRlcyxcbiAgfToge1xuICAgIHRhYmxlOiBUYWJsZTtcbiAgICBpbmRleGVzOiBJbmRleGVzO1xuICAgIGF0dHJpYnV0ZXM6IHtba2V5OiBzdHJpbmddOiBzdHJpbmd9O1xuICB9KTogRHluYW1vRW50aXR5SW5kZXhlc1NjaGVtYSB7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGluZGV4ZXMpLnJlZHVjZSgoYWNjLCBrZXkpID0+IHtcbiAgICAgIGNvbnN0IHRhYmxlSW5kZXhTaWduYXR1cmUgPSB0YWJsZS5nZXRJbmRleEJ5S2V5KGtleSk7XG4gICAgICBpZiAoIXRhYmxlSW5kZXhTaWduYXR1cmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBObyBtYXRjaGluZyBpbmRleCBzaWduYXR1cmUgZm91bmQgZm9yIGluZGV4IFwiJHtrZXl9XCIgaW4gdGFibGUgXCIke3RhYmxlLm5hbWV9XCJgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IGluZGV4ZXNba2V5XTtcblxuICAgICAgdmFsaWRhdGVLZXkoY3VycmVudEluZGV4LnNvcnRLZXksIGF0dHJpYnV0ZXMsIHRoaXMubmFtZSk7XG4gICAgICAvLyB2YWxpZGF0ZXMgYW5kIGdldHMgYW5kIGZpbGwgc2V0IGluZGV4ZXMgaW50ZXJwb2xhdGlvbnMgb2Ygc29ydCBrZXlcbiAgICAgIGNvbnN0IHNvcnRLZXlJbnRlcnBvbGF0aW9ucyA9IGdldEludGVycG9sYXRlZEtleXMoY3VycmVudEluZGV4LnNvcnRLZXkpO1xuXG4gICAgICBpZiAodGFibGVJbmRleFNpZ25hdHVyZS50eXBlID09PSBJTkRFWF9UWVBFLkxTSSkge1xuICAgICAgICBpZiAoY3VycmVudEluZGV4LnR5cGUgIT09IElOREVYX1RZUEUuTFNJKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbmRleCBzaWduYXR1cmUgbWlzbWF0Y2guJyk7XG4gICAgICAgIH1cbiAgICAgICAgYWNjW2tleV0gPSB7XG4gICAgICAgICAgYXR0cmlidXRlczoge1xuICAgICAgICAgICAgW3RhYmxlSW5kZXhTaWduYXR1cmUuc29ydEtleV06IGN1cnJlbnRJbmRleC5zb3J0S2V5LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIHR5cGU6IHRhYmxlSW5kZXhTaWduYXR1cmUudHlwZSxcbiAgICAgICAgICAgIGlzU3BhcnNlOlxuICAgICAgICAgICAgICBjdXJyZW50SW5kZXguaXNTcGFyc2UgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgICBjdXJyZW50SW5kZXguaXNTcGFyc2UgPT09IG51bGxcbiAgICAgICAgICAgICAgICA/IHRydWUgLy8gYnkgZGVmYXVsdCBhbGwgaW5kZXhlcyBhcmUgc3BhcnNlXG4gICAgICAgICAgICAgICAgOiAhIWN1cnJlbnRJbmRleC5pc1NwYXJzZSxcbiAgICAgICAgICAgIF9uYW1lOiBrZXksXG4gICAgICAgICAgICBfaW50ZXJwb2xhdGlvbnM6IHtcbiAgICAgICAgICAgICAgW3RhYmxlSW5kZXhTaWduYXR1cmUuc29ydEtleV06IHNvcnRLZXlJbnRlcnBvbGF0aW9ucyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGN1cnJlbnRJbmRleC50eXBlICE9PSBJTkRFWF9UWVBFLkdTSSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5kZXggc2lnbmF0dXJlIG1pc21hdGNoLicpO1xuICAgICAgICB9XG4gICAgICAgIHZhbGlkYXRlS2V5KGN1cnJlbnRJbmRleC5wYXJ0aXRpb25LZXksIGF0dHJpYnV0ZXMpO1xuICAgICAgICAvLyB2YWxpZGF0ZXMgYW5kIGdldHMgYW5kIGZpbGwgc2V0IGluZGV4ZXMgaW50ZXJwb2xhdGlvbnMgb2YgcGFydGl0aW9uIGtleVxuICAgICAgICBjb25zdCBwYXJ0aXRpb25LZXlJbnRlcnBvbGF0aW9ucyA9IGdldEludGVycG9sYXRlZEtleXMoXG4gICAgICAgICAgY3VycmVudEluZGV4LnBhcnRpdGlvbktleVxuICAgICAgICApO1xuXG4gICAgICAgIGFjY1trZXldID0ge1xuICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIFt0YWJsZUluZGV4U2lnbmF0dXJlLnBhcnRpdGlvbktleV06IGN1cnJlbnRJbmRleC5wYXJ0aXRpb25LZXksXG4gICAgICAgICAgICBbdGFibGVJbmRleFNpZ25hdHVyZS5zb3J0S2V5XTogY3VycmVudEluZGV4LnNvcnRLZXksXG4gICAgICAgICAgfSxcbiAgICAgICAgICBtZXRhZGF0YToge1xuICAgICAgICAgICAgaXNTcGFyc2U6XG4gICAgICAgICAgICAgIGN1cnJlbnRJbmRleC5pc1NwYXJzZSA9PT0gdW5kZWZpbmVkIHx8XG4gICAgICAgICAgICAgIGN1cnJlbnRJbmRleC5pc1NwYXJzZSA9PT0gbnVsbFxuICAgICAgICAgICAgICAgID8gdHJ1ZSAvLyBieSBkZWZhdWx0IGFsbCBpbmRleGVzIGFyZSBzcGFyc2VcbiAgICAgICAgICAgICAgICA6ICEhY3VycmVudEluZGV4LmlzU3BhcnNlLFxuICAgICAgICAgICAgdHlwZTogdGFibGVJbmRleFNpZ25hdHVyZS50eXBlLFxuICAgICAgICAgICAgX25hbWU6IGtleSxcbiAgICAgICAgICAgIC8vIHJlbW92ZSBhbnkgZHVwbGljYXRlcyBmcm9tIHBhcnRpdGlvbiBvciBzb3J0IGtleXNcbiAgICAgICAgICAgIF9pbnRlcnBvbGF0aW9uczoge1xuICAgICAgICAgICAgICBbdGFibGVJbmRleFNpZ25hdHVyZS5wYXJ0aXRpb25LZXldOiBwYXJ0aXRpb25LZXlJbnRlcnBvbGF0aW9ucyxcbiAgICAgICAgICAgICAgW3RhYmxlSW5kZXhTaWduYXR1cmUuc29ydEtleV06IHNvcnRLZXlJbnRlcnBvbGF0aW9ucyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH1cbiAgICB9LCB7fSBhcyBEeW5hbW9FbnRpdHlJbmRleGVzU2NoZW1hKTtcbiAgfVxufVxuIl19