import { IsEntityInstance, MANAGER_NAME, STATS_TYPE, } from '@typedorm/common';
import { getDynamoQueryItemsLimit } from '../../helpers/get-dynamo-query-items-limit';
import { isEmptyObject } from '../../helpers/is-empty-object';
import { DocumentClientRequestTransformer } from '../transformer/document-client-request-transformer';
import { EntityTransformer } from '../transformer/entity-transformer';
import { getConstructorForInstance } from '../../helpers/get-constructor-for-instance';
import { isUsedForPrimaryKey } from '../../helpers/is-used-for-primary-key';
import { isWriteTransactionItemList } from '../transaction/type-guards';
import { isLazyTransactionWriteItemListLoader } from '../transformer/is-lazy-transaction-write-item-list-loader';
import { getUniqueRequestId } from '../../helpers/get-unique-request-id';
export class EntityManager {
    connection;
    _dcReqTransformer;
    _entityTransformer;
    constructor(connection) {
        this.connection = connection;
        this._dcReqTransformer = new DocumentClientRequestTransformer(connection);
        this._entityTransformer = new EntityTransformer(connection);
    }
    /**
     * Creates new record in table with given entity
     * @param entity Entity to add to table as a new record
     */
    async create(entity, options, metadataOptions) {
        if (!IsEntityInstance(entity)) {
            throw new Error(`Provided entity ${JSON.stringify(entity)} must be an instance of an entity class`);
        }
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoPutItemInput = this._dcReqTransformer.toDynamoPutItem(entity, options, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        const entityClass = getConstructorForInstance(entity);
        if (!isWriteTransactionItemList(dynamoPutItemInput)) {
            const response = await this.connection.documentClient.put(dynamoPutItemInput);
            // log stats
            if (response?.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId,
                    scope: MANAGER_NAME.ENTITY_MANAGER,
                    statsType: STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            // by default dynamodb does not return attributes on create operation, so return one
            const itemToReturn = this._entityTransformer.fromDynamoEntity(entityClass, dynamoPutItemInput.Item, {
                requestId,
            });
            return itemToReturn;
        }
        // dynamoPutItemInput is a transact item list, meaning that it contains one or more unique attributes, which also
        // needs to be created along with original item
        await this.connection.transactionManger.writeRaw(dynamoPutItemInput, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        const itemToReturn = this._entityTransformer.fromDynamoEntity(entityClass, 
        // if create operation contains multiple items, first one will the original item
        dynamoPutItemInput[0]?.Put?.Item ?? {}, {
            requestId,
        });
        return itemToReturn;
    }
    /**
     * Finds an record by given primary key, when table uses composite primary key,
     * props must include both partition and sort key attributes
     * @param entityClass Entity to get value of
     * @param props attributes of entity
     */
    async findOne(entityClass, primaryKeyAttributes, options, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoGetItem = this._dcReqTransformer.toDynamoGetItem(entityClass, primaryKeyAttributes, options, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        const response = await this.connection.documentClient.get(dynamoGetItem);
        // stats
        if (response?.ConsumedCapacity) {
            this.connection.logger.logStats({
                requestId,
                scope: MANAGER_NAME.ENTITY_MANAGER,
                statsType: STATS_TYPE.CONSUMED_CAPACITY,
                consumedCapacityData: response.ConsumedCapacity,
            });
        }
        // return early when not found
        if (!response.Item) {
            return;
        }
        const entity = this._entityTransformer.fromDynamoEntity(entityClass, response.Item, {
            requestId,
        });
        return entity;
    }
    /**
     * Checks if item with given attribute/primary key exists in the table
     * @param entityClass Entity class
     * @param attributes attributes to find items by, must be primary key attributes or attribute marked as unique
     */
    async exists(entityClass, attributes, options, metadataOptions) {
        if (isEmptyObject(attributes)) {
            throw new Error("Attributes are required to check it's existence.");
        }
        const metadata = this.connection.getEntityByTarget(entityClass);
        const uniqueAttributesMetadata = this.connection.getUniqueAttributesForEntity(entityClass);
        const uniqueAttributeNames = uniqueAttributesMetadata.map(attr => attr.name);
        const { primaryKeyAttributes, uniqueAttributes } = Object.entries(attributes).reduce((acc, [attrKey, value]) => {
            if (isUsedForPrimaryKey(metadata.schema.primaryKey, attrKey)) {
                acc.primaryKeyAttributes[attrKey] = value;
            }
            else if (uniqueAttributeNames.includes(attrKey)) {
                acc.uniqueAttributes[attrKey] = value;
            }
            else {
                // any attributes that are not part of either primary key or is not marked as unique will be rejected
                throw new Error(`Only attributes that are part of primary key or is marked as unique attribute can be queried, attribute "${attrKey} is neither."`);
            }
            return acc;
        }, {
            primaryKeyAttributes: {},
            uniqueAttributes: {},
        });
        if (!isEmptyObject(primaryKeyAttributes) &&
            !isEmptyObject(uniqueAttributes)) {
            throw new Error('Can not search both primary key and unique attributes at the same time.');
        }
        // find item by primary key if it can be resolved
        if (!isEmptyObject(primaryKeyAttributes)) {
            return !!(await this.findOne(entityClass, attributes, { consistentRead: options?.consistentRead }, {
                requestId: options?.requestId ?? metadataOptions?.requestId,
                returnConsumedCapacity: options?.returnConsumedCapacity ??
                    metadataOptions?.returnConsumedCapacity,
            }));
        }
        // try finding entity by unique attribute
        if (!isEmptyObject(uniqueAttributes)) {
            const requestId = getUniqueRequestId(options?.requestId ?? metadataOptions?.requestId);
            if (Object.keys(uniqueAttributes).length > 1) {
                throw new Error('Can only query one unique attribute at a time.');
            }
            const [attrName, attrValue] = Object.entries(uniqueAttributes)[0];
            const uniqueAttributePrimaryKey = uniqueAttributesMetadata.find(meta => meta.name === attrName)?.unique;
            if (!uniqueAttributePrimaryKey) {
                console.log(`Could not find metadata for attribute ${attrName}`);
                return false;
            }
            const parsedPrimaryKey = this._entityTransformer.getParsedPrimaryKey(metadata.table, uniqueAttributePrimaryKey, { [attrName]: attrValue });
            const response = await this.connection.documentClient.get({
                Key: { ...parsedPrimaryKey },
                TableName: metadata.table.name,
                ConsistentRead: options?.consistentRead,
                ReturnConsumedCapacity: options?.requestId ?? metadataOptions?.returnConsumedCapacity,
            });
            // stats
            if (response?.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId,
                    scope: MANAGER_NAME.ENTITY_MANAGER,
                    statsType: STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            return !!response.Item;
        }
        // if none of the above, item does not exist
        return false;
    }
    /**
     *
     * @param entityClass Entity class to update
     * @param primaryKeyAttributes Primary key
     * @param body Attributes to update
     * @param options update options
     */
    async update(entityClass, primaryKeyAttributes, body, options, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoUpdateItem = this._dcReqTransformer.toDynamoUpdateItem(entityClass, primaryKeyAttributes, body, options, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        if (!isLazyTransactionWriteItemListLoader(dynamoUpdateItem)) {
            const response = await this.connection.documentClient.update(dynamoUpdateItem);
            // stats
            if (response.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId,
                    scope: MANAGER_NAME.ENTITY_MANAGER,
                    statsType: STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            return this._entityTransformer.fromDynamoEntity(entityClass, 
            // return all new attributes
            response.Attributes ?? {}, {
                requestId,
            });
        }
        // first get existing item, so that we can safely clear previous unique attributes
        const existingItem = await this.findOne(entityClass, primaryKeyAttributes, undefined, metadataOptions);
        const updateItemList = dynamoUpdateItem.lazyLoadTransactionWriteItems(existingItem);
        await this.connection.transactionManger.writeRaw(updateItemList, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        return this.findOne(entityClass, primaryKeyAttributes, undefined, metadataOptions);
    }
    /**
     * Deletes an entity by primary key
     * @param entityClass Entity Class to delete
     * @param primaryKeyAttributes Entity Primary key
     */
    async delete(entityClass, primaryKeyAttributes, options, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoDeleteItem = this._dcReqTransformer.toDynamoDeleteItem(entityClass, primaryKeyAttributes, options, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        if (!isLazyTransactionWriteItemListLoader(dynamoDeleteItem)) {
            const response = await this.connection.documentClient.delete(dynamoDeleteItem);
            // stats
            if (response.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId,
                    scope: MANAGER_NAME.ENTITY_MANAGER,
                    statsType: STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            return {
                success: true,
            };
        }
        // first get existing item, so that we can safely clear previous unique attributes
        const existingItem = await this.findOne(entityClass, primaryKeyAttributes, undefined, metadataOptions);
        const deleteItemList = dynamoDeleteItem.lazyLoadTransactionWriteItems(existingItem);
        // delete main item and all it's unique attributes as part of single transaction
        await this.connection.transactionManger.writeRaw(deleteItemList, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        return {
            success: true,
        };
    }
    /**
     * Find items using declarative query options
     * @param entityClass Entity to query
     * @param partitionKey Partition key attributes, If querying an index,
     * this is the partition key attributes of that index
     * @param queryOptions Query Options
     */
    async find(entityClass, partitionKey, queryOptions, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoQueryItem = this._dcReqTransformer.toDynamoQueryItem(entityClass, partitionKey, queryOptions, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        const response = await this._internalRecursiveQuery({
            queryInput: dynamoQueryItem,
            // if no explicit limit is set, always fall back to imposing implicit limit
            limit: queryOptions?.limit ?? getDynamoQueryItemsLimit(),
            cursor: queryOptions?.cursor,
            metadataOptions: {
                requestId,
                returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
            },
        });
        return {
            ...response,
            items: response.items.map(item => this._entityTransformer.fromDynamoEntity(entityClass, item, {
                requestId,
            })),
        };
    }
    /**
     * Returns a count of total items matching ther query
     * @param entityClass Entity to query
     * @param partitionKey Partition key attributes, If querying an index,
     * this is the partition key attributes of that index
     * @param queryOptions Count Query Options
     */
    async count(entityClass, partitionKey, queryOptions, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const dynamoQueryItem = this._dcReqTransformer.toDynamoQueryItem(entityClass, partitionKey, { ...queryOptions, onlyCount: true, select: undefined }, // select projection and count can not be used together
        {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
        const count = await this._internalRecursiveCount({
            queryInput: dynamoQueryItem,
            metadataOptions: {
                requestId,
                returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
            },
        });
        return count;
    }
    /**
     * Recursively queries all items from table
     * @param param Query params
     */
    async _internalRecursiveQuery({ queryInput, limit, cursor, itemsFetched = [], metadataOptions, }) {
        const { LastEvaluatedKey, Items = [], ConsumedCapacity, } = await this.connection.documentClient.query({
            ...queryInput,
            ExclusiveStartKey: cursor,
        });
        // stats
        if (ConsumedCapacity) {
            this.connection.logger.logStats({
                requestId: metadataOptions?.requestId,
                scope: MANAGER_NAME.ENTITY_MANAGER,
                statsType: STATS_TYPE.CONSUMED_CAPACITY,
                consumedCapacityData: ConsumedCapacity,
            });
        }
        itemsFetched = [...itemsFetched, ...Items];
        if (itemsFetched.length < limit && LastEvaluatedKey) {
            return this._internalRecursiveQuery({
                queryInput,
                limit,
                cursor: LastEvaluatedKey,
                itemsFetched,
                metadataOptions,
            });
        }
        return { items: itemsFetched, cursor: LastEvaluatedKey };
    }
    /**
     * Recursively counts all items from table
     * @param param Query params
     */
    async _internalRecursiveCount({ queryInput, cursor, currentCount = 0, metadataOptions, }) {
        const { LastEvaluatedKey, Count, ConsumedCapacity } = await this.connection.documentClient.query({
            ...queryInput,
            ExclusiveStartKey: cursor,
        });
        // stats
        if (ConsumedCapacity) {
            this.connection.logger.logStats({
                requestId: metadataOptions?.requestId,
                scope: MANAGER_NAME.ENTITY_MANAGER,
                statsType: STATS_TYPE.CONSUMED_CAPACITY,
                consumedCapacityData: ConsumedCapacity,
            });
        }
        currentCount += Count || 0;
        if (LastEvaluatedKey) {
            return this._internalRecursiveCount({
                queryInput,
                cursor: LastEvaluatedKey,
                currentCount,
                metadataOptions,
            });
        }
        return currentCount;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9jbGFzc2VzL21hbmFnZXIvZW50aXR5LW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUtMLGdCQUFnQixFQUNoQixZQUFZLEVBRVosVUFBVSxHQUNYLE1BQU0sa0JBQWtCLENBQUM7QUFDMUIsT0FBTyxFQUFDLHdCQUF3QixFQUFDLE1BQU0sNENBQTRDLENBQUM7QUFDcEYsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLCtCQUErQixDQUFDO0FBRTVELE9BQU8sRUFBQyxnQ0FBZ0MsRUFBQyxNQUFNLG9EQUFvRCxDQUFDO0FBQ3BHLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLG1DQUFtQyxDQUFDO0FBQ3BFLE9BQU8sRUFBQyx5QkFBeUIsRUFBQyxNQUFNLDRDQUE0QyxDQUFDO0FBQ3JGLE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQzFFLE9BQU8sRUFBQywwQkFBMEIsRUFBQyxNQUFNLDRCQUE0QixDQUFDO0FBQ3RFLE9BQU8sRUFBQyxvQ0FBb0MsRUFBQyxNQUFNLDJEQUEyRCxDQUFDO0FBSS9HLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBNkp2RSxNQUFNLE9BQU8sYUFBYTtJQUlGO0lBSGQsaUJBQWlCLENBQW1DO0lBQ3BELGtCQUFrQixDQUFvQjtJQUU5QyxZQUFzQixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQzFDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGdDQUFnQyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQzFFLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFL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S0FBSyxDQUFDLHVCQUF1QixDQUFDLEVBQ3BDLFVBQVUsRUFDVixNQUFNLEVBQ04sWUFBWSxHQUFHLENBQUMsRUFDaEIsZUFBZSxHQU1oQjtRQUNDLE1BQU0sRUFBQyxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUMsR0FDL0MsTUFBTSxJQUFJLENBQUMsVUFBVSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUM7WUFDekMsR0FBRyxVQUFVO1lBQ2IsaUJBQWlCLEVBQUUsTUFBTTtTQUMxQixDQUFDLENBQUM7UUFDTCxRQUFRO1FBQ1IsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7Z0JBQzlCLFNBQVMsRUFBRSxlQUFlLEVBQUUsU0FBUztnQkFDckMsS0FBSyxFQUFFLFlBQVksQ0FBQyxjQUFjO2dCQUNsQyxTQUFTLEVBQUUsVUFBVSxDQUFDLGlCQUFpQjtnQkFDdkMsb0JBQW9CLEVBQUUsZ0JBQWdCO2FBQ3ZDLENBQUMsQ0FBQztTQUNKO1FBRUQsWUFBWSxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7UUFFM0IsSUFBSSxnQkFBZ0IsRUFBRTtZQUNwQixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQztnQkFDbEMsVUFBVTtnQkFDVixNQUFNLEVBQUUsZ0JBQWdCO2dCQUN4QixZQUFZO2dCQUNaLGVBQWU7YUFDaEIsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDT05TVU1FRF9DQVBBQ0lUWV9UWVBFLFxuICBFbnRpdHlBdHRyaWJ1dGVzLFxuICBFbnRpdHlJbnN0YW5jZSxcbiAgRW50aXR5VGFyZ2V0LFxuICBJc0VudGl0eUluc3RhbmNlLFxuICBNQU5BR0VSX05BTUUsXG4gIFFVRVJZX09SREVSLFxuICBTVEFUU19UWVBFLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7Z2V0RHluYW1vUXVlcnlJdGVtc0xpbWl0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC1keW5hbW8tcXVlcnktaXRlbXMtbGltaXQnO1xuaW1wb3J0IHtpc0VtcHR5T2JqZWN0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLWVtcHR5LW9iamVjdCc7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge0RvY3VtZW50Q2xpZW50UmVxdWVzdFRyYW5zZm9ybWVyfSBmcm9tICcuLi90cmFuc2Zvcm1lci9kb2N1bWVudC1jbGllbnQtcmVxdWVzdC10cmFuc2Zvcm1lcic7XG5pbXBvcnQge0VudGl0eVRyYW5zZm9ybWVyfSBmcm9tICcuLi90cmFuc2Zvcm1lci9lbnRpdHktdHJhbnNmb3JtZXInO1xuaW1wb3J0IHtnZXRDb25zdHJ1Y3RvckZvckluc3RhbmNlfSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC1jb25zdHJ1Y3Rvci1mb3ItaW5zdGFuY2UnO1xuaW1wb3J0IHtpc1VzZWRGb3JQcmltYXJ5S2V5fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLXVzZWQtZm9yLXByaW1hcnkta2V5JztcbmltcG9ydCB7aXNXcml0ZVRyYW5zYWN0aW9uSXRlbUxpc3R9IGZyb20gJy4uL3RyYW5zYWN0aW9uL3R5cGUtZ3VhcmRzJztcbmltcG9ydCB7aXNMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyfSBmcm9tICcuLi90cmFuc2Zvcm1lci9pcy1sYXp5LXRyYW5zYWN0aW9uLXdyaXRlLWl0ZW0tbGlzdC1sb2FkZXInO1xuaW1wb3J0IHtGaWx0ZXJPcHRpb25zfSBmcm9tICcuLi9leHByZXNzaW9uL2ZpbHRlci1vcHRpb25zLXR5cGUnO1xuaW1wb3J0IHtDb25kaXRpb25PcHRpb25zfSBmcm9tICcuLi9leHByZXNzaW9uL2NvbmRpdGlvbi1vcHRpb25zLXR5cGUnO1xuaW1wb3J0IHtNZXRhZGF0YU9wdGlvbnN9IGZyb20gJy4uL3RyYW5zZm9ybWVyL2Jhc2UtdHJhbnNmb3JtZXInO1xuaW1wb3J0IHtnZXRVbmlxdWVSZXF1ZXN0SWR9IGZyb20gJy4uLy4uL2hlbHBlcnMvZ2V0LXVuaXF1ZS1yZXF1ZXN0LWlkJztcbmltcG9ydCB7UHJvamVjdGlvbktleXN9IGZyb20gJy4uL2V4cHJlc3Npb24vcHJvamVjdGlvbi1rZXlzLW9wdGlvbnMtdHlwZSc7XG5pbXBvcnQge0tleUNvbmRpdGlvbk9wdGlvbnN9IGZyb20gJy4uL2V4cHJlc3Npb24va2V5LWNvbmRpdGlvbi1vcHRpb25zLXR5cGUnO1xuaW1wb3J0IHtVcGRhdGVCb2R5fSBmcm9tICcuLi9leHByZXNzaW9uL3VwZGF0ZS1ib2R5LXR5cGUnO1xuaW1wb3J0IHtEb2N1bWVudENsaWVudFR5cGVzfSBmcm9tICdAdHlwZWRvcm0vZG9jdW1lbnQtY2xpZW50JztcblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlNYW5hZ2VyQ3JlYXRlT3B0aW9uczxFbnRpdHk+IHtcbiAgLyoqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICBvdmVyd3JpdGVJZkV4aXN0cz86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFNwZWNpZnkgY29uZGl0aW9uIHRvIGFwcGx5XG4gICAqL1xuICB3aGVyZT86IENvbmRpdGlvbk9wdGlvbnM8RW50aXR5Pjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlNYW5hZ2VyVXBkYXRlT3B0aW9uczxFbnRpdHk+IHtcbiAgLyoqXG4gICAqIEBkZWZhdWx0ICcuJ1xuICAgKi9cbiAgbmVzdGVkS2V5U2VwYXJhdG9yPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBTcGVjaWZ5IGNvbmRpdGlvbiB0byBhcHBseVxuICAgKi9cbiAgd2hlcmU/OiBDb25kaXRpb25PcHRpb25zPEVudGl0eT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50aXR5TWFuYWdlckRlbGV0ZU9wdGlvbnM8RW50aXR5PiB7XG4gIC8qKlxuICAgKiBTcGVjaWZ5IGNvbmRpdGlvbiB0byBhcHBseVxuICAgKi9cbiAgd2hlcmU/OiBDb25kaXRpb25PcHRpb25zPEVudGl0eT47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50aXR5TWFuYWdlckZpbmRPcHRpb25zPEVudGl0eSwgUGFydGl0aW9uS2V5PiB7XG4gIC8qKlxuICAgKiBJbmRleCB0byBxdWVyeSwgd2hlbiBvbWl0dGVkLCBxdWVyeSB3aWxsIGJlIHJ1biBhZ2FpbnN0IG1haW4gdGFibGVcbiAgICovXG4gIHF1ZXJ5SW5kZXg/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFNvcnQga2V5IGNvbmRpdGlvblxuICAgKiBAZGVmYXVsdCBub25lIC0gbm8gc29ydCBrZXkgY29uZGl0aW9uIGlzIGFwcGxpZWRcbiAgICovXG4gIGtleUNvbmRpdGlvbj86IEtleUNvbmRpdGlvbk9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIE1heCBudW1iZXIgb2YgcmVjb3JkcyB0byBxdWVyeVxuICAgKiBAZGVmYXVsdCAtIGltcGxpY2l0IGR5bmFtbyBkYiBxdWVyeSBsaW1pdCBpcyBhcHBsaWVkXG4gICAqL1xuICBsaW1pdD86IG51bWJlcjtcblxuICAvKipcbiAgICogT3JkZXIgdG8gcXVlcnkgaXRlbXMgaW5cbiAgICogQGRlZmF1bHQgQVNDXG4gICAqL1xuICBvcmRlckJ5PzogUVVFUllfT1JERVI7XG5cbiAgLyoqXG4gICAqIEN1cnNvciB0byB0cmF2ZXJzZSBmcm9tXG4gICAqL1xuICBjdXJzb3I/OiBEb2N1bWVudENsaWVudFR5cGVzLktleTtcblxuICAvKipcbiAgICogU3BlY2lmeSBmaWx0ZXIgdG8gYXBwbHlcbiAgICogQXZvaWQgdXNpbmcgdGhpcyB3aGVyZSBwb3NzaWJsZSwgc2luY2UgZmlsdGVycyBpbiBkeW5hbW9kYiBhcHBsaWVzIGFmdGVyIGl0ZW1zXG4gICAqIGFyZSByZWFkXG4gICAqL1xuICB3aGVyZT86IEZpbHRlck9wdGlvbnM8RW50aXR5LCBQYXJ0aXRpb25LZXk+O1xuXG4gIC8qKlxuICAgKiBTcGVjaWZpZXMgd2hpY2ggYXR0cmlidXRlcyB0byBmZXRjaFxuICAgKiBAZGVmYXVsdCBhbGwgYXR0cmlidXRlcyBhcmUgZmV0Y2hlZFxuICAgKi9cbiAgc2VsZWN0PzogUHJvamVjdGlvbktleXM8RW50aXR5PjtcblxuICAvKipcbiAgICogUGVyZm9ybSBhIGNvbnNpc3RlbnQgcmVhZCBvbiB0aGUgdGFibGUsIGNvbnN1bWVzIHR3aWNlIGFzIG11Y2ggUkNVcyB0aGVuIG5vcm1hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb24gU3Ryb25nbHkgY29uc2lzdGVudCByZWFkcyBhcmUgbm90IHN1cHBvcnRlZCBvbiBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4ZXMuXG4gICAqIElmIHlvdSBxdWVyeSBhIGdsb2JhbCBzZWNvbmRhcnkgaW5kZXggd2l0aCBDb25zaXN0ZW50UmVhZCBzZXQgdG8gdHJ1ZSxcbiAgICogeW91IHdpbGwgcmVjZWl2ZSBhIFZhbGlkYXRpb25FeGNlcHRpb24uXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2FtYXpvbmR5bmFtb2RiL2xhdGVzdC9BUElSZWZlcmVuY2UvQVBJX1F1ZXJ5Lmh0bWwjRERCLVF1ZXJ5LXJlcXVlc3QtQ29uc2lzdGVudFJlYWRcbiAgICovXG4gIGNvbnNpc3RlbnRSZWFkPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlNYW5hZ2VyQ291bnRPcHRpb25zPEVudGl0eSwgUGFydGl0aW9uS2V5PiB7XG4gIC8qKlxuICAgKiBJbmRleCB0byBxdWVyeSwgd2hlbiBvbWl0dGVkLCBxdWVyeSB3aWxsIGJlIHJ1biBhZ2FpbnN0IG1haW4gdGFibGVcbiAgICovXG4gIHF1ZXJ5SW5kZXg/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFNvcnQga2V5IGNvbmRpdGlvblxuICAgKiBAZGVmYXVsdCBub25lIC0gbm8gc29ydCBrZXkgY29uZGl0aW9uIGlzIGFwcGxpZWRcbiAgICovXG4gIGtleUNvbmRpdGlvbj86IEtleUNvbmRpdGlvbk9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIFNwZWNpZnkgZmlsdGVyIHRvIGFwcGx5XG4gICAqIEF2b2lkIHVzaW5nIHRoaXMgd2hlcmUgcG9zc2libGUsIHNpbmNlIGZpbHRlcnMgaW4gZHluYW1vZGIgYXBwbGllcyBhZnRlciBpdGVtc1xuICAgKiBhcmUgcmVhZFxuICAgKi9cbiAgd2hlcmU/OiBGaWx0ZXJPcHRpb25zPEVudGl0eSwgUGFydGl0aW9uS2V5PjtcblxuICAvKipcbiAgICogUGVyZm9ybSBhIGNvbnNpc3RlbnQgcmVhZCBvbiB0aGUgdGFibGUsIGNvbnN1bWVzIHR3aWNlIGFzIG11Y2ggUkNVcyB0aGVuIG5vcm1hbFxuICAgKlxuICAgKiBAZGVzY3JpcHRpb24gU3Ryb25nbHkgY29uc2lzdGVudCByZWFkcyBhcmUgbm90IHN1cHBvcnRlZCBvbiBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4ZXMuXG4gICAqIElmIHlvdSBxdWVyeSBhIGdsb2JhbCBzZWNvbmRhcnkgaW5kZXggd2l0aCBDb25zaXN0ZW50UmVhZCBzZXQgdG8gdHJ1ZSxcbiAgICogeW91IHdpbGwgcmVjZWl2ZSBhIFZhbGlkYXRpb25FeGNlcHRpb24uXG4gICAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2FtYXpvbmR5bmFtb2RiL2xhdGVzdC9BUElSZWZlcmVuY2UvQVBJX1F1ZXJ5Lmh0bWwjRERCLVF1ZXJ5LXJlcXVlc3QtQ29uc2lzdGVudFJlYWRcbiAgICovXG4gIGNvbnNpc3RlbnRSZWFkPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFbnRpdHlNYW5hZ2VyRmluZE9uZU9wdGlvbnM8RW50aXR5PiB7XG4gIC8qKlxuICAgKiBTcGVjaWZpZXMgd2hpY2ggYXR0cmlidXRlcyB0byBmZXRjaFxuICAgKiBAZGVmYXVsdCBhbGwgYXR0cmlidXRlcyBhcmUgZmV0Y2hlZFxuICAgKi9cbiAgc2VsZWN0PzogUHJvamVjdGlvbktleXM8RW50aXR5PjtcblxuICAvKipcbiAgICogUGVyZm9ybSBhIGNvbnNpc3RlbnQgcmVhZCBvbiB0aGUgdGFibGUsIGNvbnN1bWVzIHR3aWNlIGFzIG11Y2ggUkNVcyB0aGVuIG5vcm1hbFxuICAgKi9cbiAgY29uc2lzdGVudFJlYWQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVudGl0eU1hbmFnZXJFeGlzdHNPcHRpb25zIHtcbiAgLyoqXG4gICAqIFBlcmZvcm0gYSBjb25zaXN0ZW50IHJlYWQgb24gdGhlIHRhYmxlLCBjb25zdW1lcyB0d2ljZSBhcyBtdWNoIFJDVXMgdGhlbiBub3JtYWxcbiAgICpcbiAgICogQGRlc2NyaXB0aW9uIFN0cm9uZ2x5IGNvbnNpc3RlbnQgcmVhZHMgYXJlIG5vdCBzdXBwb3J0ZWQgb24gZ2xvYmFsIHNlY29uZGFyeSBpbmRleGVzLlxuICAgKiBJZiB5b3UgcXVlcnkgYSBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4IHdpdGggQ29uc2lzdGVudFJlYWQgc2V0IHRvIHRydWUsXG4gICAqIHlvdSB3aWxsIHJlY2VpdmUgYSBWYWxpZGF0aW9uRXhjZXB0aW9uLlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9hbWF6b25keW5hbW9kYi9sYXRlc3QvQVBJUmVmZXJlbmNlL0FQSV9RdWVyeS5odG1sI0REQi1RdWVyeS1yZXF1ZXN0LUNvbnNpc3RlbnRSZWFkXG4gICAqL1xuICBjb25zaXN0ZW50UmVhZD86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIC0gUHJvdmlkZSB0aGUgXCJyZXF1ZXN0SWRcIiBpbiB0aGUgbmV4dCBwYXJhbWV0ZXIgaW5zdGVhZFxuICAgKiBPbmx5IGF2YWlsYWJsZSBoZXJlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eVxuICAgKi9cbiAgcmVxdWVzdElkPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCAtIFByb3ZpZGUgdGhlIFwicmV0dXJuQ29uc3VtZWRDYXBhY2l0eVwiIGluIHRoZSBuZXh0IHBhcmFtZXRlciBpbnN0ZWFkXG4gICAqIE9ubHkgYXZhaWxhYmxlIGhlcmUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5XG4gICAqL1xuICByZXR1cm5Db25zdW1lZENhcGFjaXR5PzogQ09OU1VNRURfQ0FQQUNJVFlfVFlQRTtcbn1cblxuZXhwb3J0IGNsYXNzIEVudGl0eU1hbmFnZXIge1xuICBwcml2YXRlIF9kY1JlcVRyYW5zZm9ybWVyOiBEb2N1bWVudENsaWVudFJlcXVlc3RUcmFuc2Zvcm1lcjtcbiAgcHJpdmF0ZSBfZW50aXR5VHJhbnNmb3JtZXI6IEVudGl0eVRyYW5zZm9ybWVyO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBjb25uZWN0aW9uOiBDb25uZWN0aW9uKSB7XG4gICAgdGhpcy5fZGNSZXFUcmFuc2Zvcm1lciA9IG5ldyBEb2N1bWVudENsaWVudFJlcXVlc3RUcmFuc2Zvcm1lcihjb25uZWN0aW9uKTtcbiAgICB0aGlzLl9lbnRpdHlUcmFuc2Zvcm1lciA9IG5ldyBFbnRpdHlUcmFuc2Zvcm1lcihjb25uZWN0aW9uKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIG5ldyByZWNvcmQgaW4gdGFibGUgd2l0aCBnaXZlbiBlbnRpdHlcbiAgICogQHBhcmFtIGVudGl0eSBFbnRpdHkgdG8gYWRkIHRvIHRhYmxlIGFzIGEgbmV3IHJlY29yZFxuICAgKi9cbiAgYXN5bmMgY3JlYXRlPEVudGl0eT4oXG4gICAgZW50aXR5OiBFbnRpdHlJbnN0YW5jZSxcbiAgICBvcHRpb25zPzogRW50aXR5TWFuYWdlckNyZWF0ZU9wdGlvbnM8RW50aXR5PixcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnNcbiAgKTogUHJvbWlzZTxFbnRpdHk+IHtcbiAgICBpZiAoIUlzRW50aXR5SW5zdGFuY2UoZW50aXR5KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgUHJvdmlkZWQgZW50aXR5ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgZW50aXR5XG4gICAgICAgICl9IG11c3QgYmUgYW4gaW5zdGFuY2Ugb2YgYW4gZW50aXR5IGNsYXNzYFxuICAgICAgKTtcbiAgICB9XG4gICAgY29uc3QgcmVxdWVzdElkID0gZ2V0VW5pcXVlUmVxdWVzdElkKG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkKTtcblxuICAgIGNvbnN0IGR5bmFtb1B1dEl0ZW1JbnB1dCA9IHRoaXMuX2RjUmVxVHJhbnNmb3JtZXIudG9EeW5hbW9QdXRJdGVtKFxuICAgICAgZW50aXR5LFxuICAgICAgb3B0aW9ucyxcbiAgICAgIHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICB9XG4gICAgKTtcblxuICAgIGNvbnN0IGVudGl0eUNsYXNzID0gZ2V0Q29uc3RydWN0b3JGb3JJbnN0YW5jZShlbnRpdHkpO1xuXG4gICAgaWYgKCFpc1dyaXRlVHJhbnNhY3Rpb25JdGVtTGlzdChkeW5hbW9QdXRJdGVtSW5wdXQpKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5kb2N1bWVudENsaWVudC5wdXQoXG4gICAgICAgIGR5bmFtb1B1dEl0ZW1JbnB1dFxuICAgICAgKTtcblxuICAgICAgLy8gbG9nIHN0YXRzXG4gICAgICBpZiAocmVzcG9uc2U/LkNvbnN1bWVkQ2FwYWNpdHkpIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dTdGF0cyh7XG4gICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuRU5USVRZX01BTkFHRVIsXG4gICAgICAgICAgc3RhdHNUeXBlOiBTVEFUU19UWVBFLkNPTlNVTUVEX0NBUEFDSVRZLFxuICAgICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiByZXNwb25zZS5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gYnkgZGVmYXVsdCBkeW5hbW9kYiBkb2VzIG5vdCByZXR1cm4gYXR0cmlidXRlcyBvbiBjcmVhdGUgb3BlcmF0aW9uLCBzbyByZXR1cm4gb25lXG4gICAgICBjb25zdCBpdGVtVG9SZXR1cm4gPSB0aGlzLl9lbnRpdHlUcmFuc2Zvcm1lci5mcm9tRHluYW1vRW50aXR5PEVudGl0eT4oXG4gICAgICAgIGVudGl0eUNsYXNzLFxuICAgICAgICBkeW5hbW9QdXRJdGVtSW5wdXQuSXRlbSBhcyBEb2N1bWVudENsaWVudFR5cGVzLkF0dHJpYnV0ZU1hcCxcbiAgICAgICAge1xuICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgcmV0dXJuIGl0ZW1Ub1JldHVybjtcbiAgICB9XG5cbiAgICAvLyBkeW5hbW9QdXRJdGVtSW5wdXQgaXMgYSB0cmFuc2FjdCBpdGVtIGxpc3QsIG1lYW5pbmcgdGhhdCBpdCBjb250YWlucyBvbmUgb3IgbW9yZSB1bmlxdWUgYXR0cmlidXRlcywgd2hpY2ggYWxzb1xuICAgIC8vIG5lZWRzIHRvIGJlIGNyZWF0ZWQgYWxvbmcgd2l0aCBvcmlnaW5hbCBpdGVtXG5cbiAgICBhd2FpdCB0aGlzLmNvbm5lY3Rpb24udHJhbnNhY3Rpb25NYW5nZXIud3JpdGVSYXcoZHluYW1vUHV0SXRlbUlucHV0LCB7XG4gICAgICByZXF1ZXN0SWQsXG4gICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfSk7XG5cbiAgICBjb25zdCBpdGVtVG9SZXR1cm4gPSB0aGlzLl9lbnRpdHlUcmFuc2Zvcm1lci5mcm9tRHluYW1vRW50aXR5PEVudGl0eT4oXG4gICAgICBlbnRpdHlDbGFzcyxcbiAgICAgIC8vIGlmIGNyZWF0ZSBvcGVyYXRpb24gY29udGFpbnMgbXVsdGlwbGUgaXRlbXMsIGZpcnN0IG9uZSB3aWxsIHRoZSBvcmlnaW5hbCBpdGVtXG4gICAgICBkeW5hbW9QdXRJdGVtSW5wdXRbMF0/LlB1dD8uSXRlbSA/PyB7fSxcbiAgICAgIHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4gaXRlbVRvUmV0dXJuO1xuICB9XG5cbiAgLyoqXG4gICAqIEZpbmRzIGFuIHJlY29yZCBieSBnaXZlbiBwcmltYXJ5IGtleSwgd2hlbiB0YWJsZSB1c2VzIGNvbXBvc2l0ZSBwcmltYXJ5IGtleSxcbiAgICogcHJvcHMgbXVzdCBpbmNsdWRlIGJvdGggcGFydGl0aW9uIGFuZCBzb3J0IGtleSBhdHRyaWJ1dGVzXG4gICAqIEBwYXJhbSBlbnRpdHlDbGFzcyBFbnRpdHkgdG8gZ2V0IHZhbHVlIG9mXG4gICAqIEBwYXJhbSBwcm9wcyBhdHRyaWJ1dGVzIG9mIGVudGl0eVxuICAgKi9cbiAgYXN5bmMgZmluZE9uZTxFbnRpdHksIFByaW1hcnlLZXkgPSBQYXJ0aWFsPEVudGl0eT4+KFxuICAgIGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5PixcbiAgICBwcmltYXJ5S2V5QXR0cmlidXRlczogUHJpbWFyeUtleSxcbiAgICBvcHRpb25zPzogRW50aXR5TWFuYWdlckZpbmRPbmVPcHRpb25zPEVudGl0eT4sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICk6IFByb21pc2U8RW50aXR5IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3QgcmVxdWVzdElkID0gZ2V0VW5pcXVlUmVxdWVzdElkKG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkKTtcblxuICAgIGNvbnN0IGR5bmFtb0dldEl0ZW0gPSB0aGlzLl9kY1JlcVRyYW5zZm9ybWVyLnRvRHluYW1vR2V0SXRlbShcbiAgICAgIGVudGl0eUNsYXNzLFxuICAgICAgcHJpbWFyeUtleUF0dHJpYnV0ZXMsXG4gICAgICBvcHRpb25zLFxuICAgICAge1xuICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgIHJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uZG9jdW1lbnRDbGllbnQuZ2V0KGR5bmFtb0dldEl0ZW0pO1xuICAgIC8vIHN0YXRzXG4gICAgaWYgKHJlc3BvbnNlPy5Db25zdW1lZENhcGFjaXR5KSB7XG4gICAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1N0YXRzKHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICBzY29wZTogTUFOQUdFUl9OQU1FLkVOVElUWV9NQU5BR0VSLFxuICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiByZXNwb25zZS5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIGVhcmx5IHdoZW4gbm90IGZvdW5kXG4gICAgaWYgKCFyZXNwb25zZS5JdGVtKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZW50aXR5ID0gdGhpcy5fZW50aXR5VHJhbnNmb3JtZXIuZnJvbUR5bmFtb0VudGl0eTxFbnRpdHk+KFxuICAgICAgZW50aXR5Q2xhc3MsXG4gICAgICByZXNwb25zZS5JdGVtLFxuICAgICAge1xuICAgICAgICByZXF1ZXN0SWQsXG4gICAgICB9XG4gICAgKTtcblxuICAgIHJldHVybiBlbnRpdHk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGl0ZW0gd2l0aCBnaXZlbiBhdHRyaWJ1dGUvcHJpbWFyeSBrZXkgZXhpc3RzIGluIHRoZSB0YWJsZVxuICAgKiBAcGFyYW0gZW50aXR5Q2xhc3MgRW50aXR5IGNsYXNzXG4gICAqIEBwYXJhbSBhdHRyaWJ1dGVzIGF0dHJpYnV0ZXMgdG8gZmluZCBpdGVtcyBieSwgbXVzdCBiZSBwcmltYXJ5IGtleSBhdHRyaWJ1dGVzIG9yIGF0dHJpYnV0ZSBtYXJrZWQgYXMgdW5pcXVlXG4gICAqL1xuICBhc3luYyBleGlzdHM8RW50aXR5LCBLZXlBdHRyaWJ1dGVzID0gUGFydGlhbDxFbnRpdHk+PihcbiAgICBlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4sXG4gICAgYXR0cmlidXRlczogS2V5QXR0cmlidXRlcyxcbiAgICBvcHRpb25zPzogRW50aXR5TWFuYWdlckV4aXN0c09wdGlvbnMsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIGlmIChpc0VtcHR5T2JqZWN0KGF0dHJpYnV0ZXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBdHRyaWJ1dGVzIGFyZSByZXF1aXJlZCB0byBjaGVjayBpdCdzIGV4aXN0ZW5jZS5cIik7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuXG4gICAgY29uc3QgdW5pcXVlQXR0cmlidXRlc01ldGFkYXRhID1cbiAgICAgIHRoaXMuY29ubmVjdGlvbi5nZXRVbmlxdWVBdHRyaWJ1dGVzRm9yRW50aXR5KGVudGl0eUNsYXNzKTtcblxuICAgIGNvbnN0IHVuaXF1ZUF0dHJpYnV0ZU5hbWVzID0gdW5pcXVlQXR0cmlidXRlc01ldGFkYXRhLm1hcChcbiAgICAgIGF0dHIgPT4gYXR0ci5uYW1lXG4gICAgKTtcblxuICAgIGNvbnN0IHtwcmltYXJ5S2V5QXR0cmlidXRlcywgdW5pcXVlQXR0cmlidXRlc30gPSBPYmplY3QuZW50cmllcyhcbiAgICAgIGF0dHJpYnV0ZXMgYXMgb2JqZWN0XG4gICAgKS5yZWR1Y2UoXG4gICAgICAoYWNjLCBbYXR0cktleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIGlmIChpc1VzZWRGb3JQcmltYXJ5S2V5KG1ldGFkYXRhLnNjaGVtYS5wcmltYXJ5S2V5LCBhdHRyS2V5KSkge1xuICAgICAgICAgIGFjYy5wcmltYXJ5S2V5QXR0cmlidXRlc1thdHRyS2V5XSA9IHZhbHVlO1xuICAgICAgICB9IGVsc2UgaWYgKHVuaXF1ZUF0dHJpYnV0ZU5hbWVzLmluY2x1ZGVzKGF0dHJLZXkpKSB7XG4gICAgICAgICAgYWNjLnVuaXF1ZUF0dHJpYnV0ZXNbYXR0cktleV0gPSB2YWx1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBhbnkgYXR0cmlidXRlcyB0aGF0IGFyZSBub3QgcGFydCBvZiBlaXRoZXIgcHJpbWFyeSBrZXkgb3IgaXMgbm90IG1hcmtlZCBhcyB1bmlxdWUgd2lsbCBiZSByZWplY3RlZFxuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBPbmx5IGF0dHJpYnV0ZXMgdGhhdCBhcmUgcGFydCBvZiBwcmltYXJ5IGtleSBvciBpcyBtYXJrZWQgYXMgdW5pcXVlIGF0dHJpYnV0ZSBjYW4gYmUgcXVlcmllZCwgYXR0cmlidXRlIFwiJHthdHRyS2V5fSBpcyBuZWl0aGVyLlwiYFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIHByaW1hcnlLZXlBdHRyaWJ1dGVzOiB7fSBhcyBhbnksXG4gICAgICAgIHVuaXF1ZUF0dHJpYnV0ZXM6IHt9IGFzIGFueSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKFxuICAgICAgIWlzRW1wdHlPYmplY3QocHJpbWFyeUtleUF0dHJpYnV0ZXMpICYmXG4gICAgICAhaXNFbXB0eU9iamVjdCh1bmlxdWVBdHRyaWJ1dGVzKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2FuIG5vdCBzZWFyY2ggYm90aCBwcmltYXJ5IGtleSBhbmQgdW5pcXVlIGF0dHJpYnV0ZXMgYXQgdGhlIHNhbWUgdGltZS4nXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIGZpbmQgaXRlbSBieSBwcmltYXJ5IGtleSBpZiBpdCBjYW4gYmUgcmVzb2x2ZWRcbiAgICBpZiAoIWlzRW1wdHlPYmplY3QocHJpbWFyeUtleUF0dHJpYnV0ZXMpKSB7XG4gICAgICByZXR1cm4gISEoYXdhaXQgdGhpcy5maW5kT25lKFxuICAgICAgICBlbnRpdHlDbGFzcyxcbiAgICAgICAgYXR0cmlidXRlcyxcbiAgICAgICAge2NvbnNpc3RlbnRSZWFkOiBvcHRpb25zPy5jb25zaXN0ZW50UmVhZH0sXG4gICAgICAgIHtcbiAgICAgICAgICByZXF1ZXN0SWQ6IG9wdGlvbnM/LnJlcXVlc3RJZCA/PyBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OlxuICAgICAgICAgICAgb3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSA/P1xuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgICB9XG4gICAgICApKTtcbiAgICB9XG5cbiAgICAvLyB0cnkgZmluZGluZyBlbnRpdHkgYnkgdW5pcXVlIGF0dHJpYnV0ZVxuICAgIGlmICghaXNFbXB0eU9iamVjdCh1bmlxdWVBdHRyaWJ1dGVzKSkge1xuICAgICAgY29uc3QgcmVxdWVzdElkID0gZ2V0VW5pcXVlUmVxdWVzdElkKFxuICAgICAgICBvcHRpb25zPy5yZXF1ZXN0SWQgPz8gbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWRcbiAgICAgICk7XG4gICAgICBpZiAoT2JqZWN0LmtleXModW5pcXVlQXR0cmlidXRlcykubGVuZ3RoID4gMSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0NhbiBvbmx5IHF1ZXJ5IG9uZSB1bmlxdWUgYXR0cmlidXRlIGF0IGEgdGltZS4nKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IFthdHRyTmFtZSwgYXR0clZhbHVlXSA9IE9iamVjdC5lbnRyaWVzKHVuaXF1ZUF0dHJpYnV0ZXMpWzBdO1xuXG4gICAgICBjb25zdCB1bmlxdWVBdHRyaWJ1dGVQcmltYXJ5S2V5ID0gdW5pcXVlQXR0cmlidXRlc01ldGFkYXRhLmZpbmQoXG4gICAgICAgIG1ldGEgPT4gbWV0YS5uYW1lID09PSBhdHRyTmFtZVxuICAgICAgKT8udW5pcXVlO1xuXG4gICAgICBpZiAoIXVuaXF1ZUF0dHJpYnV0ZVByaW1hcnlLZXkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYENvdWxkIG5vdCBmaW5kIG1ldGFkYXRhIGZvciBhdHRyaWJ1dGUgJHthdHRyTmFtZX1gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwYXJzZWRQcmltYXJ5S2V5ID0gdGhpcy5fZW50aXR5VHJhbnNmb3JtZXIuZ2V0UGFyc2VkUHJpbWFyeUtleShcbiAgICAgICAgbWV0YWRhdGEudGFibGUsXG4gICAgICAgIHVuaXF1ZUF0dHJpYnV0ZVByaW1hcnlLZXksXG4gICAgICAgIHtbYXR0ck5hbWVdOiBhdHRyVmFsdWV9XG4gICAgICApO1xuXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5kb2N1bWVudENsaWVudC5nZXQoe1xuICAgICAgICBLZXk6IHsuLi5wYXJzZWRQcmltYXJ5S2V5fSxcbiAgICAgICAgVGFibGVOYW1lOiBtZXRhZGF0YS50YWJsZS5uYW1lLFxuICAgICAgICBDb25zaXN0ZW50UmVhZDogb3B0aW9ucz8uY29uc2lzdGVudFJlYWQsXG4gICAgICAgIFJldHVybkNvbnN1bWVkQ2FwYWNpdHk6XG4gICAgICAgICAgb3B0aW9ucz8ucmVxdWVzdElkID8/IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICAgIH0pO1xuICAgICAgLy8gc3RhdHNcbiAgICAgIGlmIChyZXNwb25zZT8uQ29uc3VtZWRDYXBhY2l0eSkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1N0YXRzKHtcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5FTlRJVFlfTUFOQUdFUixcbiAgICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgICAgY29uc3VtZWRDYXBhY2l0eURhdGE6IHJlc3BvbnNlLkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gISFyZXNwb25zZS5JdGVtO1xuICAgIH1cbiAgICAvLyBpZiBub25lIG9mIHRoZSBhYm92ZSwgaXRlbSBkb2VzIG5vdCBleGlzdFxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBAcGFyYW0gZW50aXR5Q2xhc3MgRW50aXR5IGNsYXNzIHRvIHVwZGF0ZVxuICAgKiBAcGFyYW0gcHJpbWFyeUtleUF0dHJpYnV0ZXMgUHJpbWFyeSBrZXlcbiAgICogQHBhcmFtIGJvZHkgQXR0cmlidXRlcyB0byB1cGRhdGVcbiAgICogQHBhcmFtIG9wdGlvbnMgdXBkYXRlIG9wdGlvbnNcbiAgICovXG4gIGFzeW5jIHVwZGF0ZTxcbiAgICBFbnRpdHksXG4gICAgUHJpbWFyeUtleSA9IFBhcnRpYWw8RW50aXR5PixcbiAgICBBZGRpdGlvbmFsUHJvcGVydGllcyA9IEVudGl0eVxuICA+KFxuICAgIGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5PixcbiAgICBwcmltYXJ5S2V5QXR0cmlidXRlczogUHJpbWFyeUtleSxcbiAgICBib2R5OiBVcGRhdGVCb2R5PEVudGl0eSwgQWRkaXRpb25hbFByb3BlcnRpZXM+LFxuICAgIG9wdGlvbnM/OiBFbnRpdHlNYW5hZ2VyVXBkYXRlT3B0aW9uczxFbnRpdHk+LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApOiBQcm9taXNlPEVudGl0eSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGdldFVuaXF1ZVJlcXVlc3RJZChtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCk7XG5cbiAgICBjb25zdCBkeW5hbW9VcGRhdGVJdGVtID0gdGhpcy5fZGNSZXFUcmFuc2Zvcm1lci50b0R5bmFtb1VwZGF0ZUl0ZW08XG4gICAgICBFbnRpdHksXG4gICAgICBQcmltYXJ5S2V5XG4gICAgPihlbnRpdHlDbGFzcywgcHJpbWFyeUtleUF0dHJpYnV0ZXMsIGJvZHksIG9wdGlvbnMsIHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIHJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICB9KTtcblxuICAgIGlmICghaXNMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyKGR5bmFtb1VwZGF0ZUl0ZW0pKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5kb2N1bWVudENsaWVudC51cGRhdGUoXG4gICAgICAgIGR5bmFtb1VwZGF0ZUl0ZW1cbiAgICAgICk7XG4gICAgICAvLyBzdGF0c1xuICAgICAgaWYgKHJlc3BvbnNlLkNvbnN1bWVkQ2FwYWNpdHkpIHtcbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dTdGF0cyh7XG4gICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuRU5USVRZX01BTkFHRVIsXG4gICAgICAgICAgc3RhdHNUeXBlOiBTVEFUU19UWVBFLkNPTlNVTUVEX0NBUEFDSVRZLFxuICAgICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiByZXNwb25zZS5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuX2VudGl0eVRyYW5zZm9ybWVyLmZyb21EeW5hbW9FbnRpdHk8RW50aXR5PihcbiAgICAgICAgZW50aXR5Q2xhc3MsXG4gICAgICAgIC8vIHJldHVybiBhbGwgbmV3IGF0dHJpYnV0ZXNcbiAgICAgICAgcmVzcG9uc2UuQXR0cmlidXRlcyA/PyB7fSxcbiAgICAgICAge1xuICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBmaXJzdCBnZXQgZXhpc3RpbmcgaXRlbSwgc28gdGhhdCB3ZSBjYW4gc2FmZWx5IGNsZWFyIHByZXZpb3VzIHVuaXF1ZSBhdHRyaWJ1dGVzXG4gICAgY29uc3QgZXhpc3RpbmdJdGVtID0gYXdhaXQgdGhpcy5maW5kT25lPEVudGl0eSwgUHJpbWFyeUtleT4oXG4gICAgICBlbnRpdHlDbGFzcyxcbiAgICAgIHByaW1hcnlLZXlBdHRyaWJ1dGVzLFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgbWV0YWRhdGFPcHRpb25zXG4gICAgKTtcblxuICAgIGNvbnN0IHVwZGF0ZUl0ZW1MaXN0ID1cbiAgICAgIGR5bmFtb1VwZGF0ZUl0ZW0ubGF6eUxvYWRUcmFuc2FjdGlvbldyaXRlSXRlbXMoZXhpc3RpbmdJdGVtKTtcblxuICAgIGF3YWl0IHRoaXMuY29ubmVjdGlvbi50cmFuc2FjdGlvbk1hbmdlci53cml0ZVJhdyh1cGRhdGVJdGVtTGlzdCwge1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmZpbmRPbmU8RW50aXR5LCBQcmltYXJ5S2V5PihcbiAgICAgIGVudGl0eUNsYXNzLFxuICAgICAgcHJpbWFyeUtleUF0dHJpYnV0ZXMsXG4gICAgICB1bmRlZmluZWQsXG4gICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZXMgYW4gZW50aXR5IGJ5IHByaW1hcnkga2V5XG4gICAqIEBwYXJhbSBlbnRpdHlDbGFzcyBFbnRpdHkgQ2xhc3MgdG8gZGVsZXRlXG4gICAqIEBwYXJhbSBwcmltYXJ5S2V5QXR0cmlidXRlcyBFbnRpdHkgUHJpbWFyeSBrZXlcbiAgICovXG4gIGFzeW5jIGRlbGV0ZTxFbnRpdHksIFByaW1hcnlLZXlBdHRyaWJ1dGVzID0gUGFydGlhbDxFbnRpdHk+PihcbiAgICBlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4sXG4gICAgcHJpbWFyeUtleUF0dHJpYnV0ZXM6IFByaW1hcnlLZXlBdHRyaWJ1dGVzLFxuICAgIG9wdGlvbnM/OiBFbnRpdHlNYW5hZ2VyRGVsZXRlT3B0aW9uczxFbnRpdHk+LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBnZXRVbmlxdWVSZXF1ZXN0SWQobWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQpO1xuXG4gICAgY29uc3QgZHluYW1vRGVsZXRlSXRlbSA9IHRoaXMuX2RjUmVxVHJhbnNmb3JtZXIudG9EeW5hbW9EZWxldGVJdGVtPFxuICAgICAgRW50aXR5LFxuICAgICAgUHJpbWFyeUtleUF0dHJpYnV0ZXNcbiAgICA+KGVudGl0eUNsYXNzLCBwcmltYXJ5S2V5QXR0cmlidXRlcywgb3B0aW9ucywge1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgIH0pO1xuXG4gICAgaWYgKCFpc0xhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIoZHluYW1vRGVsZXRlSXRlbSkpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jb25uZWN0aW9uLmRvY3VtZW50Q2xpZW50LmRlbGV0ZShcbiAgICAgICAgZHluYW1vRGVsZXRlSXRlbVxuICAgICAgKTtcbiAgICAgIC8vIHN0YXRzXG4gICAgICBpZiAocmVzcG9uc2UuQ29uc3VtZWRDYXBhY2l0eSkge1xuICAgICAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1N0YXRzKHtcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5FTlRJVFlfTUFOQUdFUixcbiAgICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgICAgY29uc3VtZWRDYXBhY2l0eURhdGE6IHJlc3BvbnNlLkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBmaXJzdCBnZXQgZXhpc3RpbmcgaXRlbSwgc28gdGhhdCB3ZSBjYW4gc2FmZWx5IGNsZWFyIHByZXZpb3VzIHVuaXF1ZSBhdHRyaWJ1dGVzXG4gICAgY29uc3QgZXhpc3RpbmdJdGVtID0gYXdhaXQgdGhpcy5maW5kT25lPEVudGl0eSwgUHJpbWFyeUtleUF0dHJpYnV0ZXM+KFxuICAgICAgZW50aXR5Q2xhc3MsXG4gICAgICBwcmltYXJ5S2V5QXR0cmlidXRlcyxcbiAgICAgIHVuZGVmaW5lZCxcbiAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICk7XG5cbiAgICBjb25zdCBkZWxldGVJdGVtTGlzdCA9XG4gICAgICBkeW5hbW9EZWxldGVJdGVtLmxhenlMb2FkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1zKGV4aXN0aW5nSXRlbSk7XG5cbiAgICAvLyBkZWxldGUgbWFpbiBpdGVtIGFuZCBhbGwgaXQncyB1bmlxdWUgYXR0cmlidXRlcyBhcyBwYXJ0IG9mIHNpbmdsZSB0cmFuc2FjdGlvblxuICAgIGF3YWl0IHRoaXMuY29ubmVjdGlvbi50cmFuc2FjdGlvbk1hbmdlci53cml0ZVJhdyhkZWxldGVJdGVtTGlzdCwge1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgIH0pO1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiB0cnVlLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRmluZCBpdGVtcyB1c2luZyBkZWNsYXJhdGl2ZSBxdWVyeSBvcHRpb25zXG4gICAqIEBwYXJhbSBlbnRpdHlDbGFzcyBFbnRpdHkgdG8gcXVlcnlcbiAgICogQHBhcmFtIHBhcnRpdGlvbktleSBQYXJ0aXRpb24ga2V5IGF0dHJpYnV0ZXMsIElmIHF1ZXJ5aW5nIGFuIGluZGV4LFxuICAgKiB0aGlzIGlzIHRoZSBwYXJ0aXRpb24ga2V5IGF0dHJpYnV0ZXMgb2YgdGhhdCBpbmRleFxuICAgKiBAcGFyYW0gcXVlcnlPcHRpb25zIFF1ZXJ5IE9wdGlvbnNcbiAgICovXG4gIGFzeW5jIGZpbmQ8RW50aXR5LCBQYXJ0aXRpb25LZXkgPSBQYXJ0aWFsPEVudGl0eUF0dHJpYnV0ZXM8RW50aXR5Pj4gfCBzdHJpbmc+KFxuICAgIGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5PixcbiAgICBwYXJ0aXRpb25LZXk6IFBhcnRpdGlvbktleSxcbiAgICBxdWVyeU9wdGlvbnM/OiBFbnRpdHlNYW5hZ2VyRmluZE9wdGlvbnM8RW50aXR5LCBQYXJ0aXRpb25LZXk+LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApOiBQcm9taXNlPHtcbiAgICBpdGVtczogRW50aXR5W107XG4gICAgY3Vyc29yPzogRG9jdW1lbnRDbGllbnRUeXBlcy5LZXkgfCB1bmRlZmluZWQ7XG4gIH0+IHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBnZXRVbmlxdWVSZXF1ZXN0SWQobWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQpO1xuXG4gICAgY29uc3QgZHluYW1vUXVlcnlJdGVtID0gdGhpcy5fZGNSZXFUcmFuc2Zvcm1lci50b0R5bmFtb1F1ZXJ5SXRlbTxcbiAgICAgIEVudGl0eSxcbiAgICAgIFBhcnRpdGlvbktleVxuICAgID4oZW50aXR5Q2xhc3MsIHBhcnRpdGlvbktleSwgcXVlcnlPcHRpb25zLCB7XG4gICAgICByZXF1ZXN0SWQsXG4gICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2ludGVybmFsUmVjdXJzaXZlUXVlcnkoe1xuICAgICAgcXVlcnlJbnB1dDogZHluYW1vUXVlcnlJdGVtLFxuICAgICAgLy8gaWYgbm8gZXhwbGljaXQgbGltaXQgaXMgc2V0LCBhbHdheXMgZmFsbCBiYWNrIHRvIGltcG9zaW5nIGltcGxpY2l0IGxpbWl0XG4gICAgICBsaW1pdDogcXVlcnlPcHRpb25zPy5saW1pdCA/PyBnZXREeW5hbW9RdWVyeUl0ZW1zTGltaXQoKSxcbiAgICAgIGN1cnNvcjogcXVlcnlPcHRpb25zPy5jdXJzb3IsXG4gICAgICBtZXRhZGF0YU9wdGlvbnM6IHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgaXRlbXM6IHJlc3BvbnNlLml0ZW1zLm1hcChpdGVtID0+XG4gICAgICAgIHRoaXMuX2VudGl0eVRyYW5zZm9ybWVyLmZyb21EeW5hbW9FbnRpdHk8RW50aXR5PihlbnRpdHlDbGFzcywgaXRlbSwge1xuICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgfSlcbiAgICAgICksXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgY291bnQgb2YgdG90YWwgaXRlbXMgbWF0Y2hpbmcgdGhlciBxdWVyeVxuICAgKiBAcGFyYW0gZW50aXR5Q2xhc3MgRW50aXR5IHRvIHF1ZXJ5XG4gICAqIEBwYXJhbSBwYXJ0aXRpb25LZXkgUGFydGl0aW9uIGtleSBhdHRyaWJ1dGVzLCBJZiBxdWVyeWluZyBhbiBpbmRleCxcbiAgICogdGhpcyBpcyB0aGUgcGFydGl0aW9uIGtleSBhdHRyaWJ1dGVzIG9mIHRoYXQgaW5kZXhcbiAgICogQHBhcmFtIHF1ZXJ5T3B0aW9ucyBDb3VudCBRdWVyeSBPcHRpb25zXG4gICAqL1xuICBhc3luYyBjb3VudDxcbiAgICBFbnRpdHksXG4gICAgUGFydGl0aW9uS2V5ID0gUGFydGlhbDxFbnRpdHlBdHRyaWJ1dGVzPEVudGl0eT4+IHwgc3RyaW5nXG4gID4oXG4gICAgZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+LFxuICAgIHBhcnRpdGlvbktleTogUGFydGl0aW9uS2V5LFxuICAgIHF1ZXJ5T3B0aW9ucz86IEVudGl0eU1hbmFnZXJDb3VudE9wdGlvbnM8RW50aXR5LCBQYXJ0aXRpb25LZXk+LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBnZXRVbmlxdWVSZXF1ZXN0SWQobWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQpO1xuXG4gICAgY29uc3QgZHluYW1vUXVlcnlJdGVtID0gdGhpcy5fZGNSZXFUcmFuc2Zvcm1lci50b0R5bmFtb1F1ZXJ5SXRlbTxcbiAgICAgIEVudGl0eSxcbiAgICAgIFBhcnRpdGlvbktleVxuICAgID4oXG4gICAgICBlbnRpdHlDbGFzcyxcbiAgICAgIHBhcnRpdGlvbktleSxcbiAgICAgIHsuLi5xdWVyeU9wdGlvbnMsIG9ubHlDb3VudDogdHJ1ZSwgc2VsZWN0OiB1bmRlZmluZWR9LCAvLyBzZWxlY3QgcHJvamVjdGlvbiBhbmQgY291bnQgY2FuIG5vdCBiZSB1c2VkIHRvZ2V0aGVyXG4gICAgICB7XG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgfVxuICAgICk7XG5cbiAgICBjb25zdCBjb3VudCA9IGF3YWl0IHRoaXMuX2ludGVybmFsUmVjdXJzaXZlQ291bnQoe1xuICAgICAgcXVlcnlJbnB1dDogZHluYW1vUXVlcnlJdGVtLFxuICAgICAgbWV0YWRhdGFPcHRpb25zOiB7XG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJldHVybiBjb3VudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWN1cnNpdmVseSBxdWVyaWVzIGFsbCBpdGVtcyBmcm9tIHRhYmxlXG4gICAqIEBwYXJhbSBwYXJhbSBRdWVyeSBwYXJhbXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgX2ludGVybmFsUmVjdXJzaXZlUXVlcnkoe1xuICAgIHF1ZXJ5SW5wdXQsXG4gICAgbGltaXQsXG4gICAgY3Vyc29yLFxuICAgIGl0ZW1zRmV0Y2hlZCA9IFtdLFxuICAgIG1ldGFkYXRhT3B0aW9ucyxcbiAgfToge1xuICAgIHF1ZXJ5SW5wdXQ6IGFueTtcbiAgICBsaW1pdDogbnVtYmVyO1xuICAgIGN1cnNvcj86IERvY3VtZW50Q2xpZW50VHlwZXMuS2V5O1xuICAgIGl0ZW1zRmV0Y2hlZD86IERvY3VtZW50Q2xpZW50VHlwZXMuSXRlbUxpc3Q7XG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zO1xuICB9KTogUHJvbWlzZTx7XG4gICAgaXRlbXM6IERvY3VtZW50Q2xpZW50VHlwZXMuSXRlbUxpc3Q7XG4gICAgY3Vyc29yPzogRG9jdW1lbnRDbGllbnRUeXBlcy5LZXk7XG4gIH0+IHtcbiAgICBjb25zdCB7XG4gICAgICBMYXN0RXZhbHVhdGVkS2V5LFxuICAgICAgSXRlbXMgPSBbXSxcbiAgICAgIENvbnN1bWVkQ2FwYWNpdHksXG4gICAgfSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5kb2N1bWVudENsaWVudC5xdWVyeSh7XG4gICAgICAuLi5xdWVyeUlucHV0LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGN1cnNvcixcbiAgICB9KTtcbiAgICAvLyBzdGF0c1xuICAgIGlmIChDb25zdW1lZENhcGFjaXR5KSB7XG4gICAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1N0YXRzKHtcbiAgICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5FTlRJVFlfTUFOQUdFUixcbiAgICAgICAgc3RhdHNUeXBlOiBTVEFUU19UWVBFLkNPTlNVTUVEX0NBUEFDSVRZLFxuICAgICAgICBjb25zdW1lZENhcGFjaXR5RGF0YTogQ29uc3VtZWRDYXBhY2l0eSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGl0ZW1zRmV0Y2hlZCA9IFsuLi5pdGVtc0ZldGNoZWQsIC4uLkl0ZW1zXTtcblxuICAgIGlmIChpdGVtc0ZldGNoZWQubGVuZ3RoIDwgbGltaXQgJiYgTGFzdEV2YWx1YXRlZEtleSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsUmVjdXJzaXZlUXVlcnkoe1xuICAgICAgICBxdWVyeUlucHV0LFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgY3Vyc29yOiBMYXN0RXZhbHVhdGVkS2V5LFxuICAgICAgICBpdGVtc0ZldGNoZWQsXG4gICAgICAgIG1ldGFkYXRhT3B0aW9ucyxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4ge2l0ZW1zOiBpdGVtc0ZldGNoZWQsIGN1cnNvcjogTGFzdEV2YWx1YXRlZEtleX07XG4gIH1cblxuICAvKipcbiAgICogUmVjdXJzaXZlbHkgY291bnRzIGFsbCBpdGVtcyBmcm9tIHRhYmxlXG4gICAqIEBwYXJhbSBwYXJhbSBRdWVyeSBwYXJhbXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgX2ludGVybmFsUmVjdXJzaXZlQ291bnQoe1xuICAgIHF1ZXJ5SW5wdXQsXG4gICAgY3Vyc29yLFxuICAgIGN1cnJlbnRDb3VudCA9IDAsXG4gICAgbWV0YWRhdGFPcHRpb25zLFxuICB9OiB7XG4gICAgcXVlcnlJbnB1dDogYW55O1xuICAgIGN1cnNvcj86IERvY3VtZW50Q2xpZW50VHlwZXMuS2V5O1xuICAgIGN1cnJlbnRDb3VudD86IG51bWJlcjtcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnM7XG4gIH0pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHtMYXN0RXZhbHVhdGVkS2V5LCBDb3VudCwgQ29uc3VtZWRDYXBhY2l0eX0gPVxuICAgICAgYXdhaXQgdGhpcy5jb25uZWN0aW9uLmRvY3VtZW50Q2xpZW50LnF1ZXJ5KHtcbiAgICAgICAgLi4ucXVlcnlJbnB1dCxcbiAgICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGN1cnNvcixcbiAgICAgIH0pO1xuICAgIC8vIHN0YXRzXG4gICAgaWYgKENvbnN1bWVkQ2FwYWNpdHkpIHtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nU3RhdHMoe1xuICAgICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgICBzY29wZTogTUFOQUdFUl9OQU1FLkVOVElUWV9NQU5BR0VSLFxuICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiBDb25zdW1lZENhcGFjaXR5LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY3VycmVudENvdW50ICs9IENvdW50IHx8IDA7XG5cbiAgICBpZiAoTGFzdEV2YWx1YXRlZEtleSkge1xuICAgICAgcmV0dXJuIHRoaXMuX2ludGVybmFsUmVjdXJzaXZlQ291bnQoe1xuICAgICAgICBxdWVyeUlucHV0LFxuICAgICAgICBjdXJzb3I6IExhc3RFdmFsdWF0ZWRLZXksXG4gICAgICAgIGN1cnJlbnRDb3VudCxcbiAgICAgICAgbWV0YWRhdGFPcHRpb25zLFxuICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBjdXJyZW50Q291bnQ7XG4gIH1cbn1cbiJdfQ==