import { DYNAMO_QUERY_ITEMS_IMPLICIT_LIMIT, DebugLogger, getEntityDefinition, NoSuchEntityExistsError, } from '@typedorm/common';
import { loadPackage } from '@typedorm/common';
import { DocumentClientV2, DocumentClientV3, } from '@typedorm/document-client';
import { isUsedForPrimaryKey } from '../../helpers/is-used-for-primary-key';
import { BatchManager } from '../manager/batch-manager';
import { EntityManager } from '../manager/entity-manager';
import { ScanManager } from '../manager/scan-manager';
import { TransactionManager } from '../manager/transaction-manager';
import { ConnectionMetadataBuilder } from './connection-metadata-builder';
export class Connection {
    options;
    destroySelf;
    name;
    table;
    entityManager;
    transactionManger;
    batchManager;
    scanManager;
    defaultConfig;
    documentClient;
    logger;
    _entityMetadatas;
    isConnected;
    constructor(options, destroySelf) {
        this.options = options;
        this.destroySelf = destroySelf;
        const { table, name = 'default' } = options;
        if (table) {
            this.table = table;
        }
        this.name = name;
        this.entityManager = new EntityManager(this);
        this.batchManager = new BatchManager(this);
        this.transactionManger = new TransactionManager(this);
        this.scanManager = new ScanManager(this);
        this.defaultConfig = {
            queryItemsImplicitLimit: options.dynamoQueryItemsImplicitLimit ??
                DYNAMO_QUERY_ITEMS_IMPLICIT_LIMIT,
        };
        this.documentClient = this.loadOrInitiateDocumentClient(options.documentClient);
        /**
         * This makes sure that we only ever build entity metadatas once per connection
         */
        this.isConnected = false;
        this.logger = new DebugLogger();
    }
    connect() {
        if (this.isConnected) {
            throw new Error('There is already an active connection, Connect should only be called once per application.');
        }
        try {
            this._entityMetadatas = new Map(this.buildMetadatas().map(entityMeta => [
                entityMeta.target.name,
                entityMeta,
            ]));
            this.isConnected = true;
            return this;
        }
        catch (err) {
            // Failed to connect to connection, clear self from connection manager
            this.destroySelf(this.name);
            throw err;
        }
    }
    get entityMetadatas() {
        return Array.from(this._entityMetadatas.values());
    }
    hasMetadata(entityClass) {
        return !!this.getEntityByTarget(entityClass);
    }
    getAttributesForEntity(entityClass) {
        const attributesMap = this._entityMetadatas.get(entityClass.name);
        if (!attributesMap) {
            throw new Error(`Cannot find attributes for entity "${entityClass.name}".`);
        }
        return attributesMap.attributes;
    }
    get globalTable() {
        return this.table;
    }
    /**
     * Returns any attributes marked as unique
     * If attribute used in a primary key is marked as unique, it is ignored, since all primary key are always unique
     * @param entityClass
     */
    getUniqueAttributesForEntity(entityClass) {
        const entityMetadata = this.getEntityByTarget(entityClass);
        return this.getAttributesForEntity(entityClass).filter(attr => {
            // only attributes that are not part of primary key should be included
            return (attr?.unique &&
                !isUsedForPrimaryKey(entityMetadata.schema.primaryKey, attr.name));
        });
    }
    /**
     * Returns a list of attribute names that are referenced in primary key
     * @param entityClass Entity to get primary key attributes for
     * @returns
     */
    getPrimaryKeyAttributeInterpolationsForEntity(entityClass) {
        const entityMetadata = this.getEntityByTarget(entityClass);
        return [
            ...new Set(Object.values(entityMetadata.schema.primaryKey.metadata._interpolations ?? {}).flat()),
        ];
    }
    getEntityByTarget(entityClass) {
        const metadata = this._entityMetadatas.get(entityClass.name);
        if (!metadata) {
            throw new Error(`No such entity named "${entityClass.name}" is known to TypeDORM, make sure it is declared at the connection creation time.`);
        }
        return metadata;
    }
    getEntityByPhysicalName(name) {
        const entitySpec = getEntityDefinition(name);
        if (!entitySpec) {
            throw new NoSuchEntityExistsError(name);
        }
        return this.getEntityByTarget(entitySpec.target);
    }
    getAutoUpdateAttributes(entityClass) {
        return this.getAttributesForEntity(entityClass).filter(attr => attr?.autoUpdate);
    }
    isUsedForPrimaryKey(primaryKey, attributeName) {
        const primaryKeyInterpolations = primaryKey.metadata._interpolations ?? {};
        return Object.keys(primaryKeyInterpolations).some(key => {
            const currInterpolation = primaryKeyInterpolations[key];
            return currInterpolation.includes(attributeName);
        });
    }
    buildMetadatas() {
        return new ConnectionMetadataBuilder(this).buildEntityMetadatas(this.options.entities);
    }
    loadOrInitiateDocumentClient(documentClient) {
        if (!documentClient) {
            const AWSModule = loadPackage('aws-sdk');
            return new DocumentClientV2(new AWSModule.DynamoDB.DocumentClient());
        }
        if (documentClient instanceof DocumentClientV2) {
            return documentClient;
        }
        else if (documentClient instanceof DocumentClientV3) {
            return documentClient;
        }
        else {
            return new DocumentClientV2(documentClient);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvc3JjL2NsYXNzZXMvY29ubmVjdGlvbi9jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxpQ0FBaUMsRUFJakMsV0FBVyxFQUNYLG1CQUFtQixFQUNuQix1QkFBdUIsR0FDeEIsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLEVBQUMsV0FBVyxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDN0MsT0FBTyxFQUVMLGdCQUFnQixFQUNoQixnQkFBZ0IsR0FDakIsTUFBTSwyQkFBMkIsQ0FBQztBQUNuQyxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSx1Q0FBdUMsQ0FBQztBQUMxRSxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDdEQsT0FBTyxFQUFDLGFBQWEsRUFBQyxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSx5QkFBeUIsQ0FBQztBQUNwRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQztBQU9sRSxPQUFPLEVBQUMseUJBQXlCLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUd4RSxNQUFNLE9BQU8sVUFBVTtJQWVYO0lBQ0E7SUFmRCxJQUFJLENBQVM7SUFDYixLQUFLLENBQVE7SUFDYixhQUFhLENBQWdCO0lBQzdCLGlCQUFpQixDQUFxQjtJQUN0QyxZQUFZLENBQWU7SUFDM0IsV0FBVyxDQUFjO0lBQ3pCLGFBQWEsQ0FBb0M7SUFDakQsY0FBYyxDQUFpQjtJQUMvQixNQUFNLENBQWM7SUFFckIsZ0JBQWdCLENBQThCO0lBQzlDLFdBQVcsQ0FBVTtJQUU3QixZQUNVLE9BQTBCLEVBQzFCLFdBQW1DO1FBRG5DLFlBQU8sR0FBUCxPQUFPLENBQW1CO1FBQzFCLGdCQUFXLEdBQVgs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Q0FBRSxJQUF1QyxFQUFFLFVBQVUsQ0FDekIsQ0FBQztJQUN4QyxDQUFDO0lBRUQsbUJBQW1CLENBQ2pCLFVBQXdDLEVBQ3hDLGFBQXFCO1FBRXJCLE1BQU0sd0JBQXdCLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxlQUFlLElBQUksRUFBRSxDQUFDO1FBQzNFLE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN0RCxNQUFNLGlCQUFpQixHQUFHLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3hELE9BQU8saUJBQWlCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGNBQWM7UUFDWixPQUFPLElBQUkseUJBQXlCLENBQUMsSUFBSSxDQUFDLENBQUMsb0JBQW9CLENBQzdELElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUN0QixDQUFDO0lBQ0osQ0FBQztJQUVELDRCQUE0QixDQUFDLGNBQXdCO1FBQ25ELElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDbkIsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ3pDLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQztTQUN0RTtRQUVELElBQUksY0FBYyxZQUFZLGdCQUFnQixFQUFFO1lBQzlDLE9BQU8sY0FBYyxDQUFDO1NBQ3ZCO2FBQU0sSUFBSSxjQUFjLFlBQVksZ0JBQWdCLEVBQUU7WUFDckQsT0FBTyxjQUFjLENBQUM7U0FDdkI7YUFBTTtZQUNMLE9BQU8sSUFBSSxnQkFBZ0IsQ0FBQyxjQUFxQixDQUFDLENBQUM7U0FDcEQ7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBEWU5BTU9fUVVFUllfSVRFTVNfSU1QTElDSVRfTElNSVQsXG4gIEVudGl0eVRhcmdldCxcbiAgUmVwbGFjZSxcbiAgVGFibGUsXG4gIERlYnVnTG9nZ2VyLFxuICBnZXRFbnRpdHlEZWZpbml0aW9uLFxuICBOb1N1Y2hFbnRpdHlFeGlzdHNFcnJvcixcbn0gZnJvbSAnQHR5cGVkb3JtL2NvbW1vbic7XG5pbXBvcnQge2xvYWRQYWNrYWdlfSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7XG4gIERvY3VtZW50Q2xpZW50LFxuICBEb2N1bWVudENsaWVudFYyLFxuICBEb2N1bWVudENsaWVudFYzLFxufSBmcm9tICdAdHlwZWRvcm0vZG9jdW1lbnQtY2xpZW50JztcbmltcG9ydCB7aXNVc2VkRm9yUHJpbWFyeUtleX0gZnJvbSAnLi4vLi4vaGVscGVycy9pcy11c2VkLWZvci1wcmltYXJ5LWtleSc7XG5pbXBvcnQge0JhdGNoTWFuYWdlcn0gZnJvbSAnLi4vbWFuYWdlci9iYXRjaC1tYW5hZ2VyJztcbmltcG9ydCB7RW50aXR5TWFuYWdlcn0gZnJvbSAnLi4vbWFuYWdlci9lbnRpdHktbWFuYWdlcic7XG5pbXBvcnQge1NjYW5NYW5hZ2VyfSBmcm9tICcuLi9tYW5hZ2VyL3NjYW4tbWFuYWdlcic7XG5pbXBvcnQge1RyYW5zYWN0aW9uTWFuYWdlcn0gZnJvbSAnLi4vbWFuYWdlci90cmFuc2FjdGlvbi1tYW5hZ2VyJztcbmltcG9ydCB7QXR0cmlidXRlTWV0YWRhdGF9IGZyb20gJy4uL21ldGFkYXRhL2F0dHJpYnV0ZS1tZXRhZGF0YSc7XG5pbXBvcnQge0F1dG9HZW5lcmF0ZWRBdHRyaWJ1dGVNZXRhZGF0YX0gZnJvbSAnLi4vbWV0YWRhdGEvYXV0by1nZW5lcmF0ZWQtYXR0cmlidXRlLW1ldGFkYXRhJztcbmltcG9ydCB7XG4gIEVudGl0eU1ldGFkYXRhLFxuICBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5LFxufSBmcm9tICcuLi9tZXRhZGF0YS9lbnRpdHktbWV0YWRhdGEnO1xuaW1wb3J0IHtDb25uZWN0aW9uTWV0YWRhdGFCdWlsZGVyfSBmcm9tICcuL2Nvbm5lY3Rpb24tbWV0YWRhdGEtYnVpbGRlcic7XG5pbXBvcnQge0Nvbm5lY3Rpb25PcHRpb25zfSBmcm9tICcuL2Nvbm5lY3Rpb24tb3B0aW9ucyc7XG5cbmV4cG9ydCBjbGFzcyBDb25uZWN0aW9uIHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSB0YWJsZTogVGFibGU7XG4gIHJlYWRvbmx5IGVudGl0eU1hbmFnZXI6IEVudGl0eU1hbmFnZXI7XG4gIHJlYWRvbmx5IHRyYW5zYWN0aW9uTWFuZ2VyOiBUcmFuc2FjdGlvbk1hbmFnZXI7XG4gIHJlYWRvbmx5IGJhdGNoTWFuYWdlcjogQmF0Y2hNYW5hZ2VyO1xuICByZWFkb25seSBzY2FuTWFuYWdlcjogU2Nhbk1hbmFnZXI7XG4gIHJlYWRvbmx5IGRlZmF1bHRDb25maWc6IHtxdWVyeUl0ZW1zSW1wbGljaXRMaW1pdDogbnVtYmVyfTtcbiAgcmVhZG9ubHkgZG9jdW1lbnRDbGllbnQ6IERvY3VtZW50Q2xpZW50O1xuICByZWFkb25seSBsb2dnZXI6IERlYnVnTG9nZ2VyO1xuXG4gIHByaXZhdGUgX2VudGl0eU1ldGFkYXRhczogTWFwPHN0cmluZywgRW50aXR5TWV0YWRhdGE+O1xuICBwcml2YXRlIGlzQ29ubmVjdGVkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgb3B0aW9uczogQ29ubmVjdGlvbk9wdGlvbnMsXG4gICAgcHJpdmF0ZSBkZXN0cm95U2VsZjogKG5hbWU6IHN0cmluZykgPT4gdm9pZFxuICApIHtcbiAgICBjb25zdCB7dGFibGUsIG5hbWUgPSAnZGVmYXVsdCd9ID0gb3B0aW9ucztcbiAgICBpZiAodGFibGUpIHtcbiAgICAgIHRoaXMudGFibGUgPSB0YWJsZTtcbiAgICB9XG4gICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB0aGlzLmVudGl0eU1hbmFnZXIgPSBuZXcgRW50aXR5TWFuYWdlcih0aGlzKTtcbiAgICB0aGlzLmJhdGNoTWFuYWdlciA9IG5ldyBCYXRjaE1hbmFnZXIodGhpcyk7XG4gICAgdGhpcy50cmFuc2FjdGlvbk1hbmdlciA9IG5ldyBUcmFuc2FjdGlvbk1hbmFnZXIodGhpcyk7XG4gICAgdGhpcy5zY2FuTWFuYWdlciA9IG5ldyBTY2FuTWFuYWdlcih0aGlzKTtcbiAgICB0aGlzLmRlZmF1bHRDb25maWcgPSB7XG4gICAgICBxdWVyeUl0ZW1zSW1wbGljaXRMaW1pdDpcbiAgICAgICAgb3B0aW9ucy5keW5hbW9RdWVyeUl0ZW1zSW1wbGljaXRMaW1pdCA/P1xuICAgICAgICBEWU5BTU9fUVVFUllfSVRFTVNfSU1QTElDSVRfTElNSVQsXG4gICAgfTtcblxuICAgIHRoaXMuZG9jdW1lbnRDbGllbnQgPSB0aGlzLmxvYWRPckluaXRpYXRlRG9jdW1lbnRDbGllbnQoXG4gICAgICBvcHRpb25zLmRvY3VtZW50Q2xpZW50XG4gICAgKTtcblxuICAgIC8qKlxuICAgICAqIFRoaXMgbWFrZXMgc3VyZSB0aGF0IHdlIG9ubHkgZXZlciBidWlsZCBlbnRpdHkgbWV0YWRhdGFzIG9uY2UgcGVyIGNvbm5lY3Rpb25cbiAgICAgKi9cbiAgICB0aGlzLmlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgdGhpcy5sb2dnZXIgPSBuZXcgRGVidWdMb2dnZXIoKTtcbiAgfVxuXG4gIGNvbm5lY3QoKSB7XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ1RoZXJlIGlzIGFscmVhZHkgYW4gYWN0aXZlIGNvbm5lY3Rpb24sIENvbm5lY3Qgc2hvdWxkIG9ubHkgYmUgY2FsbGVkIG9uY2UgcGVyIGFwcGxpY2F0aW9uLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuX2VudGl0eU1ldGFkYXRhcyA9IG5ldyBNYXAoXG4gICAgICAgIHRoaXMuYnVpbGRNZXRhZGF0YXMoKS5tYXAoZW50aXR5TWV0YSA9PiBbXG4gICAgICAgICAgZW50aXR5TWV0YS50YXJnZXQubmFtZSxcbiAgICAgICAgICBlbnRpdHlNZXRhLFxuICAgICAgICBdKVxuICAgICAgKTtcblxuICAgICAgdGhpcy5pc0Nvbm5lY3RlZCA9IHRydWU7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIEZhaWxlZCB0byBjb25uZWN0IHRvIGNvbm5lY3Rpb24sIGNsZWFyIHNlbGYgZnJvbSBjb25uZWN0aW9uIG1hbmFnZXJcbiAgICAgIHRoaXMuZGVzdHJveVNlbGYodGhpcy5uYW1lKTtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cblxuICBnZXQgZW50aXR5TWV0YWRhdGFzKCkge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuX2VudGl0eU1ldGFkYXRhcy52YWx1ZXMoKSk7XG4gIH1cblxuICBoYXNNZXRhZGF0YTxFbnRpdHk+KGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5Pikge1xuICAgIHJldHVybiAhIXRoaXMuZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuICB9XG5cbiAgZ2V0QXR0cmlidXRlc0ZvckVudGl0eTxFbnRpdHk+KGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5Pikge1xuICAgIGNvbnN0IGF0dHJpYnV0ZXNNYXAgPSB0aGlzLl9lbnRpdHlNZXRhZGF0YXMuZ2V0KGVudGl0eUNsYXNzLm5hbWUpO1xuICAgIGlmICghYXR0cmlidXRlc01hcCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgQ2Fubm90IGZpbmQgYXR0cmlidXRlcyBmb3IgZW50aXR5IFwiJHtlbnRpdHlDbGFzcy5uYW1lfVwiLmBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBhdHRyaWJ1dGVzTWFwLmF0dHJpYnV0ZXM7XG4gIH1cblxuICBnZXQgZ2xvYmFsVGFibGUoKSB7XG4gICAgcmV0dXJuIHRoaXMudGFibGU7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbnkgYXR0cmlidXRlcyBtYXJrZWQgYXMgdW5pcXVlXG4gICAqIElmIGF0dHJpYnV0ZSB1c2VkIGluIGEgcHJpbWFyeSBrZXkgaXMgbWFya2VkIGFzIHVuaXF1ZSwgaXQgaXMgaWdub3JlZCwgc2luY2UgYWxsIHByaW1hcnkga2V5IGFyZSBhbHdheXMgdW5pcXVlXG4gICAqIEBwYXJhbSBlbnRpdHlDbGFzc1xuICAgKi9cbiAgZ2V0VW5pcXVlQXR0cmlidXRlc0ZvckVudGl0eTxFbnRpdHk+KGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5Pikge1xuICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhID0gdGhpcy5nZXRFbnRpdHlCeVRhcmdldChlbnRpdHlDbGFzcyk7XG5cbiAgICByZXR1cm4gdGhpcy5nZXRBdHRyaWJ1dGVzRm9yRW50aXR5PEVudGl0eT4oZW50aXR5Q2xhc3MpLmZpbHRlcihhdHRyID0+IHtcbiAgICAgIC8vIG9ubHkgYXR0cmlidXRlcyB0aGF0IGFyZSBub3QgcGFydCBvZiBwcmltYXJ5IGtleSBzaG91bGQgYmUgaW5jbHVkZWRcbiAgICAgIHJldHVybiAoXG4gICAgICAgIChhdHRyIGFzIEF0dHJpYnV0ZU1ldGFkYXRhKT8udW5pcXVlICYmXG4gICAgICAgICFpc1VzZWRGb3JQcmltYXJ5S2V5KGVudGl0eU1ldGFkYXRhLnNjaGVtYS5wcmltYXJ5S2V5LCBhdHRyLm5hbWUpXG4gICAgICApO1xuICAgIH0pIGFzIFJlcGxhY2U8XG4gICAgICBBdHRyaWJ1dGVNZXRhZGF0YSxcbiAgICAgICd1bmlxdWUnLFxuICAgICAge3VuaXF1ZTogRHluYW1vRW50aXR5U2NoZW1hUHJpbWFyeUtleX1cbiAgICA+W107XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIGxpc3Qgb2YgYXR0cmlidXRlIG5hbWVzIHRoYXQgYXJlIHJlZmVyZW5jZWQgaW4gcHJpbWFyeSBrZXlcbiAgICogQHBhcmFtIGVudGl0eUNsYXNzIEVudGl0eSB0byBnZXQgcHJpbWFyeSBrZXkgYXR0cmlidXRlcyBmb3JcbiAgICogQHJldHVybnNcbiAgICovXG4gIGdldFByaW1hcnlLZXlBdHRyaWJ1dGVJbnRlcnBvbGF0aW9uc0ZvckVudGl0eTxFbnRpdHk+KFxuICAgIGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5PlxuICApIHtcbiAgICBjb25zdCBlbnRpdHlNZXRhZGF0YSA9IHRoaXMuZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuICAgIHJldHVybiBbXG4gICAgICAuLi5uZXcgU2V0KFxuICAgICAgICBPYmplY3QudmFsdWVzKFxuICAgICAgICAgIGVudGl0eU1ldGFkYXRhLnNjaGVtYS5wcmltYXJ5S2V5Lm1ldGFkYXRhLl9pbnRlcnBvbGF0aW9ucyA/PyB7fVxuICAgICAgICApLmZsYXQoKVxuICAgICAgKSxcbiAgICBdO1xuICB9XG5cbiAgZ2V0RW50aXR5QnlUYXJnZXQ8RW50aXR5PihlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4pIHtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuX2VudGl0eU1ldGFkYXRhcy5nZXQoZW50aXR5Q2xhc3MubmFtZSk7XG4gICAgaWYgKCFtZXRhZGF0YSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgTm8gc3VjaCBlbnRpdHkgbmFtZWQgXCIke2VudGl0eUNsYXNzLm5hbWV9XCIgaXMga25vd24gdG8gVHlwZURPUk0sIG1ha2Ugc3VyZSBpdCBpcyBkZWNsYXJlZCBhdCB0aGUgY29ubmVjdGlvbiBjcmVhdGlvbiB0aW1lLmBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBtZXRhZGF0YTtcbiAgfVxuXG4gIGdldEVudGl0eUJ5UGh5c2ljYWxOYW1lKG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGVudGl0eVNwZWMgPSBnZXRFbnRpdHlEZWZpbml0aW9uKG5hbWUpO1xuXG4gICAgaWYgKCFlbnRpdHlTcGVjKSB7XG4gICAgICB0aHJvdyBuZXcgTm9TdWNoRW50aXR5RXhpc3RzRXJyb3IobmFtZSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldEVudGl0eUJ5VGFyZ2V0KGVudGl0eVNwZWMudGFyZ2V0KTtcbiAgfVxuXG4gIGdldEF1dG9VcGRhdGVBdHRyaWJ1dGVzPEVudGl0eT4oZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+KSB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QXR0cmlidXRlc0ZvckVudGl0eShlbnRpdHlDbGFzcykuZmlsdGVyKFxuICAgICAgYXR0ciA9PiAoYXR0ciBhcyBBdXRvR2VuZXJhdGVkQXR0cmlidXRlTWV0YWRhdGEpPy5hdXRvVXBkYXRlXG4gICAgKSBhcyBBdXRvR2VuZXJhdGVkQXR0cmlidXRlTWV0YWRhdGFbXTtcbiAgfVxuXG4gIGlzVXNlZEZvclByaW1hcnlLZXkoXG4gICAgcHJpbWFyeUtleTogRHluYW1vRW50aXR5U2NoZW1hUHJpbWFyeUtleSxcbiAgICBhdHRyaWJ1dGVOYW1lOiBzdHJpbmdcbiAgKSB7XG4gICAgY29uc3QgcHJpbWFyeUtleUludGVycG9sYXRpb25zID0gcHJpbWFyeUtleS5tZXRhZGF0YS5faW50ZXJwb2xhdGlvbnMgPz8ge307XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKHByaW1hcnlLZXlJbnRlcnBvbGF0aW9ucykuc29tZShrZXkgPT4ge1xuICAgICAgY29uc3QgY3VyckludGVycG9sYXRpb24gPSBwcmltYXJ5S2V5SW50ZXJwb2xhdGlvbnNba2V5XTtcbiAgICAgIHJldHVybiBjdXJySW50ZXJwb2xhdGlvbi5pbmNsdWRlcyhhdHRyaWJ1dGVOYW1lKTtcbiAgICB9KTtcbiAgfVxuXG4gIGJ1aWxkTWV0YWRhdGFzKCkge1xuICAgIHJldHVybiBuZXcgQ29ubmVjdGlvbk1ldGFkYXRhQnVpbGRlcih0aGlzKS5idWlsZEVudGl0eU1ldGFkYXRhcyhcbiAgICAgIHRoaXMub3B0aW9ucy5lbnRpdGllc1xuICAgICk7XG4gIH1cblxuICBsb2FkT3JJbml0aWF0ZURvY3VtZW50Q2xpZW50KGRvY3VtZW50Q2xpZW50PzogdW5rbm93bikge1xuICAgIGlmICghZG9jdW1lbnRDbGllbnQpIHtcbiAgICAgIGNvbnN0IEFXU01vZHVsZSA9IGxvYWRQYWNrYWdlKCdhd3Mtc2RrJyk7XG4gICAgICByZXR1cm4gbmV3IERvY3VtZW50Q2xpZW50VjIobmV3IEFXU01vZHVsZS5EeW5hbW9EQi5Eb2N1bWVudENsaWVudCgpKTtcbiAgICB9XG5cbiAgICBpZiAoZG9jdW1lbnRDbGllbnQgaW5zdGFuY2VvZiBEb2N1bWVudENsaWVudFYyKSB7XG4gICAgICByZXR1cm4gZG9jdW1lbnRDbGllbnQ7XG4gICAgfSBlbHNlIGlmIChkb2N1bWVudENsaWVudCBpbnN0YW5jZW9mIERvY3VtZW50Q2xpZW50VjMpIHtcbiAgICAgIHJldHVybiBkb2N1bWVudENsaWVudDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBEb2N1bWVudENsaWVudFYyKGRvY3VtZW50Q2xpZW50IGFzIGFueSk7XG4gICAgfVxuICB9XG59XG4iXX0=