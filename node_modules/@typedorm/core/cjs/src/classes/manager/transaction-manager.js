"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TransactionManager = void 0;
const document_client_transaction_transformer_1 = require("../transformer/document-client-transaction-transformer");
const common_1 = require("@typedorm/common");
const get_unique_request_id_1 = require("../../helpers/get-unique-request-id");
class TransactionManager {
    constructor(connection) {
        this.connection = connection;
        this._dcTransactionTransformer = new document_client_transaction_transformer_1.DocumentClientTransactionTransformer(connection);
    }
    /**
     * Processes transactions over document client's transaction api
     * @param transaction Write transaction to process
     */
    write(transaction, metadataOptions) {
        return __awaiter(this, void 0, void 0, function* () {
            const requestId = (0, get_unique_request_id_1.getUniqueRequestId)(metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId);
            const { transactionItemList, lazyTransactionWriteItemListLoader } = this._dcTransactionTransformer.toDynamoWriteTransactionItems(transaction, {
                requestId,
            });
            this.connection.logger.logInfo({
                requestId,
                scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                log: `Requested to write transaction for total ${transaction.items.length} items.`,
            });
            const lazyTransactionItems = (yield Promise.all(lazyTransactionWriteItemListLoader.map((item) => __awaiter(this, void 0, void 0, function* () {
                // if updating/removing unique attribute in transaction, get previous value of attributes
                const existingItem = yield this.connection.entityManager.findOne(item.entityClass, item.primaryKeyAttributes, undefined, {
                    requestId,
                    returnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
                });
                return item.lazyLoadTransactionWriteItems(existingItem);
            })))).flat();
            const itemsToWriteInTransaction = [
                ...transactionItemList,
                ...lazyTransactionItems,
            ];
            if (itemsToWriteInTransaction.length > common_1.TRANSACTION_WRITE_ITEMS_LIMIT) {
                throw new common_1.WriteTransactionItemLimitExceededError(transaction.items.length, itemsToWriteInTransaction.length);
            }
            if (itemsToWriteInTransaction.length > transaction.items.length) {
                this.connection.logger.logInfo({
                    requestId,
                    scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                    log: `Original items count ${transaction.items.length} expanded 
        to ${itemsToWriteInTransaction.length} to accommodate unique attributes.`,
                });
            }
            return this.writeRaw(itemsToWriteInTransaction, {
                requestId,
                returnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
            });
        });
    }
    /**
     * Processes transactions over document client's transaction api
     * @param transaction read transaction to process
     */
    read(transaction, metadataOptions) {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const requestId = (0, get_unique_request_id_1.getUniqueRequestId)(metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId);
            const { transactionItemList } = this._dcTransactionTransformer.toDynamoReadTransactionItems(transaction, {
                requestId,
            });
            if (transactionItemList.length > common_1.TRANSACTION_READ_ITEMS_LIMIT) {
                throw new common_1.ReadTransactionItemLimitExceededError(transactionItemList.length);
            }
            this.connection.logger.logInfo({
                requestId,
                scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                log: `Running a transaction read ${transactionItemList.length} items..`,
            });
            const transactionInput = {
                TransactItems: transactionItemList,
                ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
            };
            const response = yield this.connection.documentClient.transactGet(transactionInput);
            // log stats
            if (response === null || response === void 0 ? void 0 : response.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId,
                    scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                    statsType: common_1.STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            // Items are always returned in the same as they were requested.
            // An ordered array of up to 25 ItemResponse objects, each of which corresponds to the
            // TransactGetItem object in the same position in the TransactItems array
            return (_a = response.Responses) === null || _a === void 0 ? void 0 : _a.map((response, index) => {
                if (!response.Item) {
                    // If a requested item could not be retrieved, the corresponding ItemResponse object is Null,
                    return null;
                }
                const originalRequest = transaction.items[index];
                return this._dcTransactionTransformer.fromDynamoEntity(originalRequest.get.item, response.Item, {
                    requestId,
                });
            });
        });
    }
    /**
     * Perhaps, you are looking for ".write" instead.
     *
     * Writes items to dynamodb over document client's transact write API without performing any pre transforming
     * You would almost never need to use this.
     */
    writeRaw(transactItems, metadataOptions) {
        return __awaiter(this, void 0, void 0, function* () {
            const transactionInput = {
                TransactItems: transactItems,
                ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
            };
            this.connection.logger.logInfo({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                log: `Running a transaction write request for ${transactItems.length} items.`,
            });
            const response = yield this.connection.documentClient.transactWrite(transactionInput);
            // log stats
            if (response === null || response === void 0 ? void 0 : response.ConsumedCapacity) {
                this.connection.logger.logStats({
                    requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                    scope: common_1.MANAGER_NAME.TRANSACTION_MANAGER,
                    statsType: common_1.STATS_TYPE.CONSUMED_CAPACITY,
                    consumedCapacityData: response.ConsumedCapacity,
                });
            }
            // return success when successfully processed all items in a transaction
            return { success: true };
        });
    }
}
exports.TransactionManager = TransactionManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24tbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvc3JjL2NsYXNzZXMvbWFuYWdlci90cmFuc2FjdGlvbi1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUdBLG9IQUE0RztBQUM1Ryw2Q0FPMEI7QUFHMUIsK0VBQXVFO0FBRXZFLE1BQWEsa0JBQWtCO0lBRzdCLFlBQW9CLFVBQXNCO1FBQXRCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDeEMsSUFBSSxDQUFDLHlCQUF5QixHQUFHLElBQUksOEVBQW9DLENBQ3ZFLFVBQVUsQ0FDWCxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7T0FHRztJQUNHLEtBQUssQ0FDVCxXQUE2QixFQUM3QixlQUFpQzs7WUFFakMsTUFBTSxTQUFTLEdBQUcsSUFBQSwwQ0FBa0IsRUFBQyxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUyxDQUFDLENBQUM7WUFDakUsTUFBTSxFQUFDLG1CQUFtQixFQUFFLGtDQUFrQyxFQUFDLEdBQzdELElBQUksQ0FBQyx5QkFBeUIsQ0FBQyw2QkFBNkIsQ0FDMUQsV0FBVyxFQUNYO2dCQUNFLFNBQVM7YUFDVixDQUNGLENBQUM7WUFFSixJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7Z0JBQzdCLFNBQVM7Z0JBQ1QsS0FBSyxFQUFFLHFCQUFZLENBQUMsbUJBQW1CO2dCQUN2QyxHQUFHLEVBQUUsNENBQTRDLFdBQVcsQ0FBQyxLQUFLLENBQUMsTUFBTSxTQUFTO2FBQ25GLENBQUMsQ0FBQztZQUVILE1BQU0sb0JBQW9CLEdBQUcsQ0FDM0IsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUNmLGtDQUFrQyxDQUFDLEdBQUcsQ0FBQyxDQUFPLElBQVMsRUFBRSxFQUFFO2dCQUN6RCx5RkFBeUY7Z0JBQ3pGLE1BQU0sWUFBWSxH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QVEsYUFBUixRQUFRLHVCQUFSLFFBQVEsQ0FBRSxnQkFBZ0IsRUFBRTtnQkFDOUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDO29CQUM5QixTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7b0JBQ3JDLEtBQUssRUFBRSxxQkFBWSxDQUFDLG1CQUFtQjtvQkFDdkMsU0FBUyxFQUFFLG1CQUFVLENBQUMsaUJBQWlCO29CQUN2QyxvQkFBb0IsRUFBRSxRQUFRLENBQUMsZ0JBQWdCO2lCQUNoRCxDQUFDLENBQUM7YUFDSjtZQUVELHdFQUF3RTtZQUN4RSxPQUFPLEVBQUMsT0FBTyxFQUFFLElBQUksRUFBQyxDQUFDO1FBQ3pCLENBQUM7S0FBQTtDQUNGO0FBckxELGdEQXFMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RG9jdW1lbnRDbGllbnRUeXBlc30gZnJvbSAnQHR5cGVkb3JtL2RvY3VtZW50LWNsaWVudCc7XG5pbXBvcnQge1dyaXRlVHJhbnNhY3Rpb259IGZyb20gJy4vLi4vdHJhbnNhY3Rpb24vd3JpdGUtdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHtDb25uZWN0aW9ufSBmcm9tICcuLi9jb25uZWN0aW9uL2Nvbm5lY3Rpb24nO1xuaW1wb3J0IHtEb2N1bWVudENsaWVudFRyYW5zYWN0aW9uVHJhbnNmb3JtZXJ9IGZyb20gJy4uL3RyYW5zZm9ybWVyL2RvY3VtZW50LWNsaWVudC10cmFuc2FjdGlvbi10cmFuc2Zvcm1lcic7XG5pbXBvcnQge1xuICBNQU5BR0VSX05BTUUsXG4gIFJlYWRUcmFuc2FjdGlvbkl0ZW1MaW1pdEV4Y2VlZGVkRXJyb3IsXG4gIFNUQVRTX1RZUEUsXG4gIFRSQU5TQUNUSU9OX1JFQURfSVRFTVNfTElNSVQsXG4gIFRSQU5TQUNUSU9OX1dSSVRFX0lURU1TX0xJTUlULFxuICBXcml0ZVRyYW5zYWN0aW9uSXRlbUxpbWl0RXhjZWVkZWRFcnJvcixcbn0gZnJvbSAnQHR5cGVkb3JtL2NvbW1vbic7XG5pbXBvcnQge1JlYWRUcmFuc2FjdGlvbn0gZnJvbSAnLi4vdHJhbnNhY3Rpb24vcmVhZC10cmFuc2FjdGlvbic7XG5pbXBvcnQge01ldGFkYXRhT3B0aW9uc30gZnJvbSAnLi4vdHJhbnNmb3JtZXIvYmFzZS10cmFuc2Zvcm1lcic7XG5pbXBvcnQge2dldFVuaXF1ZVJlcXVlc3RJZH0gZnJvbSAnLi4vLi4vaGVscGVycy9nZXQtdW5pcXVlLXJlcXVlc3QtaWQnO1xuXG5leHBvcnQgY2xhc3MgVHJhbnNhY3Rpb25NYW5hZ2VyIHtcbiAgcHJpdmF0ZSBfZGNUcmFuc2FjdGlvblRyYW5zZm9ybWVyOiBEb2N1bWVudENsaWVudFRyYW5zYWN0aW9uVHJhbnNmb3JtZXI7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjb25uZWN0aW9uOiBDb25uZWN0aW9uKSB7XG4gICAgdGhpcy5fZGNUcmFuc2FjdGlvblRyYW5zZm9ybWVyID0gbmV3IERvY3VtZW50Q2xpZW50VHJhbnNhY3Rpb25UcmFuc2Zvcm1lcihcbiAgICAgIGNvbm5lY3Rpb25cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFByb2Nlc3NlcyB0cmFuc2FjdGlvbnMgb3ZlciBkb2N1bWVudCBjbGllbnQncyB0cmFuc2FjdGlvbiBhcGlcbiAgICogQHBhcmFtIHRyYW5zYWN0aW9uIFdyaXRlIHRyYW5zYWN0aW9uIHRvIHByb2Nlc3NcbiAgICovXG4gIGFzeW5jIHdyaXRlKFxuICAgIHRyYW5zYWN0aW9uOiBXcml0ZVRyYW5zYWN0aW9uLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCByZXF1ZXN0SWQgPSBnZXRVbmlxdWVSZXF1ZXN0SWQobWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQpO1xuICAgIGNvbnN0IHt0cmFuc2FjdGlvbkl0ZW1MaXN0LCBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyfSA9XG4gICAgICB0aGlzLl9kY1RyYW5zYWN0aW9uVHJhbnNmb3JtZXIudG9EeW5hbW9Xcml0ZVRyYW5zYWN0aW9uSXRlbXMoXG4gICAgICAgIHRyYW5zYWN0aW9uLFxuICAgICAgICB7XG4gICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dJbmZvKHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuVFJBTlNBQ1RJT05fTUFOQUdFUixcbiAgICAgIGxvZzogYFJlcXVlc3RlZCB0byB3cml0ZSB0cmFuc2FjdGlvbiBmb3IgdG90YWwgJHt0cmFuc2FjdGlvbi5pdGVtcy5sZW5ndGh9IGl0ZW1zLmAsXG4gICAgfSk7XG5cbiAgICBjb25zdCBsYXp5VHJhbnNhY3Rpb25JdGVtcyA9IChcbiAgICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgICBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyLm1hcChhc3luYyAoaXRlbTogYW55KSA9PiB7XG4gICAgICAgICAgLy8gaWYgdXBkYXRpbmcvcmVtb3ZpbmcgdW5pcXVlIGF0dHJpYnV0ZSBpbiB0cmFuc2FjdGlvbiwgZ2V0IHByZXZpb3VzIHZhbHVlIG9mIGF0dHJpYnV0ZXNcbiAgICAgICAgICBjb25zdCBleGlzdGluZ0l0ZW0gPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uZW50aXR5TWFuYWdlci5maW5kT25lKFxuICAgICAgICAgICAgaXRlbS5lbnRpdHlDbGFzcyxcbiAgICAgICAgICAgIGl0ZW0ucHJpbWFyeUtleUF0dHJpYnV0ZXMsXG4gICAgICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgcmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICByZXR1cm4gaXRlbS5sYXp5TG9hZFRyYW5zYWN0aW9uV3JpdGVJdGVtcyhleGlzdGluZ0l0ZW0pO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICkuZmxhdCgpO1xuXG4gICAgY29uc3QgaXRlbXNUb1dyaXRlSW5UcmFuc2FjdGlvbiA9IFtcbiAgICAgIC4uLnRyYW5zYWN0aW9uSXRlbUxpc3QsXG4gICAgICAuLi5sYXp5VHJhbnNhY3Rpb25JdGVtcyxcbiAgICBdO1xuXG4gICAgaWYgKGl0ZW1zVG9Xcml0ZUluVHJhbnNhY3Rpb24ubGVuZ3RoID4gVFJBTlNBQ1RJT05fV1JJVEVfSVRFTVNfTElNSVQpIHtcbiAgICAgIHRocm93IG5ldyBXcml0ZVRyYW5zYWN0aW9uSXRlbUxpbWl0RXhjZWVkZWRFcnJvcihcbiAgICAgICAgdHJhbnNhY3Rpb24uaXRlbXMubGVuZ3RoLFxuICAgICAgICBpdGVtc1RvV3JpdGVJblRyYW5zYWN0aW9uLmxlbmd0aFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAoaXRlbXNUb1dyaXRlSW5UcmFuc2FjdGlvbi5sZW5ndGggPiB0cmFuc2FjdGlvbi5pdGVtcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nSW5mbyh7XG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgICBsb2c6IGBPcmlnaW5hbCBpdGVtcyBjb3VudCAke3RyYW5zYWN0aW9uLml0ZW1zLmxlbmd0aH0gZXhwYW5kZWQgXG4gICAgICAgIHRvICR7aXRlbXNUb1dyaXRlSW5UcmFuc2FjdGlvbi5sZW5ndGh9IHRvIGFjY29tbW9kYXRlIHVuaXF1ZSBhdHRyaWJ1dGVzLmAsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy53cml0ZVJhdyhpdGVtc1RvV3JpdGVJblRyYW5zYWN0aW9uLCB7XG4gICAgICByZXF1ZXN0SWQsXG4gICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUHJvY2Vzc2VzIHRyYW5zYWN0aW9ucyBvdmVyIGRvY3VtZW50IGNsaWVudCdzIHRyYW5zYWN0aW9uIGFwaVxuICAgKiBAcGFyYW0gdHJhbnNhY3Rpb24gcmVhZCB0cmFuc2FjdGlvbiB0byBwcm9jZXNzXG4gICAqL1xuICBhc3luYyByZWFkKHRyYW5zYWN0aW9uOiBSZWFkVHJhbnNhY3Rpb24sIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9ucykge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGdldFVuaXF1ZVJlcXVlc3RJZChtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCk7XG5cbiAgICBjb25zdCB7dHJhbnNhY3Rpb25JdGVtTGlzdH0gPVxuICAgICAgdGhpcy5fZGNUcmFuc2FjdGlvblRyYW5zZm9ybWVyLnRvRHluYW1vUmVhZFRyYW5zYWN0aW9uSXRlbXModHJhbnNhY3Rpb24sIHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgfSk7XG5cbiAgICBpZiAodHJhbnNhY3Rpb25JdGVtTGlzdC5sZW5ndGggPiBUUkFOU0FDVElPTl9SRUFEX0lURU1TX0xJTUlUKSB7XG4gICAgICB0aHJvdyBuZXcgUmVhZFRyYW5zYWN0aW9uSXRlbUxpbWl0RXhjZWVkZWRFcnJvcihcbiAgICAgICAgdHJhbnNhY3Rpb25JdGVtTGlzdC5sZW5ndGhcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dJbmZvKHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuVFJBTlNBQ1RJT05fTUFOQUdFUixcbiAgICAgIGxvZzogYFJ1bm5pbmcgYSB0cmFuc2FjdGlvbiByZWFkICR7dHJhbnNhY3Rpb25JdGVtTGlzdC5sZW5ndGh9IGl0ZW1zLi5gLFxuICAgIH0pO1xuXG4gICAgY29uc3QgdHJhbnNhY3Rpb25JbnB1dDogRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdEdldEl0ZW1JbnB1dCA9IHtcbiAgICAgIFRyYW5zYWN0SXRlbXM6IHRyYW5zYWN0aW9uSXRlbUxpc3QsXG4gICAgICBSZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jb25uZWN0aW9uLmRvY3VtZW50Q2xpZW50LnRyYW5zYWN0R2V0KFxuICAgICAgdHJhbnNhY3Rpb25JbnB1dFxuICAgICk7XG5cbiAgICAvLyBsb2cgc3RhdHNcbiAgICBpZiAocmVzcG9uc2U/LkNvbnN1bWVkQ2FwYWNpdHkpIHtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nU3RhdHMoe1xuICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuVFJBTlNBQ1RJT05fTUFOQUdFUixcbiAgICAgICAgc3RhdHNUeXBlOiBTVEFUU19UWVBFLkNPTlNVTUVEX0NBUEFDSVRZLFxuICAgICAgICBjb25zdW1lZENhcGFjaXR5RGF0YTogcmVzcG9uc2UuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIEl0ZW1zIGFyZSBhbHdheXMgcmV0dXJuZWQgaW4gdGhlIHNhbWUgYXMgdGhleSB3ZXJlIHJlcXVlc3RlZC5cbiAgICAvLyBBbiBvcmRlcmVkIGFycmF5IG9mIHVwIHRvIDI1IEl0ZW1SZXNwb25zZSBvYmplY3RzLCBlYWNoIG9mIHdoaWNoIGNvcnJlc3BvbmRzIHRvIHRoZVxuICAgIC8vIFRyYW5zYWN0R2V0SXRlbSBvYmplY3QgaW4gdGhlIHNhbWUgcG9zaXRpb24gaW4gdGhlIFRyYW5zYWN0SXRlbXMgYXJyYXlcbiAgICByZXR1cm4gKHJlc3BvbnNlLlJlc3BvbnNlcyBhcyBEb2N1bWVudENsaWVudFR5cGVzLkl0ZW1SZXNwb25zZUxpc3QpPy5tYXAoXG4gICAgICAocmVzcG9uc2UsIGluZGV4KSA9PiB7XG4gICAgICAgIGlmICghcmVzcG9uc2UuSXRlbSkge1xuICAgICAgICAgIC8vIElmIGEgcmVxdWVzdGVkIGl0ZW0gY291bGQgbm90IGJlIHJldHJpZXZlZCwgdGhlIGNvcnJlc3BvbmRpbmcgSXRlbVJlc3BvbnNlIG9iamVjdCBpcyBOdWxsLFxuICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gdHJhbnNhY3Rpb24uaXRlbXNbaW5kZXhdO1xuICAgICAgICByZXR1cm4gdGhpcy5fZGNUcmFuc2FjdGlvblRyYW5zZm9ybWVyLmZyb21EeW5hbW9FbnRpdHkoXG4gICAgICAgICAgb3JpZ2luYWxSZXF1ZXN0LmdldC5pdGVtLFxuICAgICAgICAgIHJlc3BvbnNlLkl0ZW0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmhhcHMsIHlvdSBhcmUgbG9va2luZyBmb3IgXCIud3JpdGVcIiBpbnN0ZWFkLlxuICAgKlxuICAgKiBXcml0ZXMgaXRlbXMgdG8gZHluYW1vZGIgb3ZlciBkb2N1bWVudCBjbGllbnQncyB0cmFuc2FjdCB3cml0ZSBBUEkgd2l0aG91dCBwZXJmb3JtaW5nIGFueSBwcmUgdHJhbnNmb3JtaW5nXG4gICAqIFlvdSB3b3VsZCBhbG1vc3QgbmV2ZXIgbmVlZCB0byB1c2UgdGhpcy5cbiAgICovXG4gIGFzeW5jIHdyaXRlUmF3KFxuICAgIHRyYW5zYWN0SXRlbXM6IERvY3VtZW50Q2xpZW50VHlwZXMuVHJhbnNhY3RXcml0ZUl0ZW1bXSxcbiAgICBtZXRhZGF0YU9wdGlvbnM6IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCB0cmFuc2FjdGlvbklucHV0OiBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtSW5wdXQgPSB7XG4gICAgICBUcmFuc2FjdEl0ZW1zOiB0cmFuc2FjdEl0ZW1zLFxuICAgICAgUmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgIH07XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ0luZm8oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIHNjb3BlOiBNQU5BR0VSX05BTUUuVFJBTlNBQ1RJT05fTUFOQUdFUixcbiAgICAgIGxvZzogYFJ1bm5pbmcgYSB0cmFuc2FjdGlvbiB3cml0ZSByZXF1ZXN0IGZvciAke3RyYW5zYWN0SXRlbXMubGVuZ3RofSBpdGVtcy5gLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uZG9jdW1lbnRDbGllbnQudHJhbnNhY3RXcml0ZShcbiAgICAgIHRyYW5zYWN0aW9uSW5wdXRcbiAgICApO1xuXG4gICAgLy8gbG9nIHN0YXRzXG4gICAgaWYgKHJlc3BvbnNlPy5Db25zdW1lZENhcGFjaXR5KSB7XG4gICAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1N0YXRzKHtcbiAgICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiByZXNwb25zZS5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gcmV0dXJuIHN1Y2Nlc3Mgd2hlbiBzdWNjZXNzZnVsbHkgcHJvY2Vzc2VkIGFsbCBpdGVtcyBpbiBhIHRyYW5zYWN0aW9uXG4gICAgcmV0dXJuIHtzdWNjZXNzOiB0cnVlfTtcbiAgfVxufVxuIl19