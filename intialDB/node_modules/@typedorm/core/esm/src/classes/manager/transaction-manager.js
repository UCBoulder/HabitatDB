import { DocumentClientTransactionTransformer } from '../transformer/document-client-transaction-transformer';
import { MANAGER_NAME, ReadTransactionItemLimitExceededError, STATS_TYPE, TRANSACTION_READ_ITEMS_LIMIT, TRANSACTION_WRITE_ITEMS_LIMIT, WriteTransactionItemLimitExceededError, } from '@typedorm/common';
import { getUniqueRequestId } from '../../helpers/get-unique-request-id';
export class TransactionManager {
    connection;
    _dcTransactionTransformer;
    constructor(connection) {
        this.connection = connection;
        this._dcTransactionTransformer = new DocumentClientTransactionTransformer(connection);
    }
    /**
     * Processes transactions over document client's transaction api
     * @param transaction Write transaction to process
     */
    async write(transaction, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const { transactionItemList, lazyTransactionWriteItemListLoader } = this._dcTransactionTransformer.toDynamoWriteTransactionItems(transaction, {
            requestId,
        });
        this.connection.logger.logInfo({
            requestId,
            scope: MANAGER_NAME.TRANSACTION_MANAGER,
            log: `Requested to write transaction for total ${transaction.items.length} items.`,
        });
        const lazyTransactionItems = (await Promise.all(lazyTransactionWriteItemListLoader.map(async (item) => {
            // if updating/removing unique attribute in transaction, get previous value of attributes
            const existingItem = await this.connection.entityManager.findOne(item.entityClass, item.primaryKeyAttributes, undefined, {
                requestId,
                returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
            });
            return item.lazyLoadTransactionWriteItems(existingItem);
        }))).flat();
        const itemsToWriteInTransaction = [
            ...transactionItemList,
            ...lazyTransactionItems,
        ];
        if (itemsToWriteInTransaction.length > TRANSACTION_WRITE_ITEMS_LIMIT) {
            throw new WriteTransactionItemLimitExceededError(transaction.items.length, itemsToWriteInTransaction.length);
        }
        if (itemsToWriteInTransaction.length > transaction.items.length) {
            this.connection.logger.logInfo({
                requestId,
                scope: MANAGER_NAME.TRANSACTION_MANAGER,
                log: `Original items count ${transaction.items.length} expanded 
        to ${itemsToWriteInTransaction.length} to accommodate unique attributes.`,
            });
        }
        return this.writeRaw(itemsToWriteInTransaction, {
            requestId,
            returnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        });
    }
    /**
     * Processes transactions over document client's transaction api
     * @param transaction read transaction to process
     */
    async read(transaction, metadataOptions) {
        const requestId = getUniqueRequestId(metadataOptions?.requestId);
        const { transactionItemList } = this._dcTransactionTransformer.toDynamoReadTransactionItems(transaction, {
            requestId,
        });
        if (transactionItemList.length > TRANSACTION_READ_ITEMS_LIMIT) {
            throw new ReadTransactionItemLimitExceededError(transactionItemList.length);
        }
        this.connection.logger.logInfo({
            requestId,
            scope: MANAGER_NAME.TRANSACTION_MANAGER,
            log: `Running a transaction read ${transactionItemList.length} items..`,
        });
        const transactionInput = {
            TransactItems: transactionItemList,
            ReturnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        };
        const response = await this.connection.documentClient.transactGet(transactionInput);
        // log stats
        if (response?.ConsumedCapacity) {
            this.connection.logger.logStats({
                requestId,
                scope: MANAGER_NAME.TRANSACTION_MANAGER,
                statsType: STATS_TYPE.CONSUMED_CAPACITY,
                consumedCapacityData: response.ConsumedCapacity,
            });
        }
        // Items are always returned in the same as they were requested.
        // An ordered array of up to 25 ItemResponse objects, each of which corresponds to the
        // TransactGetItem object in the same position in the TransactItems array
        return response.Responses?.map((response, index) => {
            if (!response.Item) {
                // If a requested item could not be retrieved, the corresponding ItemResponse object is Null,
                return null;
            }
            const originalRequest = transaction.items[index];
            return this._dcTransactionTransformer.fromDynamoEntity(originalRequest.get.item, response.Item, {
                requestId,
            });
        });
    }
    /**
     * Perhaps, you are looking for ".write" instead.
     *
     * Writes items to dynamodb over document client's transact write API without performing any pre transforming
     * You would almost never need to use this.
     */
    async writeRaw(transactItems, metadataOptions) {
        const transactionInput = {
            TransactItems: transactItems,
            ReturnConsumedCapacity: metadataOptions?.returnConsumedCapacity,
        };
        this.connection.logger.logInfo({
            requestId: metadataOptions?.requestId,
            scope: MANAGER_NAME.TRANSACTION_MANAGER,
            log: `Running a transaction write request for ${transactItems.length} items.`,
        });
        const response = await this.connection.documentClient.transactWrite(transactionInput);
        // log stats
        if (response?.ConsumedCapacity) {
            this.connection.logger.logStats({
                requestId: metadataOptions?.requestId,
                scope: MANAGER_NAME.TRANSACTION_MANAGER,
                statsType: STATS_TYPE.CONSUMED_CAPACITY,
                consumedCapacityData: response.ConsumedCapacity,
            });
        }
        // return success when successfully processed all items in a transaction
        return { success: true };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNhY3Rpb24tbWFuYWdlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvc3JjL2NsYXNzZXMvbWFuYWdlci90cmFuc2FjdGlvbi1tYW5hZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBQyxvQ0FBb0MsRUFBQyxNQUFNLHdEQUF3RCxDQUFDO0FBQzVHLE9BQU8sRUFDTCxZQUFZLEVBQ1oscUNBQXFDLEVBQ3JDLFVBQVUsRUFDViw0QkFBNEIsRUFDNUIsNkJBQTZCLEVBQzdCLHNDQUFzQyxHQUN2QyxNQUFNLGtCQUFrQixDQUFDO0FBRzFCLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLHFDQUFxQyxDQUFDO0FBRXZFLE1BQU0sT0FBTyxrQkFBa0I7SUFHVDtJQUZaLHlCQUF5QixDQUF1QztJQUV4RSxZQUFvQixVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3hDLElBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLG9DQUFvQyxDQUN2RSxVQUFVLENBQ1gsQ0FBQztJQUNKLENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsS0FBSyxDQUNULFdBQTZCLEVBQzdCLGVBQWlDO1FBRWpDLE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLGVBQWUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNqRSxNQUFNLEVBQUMsbUJBQW1CLEVBQUUsa0NBQWtDLEVBQUMsR0FDN0QsSUFBSSxDQUFDLHlCQUF5QixDQUFDLDZCQUE2QixDQUMxRCxXQUFXLEVBQ1g7WUFDRSxTQUFTO1NBQ1YsQ0FDRixDQUFDO1FBRUosSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQzdCLFNBQVM7WUFDVCxLQUFLLEVBQUUsWUFBWSxDQUFDLG1CQUFtQjtZQUN2QyxHQUFHLEVBQUUsNENBQTRDLFdBQVcsQ0FBQyxLQUFLLENBQUMsTUFB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QUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUM7Z0JBQzlCLFNBQVMsRUFBRSxlQUFlLEVBQUUsU0FBUztnQkFDckMsS0FBSyxFQUFFLFlBQVksQ0FBQyxtQkFBbUI7Z0JBQ3ZDLFNBQVMsRUFBRSxVQUFVLENBQUMsaUJBQWlCO2dCQUN2QyxvQkFBb0IsRUFBRSxRQUFRLENBQUMsZ0JBQWdCO2FBQ2hELENBQUMsQ0FBQztTQUNKO1FBRUQsd0VBQXdFO1FBQ3hFLE9BQU8sRUFBQyxPQUFPLEVBQUUsSUFBSSxFQUFDLENBQUM7SUFDekIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtEb2N1bWVudENsaWVudFR5cGVzfSBmcm9tICdAdHlwZWRvcm0vZG9jdW1lbnQtY2xpZW50JztcbmltcG9ydCB7V3JpdGVUcmFuc2FjdGlvbn0gZnJvbSAnLi8uLi90cmFuc2FjdGlvbi93cml0ZS10cmFuc2FjdGlvbic7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge0RvY3VtZW50Q2xpZW50VHJhbnNhY3Rpb25UcmFuc2Zvcm1lcn0gZnJvbSAnLi4vdHJhbnNmb3JtZXIvZG9jdW1lbnQtY2xpZW50LXRyYW5zYWN0aW9uLXRyYW5zZm9ybWVyJztcbmltcG9ydCB7XG4gIE1BTkFHRVJfTkFNRSxcbiAgUmVhZFRyYW5zYWN0aW9uSXRlbUxpbWl0RXhjZWVkZWRFcnJvcixcbiAgU1RBVFNfVFlQRSxcbiAgVFJBTlNBQ1RJT05fUkVBRF9JVEVNU19MSU1JVCxcbiAgVFJBTlNBQ1RJT05fV1JJVEVfSVRFTVNfTElNSVQsXG4gIFdyaXRlVHJhbnNhY3Rpb25JdGVtTGltaXRFeGNlZWRlZEVycm9yLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7UmVhZFRyYW5zYWN0aW9ufSBmcm9tICcuLi90cmFuc2FjdGlvbi9yZWFkLXRyYW5zYWN0aW9uJztcbmltcG9ydCB7TWV0YWRhdGFPcHRpb25zfSBmcm9tICcuLi90cmFuc2Zvcm1lci9iYXNlLXRyYW5zZm9ybWVyJztcbmltcG9ydCB7Z2V0VW5pcXVlUmVxdWVzdElkfSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC11bmlxdWUtcmVxdWVzdC1pZCc7XG5cbmV4cG9ydCBjbGFzcyBUcmFuc2FjdGlvbk1hbmFnZXIge1xuICBwcml2YXRlIF9kY1RyYW5zYWN0aW9uVHJhbnNmb3JtZXI6IERvY3VtZW50Q2xpZW50VHJhbnNhY3Rpb25UcmFuc2Zvcm1lcjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbm5lY3Rpb246IENvbm5lY3Rpb24pIHtcbiAgICB0aGlzLl9kY1RyYW5zYWN0aW9uVHJhbnNmb3JtZXIgPSBuZXcgRG9jdW1lbnRDbGllbnRUcmFuc2FjdGlvblRyYW5zZm9ybWVyKFxuICAgICAgY29ubmVjdGlvblxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUHJvY2Vzc2VzIHRyYW5zYWN0aW9ucyBvdmVyIGRvY3VtZW50IGNsaWVudCdzIHRyYW5zYWN0aW9uIGFwaVxuICAgKiBAcGFyYW0gdHJhbnNhY3Rpb24gV3JpdGUgdHJhbnNhY3Rpb24gdG8gcHJvY2Vzc1xuICAgKi9cbiAgYXN5bmMgd3JpdGUoXG4gICAgdHJhbnNhY3Rpb246IFdyaXRlVHJhbnNhY3Rpb24sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIGNvbnN0IHJlcXVlc3RJZCA9IGdldFVuaXF1ZVJlcXVlc3RJZChtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCk7XG4gICAgY29uc3Qge3RyYW5zYWN0aW9uSXRlbUxpc3QsIGxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXJ9ID1cbiAgICAgIHRoaXMuX2RjVHJhbnNhY3Rpb25UcmFuc2Zvcm1lci50b0R5bmFtb1dyaXRlVHJhbnNhY3Rpb25JdGVtcyhcbiAgICAgICAgdHJhbnNhY3Rpb24sXG4gICAgICAgIHtcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ0luZm8oe1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgbG9nOiBgUmVxdWVzdGVkIHRvIHdyaXRlIHRyYW5zYWN0aW9uIGZvciB0b3RhbCAke3RyYW5zYWN0aW9uLml0ZW1zLmxlbmd0aH0gaXRlbXMuYCxcbiAgICB9KTtcblxuICAgIGNvbnN0IGxhenlUcmFuc2FjdGlvbkl0ZW1zID0gKFxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICAgIGxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIubWFwKGFzeW5jIChpdGVtOiBhbnkpID0+IHtcbiAgICAgICAgICAvLyBpZiB1cGRhdGluZy9yZW1vdmluZyB1bmlxdWUgYXR0cmlidXRlIGluIHRyYW5zYWN0aW9uLCBnZXQgcHJldmlvdXMgdmFsdWUgb2YgYXR0cmlidXRlc1xuICAgICAgICAgIGNvbnN0IGV4aXN0aW5nSXRlbSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5lbnRpdHlNYW5hZ2VyLmZpbmRPbmUoXG4gICAgICAgICAgICBpdGVtLmVudGl0eUNsYXNzLFxuICAgICAgICAgICAgaXRlbS5wcmltYXJ5S2V5QXR0cmlidXRlcyxcbiAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgICByZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHJldHVybiBpdGVtLmxhenlMb2FkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1zKGV4aXN0aW5nSXRlbSk7XG4gICAgICAgIH0pXG4gICAgICApXG4gICAgKS5mbGF0KCk7XG5cbiAgICBjb25zdCBpdGVtc1RvV3JpdGVJblRyYW5zYWN0aW9uID0gW1xuICAgICAgLi4udHJhbnNhY3Rpb25JdGVtTGlzdCxcbiAgICAgIC4uLmxhenlUcmFuc2FjdGlvbkl0ZW1zLFxuICAgIF07XG5cbiAgICBpZiAoaXRlbXNUb1dyaXRlSW5UcmFuc2FjdGlvbi5sZW5ndGggPiBUUkFOU0FDVElPTl9XUklURV9JVEVNU19MSU1JVCkge1xuICAgICAgdGhyb3cgbmV3IFdyaXRlVHJhbnNhY3Rpb25JdGVtTGltaXRFeGNlZWRlZEVycm9yKFxuICAgICAgICB0cmFuc2FjdGlvbi5pdGVtcy5sZW5ndGgsXG4gICAgICAgIGl0ZW1zVG9Xcml0ZUluVHJhbnNhY3Rpb24ubGVuZ3RoXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChpdGVtc1RvV3JpdGVJblRyYW5zYWN0aW9uLmxlbmd0aCA+IHRyYW5zYWN0aW9uLml0ZW1zLmxlbmd0aCkge1xuICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dJbmZvKHtcbiAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICBzY29wZTogTUFOQUdFUl9OQU1FLlRSQU5TQUNUSU9OX01BTkFHRVIsXG4gICAgICAgIGxvZzogYE9yaWdpbmFsIGl0ZW1zIGNvdW50ICR7dHJhbnNhY3Rpb24uaXRlbXMubGVuZ3RofSBleHBhbmRlZCBcbiAgICAgICAgdG8gJHtpdGVtc1RvV3JpdGVJblRyYW5zYWN0aW9uLmxlbmd0aH0gdG8gYWNjb21tb2RhdGUgdW5pcXVlIGF0dHJpYnV0ZXMuYCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLndyaXRlUmF3KGl0ZW1zVG9Xcml0ZUluVHJhbnNhY3Rpb24sIHtcbiAgICAgIHJlcXVlc3RJZCxcbiAgICAgIHJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm9jZXNzZXMgdHJhbnNhY3Rpb25zIG92ZXIgZG9jdW1lbnQgY2xpZW50J3MgdHJhbnNhY3Rpb24gYXBpXG4gICAqIEBwYXJhbSB0cmFuc2FjdGlvbiByZWFkIHRyYW5zYWN0aW9uIHRvIHByb2Nlc3NcbiAgICovXG4gIGFzeW5jIHJlYWQodHJhbnNhY3Rpb246IFJlYWRUcmFuc2FjdGlvbiwgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zKSB7XG4gICAgY29uc3QgcmVxdWVzdElkID0gZ2V0VW5pcXVlUmVxdWVzdElkKG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkKTtcblxuICAgIGNvbnN0IHt0cmFuc2FjdGlvbkl0ZW1MaXN0fSA9XG4gICAgICB0aGlzLl9kY1RyYW5zYWN0aW9uVHJhbnNmb3JtZXIudG9EeW5hbW9SZWFkVHJhbnNhY3Rpb25JdGVtcyh0cmFuc2FjdGlvbiwge1xuICAgICAgICByZXF1ZXN0SWQsXG4gICAgICB9KTtcblxuICAgIGlmICh0cmFuc2FjdGlvbkl0ZW1MaXN0Lmxlbmd0aCA+IFRSQU5TQUNUSU9OX1JFQURfSVRFTVNfTElNSVQpIHtcbiAgICAgIHRocm93IG5ldyBSZWFkVHJhbnNhY3Rpb25JdGVtTGltaXRFeGNlZWRlZEVycm9yKFxuICAgICAgICB0cmFuc2FjdGlvbkl0ZW1MaXN0Lmxlbmd0aFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ0luZm8oe1xuICAgICAgcmVxdWVzdElkLFxuICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgbG9nOiBgUnVubmluZyBhIHRyYW5zYWN0aW9uIHJlYWQgJHt0cmFuc2FjdGlvbkl0ZW1MaXN0Lmxlbmd0aH0gaXRlbXMuLmAsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0cmFuc2FjdGlvbklucHV0OiBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0R2V0SXRlbUlucHV0ID0ge1xuICAgICAgVHJhbnNhY3RJdGVtczogdHJhbnNhY3Rpb25JdGVtTGlzdCxcbiAgICAgIFJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICB9O1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNvbm5lY3Rpb24uZG9jdW1lbnRDbGllbnQudHJhbnNhY3RHZXQoXG4gICAgICB0cmFuc2FjdGlvbklucHV0XG4gICAgKTtcblxuICAgIC8vIGxvZyBzdGF0c1xuICAgIGlmIChyZXNwb25zZT8uQ29uc3VtZWRDYXBhY2l0eSkge1xuICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dTdGF0cyh7XG4gICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgICBzdGF0c1R5cGU6IFNUQVRTX1RZUEUuQ09OU1VNRURfQ0FQQUNJVFksXG4gICAgICAgIGNvbnN1bWVkQ2FwYWNpdHlEYXRhOiByZXNwb25zZS5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gSXRlbXMgYXJlIGFsd2F5cyByZXR1cm5lZCBpbiB0aGUgc2FtZSBhcyB0aGV5IHdlcmUgcmVxdWVzdGVkLlxuICAgIC8vIEFuIG9yZGVyZWQgYXJyYXkgb2YgdXAgdG8gMjUgSXRlbVJlc3BvbnNlIG9iamVjdHMsIGVhY2ggb2Ygd2hpY2ggY29ycmVzcG9uZHMgdG8gdGhlXG4gICAgLy8gVHJhbnNhY3RHZXRJdGVtIG9iamVjdCBpbiB0aGUgc2FtZSBwb3NpdGlvbiBpbiB0aGUgVHJhbnNhY3RJdGVtcyBhcnJheVxuICAgIHJldHVybiAocmVzcG9uc2UuUmVzcG9uc2VzIGFzIERvY3VtZW50Q2xpZW50VHlwZXMuSXRlbVJlc3BvbnNlTGlzdCk/Lm1hcChcbiAgICAgIChyZXNwb25zZSwgaW5kZXgpID0+IHtcbiAgICAgICAgaWYgKCFyZXNwb25zZS5JdGVtKSB7XG4gICAgICAgICAgLy8gSWYgYSByZXF1ZXN0ZWQgaXRlbSBjb3VsZCBub3QgYmUgcmV0cmlldmVkLCB0aGUgY29ycmVzcG9uZGluZyBJdGVtUmVzcG9uc2Ugb2JqZWN0IGlzIE51bGwsXG4gICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBvcmlnaW5hbFJlcXVlc3QgPSB0cmFuc2FjdGlvbi5pdGVtc1tpbmRleF07XG4gICAgICAgIHJldHVybiB0aGlzLl9kY1RyYW5zYWN0aW9uVHJhbnNmb3JtZXIuZnJvbUR5bmFtb0VudGl0eShcbiAgICAgICAgICBvcmlnaW5hbFJlcXVlc3QuZ2V0Lml0ZW0sXG4gICAgICAgICAgcmVzcG9uc2UuSXRlbSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUGVyaGFwcywgeW91IGFyZSBsb29raW5nIGZvciBcIi53cml0ZVwiIGluc3RlYWQuXG4gICAqXG4gICAqIFdyaXRlcyBpdGVtcyB0byBkeW5hbW9kYiBvdmVyIGRvY3VtZW50IGNsaWVudCdzIHRyYW5zYWN0IHdyaXRlIEFQSSB3aXRob3V0IHBlcmZvcm1pbmcgYW55IHByZSB0cmFuc2Zvcm1pbmdcbiAgICogWW91IHdvdWxkIGFsbW9zdCBuZXZlciBuZWVkIHRvIHVzZSB0aGlzLlxuICAgKi9cbiAgYXN5bmMgd3JpdGVSYXcoXG4gICAgdHJhbnNhY3RJdGVtczogRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbVtdLFxuICAgIG1ldGFkYXRhT3B0aW9uczogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uSW5wdXQ6IERvY3VtZW50Q2xpZW50VHlwZXMuVHJhbnNhY3RXcml0ZUl0ZW1JbnB1dCA9IHtcbiAgICAgIFRyYW5zYWN0SXRlbXM6IHRyYW5zYWN0SXRlbXMsXG4gICAgICBSZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfTtcblxuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nSW5mbyh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgc2NvcGU6IE1BTkFHRVJfTkFNRS5UUkFOU0FDVElPTl9NQU5BR0VSLFxuICAgICAgbG9nOiBgUnVubmluZyBhIHRyYW5zYWN0aW9uIHdyaXRlIHJlcXVlc3QgZm9yICR7dHJhbnNhY3RJdGVtcy5sZW5ndGh9IGl0ZW1zLmAsXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY29ubmVjdGlvbi5kb2N1bWVudENsaWVudC50cmFuc2FjdFdyaXRlKFxuICAgICAgdHJhbnNhY3Rpb25JbnB1dFxuICAgICk7XG5cbiAgICAvLyBsb2cgc3RhdHNcbiAgICBpZiAocmVzcG9uc2U/LkNvbnN1bWVkQ2FwYWNpdHkpIHtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nU3RhdHMoe1xuICAgICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgICBzY29wZTogTUFOQUdFUl9OQU1FLlRSQU5TQUNUSU9OX01BTkFHRVIsXG4gICAgICAgIHN0YXRzVHlwZTogU1RBVFNfVFlQRS5DT05TVU1FRF9DQVBBQ0lUWSxcbiAgICAgICAgY29uc3VtZWRDYXBhY2l0eURhdGE6IHJlc3BvbnNlLkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyByZXR1cm4gc3VjY2VzcyB3aGVuIHN1Y2Nlc3NmdWxseSBwcm9jZXNzZWQgYWxsIGl0ZW1zIGluIGEgdHJhbnNhY3Rpb25cbiAgICByZXR1cm4ge3N1Y2Nlc3M6IHRydWV9O1xuICB9XG59XG4iXX0=