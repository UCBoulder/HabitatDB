import { TRANSFORM_TYPE } from '@typedorm/common';
import { plainToClassFromExist } from 'class-transformer';
import { unParseKey } from '../../helpers/unparse-key';
import { BaseTransformer } from './base-transformer';
/**
 * Note: To use any of the base transformer methods, this default entity transformer should be used
 */
export class EntityTransformer extends BaseTransformer {
    constructor(connection) {
        super(connection);
    }
    /**
     * Converts dynamodb entity to model defined in entities
     * @param entityClass - Target class to look metadata off
     * @param dynamoEntity
     */
    fromDynamoEntity(entityClass, dynamoEntity, metadataOptions) {
        const entityMetadata = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TYPE.RESPONSE,
            prefix: 'Before',
            entityName: entityMetadata.name,
            primaryKey: null,
            body: dynamoEntity,
        });
        const vanillaAttributesToInclude = entityMetadata.attributes
            .filter(attr => !attr.hidden)
            .map(attr => attr.name);
        const primaryKeyAttributesToInclude = Object.keys(entityMetadata.schema.primaryKey.attributes).filter(attr => !vanillaAttributesToInclude.includes(attr));
        const entityInternalAttributeKeys = entityMetadata.internalAttributes.map(attr => attr.name);
        const entityHiddenAttributeKeys = entityMetadata.attributes
            .filter(attr => attr.hidden)
            .map(attr => attr.name);
        const entityMetadataSchemaIndexes = entityMetadata.schema.indexes ?? {};
        const indexAttributesToInclude = Object.keys(entityMetadataSchemaIndexes)
            .map(key => {
            return Object.keys(entityMetadataSchemaIndexes[key].attributes ?? {});
        })
            .flat()
            .filter(attr => !vanillaAttributesToInclude.includes(attr));
        const plainEntityAttributes = Object.keys(dynamoEntity).reduce((acc, key) => {
            // if any of the below conditions are true, skip adding given attribute from returning response
            if (primaryKeyAttributesToInclude.includes(key) ||
                indexAttributesToInclude.includes(key) ||
                entityInternalAttributeKeys.includes(key) ||
                entityHiddenAttributeKeys.includes(key)) {
                return acc;
            }
            acc[key] = dynamoEntity[key];
            return acc;
        }, {});
        // get reflected constructor to avoid initialization issues with custom constructor
        const reflectedConstructor = Reflect.construct(Object, [], entityClass);
        // Perform a deep-copy of item returned by Document client to drop all the custom function types
        // Custom types are emitted by the document client in cases where dynamodb item was created outside the js ecosystem.
        // To correctly deserialize the returned values to the relevant Entity, it needs to be in a plain JSON structure.
        // i.e DynamoDB itself supports `StringSet` type but since js doesn't have a `StringSet` as a native type,
        // Therefore, DocumentClient wraps it as a custom `Set` type which must be turned into its JSON form before it can
        // be correctly deserialized by `class-transformer`.
        const deserializedEntityAttributes = JSON.parse(JSON.stringify(plainEntityAttributes));
        const transformedEntity = plainToClassFromExist(reflectedConstructor, deserializedEntityAttributes);
        this.connection.logger.logTransform({
            requestId: metadataOptions?.requestId,
            operation: TRANSFORM_TYPE.RESPONSE,
            prefix: 'After',
            entityName: entityMetadata.name,
            primaryKey: null,
            body: transformedEntity,
        });
        return transformedEntity;
    }
    fromDynamoKeyToAttributes(entityClass, dynamoKey) {
        const entityMetadata = this.connection.getEntityByTarget(entityClass);
        const primaryKeyAttributes = entityMetadata.schema.primaryKey.attributes;
        const interpolations = entityMetadata.schema.primaryKey?.metadata?._interpolations ?? {};
        const rawAttributes = Object.entries(primaryKeyAttributes).reduce((acc, [keyName, keyPattern]) => {
            const unParsed = unParseKey(keyPattern, dynamoKey[keyName], interpolations[keyName] ?? []);
            acc = { ...acc, ...unParsed };
            return acc;
        }, {});
        // like compare actual key with the schema and pull out variable name an it's values
        // then return those as key value pair
        const attributes = Object.entries(rawAttributes).reduce((acc, [attrName, value]) => {
            const attrMetadata = entityMetadata.attributes.find(attr => attr.name === attrName);
            if (!attrMetadata) {
                throw new Error(`Failed to reverse transform attribute ${attrName}, it was referenced in schema but it is not known to entity ${entityClass.name}`);
            }
            if ((attrMetadata.type === 'Boolean' || attrMetadata.type === 'Number') &&
                value) {
                acc[attrName] = JSON.parse(value);
            }
            else {
                acc[attrName] = value;
            }
            return acc;
        }, {});
        return attributes;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LXRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy90cmFuc2Zvcm1lci9lbnRpdHktdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUE2QixjQUFjLEVBQUMsTUFBTSxrQkFBa0IsQ0FBQztBQUM1RSxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSxtQkFBbUIsQ0FBQztBQUN4RCxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFFckQsT0FBTyxFQUFDLGVBQWUsRUFBa0IsTUFBTSxvQkFBb0IsQ0FBQztBQUVwRTs7R0FFRztBQUNILE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxlQUFlO0lBQ3BELFlBQVksVUFBc0I7UUFDaEMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3BCLENBQUM7SUFDRDs7OztPQUlHO0lBQ0gsZ0JBQWdCLENBQ2QsV0FBaUMsRUFDakMsWUFBa0MsRUFDbEMsZUFBb0Q7UUFFcEQsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDbEMsU0FBUyxFQUFFLGVBQWUsRUFBRSxTQUFTO1lBQ3JDLFNBQVMsRUFBRSxjQUFjLENBQUMsUUFBUTtZQUNsQyxNQUFNLEVBQUUsUUFBUTtZQUNoQixVQUFVLEVBQUUsY0FBYyxDQUFDLElBQUk7WUFDL0IsVUFBVSxFQUFFLElBQUk7WUFDaEIsSUFBSSxFQUFFLFlBQVk7U0FDbkIsQ0FBQyxDQUFDO1FBRUgsTUFBTSwwQkFBMEIsR0FBRyxjQUFjLENBQUMsVUFBVTthQUN6RCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFN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Q2IseUNBQXlDLFFBQVEsK0RBQStELFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FDbkksQ0FBQzthQUNIO1lBRUQsSUFDRSxDQUFDLFlBQVksQ0FBQyxJQUFJLEtBQUssU0FBUyxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDO2dCQUNuRSxLQUFLLEVBQ0w7Z0JBQ0EsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDbkM7aUJBQU07Z0JBQ0wsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQzthQUN2QjtZQUNELE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUNELEVBQXlCLENBQzFCLENBQUM7UUFDRixPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0RvY3VtZW50Q2xpZW50VHlwZXN9IGZyb20gJ0B0eXBlZG9ybS9kb2N1bWVudC1jbGllbnQnO1xuaW1wb3J0IHtEeW5hbW9FbnRpdHksIEVudGl0eVRhcmdldCwgVFJBTlNGT1JNX1RZUEV9IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtwbGFpblRvQ2xhc3NGcm9tRXhpc3R9IGZyb20gJ2NsYXNzLXRyYW5zZm9ybWVyJztcbmltcG9ydCB7dW5QYXJzZUtleX0gZnJvbSAnLi4vLi4vaGVscGVycy91bnBhcnNlLWtleSc7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge0Jhc2VUcmFuc2Zvcm1lciwgTWV0YWRhdGFPcHRpb25zfSBmcm9tICcuL2Jhc2UtdHJhbnNmb3JtZXInO1xuXG4vKipcbiAqIE5vdGU6IFRvIHVzZSBhbnkgb2YgdGhlIGJhc2UgdHJhbnNmb3JtZXIgbWV0aG9kcywgdGhpcyBkZWZhdWx0IGVudGl0eSB0cmFuc2Zvcm1lciBzaG91bGQgYmUgdXNlZFxuICovXG5leHBvcnQgY2xhc3MgRW50aXR5VHJhbnNmb3JtZXIgZXh0ZW5kcyBCYXNlVHJhbnNmb3JtZXIge1xuICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uOiBDb25uZWN0aW9uKSB7XG4gICAgc3VwZXIoY29ubmVjdGlvbik7XG4gIH1cbiAgLyoqXG4gICAqIENvbnZlcnRzIGR5bmFtb2RiIGVudGl0eSB0byBtb2RlbCBkZWZpbmVkIGluIGVudGl0aWVzXG4gICAqIEBwYXJhbSBlbnRpdHlDbGFzcyAtIFRhcmdldCBjbGFzcyB0byBsb29rIG1ldGFkYXRhIG9mZlxuICAgKiBAcGFyYW0gZHluYW1vRW50aXR5XG4gICAqL1xuICBmcm9tRHluYW1vRW50aXR5PEVudGl0eT4oXG4gICAgZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+LFxuICAgIGR5bmFtb0VudGl0eTogRHluYW1vRW50aXR5PEVudGl0eT4sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogUGljazxNZXRhZGF0YU9wdGlvbnMsICdyZXF1ZXN0SWQnPlxuICApOiBFbnRpdHkge1xuICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhID0gdGhpcy5jb25uZWN0aW9uLmdldEVudGl0eUJ5VGFyZ2V0KGVudGl0eUNsYXNzKTtcbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5SRVNQT05TRSxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBlbnRpdHlOYW1lOiBlbnRpdHlNZXRhZGF0YS5uYW1lLFxuICAgICAgcHJpbWFyeUtleTogbnVsbCxcbiAgICAgIGJvZHk6IGR5bmFtb0VudGl0eSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHZhbmlsbGFBdHRyaWJ1dGVzVG9JbmNsdWRlID0gZW50aXR5TWV0YWRhdGEuYXR0cmlidXRlc1xuICAgICAgLmZpbHRlcihhdHRyID0+ICFhdHRyLmhpZGRlbilcbiAgICAgIC5tYXAoYXR0ciA9PiBhdHRyLm5hbWUpO1xuXG4gICAgY29uc3QgcHJpbWFyeUtleUF0dHJpYnV0ZXNUb0luY2x1ZGUgPSBPYmplY3Qua2V5cyhcbiAgICAgIGVudGl0eU1ldGFkYXRhLnNjaGVtYS5wcmltYXJ5S2V5LmF0dHJpYnV0ZXNcbiAgICApLmZpbHRlcihhdHRyID0+ICF2YW5pbGxhQXR0cmlidXRlc1RvSW5jbHVkZS5pbmNsdWRlcyhhdHRyKSk7XG5cbiAgICBjb25zdCBlbnRpdHlJbnRlcm5hbEF0dHJpYnV0ZUtleXMgPSBlbnRpdHlNZXRhZGF0YS5pbnRlcm5hbEF0dHJpYnV0ZXMubWFwKFxuICAgICAgYXR0ciA9PiBhdHRyLm5hbWVcbiAgICApO1xuICAgIGNvbnN0IGVudGl0eUhpZGRlbkF0dHJpYnV0ZUtleXMgPSBlbnRpdHlNZXRhZGF0YS5hdHRyaWJ1dGVzXG4gICAgICAuZmlsdGVyKGF0dHIgPT4gYXR0ci5oaWRkZW4pXG4gICAgICAubWFwKGF0dHIgPT4gYXR0ci5uYW1lKTtcblxuICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhU2NoZW1hSW5kZXhlcyA9IGVudGl0eU1ldGFkYXRhLnNjaGVtYS5pbmRleGVzID8/IHt9O1xuICAgIGNvbnN0IGluZGV4QXR0cmlidXRlc1RvSW5jbHVkZSA9IE9iamVjdC5rZXlzKGVudGl0eU1ldGFkYXRhU2NoZW1hSW5kZXhlcylcbiAgICAgIC5tYXAoa2V5ID0+IHtcbiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKGVudGl0eU1ldGFkYXRhU2NoZW1hSW5kZXhlc1trZXldLmF0dHJpYnV0ZXMgPz8ge30pO1xuICAgICAgfSlcbiAgICAgIC5mbGF0KClcbiAgICAgIC5maWx0ZXIoYXR0ciA9PiAhdmFuaWxsYUF0dHJpYnV0ZXNUb0luY2x1ZGUuaW5jbHVkZXMoYXR0cikpO1xuXG4gICAgY29uc3QgcGxhaW5FbnRpdHlBdHRyaWJ1dGVzID0gT2JqZWN0LmtleXMoZHluYW1vRW50aXR5IGFzIG9iamVjdCkucmVkdWNlKFxuICAgICAgKGFjYywga2V5KSA9PiB7XG4gICAgICAgIC8vIGlmIGFueSBvZiB0aGUgYmVsb3cgY29uZGl0aW9ucyBhcmUgdHJ1ZSwgc2tpcCBhZGRpbmcgZ2l2ZW4gYXR0cmlidXRlIGZyb20gcmV0dXJuaW5nIHJlc3BvbnNlXG4gICAgICAgIGlmIChcbiAgICAgICAgICBwcmltYXJ5S2V5QXR0cmlidXRlc1RvSW5jbHVkZS5pbmNsdWRlcyhrZXkpIHx8XG4gICAgICAgICAgaW5kZXhBdHRyaWJ1dGVzVG9JbmNsdWRlLmluY2x1ZGVzKGtleSkgfHxcbiAgICAgICAgICBlbnRpdHlJbnRlcm5hbEF0dHJpYnV0ZUtleXMuaW5jbHVkZXMoa2V5KSB8fFxuICAgICAgICAgIGVudGl0eUhpZGRlbkF0dHJpYnV0ZUtleXMuaW5jbHVkZXMoa2V5KVxuICAgICAgICApIHtcbiAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICB9XG4gICAgICAgIChhY2MgYXMgYW55KVtrZXldID0gKGR5bmFtb0VudGl0eSBhcyBhbnkpW2tleV07XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge30gYXMgT2JqZWN0XG4gICAgKTtcblxuICAgIC8vIGdldCByZWZsZWN0ZWQgY29uc3RydWN0b3IgdG8gYXZvaWQgaW5pdGlhbGl6YXRpb24gaXNzdWVzIHdpdGggY3VzdG9tIGNvbnN0cnVjdG9yXG4gICAgY29uc3QgcmVmbGVjdGVkQ29uc3RydWN0b3IgPSBSZWZsZWN0LmNvbnN0cnVjdChPYmplY3QsIFtdLCBlbnRpdHlDbGFzcyk7XG5cbiAgICAvLyBQZXJmb3JtIGEgZGVlcC1jb3B5IG9mIGl0ZW0gcmV0dXJuZWQgYnkgRG9jdW1lbnQgY2xpZW50IHRvIGRyb3AgYWxsIHRoZSBjdXN0b20gZnVuY3Rpb24gdHlwZXNcblxuICAgIC8vIEN1c3RvbSB0eXBlcyBhcmUgZW1pdHRlZCBieSB0aGUgZG9jdW1lbnQgY2xpZW50IGluIGNhc2VzIHdoZXJlIGR5bmFtb2RiIGl0ZW0gd2FzIGNyZWF0ZWQgb3V0c2lkZSB0aGUganMgZWNvc3lzdGVtLlxuICAgIC8vIFRvIGNvcnJlY3RseSBkZXNlcmlhbGl6ZSB0aGUgcmV0dXJuZWQgdmFsdWVzIHRvIHRoZSByZWxldmFudCBFbnRpdHksIGl0IG5lZWRzIHRvIGJlIGluIGEgcGxhaW4gSlNPTiBzdHJ1Y3R1cmUuXG4gICAgLy8gaS5lIER5bmFtb0RCIGl0c2VsZiBzdXBwb3J0cyBgU3RyaW5nU2V0YCB0eXBlIGJ1dCBzaW5jZSBqcyBkb2Vzbid0IGhhdmUgYSBgU3RyaW5nU2V0YCBhcyBhIG5hdGl2ZSB0eXBlLFxuICAgIC8vIFRoZXJlZm9yZSwgRG9jdW1lbnRDbGllbnQgd3JhcHMgaXQgYXMgYSBjdXN0b20gYFNldGAgdHlwZSB3aGljaCBtdXN0IGJlIHR1cm5lZCBpbnRvIGl0cyBKU09OIGZvcm0gYmVmb3JlIGl0IGNhblxuICAgIC8vIGJlIGNvcnJlY3RseSBkZXNlcmlhbGl6ZWQgYnkgYGNsYXNzLXRyYW5zZm9ybWVyYC5cblxuICAgIGNvbnN0IGRlc2VyaWFsaXplZEVudGl0eUF0dHJpYnV0ZXMgPSBKU09OLnBhcnNlKFxuICAgICAgSlNPTi5zdHJpbmdpZnkocGxhaW5FbnRpdHlBdHRyaWJ1dGVzKVxuICAgICk7XG5cbiAgICBjb25zdCB0cmFuc2Zvcm1lZEVudGl0eSA9IHBsYWluVG9DbGFzc0Zyb21FeGlzdChcbiAgICAgIHJlZmxlY3RlZENvbnN0cnVjdG9yLFxuICAgICAgZGVzZXJpYWxpemVkRW50aXR5QXR0cmlidXRlc1xuICAgICk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5SRVNQT05TRSxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGVudGl0eU5hbWU6IGVudGl0eU1ldGFkYXRhLm5hbWUsXG4gICAgICBwcmltYXJ5S2V5OiBudWxsLFxuICAgICAgYm9keTogdHJhbnNmb3JtZWRFbnRpdHksXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdHJhbnNmb3JtZWRFbnRpdHk7XG4gIH1cblxuICBmcm9tRHluYW1vS2V5VG9BdHRyaWJ1dGVzPEVudGl0eT4oXG4gICAgZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+LFxuICAgIGR5bmFtb0tleTogRG9jdW1lbnRDbGllbnRUeXBlcy5LZXlcbiAgKSB7XG4gICAgY29uc3QgZW50aXR5TWV0YWRhdGEgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuICAgIGNvbnN0IHByaW1hcnlLZXlBdHRyaWJ1dGVzID0gZW50aXR5TWV0YWRhdGEuc2NoZW1hLnByaW1hcnlLZXkuYXR0cmlidXRlcztcbiAgICBjb25zdCBpbnRlcnBvbGF0aW9ucyA9XG4gICAgICBlbnRpdHlNZXRhZGF0YS5zY2hlbWEucHJpbWFyeUtleT8ubWV0YWRhdGE/Ll9pbnRlcnBvbGF0aW9ucyA/PyB7fTtcblxuICAgIGNvbnN0IHJhd0F0dHJpYnV0ZXMgPSBPYmplY3QuZW50cmllcyhwcmltYXJ5S2V5QXR0cmlidXRlcykucmVkdWNlKFxuICAgICAgKGFjYywgW2tleU5hbWUsIGtleVBhdHRlcm5dKSA9PiB7XG4gICAgICAgIGNvbnN0IHVuUGFyc2VkID0gdW5QYXJzZUtleShcbiAgICAgICAgICBrZXlQYXR0ZXJuLFxuICAgICAgICAgIGR5bmFtb0tleVtrZXlOYW1lXSxcbiAgICAgICAgICBpbnRlcnBvbGF0aW9uc1trZXlOYW1lXSA/PyBbXVxuICAgICAgICApO1xuICAgICAgICBhY2MgPSB7Li4uYWNjLCAuLi51blBhcnNlZH07XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge31cbiAgICApO1xuXG4gICAgLy8gbGlrZSBjb21wYXJlIGFjdHVhbCBrZXkgd2l0aCB0aGUgc2NoZW1hIGFuZCBwdWxsIG91dCB2YXJpYWJsZSBuYW1lIGFuIGl0J3MgdmFsdWVzXG4gICAgLy8gdGhlbiByZXR1cm4gdGhvc2UgYXMga2V5IHZhbHVlIHBhaXJcblxuICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBPYmplY3QuZW50cmllcyhyYXdBdHRyaWJ1dGVzKS5yZWR1Y2UoXG4gICAgICAoYWNjLCBbYXR0ck5hbWUsIHZhbHVlXTogW3N0cmluZywgYW55XSkgPT4ge1xuICAgICAgICBjb25zdCBhdHRyTWV0YWRhdGEgPSBlbnRpdHlNZXRhZGF0YS5hdHRyaWJ1dGVzLmZpbmQoXG4gICAgICAgICAgYXR0ciA9PiBhdHRyLm5hbWUgPT09IGF0dHJOYW1lXG4gICAgICAgICk7XG5cbiAgICAgICAgaWYgKCFhdHRyTWV0YWRhdGEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICBgRmFpbGVkIHRvIHJldmVyc2UgdHJhbnNmb3JtIGF0dHJpYnV0ZSAke2F0dHJOYW1lfSwgaXQgd2FzIHJlZmVyZW5jZWQgaW4gc2NoZW1hIGJ1dCBpdCBpcyBub3Qga25vd24gdG8gZW50aXR5ICR7ZW50aXR5Q2xhc3MubmFtZX1gXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAoYXR0ck1ldGFkYXRhLnR5cGUgPT09ICdCb29sZWFuJyB8fCBhdHRyTWV0YWRhdGEudHlwZSA9PT0gJ051bWJlcicpICYmXG4gICAgICAgICAgdmFsdWVcbiAgICAgICAgKSB7XG4gICAgICAgICAgYWNjW2F0dHJOYW1lXSA9IEpTT04ucGFyc2UodmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGFjY1thdHRyTmFtZV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIGFueT5cbiAgICApO1xuICAgIHJldHVybiBhdHRyaWJ1dGVzO1xuICB9XG59XG4iXX0=