"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.EntityMetadata = void 0;
const common_1 = require("@typedorm/common");
const build_primary_key_schema_1 = require("../../helpers/build-primary-key-schema");
const get_interpolated_keys_1 = require("../../helpers/get-interpolated-keys");
const validate_key_1 = require("../../helpers/validate-key");
const base_metadata_1 = require("./base-metadata");
const internal_attribute_metadata_1 = require("./internal-attribute-metadata");
class EntityMetadata extends base_metadata_1.BaseMetadata {
    constructor({ connection, table, name, target, primaryKey, indexes, attributes, }) {
        super(connection);
        this.name = name;
        this.target = target;
        this.attributes = attributes;
        this.table = table;
        // auto persist internal attributes
        this.internalAttributes = [
            new internal_attribute_metadata_1.InternalAttributeMetadata({
                name: common_1.INTERNAL_ENTITY_ATTRIBUTE.ENTITY_NAME,
                type: 'String',
                value: this.name,
            }),
        ];
        // validate attributes and key type pair
        const attributesKeyTypePair = this.attributes.reduce((acc, attr) => {
            this.validateAttributeMetadata(attr);
            acc[attr.name] = attr.type;
            return acc;
        }, {});
        this.schema = {
            primaryKey: (0, build_primary_key_schema_1.buildPrimaryKeySchema)({
                table: this.table,
                primaryKey,
                attributes: attributesKeyTypePair,
            }),
            indexes: this.buildIndexesSchema({
                table: this.table,
                indexes: Object.assign({}, indexes),
                attributes: attributesKeyTypePair,
            }),
        };
    }
    validateAttributeMetadata(attributeToValidate) {
        this.internalAttributes.forEach(internalAttr => {
            if (attributeToValidate.name === internalAttr.name) {
                throw new Error(`Attribute name "${attributeToValidate.name}" is reserved by TypeDORM and cannot be used.`);
            }
        });
    }
    buildIndexesSchema({ table, indexes, attributes, }) {
        return Object.keys(indexes).reduce((acc, key) => {
            const tableIndexSignature = table.getIndexByKey(key);
            if (!tableIndexSignature) {
                throw new Error(`No matching index signature found for index "${key}" in table "${table.name}"`);
            }
            const currentIndex = indexes[key];
            (0, validate_key_1.validateKey)(currentIndex.sortKey, attributes, this.name);
            // validates and gets and fill set indexes interpolations of sort key
            const sortKeyInterpolations = (0, get_interpolated_keys_1.getInterpolatedKeys)(currentIndex.sortKey);
            if (tableIndexSignature.type === common_1.INDEX_TYPE.LSI) {
                if (currentIndex.type !== common_1.INDEX_TYPE.LSI) {
                    throw new Error('Index signature mismatch.');
                }
                acc[key] = {
                    attributes: {
                        [tableIndexSignature.sortKey]: currentIndex.sortKey,
                    },
                    metadata: {
                        type: tableIndexSignature.type,
                        isSparse: currentIndex.isSparse === undefined ||
                            currentIndex.isSparse === null
                            ? true // by default all indexes are sparse
                            : !!currentIndex.isSparse,
                        _name: key,
                        _interpolations: {
                            [tableIndexSignature.sortKey]: sortKeyInterpolations,
                        },
                    },
                };
                return acc;
            }
            else {
                if (currentIndex.type !== common_1.INDEX_TYPE.GSI) {
                    throw new Error('Index signature mismatch.');
                }
                (0, validate_key_1.validateKey)(currentIndex.partitionKey, attributes);
                // validates and gets and fill set indexes interpolations of partition key
                const partitionKeyInterpolations = (0, get_interpolated_keys_1.getInterpolatedKeys)(currentIndex.partitionKey);
                acc[key] = {
                    attributes: {
                        [tableIndexSignature.partitionKey]: currentIndex.partitionKey,
                        [tableIndexSignature.sortKey]: currentIndex.sortKey,
                    },
                    metadata: {
                        isSparse: currentIndex.isSparse === undefined ||
                            currentIndex.isSparse === null
                            ? true // by default all indexes are sparse
                            : !!currentIndex.isSparse,
                        type: tableIndexSignature.type,
                        _name: key,
                        // remove any duplicates from partition or sort keys
                        _interpolations: {
                            [tableIndexSignature.partitionKey]: partitionKeyInterpolations,
                            [tableIndexSignature.sortKey]: sortKeyInterpolations,
                        },
                    },
                };
                return acc;
            }
        }, {});
    }
}
exports.EntityMetadata = EntityMetadata;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5LW1ldGFkYXRhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy9tZXRhZGF0YS9lbnRpdHktbWV0YWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkNBTzBCO0FBQzFCLHFGQUE2RTtBQUM3RSwrRUFBd0U7QUFDeEUsNkRBQXVEO0FBSXZELG1EQUE2QztBQUM3QywrRUFBd0U7QUF1Q3hFLE1BQWEsY0FBZSxTQUFRLDRCQUFZO0lBTzlDLFlBQVksRUFDVixVQUFVLEVBQ1YsS0FBSyxFQUNMLElBQUksRUFDSixNQUFNLEVBQ04sVUFBVSxFQUNWLE9BQU8sRUFDUCxVQUFVLEdBQ1k7UUFDdEIsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO1FBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBRW5CLG1DQUFtQztRQUNuQyxJQUFJLENBQUMsa0JBQWtCLEdBQUc7WUFDeEIsSUFBSSx1REFBeUIsQ0FBQztnQkFDNUIsSUFBSSxFQUFFLGtDQUF5QixDQUFDLFdBQVc7Z0JBQzNDLElBQUksRUFBRSxRQUFRO2dCQUNkLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSTthQUNqQixDQUFDO1NBQ0gsQ0FBQztRQUVGLHdDQUF3QztRQUN4QyxNQUFNLHFCQUFxQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ2pFLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUks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Z0JBQ0QsSUFBQSwwQkFBVyxFQUFDLFlBQVksQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBQ25ELDBFQUEwRTtnQkFDMUUsTUFBTSwwQkFBMEIsR0FBRyxJQUFBLDJDQUFtQixFQUNwRCxZQUFZLENBQUMsWUFBWSxDQUMxQixDQUFDO2dCQUVGLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRztvQkFDVCxVQUFVLEVBQUU7d0JBQ1YsQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsRUFBRSxZQUFZLENBQUMsWUFBWTt3QkFDN0QsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxZQUFZLENBQUMsT0FBTztxQkFDcEQ7b0JBQ0QsUUFBUSxFQUFFO3dCQUNSLFFBQVEsRUFDTixZQUFZLENBQUMsUUFBUSxLQUFLLFNBQVM7NEJBQ25DLFlBQVksQ0FBQyxRQUFRLEtBQUssSUFBSTs0QkFDNUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQ0FBb0M7NEJBQzNDLENBQUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFFBQVE7d0JBQzdCLElBQUksRUFBRSxtQkFBbUIsQ0FBQyxJQUFJO3dCQUM5QixLQUFLLEVBQUUsR0FBRzt3QkFDVixvREFBb0Q7d0JBQ3BELGVBQWUsRUFBRTs0QkFDZixDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxFQUFFLDBCQUEwQjs0QkFDOUQsQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxxQkFBcUI7eUJBQ3JEO3FCQUNGO2lCQUNGLENBQUM7Z0JBQ0YsT0FBTyxHQUFHLENBQUM7YUFDWjtRQUNILENBQUMsRUFBRSxFQUErQixDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBaEpELHdDQWdKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEVudGl0eVJhd01ldGFkYXRhT3B0aW9ucyxcbiAgRW50aXR5VGFyZ2V0LFxuICBJbmRleGVzLFxuICBJTkRFWF9UWVBFLFxuICBJTlRFUk5BTF9FTlRJVFlfQVRUUklCVVRFLFxuICBUYWJsZSxcbn0gZnJvbSAnQHR5cGVkb3JtL2NvbW1vbic7XG5pbXBvcnQge2J1aWxkUHJpbWFyeUtleVNjaGVtYX0gZnJvbSAnLi4vLi4vaGVscGVycy9idWlsZC1wcmltYXJ5LWtleS1zY2hlbWEnO1xuaW1wb3J0IHtnZXRJbnRlcnBvbGF0ZWRLZXlzfSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC1pbnRlcnBvbGF0ZWQta2V5cyc7XG5pbXBvcnQge3ZhbGlkYXRlS2V5fSBmcm9tICcuLi8uLi9oZWxwZXJzL3ZhbGlkYXRlLWtleSc7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge0F0dHJpYnV0ZU1ldGFkYXRhfSBmcm9tICcuL2F0dHJpYnV0ZS1tZXRhZGF0YSc7XG5pbXBvcnQge0F1dG9HZW5lcmF0ZWRBdHRyaWJ1dGVNZXRhZGF0YX0gZnJvbSAnLi9hdXRvLWdlbmVyYXRlZC1hdHRyaWJ1dGUtbWV0YWRhdGEnO1xuaW1wb3J0IHtCYXNlTWV0YWRhdGF9IGZyb20gJy4vYmFzZS1tZXRhZGF0YSc7XG5pbXBvcnQge0ludGVybmFsQXR0cmlidXRlTWV0YWRhdGF9IGZyb20gJy4vaW50ZXJuYWwtYXR0cmlidXRlLW1ldGFkYXRhJztcblxuZXhwb3J0IHR5cGUgRHluYW1vRW50aXR5U2NoZW1hUHJpbWFyeUtleSA9IHtcbiAgYXR0cmlidXRlczoge1trZXk6IHN0cmluZ106IGFueX07XG4gIG1ldGFkYXRhOiB7XG4gICAgX2ludGVycG9sYXRpb25zPzoge1trZXk6IHN0cmluZ106IHN0cmluZ1tdfTtcbiAgfTtcbn07XG5leHBvcnQgdHlwZSBEeW5hbW9FbnRpdHlJbmRleGVzU2NoZW1hID0ge1xuICBba2V5OiBzdHJpbmddOiB7XG4gICAgYXR0cmlidXRlczoge1trZXk6IHN0cmluZ106IGFueX07XG4gICAgbWV0YWRhdGE6IER5bmFtb0VudGl0eUluZGV4U2NoZW1hO1xuICB9O1xufTtcblxuZXhwb3J0IHR5cGUgRHluYW1vRW50aXR5SW5kZXhTY2hlbWEgPSB7XG4gIC8vIGF1dG8gZ2VuZXJhdGVkXG4gIF9uYW1lPzogc3RyaW5nO1xuICAvLyBmb3IgTFNJLCBvbmx5IGNvbnRhaW5zIGludGVycG9sYXRpb25zIGZvciBzb3J0IGtleVxuICBfaW50ZXJwb2xhdGlvbnM/OiB7W2tleTogc3RyaW5nXTogc3RyaW5nW119O1xuICBpc1NwYXJzZTogYm9vbGVhbjtcbiAgdHlwZTogSU5ERVhfVFlQRTtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgRHluYW1vRW50aXR5U2NoZW1hIHtcbiAgcHJpbWFyeUtleTogRHluYW1vRW50aXR5U2NoZW1hUHJpbWFyeUtleTtcbiAgaW5kZXhlcz86IER5bmFtb0VudGl0eUluZGV4ZXNTY2hlbWE7XG59XG5cbmV4cG9ydCB0eXBlIEF0dHJpYnV0ZU1ldGFkYXRhVHlwZSA9XG4gIHwgQXR0cmlidXRlTWV0YWRhdGFcbiAgfCBBdXRvR2VuZXJhdGVkQXR0cmlidXRlTWV0YWRhdGE7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50aXR5TWV0YWRhdGFPcHRpb25zIGV4dGVuZHMgRW50aXR5UmF3TWV0YWRhdGFPcHRpb25zIHtcbiAgdGFibGU6IFRhYmxlO1xuICBjb25uZWN0aW9uOiBDb25uZWN0aW9uO1xuICBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVNZXRhZGF0YVR5cGVbXTtcbn1cblxuZXhwb3J0IGNsYXNzIEVudGl0eU1ldGFkYXRhIGV4dGVuZHMgQmFzZU1ldGFkYXRhIHtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuICByZWFkb25seSB0YWJsZTogVGFibGU7XG4gIHJlYWRvbmx5IHRhcmdldDogRW50aXR5VGFyZ2V0PGFueT47XG4gIHJlYWRvbmx5IGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZU1ldGFkYXRhVHlwZVtdO1xuICByZWFkb25seSBpbnRlcm5hbEF0dHJpYnV0ZXM6IEludGVybmFsQXR0cmlidXRlTWV0YWRhdGFbXTtcbiAgcmVhZG9ubHkgc2NoZW1hOiBEeW5hbW9FbnRpdHlTY2hlbWE7XG4gIGNvbnN0cnVjdG9yKHtcbiAgICBjb25uZWN0aW9uLFxuICAgIHRhYmxlLFxuICAgIG5hbWUsXG4gICAgdGFyZ2V0LFxuICAgIHByaW1hcnlLZXksXG4gICAgaW5kZXhlcyxcbiAgICBhdHRyaWJ1dGVzLFxuICB9OiBFbnRpdHlNZXRhZGF0YU9wdGlvbnMpIHtcbiAgICBzdXBlcihjb25uZWN0aW9uKTtcbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0O1xuICAgIHRoaXMuYXR0cmlidXRlcyA9IGF0dHJpYnV0ZXM7XG4gICAgdGhpcy50YWJsZSA9IHRhYmxlO1xuXG4gICAgLy8gYXV0byBwZXJzaXN0IGludGVybmFsIGF0dHJpYnV0ZXNcbiAgICB0aGlzLmludGVybmFsQXR0cmlidXRlcyA9IFtcbiAgICAgIG5ldyBJbnRlcm5hbEF0dHJpYnV0ZU1ldGFkYXRhKHtcbiAgICAgICAgbmFtZTogSU5URVJOQUxfRU5USVRZX0FUVFJJQlVURS5FTlRJVFlfTkFNRSxcbiAgICAgICAgdHlwZTogJ1N0cmluZycsXG4gICAgICAgIHZhbHVlOiB0aGlzLm5hbWUsXG4gICAgICB9KSxcbiAgICBdO1xuXG4gICAgLy8gdmFsaWRhdGUgYXR0cmlidXRlcyBhbmQga2V5IHR5cGUgcGFpclxuICAgIGNvbnN0IGF0dHJpYnV0ZXNLZXlUeXBlUGFpciA9IHRoaXMuYXR0cmlidXRlcy5yZWR1Y2UoKGFjYywgYXR0cikgPT4ge1xuICAgICAgdGhpcy52YWxpZGF0ZUF0dHJpYnV0ZU1ldGFkYXRhKGF0dHIpO1xuICAgICAgYWNjW2F0dHIubmFtZV0gPSBhdHRyLnR5cGU7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIHtba2V5OiBzdHJpbmddOiBzdHJpbmd9KTtcblxuICAgIHRoaXMuc2NoZW1hID0ge1xuICAgICAgcHJpbWFyeUtleTogYnVpbGRQcmltYXJ5S2V5U2NoZW1hKHtcbiAgICAgICAgdGFibGU6IHRoaXMudGFibGUsXG4gICAgICAgIHByaW1hcnlLZXksXG4gICAgICAgIGF0dHJpYnV0ZXM6IGF0dHJpYnV0ZXNLZXlUeXBlUGFpcixcbiAgICAgIH0pLFxuICAgICAgaW5kZXhlczogdGhpcy5idWlsZEluZGV4ZXNTY2hlbWEoe1xuICAgICAgICB0YWJsZTogdGhpcy50YWJsZSxcbiAgICAgICAgaW5kZXhlczogey4uLmluZGV4ZXN9LFxuICAgICAgICBhdHRyaWJ1dGVzOiBhdHRyaWJ1dGVzS2V5VHlwZVBhaXIsXG4gICAgICB9KSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZUF0dHJpYnV0ZU1ldGFkYXRhKFxuICAgIGF0dHJpYnV0ZVRvVmFsaWRhdGU6IEF0dHJpYnV0ZU1ldGFkYXRhVHlwZVxuICApIHtcbiAgICB0aGlzLmludGVybmFsQXR0cmlidXRlcy5mb3JFYWNoKGludGVybmFsQXR0ciA9PiB7XG4gICAgICBpZiAoYXR0cmlidXRlVG9WYWxpZGF0ZS5uYW1lID09PSBpbnRlcm5hbEF0dHIubmFtZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEF0dHJpYnV0ZSBuYW1lIFwiJHthdHRyaWJ1dGVUb1ZhbGlkYXRlLm5hbWV9XCIgaXMgcmVzZXJ2ZWQgYnkgVHlwZURPUk0gYW5kIGNhbm5vdCBiZSB1c2VkLmBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRJbmRleGVzU2NoZW1hKHtcbiAgICB0YWJsZSxcbiAgICBpbmRleGVzLFxuICAgIGF0dHJpYnV0ZXMsXG4gIH06IHtcbiAgICB0YWJsZTogVGFibGU7XG4gICAgaW5kZXhlczogSW5kZXhlcztcbiAgICBhdHRyaWJ1dGVzOiB7W2tleTogc3RyaW5nXTogc3RyaW5nfTtcbiAgfSk6IER5bmFtb0VudGl0eUluZGV4ZXNTY2hlbWEge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhpbmRleGVzKS5yZWR1Y2UoKGFjYywga2V5KSA9PiB7XG4gICAgICBjb25zdCB0YWJsZUluZGV4U2lnbmF0dXJlID0gdGFibGUuZ2V0SW5kZXhCeUtleShrZXkpO1xuICAgICAgaWYgKCF0YWJsZUluZGV4U2lnbmF0dXJlKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgTm8gbWF0Y2hpbmcgaW5kZXggc2lnbmF0dXJlIGZvdW5kIGZvciBpbmRleCBcIiR7a2V5fVwiIGluIHRhYmxlIFwiJHt0YWJsZS5uYW1lfVwiYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBjdXJyZW50SW5kZXggPSBpbmRleGVzW2tleV07XG5cbiAgICAgIHZhbGlkYXRlS2V5KGN1cnJlbnRJbmRleC5zb3J0S2V5LCBhdHRyaWJ1dGVzLCB0aGlzLm5hbWUpO1xuICAgICAgLy8gdmFsaWRhdGVzIGFuZCBnZXRzIGFuZCBmaWxsIHNldCBpbmRleGVzIGludGVycG9sYXRpb25zIG9mIHNvcnQga2V5XG4gICAgICBjb25zdCBzb3J0S2V5SW50ZXJwb2xhdGlvbnMgPSBnZXRJbnRlcnBvbGF0ZWRLZXlzKGN1cnJlbnRJbmRleC5zb3J0S2V5KTtcblxuICAgICAgaWYgKHRhYmxlSW5kZXhTaWduYXR1cmUudHlwZSA9PT0gSU5ERVhfVFlQRS5MU0kpIHtcbiAgICAgICAgaWYgKGN1cnJlbnRJbmRleC50eXBlICE9PSBJTkRFWF9UWVBFLkxTSSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW5kZXggc2lnbmF0dXJlIG1pc21hdGNoLicpO1xuICAgICAgICB9XG4gICAgICAgIGFjY1trZXldID0ge1xuICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgIFt0YWJsZUluZGV4U2lnbmF0dXJlLnNvcnRLZXldOiBjdXJyZW50SW5kZXguc29ydEtleSxcbiAgICAgICAgICB9LFxuICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICB0eXBlOiB0YWJsZUluZGV4U2lnbmF0dXJlLnR5cGUsXG4gICAgICAgICAgICBpc1NwYXJzZTpcbiAgICAgICAgICAgICAgY3VycmVudEluZGV4LmlzU3BhcnNlID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgICAgY3VycmVudEluZGV4LmlzU3BhcnNlID09PSBudWxsXG4gICAgICAgICAgICAgICAgPyB0cnVlIC8vIGJ5IGRlZmF1bHQgYWxsIGluZGV4ZXMgYXJlIHNwYXJzZVxuICAgICAgICAgICAgICAgIDogISFjdXJyZW50SW5kZXguaXNTcGFyc2UsXG4gICAgICAgICAgICBfbmFtZToga2V5LFxuICAgICAgICAgICAgX2ludGVycG9sYXRpb25zOiB7XG4gICAgICAgICAgICAgIFt0YWJsZUluZGV4U2lnbmF0dXJlLnNvcnRLZXldOiBzb3J0S2V5SW50ZXJwb2xhdGlvbnMsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChjdXJyZW50SW5kZXgudHlwZSAhPT0gSU5ERVhfVFlQRS5HU0kpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0luZGV4IHNpZ25hdHVyZSBtaXNtYXRjaC4nKTtcbiAgICAgICAgfVxuICAgICAgICB2YWxpZGF0ZUtleShjdXJyZW50SW5kZXgucGFydGl0aW9uS2V5LCBhdHRyaWJ1dGVzKTtcbiAgICAgICAgLy8gdmFsaWRhdGVzIGFuZCBnZXRzIGFuZCBmaWxsIHNldCBpbmRleGVzIGludGVycG9sYXRpb25zIG9mIHBhcnRpdGlvbiBrZXlcbiAgICAgICAgY29uc3QgcGFydGl0aW9uS2V5SW50ZXJwb2xhdGlvbnMgPSBnZXRJbnRlcnBvbGF0ZWRLZXlzKFxuICAgICAgICAgIGN1cnJlbnRJbmRleC5wYXJ0aXRpb25LZXlcbiAgICAgICAgKTtcblxuICAgICAgICBhY2Nba2V5XSA9IHtcbiAgICAgICAgICBhdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICBbdGFibGVJbmRleFNpZ25hdHVyZS5wYXJ0aXRpb25LZXldOiBjdXJyZW50SW5kZXgucGFydGl0aW9uS2V5LFxuICAgICAgICAgICAgW3RhYmxlSW5kZXhTaWduYXR1cmUuc29ydEtleV06IGN1cnJlbnRJbmRleC5zb3J0S2V5LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIGlzU3BhcnNlOlxuICAgICAgICAgICAgICBjdXJyZW50SW5kZXguaXNTcGFyc2UgPT09IHVuZGVmaW5lZCB8fFxuICAgICAgICAgICAgICBjdXJyZW50SW5kZXguaXNTcGFyc2UgPT09IG51bGxcbiAgICAgICAgICAgICAgICA/IHRydWUgLy8gYnkgZGVmYXVsdCBhbGwgaW5kZXhlcyBhcmUgc3BhcnNlXG4gICAgICAgICAgICAgICAgOiAhIWN1cnJlbnRJbmRleC5pc1NwYXJzZSxcbiAgICAgICAgICAgIHR5cGU6IHRhYmxlSW5kZXhTaWduYXR1cmUudHlwZSxcbiAgICAgICAgICAgIF9uYW1lOiBrZXksXG4gICAgICAgICAgICAvLyByZW1vdmUgYW55IGR1cGxpY2F0ZXMgZnJvbSBwYXJ0aXRpb24gb3Igc29ydCBrZXlzXG4gICAgICAgICAgICBfaW50ZXJwb2xhdGlvbnM6IHtcbiAgICAgICAgICAgICAgW3RhYmxlSW5kZXhTaWduYXR1cmUucGFydGl0aW9uS2V5XTogcGFydGl0aW9uS2V5SW50ZXJwb2xhdGlvbnMsXG4gICAgICAgICAgICAgIFt0YWJsZUluZGV4U2lnbmF0dXJlLnNvcnRLZXldOiBzb3J0S2V5SW50ZXJwb2xhdGlvbnMsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9XG4gICAgfSwge30gYXMgRHluYW1vRW50aXR5SW5kZXhlc1NjaGVtYSk7XG4gIH1cbn1cbiJdfQ==