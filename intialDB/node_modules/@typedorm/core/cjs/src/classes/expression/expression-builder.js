"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExpressionBuilder = void 0;
const is_empty_object_1 = require("../../helpers/is-empty-object");
const base_expression_input_1 = require("./base-expression-input");
const condition_1 = require("./condition");
class ExpressionBuilder {
    andMergeConditionExpressions(existingExp, newExp) {
        if (existingExp.ConditionExpression && !newExp.ConditionExpression) {
            return this.removeEmptyFieldsAndReturn(existingExp);
        }
        if (newExp.ConditionExpression && !existingExp.ConditionExpression) {
            return this.removeEmptyFieldsAndReturn(newExp);
        }
        if (!newExp && !existingExp) {
            return {};
        }
        const mergedExp = {
            ConditionExpression: `(${existingExp.ConditionExpression}) AND (${newExp.ConditionExpression})`,
            ExpressionAttributeNames: Object.assign(Object.assign({}, existingExp.ExpressionAttributeNames), newExp.ExpressionAttributeNames),
            ExpressionAttributeValues: Object.assign(Object.assign({}, existingExp.ExpressionAttributeValues), newExp.ExpressionAttributeValues),
        };
        return this.removeEmptyFieldsAndReturn(mergedExp);
    }
    /**
     * Higher level function to build unique record condition expression
     * @param table table to build unique record expression for
     */
    buildUniqueRecordConditionExpression(table) {
        const uniqueRecordCondition = table.usesCompositeKey()
            ? new condition_1.Condition()
                .attributeNotExist(table.partitionKey)
                .merge(new condition_1.Condition().attributeNotExist(table.sortKey), base_expression_input_1.MERGE_STRATEGY.AND)
            : new condition_1.Condition().attributeNotExist(table.partitionKey);
        const expression = this.buildConditionExpression(uniqueRecordCondition);
        return this.removeEmptyFieldsAndReturn(expression);
    }
    buildConditionExpression(condition) {
        if (!condition.expression) {
            return {};
        }
        const expression = {
            ConditionExpression: condition.expression.trim(),
            ExpressionAttributeNames: condition.names,
            ExpressionAttributeValues: condition.values,
        };
        return this.removeEmptyFieldsAndReturn(expression);
    }
    buildProjectionExpression(projection) {
        if (!projection.expression) {
            return {};
        }
        const expression = {
            ProjectionExpression: projection.expression.trim(),
            ExpressionAttributeNames: projection.names,
        };
        return this.removeEmptyFieldsAndReturn(expression);
    }
    buildUpdateExpression(update) {
        if (!update.expression) {
            return {};
        }
        const expression = {
            UpdateExpression: update.expression.trim(),
            ExpressionAttributeNames: update.names,
            ExpressionAttributeValues: update.values,
        };
        return this.removeEmptyFieldsAndReturn(expression);
    }
    buildKeyConditionExpression(condition) {
        if (!condition.expression) {
            return {};
        }
        const expression = {
            KeyConditionExpression: condition.expression.trim(),
            ExpressionAttributeNames: condition.names,
            ExpressionAttributeValues: condition.values,
        };
        return this.removeEmptyFieldsAndReturn(expression);
    }
    buildFilterExpression(filter) {
        if (!filter.expression) {
            return {};
        }
        const expression = {
            FilterExpression: filter.expression.trim(),
            ExpressionAttributeNames: filter.names,
            ExpressionAttributeValues: filter.values,
        };
        return this.removeEmptyFieldsAndReturn(expression);
    }
    removeEmptyFieldsAndReturn(expression) {
        if ((0, is_empty_object_1.isEmptyObject)(expression.ExpressionAttributeNames)) {
            delete expression.ExpressionAttributeNames;
        }
        if ((0, is_empty_object_1.isEmptyObject)(expression.ExpressionAttributeValues)) {
            delete expression.ExpressionAttributeValues;
        }
        return expression;
    }
}
exports.ExpressionBuilder = ExpressionBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXhwcmVzc2lvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy9leHByZXNzaW9uL2V4cHJlc3Npb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxtRUFBNEQ7QUFDNUQsbUVBQXVEO0FBQ3ZELDJDQUFzQztBQU10QyxNQUFhLGlCQUFpQjtJQUM1Qiw0QkFBNEIsQ0FDMUIsV0FJQyxFQUNELE1BSUM7UUFFRCxJQUFJLFdBQVcsQ0FBQyxtQkFBbUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsRUFBRTtZQUNsRSxPQUFPLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxXQUFXLENBQUMsQ0FBQztTQUNyRDtRQUVELElBQUksTUFBTSxDQUFDLG1CQUFtQixJQUFJLENBQUMsV0FBVyxDQUFDLG1CQUFtQixFQUFFO1lBQ2xFLE9BQU8sSUFBSSxDQUFDLDBCQUEwQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hEO1FBRUQsSUFBSSxDQUFDLE1BQU0sSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUMzQixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsTUFBTSxTQUFTLEdBQUc7WUFDaEIsbUJBQW1CLEVBQUUsSUFBSSxXQUFXLENBQUMsbUJBQW1CLFVBQVUsTUFBTSxDQUFDLG1CQUFtQixHQUFHO1lBQy9GLHdCQUF3QixrQ0FDbkIsV0FBVyxDQUFDLHdCQUF3QixHQUNwQyxNQUFNLENBQUMsd0JBQXdCLENBQ25DO1lBQ0QseUJBQXlCLGtDQUNwQixXQUFXLENBQUMseUJBQXlCLEdBQ3JDLE1BQU0sQ0FBQyx5QkFBeUIsQ0FDcEM7U0FDRixDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsMEJBQTBCLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVEOzs7T0FHRztJQUNILG9DQUFvQyxDQUFDLEtBQVk7UUFDL0MsTUFBTSxx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RU8sMEJBQTBCLENBQUMsVUFJbEM7UUFDQyxJQUFJLElBQUEsK0JBQWEsRUFBQyxVQUFVLENBQUMsd0JBQXdCLENBQUMsRUFBRTtZQUN0RCxPQUFPLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQztTQUM1QztRQUVELElBQUksSUFBQSwrQkFBYSxFQUFDLFVBQVUsQ0FBQyx5QkFBeUIsQ0FBQyxFQUFFO1lBQ3ZELE9BQU8sVUFBVSxDQUFDLHlCQUF5QixDQUFDO1NBQzdDO1FBQ0QsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBekpELDhDQXlKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7VGFibGV9IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtpc0VtcHR5T2JqZWN0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLWVtcHR5LW9iamVjdCc7XG5pbXBvcnQge01FUkdFX1NUUkFURUdZfSBmcm9tICcuL2Jhc2UtZXhwcmVzc2lvbi1pbnB1dCc7XG5pbXBvcnQge0NvbmRpdGlvbn0gZnJvbSAnLi9jb25kaXRpb24nO1xuaW1wb3J0IHtGaWx0ZXJ9IGZyb20gJy4vZmlsdGVyJztcbmltcG9ydCB7S2V5Q29uZGl0aW9ufSBmcm9tICcuL2tleS1jb25kaXRpb24nO1xuaW1wb3J0IHtQcm9qZWN0aW9ufSBmcm9tICcuL3Byb2plY3Rpb24nO1xuaW1wb3J0IHtVcGRhdGV9IGZyb20gJy4vdXBkYXRlL3VwZGF0ZSc7XG5cbmV4cG9ydCBjbGFzcyBFeHByZXNzaW9uQnVpbGRlciB7XG4gIGFuZE1lcmdlQ29uZGl0aW9uRXhwcmVzc2lvbnMoXG4gICAgZXhpc3RpbmdFeHA6IHtcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb24/OiBzdHJpbmc7XG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM/OiBhbnk7XG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzPzogYW55O1xuICAgIH0sXG4gICAgbmV3RXhwOiB7XG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uPzogc3RyaW5nO1xuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzPzogYW55O1xuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcz86IGFueTtcbiAgICB9XG4gICkge1xuICAgIGlmIChleGlzdGluZ0V4cC5Db25kaXRpb25FeHByZXNzaW9uICYmICFuZXdFeHAuQ29uZGl0aW9uRXhwcmVzc2lvbikge1xuICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlRW1wdHlGaWVsZHNBbmRSZXR1cm4oZXhpc3RpbmdFeHApO1xuICAgIH1cblxuICAgIGlmIChuZXdFeHAuQ29uZGl0aW9uRXhwcmVzc2lvbiAmJiAhZXhpc3RpbmdFeHAuQ29uZGl0aW9uRXhwcmVzc2lvbikge1xuICAgICAgcmV0dXJuIHRoaXMucmVtb3ZlRW1wdHlGaWVsZHNBbmRSZXR1cm4obmV3RXhwKTtcbiAgICB9XG5cbiAgICBpZiAoIW5ld0V4cCAmJiAhZXhpc3RpbmdFeHApIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBtZXJnZWRFeHAgPSB7XG4gICAgICBDb25kaXRpb25FeHByZXNzaW9uOiBgKCR7ZXhpc3RpbmdFeHAuQ29uZGl0aW9uRXhwcmVzc2lvbn0pIEFORCAoJHtuZXdFeHAuQ29uZGl0aW9uRXhwcmVzc2lvbn0pYCxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAuLi5leGlzdGluZ0V4cC5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgIC4uLm5ld0V4cC5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAuLi5leGlzdGluZ0V4cC5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAuLi5uZXdFeHAuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnJlbW92ZUVtcHR5RmllbGRzQW5kUmV0dXJuKG1lcmdlZEV4cCk7XG4gIH1cblxuICAvKipcbiAgICogSGlnaGVyIGxldmVsIGZ1bmN0aW9uIHRvIGJ1aWxkIHVuaXF1ZSByZWNvcmQgY29uZGl0aW9uIGV4cHJlc3Npb25cbiAgICogQHBhcmFtIHRhYmxlIHRhYmxlIHRvIGJ1aWxkIHVuaXF1ZSByZWNvcmQgZXhwcmVzc2lvbiBmb3JcbiAgICovXG4gIGJ1aWxkVW5pcXVlUmVjb3JkQ29uZGl0aW9uRXhwcmVzc2lvbih0YWJsZTogVGFibGUpIHtcbiAgICBjb25zdCB1bmlxdWVSZWNvcmRDb25kaXRpb24gPSB0YWJsZS51c2VzQ29tcG9zaXRlS2V5KClcbiAgICAgID8gbmV3IENvbmRpdGlvbigpXG4gICAgICAgICAgLmF0dHJpYnV0ZU5vdEV4aXN0KHRhYmxlLnBhcnRpdGlvbktleSlcbiAgICAgICAgICAubWVyZ2UoXG4gICAgICAgICAgICBuZXcgQ29uZGl0aW9uKCkuYXR0cmlidXRlTm90RXhpc3QodGFibGUuc29ydEtleSksXG4gICAgICAgICAgICBNRVJHRV9TVFJBVEVHWS5BTkRcbiAgICAgICAgICApXG4gICAgICA6IG5ldyBDb25kaXRpb24oKS5hdHRyaWJ1dGVOb3RFeGlzdCh0YWJsZS5wYXJ0aXRpb25LZXkpO1xuXG4gICAgY29uc3QgZXhwcmVzc2lvbiA9IHRoaXMuYnVpbGRDb25kaXRpb25FeHByZXNzaW9uKHVuaXF1ZVJlY29yZENvbmRpdGlvbik7XG4gICAgcmV0dXJuIHRoaXMucmVtb3ZlRW1wdHlGaWVsZHNBbmRSZXR1cm4oZXhwcmVzc2lvbik7XG4gIH1cblxuICBidWlsZENvbmRpdGlvbkV4cHJlc3Npb24oY29uZGl0aW9uOiBDb25kaXRpb24pOiB7XG4gICAgQ29uZGl0aW9uRXhwcmVzc2lvbj86IHN0cmluZztcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICB9IHtcbiAgICBpZiAoIWNvbmRpdGlvbi5leHByZXNzaW9uKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3QgZXhwcmVzc2lvbiA9IHtcbiAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246IGNvbmRpdGlvbi5leHByZXNzaW9uLnRyaW0oKSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogY29uZGl0aW9uLm5hbWVzLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogY29uZGl0aW9uLnZhbHVlcyxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHRoaXMucmVtb3ZlRW1wdHlGaWVsZHNBbmRSZXR1cm4oZXhwcmVzc2lvbik7XG4gIH1cblxuICBidWlsZFByb2plY3Rpb25FeHByZXNzaW9uKHByb2plY3Rpb246IFByb2plY3Rpb24pOiB7XG4gICAgUHJvamVjdGlvbkV4cHJlc3Npb24/OiBzdHJpbmc7XG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgfSB7XG4gICAgaWYgKCFwcm9qZWN0aW9uLmV4cHJlc3Npb24pIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBleHByZXNzaW9uID0ge1xuICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb246IHByb2plY3Rpb24uZXhwcmVzc2lvbi50cmltKCksXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHByb2plY3Rpb24ubmFtZXMsXG4gICAgfTtcblxuICAgIHJldHVybiB0aGlzLnJlbW92ZUVtcHR5RmllbGRzQW5kUmV0dXJuKGV4cHJlc3Npb24pO1xuICB9XG5cbiAgYnVpbGRVcGRhdGVFeHByZXNzaW9uKHVwZGF0ZTogVXBkYXRlKSB7XG4gICAgaWYgKCF1cGRhdGUuZXhwcmVzc2lvbikge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cblxuICAgIGNvbnN0IGV4cHJlc3Npb24gPSB7XG4gICAgICBVcGRhdGVFeHByZXNzaW9uOiB1cGRhdGUuZXhwcmVzc2lvbi50cmltKCksXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHVwZGF0ZS5uYW1lcyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHVwZGF0ZS52YWx1ZXMsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5yZW1vdmVFbXB0eUZpZWxkc0FuZFJldHVybihleHByZXNzaW9uKTtcbiAgfVxuXG4gIGJ1aWxkS2V5Q29uZGl0aW9uRXhwcmVzc2lvbihjb25kaXRpb246IEtleUNvbmRpdGlvbik6IHtcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uPzogc3RyaW5nO1xuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIH0ge1xuICAgIGlmICghY29uZGl0aW9uLmV4cHJlc3Npb24pIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBleHByZXNzaW9uID0ge1xuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogY29uZGl0aW9uLmV4cHJlc3Npb24udHJpbSgpLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBjb25kaXRpb24ubmFtZXMsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBjb25kaXRpb24udmFsdWVzLFxuICAgIH07XG4gICAgcmV0dXJuIHRoaXMucmVtb3ZlRW1wdHlGaWVsZHNBbmRSZXR1cm4oZXhwcmVzc2lvbik7XG4gIH1cblxuICBidWlsZEZpbHRlckV4cHJlc3Npb24oZmlsdGVyOiBGaWx0ZXIpOiB7XG4gICAgRmlsdGVyRXhwcmVzc2lvbj86IHN0cmluZztcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICB9IHtcbiAgICBpZiAoIWZpbHRlci5leHByZXNzaW9uKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgY29uc3QgZXhwcmVzc2lvbiA9IHtcbiAgICAgIEZpbHRlckV4cHJlc3Npb246IGZpbHRlci5leHByZXNzaW9uLnRyaW0oKSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogZmlsdGVyLm5hbWVzLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZmlsdGVyLnZhbHVlcyxcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLnJlbW92ZUVtcHR5RmllbGRzQW5kUmV0dXJuKGV4cHJlc3Npb24pO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFbXB0eUZpZWxkc0FuZFJldHVybihleHByZXNzaW9uOiB7XG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XG4gIH0pIHtcbiAgICBpZiAoaXNFbXB0eU9iamVjdChleHByZXNzaW9uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcykpIHtcbiAgICAgIGRlbGV0ZSBleHByZXNzaW9uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcztcbiAgICB9XG5cbiAgICBpZiAoaXNFbXB0eU9iamVjdChleHByZXNzaW9uLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMpKSB7XG4gICAgICBkZWxldGUgZXhwcmVzc2lvbi5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzO1xuICAgIH1cbiAgICByZXR1cm4gZXhwcmVzc2lvbjtcbiAgfVxufVxuIl19