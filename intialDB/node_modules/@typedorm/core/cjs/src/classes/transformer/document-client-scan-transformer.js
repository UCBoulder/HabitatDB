"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentClientScanTransformer = void 0;
const common_1 = require("@typedorm/common");
const is_empty_object_1 = require("../../helpers/is-empty-object");
const base_expression_input_1 = require("../expression/base-expression-input");
const filter_1 = require("../expression/filter");
const low_order_transformers_1 = require("./low-order-transformers");
class DocumentClientScanTransformer extends low_order_transformers_1.LowOrderTransformers {
    constructor(connection) {
        super(connection);
    }
    /**
     * Transforms TypeDORM input into dynamo scan operation input
     */
    toDynamoScanItem(scanOptions, metadataOptions) {
        var _a;
        this.connection.logger.logTransformScan({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_SCAN_TYPE.SCAN,
            prefix: 'Before',
            options: scanOptions,
        });
        const tableToScan = (scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.entity)
            ? (_a = this.connection.getEntityByTarget(scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.entity)) === null || _a === void 0 ? void 0 : _a.table
            : this.connection.table;
        let verifiedIndexToScan;
        // validate if index requested to scan belongs to current resolved table
        if (scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.scanIndex) {
            const scanIndexOptions = tableToScan.getIndexByKey(scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.scanIndex);
            if (!scanIndexOptions) {
                throw new common_1.NoSuchIndexFoundError(tableToScan.name, scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.scanIndex);
            }
        }
        let transformedScanInput = {
            TableName: tableToScan.name,
            IndexName: verifiedIndexToScan,
            ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
        };
        // transform additional options
        if (scanOptions && !(0, is_empty_object_1.isEmptyObject)(scanOptions)) {
            const { cursor, limit, where, onlyCount, select, entity } = scanOptions;
            transformedScanInput.Limit = limit;
            transformedScanInput.ExclusiveStartKey = cursor;
            // check if only the count was requested
            if (onlyCount) {
                if (select === null || select === void 0 ? void 0 : select.length) {
                    throw new Error('Attributes projection and count can not be used together');
                }
                // count and projection selection can not be used together
                transformedScanInput.Select = common_1.QUERY_SELECT_TYPE.COUNT;
            }
            // entity filter
            let entityFilter = undefined;
            if (entity) {
                const metadata = this.connection.getEntityByTarget(entity);
                if (!metadata) {
                    throw new common_1.NoSuchEntityExistsError(entity.name);
                }
                // build current entity filter
                entityFilter = this.expressionInputParser.parseToFilter({
                    [common_1.INTERNAL_ENTITY_ATTRIBUTE.ENTITY_NAME]: {
                        EQ: metadata.name,
                    },
                });
            }
            // build filter expression
            let optionsFilter = undefined;
            if (where && !(0, is_empty_object_1.isEmptyObject)(where)) {
                const inputFilter = this.expressionInputParser.parseToFilter(where);
                if (!inputFilter) {
                    throw new common_1.InvalidFilterInputError(where);
                }
                optionsFilter = inputFilter;
            }
            // merge filters of fall back to none
            let filter;
            if (entityFilter && optionsFilter) {
                filter = new filter_1.Filter().mergeMany([entityFilter, optionsFilter], base_expression_input_1.MERGE_STRATEGY.AND);
            }
            else {
                filter = entityFilter || optionsFilter || null; // if non of the condition skip it all together
            }
            // if at least one condition was truthy, parse it and include it in the input
            if (filter) {
                const { FilterExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildFilterExpression(filter);
                transformedScanInput = Object.assign(Object.assign({}, transformedScanInput), { FilterExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, transformedScanInput.ExpressionAttributeNames), ExpressionAttributeNames), ExpressionAttributeValues: Object.assign(Object.assign({}, transformedScanInput.ExpressionAttributeValues), ExpressionAttributeValues) });
            }
            // projection builder
            if (select === null || select === void 0 ? void 0 : select.length) {
                const projection = this.expressionInputParser.parseToProjection(select);
                if (!projection) {
                    throw new common_1.InvalidSelectInputError(select);
                }
                const { ProjectionExpression, ExpressionAttributeNames } = this.expressionBuilder.buildProjectionExpression(projection);
                transformedScanInput = Object.assign(Object.assign({}, transformedScanInput), { ProjectionExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, transformedScanInput.ExpressionAttributeNames), ExpressionAttributeNames) });
            }
        }
        // validate value for segment and totalSegment before appending
        if ((scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments) !== undefined &&
            (scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments) !== null) {
            if ((scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments) === 0) {
                throw new Error(`Invalid scan option totalSegment: ${scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments}.
        totalSegments is optional, but when provided it's value must be greater than 0.`);
            }
            if ((scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment) === undefined || (scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment) === null) {
                throw new Error(`Invalid scan option segment: ${scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment}.
        When totalSegments value is defined, value for option 'segment' must also be defined.`);
            }
            if ((scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment) >= (scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments)) {
                throw new Error(`Invalid scan option segment: ${scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment}.
        When totalSegments value is defined, value for option 'segment' must be one less than totalSegment size.`);
            }
            transformedScanInput.TotalSegments = scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.totalSegments;
            transformedScanInput.Segment = scanOptions === null || scanOptions === void 0 ? void 0 : scanOptions.segment;
        }
        this.connection.logger.logTransformScan({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            prefix: 'After',
            operation: common_1.TRANSFORM_SCAN_TYPE.SCAN,
            body: transformedScanInput,
        });
        return transformedScanInput;
    }
    /**
     * Transforms DynamoDB scan output into entities
     */
    fromDynamoScanResponseItemList(itemList, metadataOptions) {
        const initialResponse = {
            items: [],
            unknownItems: [],
        };
        if (!itemList.length) {
            return initialResponse;
        }
        return itemList.reduce((acc, responseItem) => {
            const entityPhysicalName = responseItem[common_1.INTERNAL_ENTITY_ATTRIBUTE.ENTITY_NAME];
            // early return if no entity metadata was found on item
            if (!entityPhysicalName) {
                acc.unknownItems.push(responseItem);
                return acc;
            }
            const entityMetadata = this.connection.getEntityByPhysicalName(entityPhysicalName);
            const reverseTransformedItem = this.fromDynamoEntity(entityMetadata.target, responseItem, metadataOptions);
            acc.items.push(reverseTransformedItem);
            return acc;
        }, initialResponse);
    }
}
exports.DocumentClientScanTransformer = DocumentClientScanTransformer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LXNjYW4tdHJhbnNmb3JtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9jbGFzc2VzL3RyYW5zZm9ybWVyL2RvY3VtZW50LWNsaWVudC1zY2FuLXRyYW5zZm9ybWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDZDQVMwQjtBQUMxQixtRUFBNEQ7QUFFNUQsK0VBQW1FO0FBQ25FLGlEQUE0QztBQUU1QyxxRUFBOEQ7QUFjOUQsTUFBYSw2QkFBOEIsU0FBUSw2Q0FBb0I7SUFDckUsWUFBWSxVQUFzQjtRQUNoQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCLENBQ2QsV0FBZ0QsRUFDaEQsZUFBaUM7O1FBRWpDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ3RDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztZQUNyQyxTQUFTLEVBQUUsNEJBQW1CLENBQUMsSUFBSTtZQUNuQyxNQUFNLEVBQUUsUUFBUTtZQUNoQixPQUFPLEVBQUUsV0FBVztTQUNyQixDQUFDLENBQUM7UUFFSCxNQUFNLFdBQVcsR0FBRyxDQUFBLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxNQUFNO1lBQ3JDLENBQUMsQ0FBQyxNQUFBLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsV0FBVyxhQUFYLFdBQVcsdUJBQVgsV0FBVyxDQUFFLE1BQU0sQ0FBQywwQ0FBRSxLQUFLO1lBQy9ELENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztRQUUxQixJQUFJLG1CQUF1QyxDQUFDO1FBQzVDLHdFQUF3RTtRQUN4RSxJQUFJLFdBQVcsYUFBWCxXQUFXLHVCQUFYLFdBQVcsQ0FBRSxTQUFT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LEVBQUUsRUFBRTtZQUNULFlBQVksRUFBRSxFQUFFO1NBQ2pCLENBQUM7UUFFRixJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRTtZQUNwQixPQUFPLGVBQWUsQ0FBQztTQUN4QjtRQUVELE9BQU8sUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQTJCLEVBQUUsWUFBWSxFQUFFLEVBQUU7WUFDbkUsTUFBTSxrQkFBa0IsR0FDdEIsWUFBWSxDQUFDLGtDQUF5QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXRELHVEQUF1RDtZQUN2RCxJQUFJLENBQUMsa0JBQWtCLEVBQUU7Z0JBQ3ZCLEdBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO2dCQUNwQyxPQUFPLEdBQUcsQ0FBQzthQUNaO1lBRUQsTUFBTSxjQUFjLEdBQ2xCLElBQUksQ0FBQyxVQUFVLENBQUMsdUJBQXVCLENBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUU5RCxNQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FDbEQsY0FBYyxDQUFDLE1BQU0sRUFDckIsWUFBWSxFQUNaLGVBQWUsQ0FDaEIsQ0FBQztZQUVGLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7WUFFdkMsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBN05ELHNFQTZOQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7RG9jdW1lbnRDbGllbnRUeXBlc30gZnJvbSAnQHR5cGVkb3JtL2RvY3VtZW50LWNsaWVudCc7XG5pbXBvcnQge1xuICBFbnRpdHlUYXJnZXQsXG4gIElOVEVSTkFMX0VOVElUWV9BVFRSSUJVVEUsXG4gIEludmFsaWRGaWx0ZXJJbnB1dEVycm9yLFxuICBJbnZhbGlkU2VsZWN0SW5wdXRFcnJvcixcbiAgTm9TdWNoRW50aXR5RXhpc3RzRXJyb3IsXG4gIE5vU3VjaEluZGV4Rm91bmRFcnJvcixcbiAgUVVFUllfU0VMRUNUX1RZUEUsXG4gIFRSQU5TRk9STV9TQ0FOX1RZUEUsXG59IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtpc0VtcHR5T2JqZWN0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLWVtcHR5LW9iamVjdCc7XG5pbXBvcnQge0Nvbm5lY3Rpb259IGZyb20gJy4uL2Nvbm5lY3Rpb24vY29ubmVjdGlvbic7XG5pbXBvcnQge01FUkdFX1NUUkFURUdZfSBmcm9tICcuLi9leHByZXNzaW9uL2Jhc2UtZXhwcmVzc2lvbi1pbnB1dCc7XG5pbXBvcnQge0ZpbHRlcn0gZnJvbSAnLi4vZXhwcmVzc2lvbi9maWx0ZXInO1xuaW1wb3J0IHtNZXRhZGF0YU9wdGlvbnN9IGZyb20gJy4vYmFzZS10cmFuc2Zvcm1lcic7XG5pbXBvcnQge0xvd09yZGVyVHJhbnNmb3JtZXJzfSBmcm9tICcuL2xvdy1vcmRlci10cmFuc2Zvcm1lcnMnO1xuXG5pbnRlcmZhY2UgU2NhblRyYW5zZm9ybWVyVG9EeW5hbW9TY2FuT3B0aW9ucyB7XG4gIGVudGl0eT86IEVudGl0eVRhcmdldDxhbnk+O1xuICBzY2FuSW5kZXg/OiBzdHJpbmc7XG4gIGxpbWl0PzogbnVtYmVyO1xuICBjdXJzb3I/OiBEb2N1bWVudENsaWVudFR5cGVzLktleTtcbiAgd2hlcmU/OiBhbnk7XG4gIHNlbGVjdD86IGFueVtdO1xuICBvbmx5Q291bnQ/OiBib29sZWFuO1xuICBzZWdtZW50PzogbnVtYmVyOyAvLyBjdXJyZW50IHNlZ21lbnRcbiAgdG90YWxTZWdtZW50cz86IG51bWJlcjsgLy8gdG90YWwgc2VnbWVudHMgdGhhdCB0aGlzIHBhcmFsbGVsIHNjYW4gd2lsbCBiZSBkaXZpZGVkIGluXG59XG5cbmV4cG9ydCBjbGFzcyBEb2N1bWVudENsaWVudFNjYW5UcmFuc2Zvcm1lciBleHRlbmRzIExvd09yZGVyVHJhbnNmb3JtZXJzIHtcbiAgY29uc3RydWN0b3IoY29ubmVjdGlvbjogQ29ubmVjdGlvbikge1xuICAgIHN1cGVyKGNvbm5lY3Rpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgVHlwZURPUk0gaW5wdXQgaW50byBkeW5hbW8gc2NhbiBvcGVyYXRpb24gaW5wdXRcbiAgICovXG4gIHRvRHluYW1vU2Nhbkl0ZW0oXG4gICAgc2Nhbk9wdGlvbnM/OiBTY2FuVHJhbnNmb3JtZXJUb0R5bmFtb1NjYW5PcHRpb25zLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApOiBEb2N1bWVudENsaWVudFR5cGVzLlNjYW5JbnB1dCB7XG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1TY2FuKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9TQ0FOX1RZUEUuU0NBTixcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBvcHRpb25zOiBzY2FuT3B0aW9ucyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHRhYmxlVG9TY2FuID0gc2Nhbk9wdGlvbnM/LmVudGl0eVxuICAgICAgPyB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoc2Nhbk9wdGlvbnM/LmVudGl0eSk/LnRhYmxlXG4gICAgICA6IHRoaXMuY29ubmVjdGlvbi50YWJsZTtcblxuICAgIGxldCB2ZXJpZmllZEluZGV4VG9TY2FuOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgLy8gdmFsaWRhdGUgaWYgaW5kZXggcmVxdWVzdGVkIHRvIHNjYW4gYmVsb25ncyB0byBjdXJyZW50IHJlc29sdmVkIHRhYmxlXG4gICAgaWYgKHNjYW5PcHRpb25zPy5zY2FuSW5kZXgpIHtcbiAgICAgIGNvbnN0IHNjYW5JbmRleE9wdGlvbnMgPSB0YWJsZVRvU2Nhbi5nZXRJbmRleEJ5S2V5KFxuICAgICAgICBzY2FuT3B0aW9ucz8uc2NhbkluZGV4XG4gICAgICApO1xuICAgICAgaWYgKCFzY2FuSW5kZXhPcHRpb25zKSB7XG4gICAgICAgIHRocm93IG5ldyBOb1N1Y2hJbmRleEZvdW5kRXJyb3IoXG4gICAgICAgICAgdGFibGVUb1NjYW4ubmFtZSxcbiAgICAgICAgICBzY2FuT3B0aW9ucz8uc2NhbkluZGV4XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IHRyYW5zZm9ybWVkU2NhbklucHV0OiBEb2N1bWVudENsaWVudFR5cGVzLlNjYW5JbnB1dCA9IHtcbiAgICAgIFRhYmxlTmFtZTogdGFibGVUb1NjYW4ubmFtZSxcbiAgICAgIEluZGV4TmFtZTogdmVyaWZpZWRJbmRleFRvU2NhbixcbiAgICAgIFJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICB9O1xuXG4gICAgLy8gdHJhbnNmb3JtIGFkZGl0aW9uYWwgb3B0aW9uc1xuICAgIGlmIChzY2FuT3B0aW9ucyAmJiAhaXNFbXB0eU9iamVjdChzY2FuT3B0aW9ucykpIHtcbiAgICAgIGNvbnN0IHtjdXJzb3IsIGxpbWl0LCB3aGVyZSwgb25seUNvdW50LCBzZWxlY3QsIGVudGl0eX0gPSBzY2FuT3B0aW9ucztcblxuICAgICAgdHJhbnNmb3JtZWRTY2FuSW5wdXQuTGltaXQgPSBsaW1pdDtcbiAgICAgIHRyYW5zZm9ybWVkU2NhbklucHV0LkV4Y2x1c2l2ZVN0YXJ0S2V5ID0gY3Vyc29yO1xuXG4gICAgICAvLyBjaGVjayBpZiBvbmx5IHRoZSBjb3VudCB3YXMgcmVxdWVzdGVkXG4gICAgICBpZiAob25seUNvdW50KSB7XG4gICAgICAgIGlmIChzZWxlY3Q/Lmxlbmd0aCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICdBdHRyaWJ1dGVzIHByb2plY3Rpb24gYW5kIGNvdW50IGNhbiBub3QgYmUgdXNlZCB0b2dldGhlcidcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIC8vIGNvdW50IGFuZCBwcm9qZWN0aW9uIHNlbGVjdGlvbiBjYW4gbm90IGJlIHVzZWQgdG9nZXRoZXJcbiAgICAgICAgdHJhbnNmb3JtZWRTY2FuSW5wdXQuU2VsZWN0ID0gUVVFUllfU0VMRUNUX1RZUEUuQ09VTlQ7XG4gICAgICB9XG5cbiAgICAgIC8vIGVudGl0eSBmaWx0ZXJcbiAgICAgIGxldCBlbnRpdHlGaWx0ZXI6IEZpbHRlciB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICAgIGlmIChlbnRpdHkpIHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5KTtcblxuICAgICAgICBpZiAoIW1ldGFkYXRhKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IE5vU3VjaEVudGl0eUV4aXN0c0Vycm9yKGVudGl0eS5uYW1lKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBidWlsZCBjdXJyZW50IGVudGl0eSBmaWx0ZXJcbiAgICAgICAgZW50aXR5RmlsdGVyID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb0ZpbHRlcih7XG4gICAgICAgICAgW0lOVEVSTkFMX0VOVElUWV9BVFRSSUJVVEUuRU5USVRZX05BTUVdOiB7XG4gICAgICAgICAgICBFUTogbWV0YWRhdGEubmFtZSxcbiAgICAgICAgICB9LFxuICAgICAgICB9IGFzIGFueSk7XG4gICAgICB9XG5cbiAgICAgIC8vIGJ1aWxkIGZpbHRlciBleHByZXNzaW9uXG4gICAgICBsZXQgb3B0aW9uc0ZpbHRlcjogRmlsdGVyIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkO1xuICAgICAgaWYgKHdoZXJlICYmICFpc0VtcHR5T2JqZWN0KHdoZXJlKSkge1xuICAgICAgICBjb25zdCBpbnB1dEZpbHRlciA9IHRoaXMuZXhwcmVzc2lvbklucHV0UGFyc2VyLnBhcnNlVG9GaWx0ZXIod2hlcmUpO1xuXG4gICAgICAgIGlmICghaW5wdXRGaWx0ZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZEZpbHRlcklucHV0RXJyb3Iod2hlcmUpO1xuICAgICAgICB9XG4gICAgICAgIG9wdGlvbnNGaWx0ZXIgPSBpbnB1dEZpbHRlcjtcbiAgICAgIH1cblxuICAgICAgLy8gbWVyZ2UgZmlsdGVycyBvZiBmYWxsIGJhY2sgdG8gbm9uZVxuICAgICAgbGV0IGZpbHRlcjogRmlsdGVyIHwgbnVsbDtcbiAgICAgIGlmIChlbnRpdHlGaWx0ZXIgJiYgb3B0aW9uc0ZpbHRlcikge1xuICAgICAgICBmaWx0ZXIgPSBuZXcgRmlsdGVyKCkubWVyZ2VNYW55KFxuICAgICAgICAgIFtlbnRpdHlGaWx0ZXIsIG9wdGlvbnNGaWx0ZXJdLFxuICAgICAgICAgIE1FUkdFX1NUUkFURUdZLkFORFxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlsdGVyID0gZW50aXR5RmlsdGVyIHx8IG9wdGlvbnNGaWx0ZXIgfHwgbnVsbDsgLy8gaWYgbm9uIG9mIHRoZSBjb25kaXRpb24gc2tpcCBpdCBhbGwgdG9nZXRoZXJcbiAgICAgIH1cblxuICAgICAgLy8gaWYgYXQgbGVhc3Qgb25lIGNvbmRpdGlvbiB3YXMgdHJ1dGh5LCBwYXJzZSBpdCBhbmQgaW5jbHVkZSBpdCBpbiB0aGUgaW5wdXRcbiAgICAgIGlmIChmaWx0ZXIpIHtcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIEZpbHRlckV4cHJlc3Npb24sXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAgIH0gPSB0aGlzLmV4cHJlc3Npb25CdWlsZGVyLmJ1aWxkRmlsdGVyRXhwcmVzc2lvbihmaWx0ZXIpO1xuXG4gICAgICAgIHRyYW5zZm9ybWVkU2NhbklucHV0ID0ge1xuICAgICAgICAgIC4uLnRyYW5zZm9ybWVkU2NhbklucHV0LFxuICAgICAgICAgIEZpbHRlckV4cHJlc3Npb24sXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICAgICAuLi50cmFuc2Zvcm1lZFNjYW5JbnB1dC5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgICAuLi5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgICAuLi50cmFuc2Zvcm1lZFNjYW5JbnB1dC5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAgICAgLi4uRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBwcm9qZWN0aW9uIGJ1aWxkZXJcbiAgICAgIGlmIChzZWxlY3Q/Lmxlbmd0aCkge1xuICAgICAgICBjb25zdCBwcm9qZWN0aW9uID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb1Byb2plY3Rpb24oc2VsZWN0KTtcblxuICAgICAgICBpZiAoIXByb2plY3Rpb24pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFNlbGVjdElucHV0RXJyb3Ioc2VsZWN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHtQcm9qZWN0aW9uRXhwcmVzc2lvbiwgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzfSA9XG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uQnVpbGRlci5idWlsZFByb2plY3Rpb25FeHByZXNzaW9uKHByb2plY3Rpb24pO1xuXG4gICAgICAgIHRyYW5zZm9ybWVkU2NhbklucHV0ID0ge1xuICAgICAgICAgIC4uLnRyYW5zZm9ybWVkU2NhbklucHV0LFxuICAgICAgICAgIFByb2plY3Rpb25FeHByZXNzaW9uLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICAgLi4udHJhbnNmb3JtZWRTY2FuSW5wdXQuRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgICAgLi4uRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gdmFsaWRhdGUgdmFsdWUgZm9yIHNlZ21lbnQgYW5kIHRvdGFsU2VnbWVudCBiZWZvcmUgYXBwZW5kaW5nXG4gICAgaWYgKFxuICAgICAgc2Nhbk9wdGlvbnM/LnRvdGFsU2VnbWVudHMgIT09IHVuZGVmaW5lZCAmJlxuICAgICAgc2Nhbk9wdGlvbnM/LnRvdGFsU2VnbWVudHMgIT09IG51bGxcbiAgICApIHtcbiAgICAgIGlmIChzY2FuT3B0aW9ucz8udG90YWxTZWdtZW50cyA9PT0gMCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc2NhbiBvcHRpb24gdG90YWxTZWdtZW50OiAke3NjYW5PcHRpb25zPy50b3RhbFNlZ21lbnRzfS5cbiAgICAgICAgdG90YWxTZWdtZW50cyBpcyBvcHRpb25hbCwgYnV0IHdoZW4gcHJvdmlkZWQgaXQncyB2YWx1ZSBtdXN0IGJlIGdyZWF0ZXIgdGhhbiAwLmApO1xuICAgICAgfVxuICAgICAgaWYgKHNjYW5PcHRpb25zPy5zZWdtZW50ID09PSB1bmRlZmluZWQgfHwgc2Nhbk9wdGlvbnM/LnNlZ21lbnQgPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHNjYW4gb3B0aW9uIHNlZ21lbnQ6ICR7c2Nhbk9wdGlvbnM/LnNlZ21lbnR9LlxuICAgICAgICBXaGVuIHRvdGFsU2VnbWVudHMgdmFsdWUgaXMgZGVmaW5lZCwgdmFsdWUgZm9yIG9wdGlvbiAnc2VnbWVudCcgbXVzdCBhbHNvIGJlIGRlZmluZWQuYCk7XG4gICAgICB9XG4gICAgICBpZiAoc2Nhbk9wdGlvbnM/LnNlZ21lbnQgPj0gc2Nhbk9wdGlvbnM/LnRvdGFsU2VnbWVudHMpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHNjYW4gb3B0aW9uIHNlZ21lbnQ6ICR7c2Nhbk9wdGlvbnM/LnNlZ21lbnR9LlxuICAgICAgICBXaGVuIHRvdGFsU2VnbWVudHMgdmFsdWUgaXMgZGVmaW5lZCwgdmFsdWUgZm9yIG9wdGlvbiAnc2VnbWVudCcgbXVzdCBiZSBvbmUgbGVzcyB0aGFuIHRvdGFsU2VnbWVudCBzaXplLmApO1xuICAgICAgfVxuXG4gICAgICB0cmFuc2Zvcm1lZFNjYW5JbnB1dC5Ub3RhbFNlZ21lbnRzID0gc2Nhbk9wdGlvbnM/LnRvdGFsU2VnbWVudHM7XG4gICAgICB0cmFuc2Zvcm1lZFNjYW5JbnB1dC5TZWdtZW50ID0gc2Nhbk9wdGlvbnM/LnNlZ21lbnQ7XG4gICAgfVxuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1TY2FuKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBwcmVmaXg6ICdBZnRlcicsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9TQ0FOX1RZUEUuU0NBTixcbiAgICAgIGJvZHk6IHRyYW5zZm9ybWVkU2NhbklucHV0LFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRyYW5zZm9ybWVkU2NhbklucHV0O1xuICB9XG5cbiAgLyoqXG4gICAqIFRyYW5zZm9ybXMgRHluYW1vREIgc2NhbiBvdXRwdXQgaW50byBlbnRpdGllc1xuICAgKi9cbiAgZnJvbUR5bmFtb1NjYW5SZXNwb25zZUl0ZW1MaXN0PFQ+KFxuICAgIGl0ZW1MaXN0OiBEb2N1bWVudENsaWVudFR5cGVzLkl0ZW1MaXN0LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApOiB7XG4gICAgaXRlbXM6IFRbXTtcbiAgICB1bmtub3duSXRlbXM6IERvY3VtZW50Q2xpZW50VHlwZXMuQXR0cmlidXRlTWFwW107XG4gIH0ge1xuICAgIGNvbnN0IGluaXRpYWxSZXNwb25zZToge1xuICAgICAgaXRlbXM6IFRbXTtcbiAgICAgIHVua25vd25JdGVtczogRG9jdW1lbnRDbGllbnRUeXBlcy5BdHRyaWJ1dGVNYXBbXTtcbiAgICB9ID0ge1xuICAgICAgaXRlbXM6IFtdLFxuICAgICAgdW5rbm93bkl0ZW1zOiBbXSxcbiAgICB9O1xuXG4gICAgaWYgKCFpdGVtTGlzdC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBpbml0aWFsUmVzcG9uc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGl0ZW1MaXN0LnJlZHVjZSgoYWNjOiB0eXBlb2YgaW5pdGlhbFJlc3BvbnNlLCByZXNwb25zZUl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IGVudGl0eVBoeXNpY2FsTmFtZSA9XG4gICAgICAgIHJlc3BvbnNlSXRlbVtJTlRFUk5BTF9FTlRJVFlfQVRUUklCVVRFLkVOVElUWV9OQU1FXTtcblxuICAgICAgLy8gZWFybHkgcmV0dXJuIGlmIG5vIGVudGl0eSBtZXRhZGF0YSB3YXMgZm91bmQgb24gaXRlbVxuICAgICAgaWYgKCFlbnRpdHlQaHlzaWNhbE5hbWUpIHtcbiAgICAgICAgYWNjLnVua25vd25JdGVtcy5wdXNoKHJlc3BvbnNlSXRlbSk7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhID1cbiAgICAgICAgdGhpcy5jb25uZWN0aW9uLmdldEVudGl0eUJ5UGh5c2ljYWxOYW1lKGVudGl0eVBoeXNpY2FsTmFtZSk7XG5cbiAgICAgIGNvbnN0IHJldmVyc2VUcmFuc2Zvcm1lZEl0ZW0gPSB0aGlzLmZyb21EeW5hbW9FbnRpdHkoXG4gICAgICAgIGVudGl0eU1ldGFkYXRhLnRhcmdldCxcbiAgICAgICAgcmVzcG9uc2VJdGVtLFxuICAgICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICAgICk7XG5cbiAgICAgIGFjYy5pdGVtcy5wdXNoKHJldmVyc2VUcmFuc2Zvcm1lZEl0ZW0pO1xuXG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIGluaXRpYWxSZXNwb25zZSk7XG4gIH1cbn1cbiJdfQ==