"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentClientRequestTransformer = void 0;
const common_1 = require("@typedorm/common");
const drop_prop_1 = require("../../helpers/drop-prop");
const get_constructor_for_instance_1 = require("../../helpers/get-constructor-for-instance");
const is_empty_object_1 = require("../../helpers/is-empty-object");
const parse_key_1 = require("../../helpers/parse-key");
const key_condition_1 = require("../expression/key-condition");
const expression_builder_1 = require("../expression/expression-builder");
const base_transformer_1 = require("./base-transformer");
const is_object_1 = require("../../helpers/is-object");
const auto_generate_attribute_value_1 = require("../../helpers/auto-generate-attribute-value");
class DocumentClientRequestTransformer extends base_transformer_1.BaseTransformer {
    constructor(connection) {
        super(connection);
        this._expressionBuilder = new expression_builder_1.ExpressionBuilder();
    }
    get expressionBuilder() {
        return this._expressionBuilder;
    }
    get expressionInputParser() {
        return this._expressionInputParser;
    }
    toDynamoPutItem(entity, options, metadataOptions) {
        const entityClass = (0, get_constructor_for_instance_1.getConstructorForInstance)(entity);
        const { table, internalAttributes, name } = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.PUT,
            prefix: 'Before',
            entityName: name,
            primaryKey: null,
            body: entity,
            options,
        });
        const uniqueAttributes = this.connection.getUniqueAttributesForEntity(entityClass);
        // include attributes with default values in
        const dynamoEntity = this.toDynamoEntity(entity);
        const entityInternalAttributes = internalAttributes.reduce((acc, attr) => {
            acc[attr.name] = attr.value;
            return acc;
        }, {});
        let dynamoPutItem = {
            Item: Object.assign(Object.assign({}, entityInternalAttributes), dynamoEntity),
            TableName: table.name,
            ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
        };
        // apply attribute not exist condition when creating unique
        const uniqueRecordConditionExpression = this.expressionBuilder.buildUniqueRecordConditionExpression(table);
        // always prevent overwriting data until explicitly told to do otherwise
        if (!(options === null || options === void 0 ? void 0 : options.overwriteIfExists)) {
            dynamoPutItem = Object.assign(Object.assign({}, dynamoPutItem), uniqueRecordConditionExpression);
        }
        // if there is `where` condition options exists, build condition expression
        if ((options === null || options === void 0 ? void 0 : options.where) && !(0, is_empty_object_1.isEmptyObject)(options === null || options === void 0 ? void 0 : options.where)) {
            const condition = this.expressionInputParser.parseToCondition(options === null || options === void 0 ? void 0 : options.where);
            if (!condition) {
                throw new Error(`Failed to build condition expression for input: ${JSON.stringify(options === null || options === void 0 ? void 0 : options.where)}`);
            }
            const { ConditionExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildConditionExpression(condition);
            // by default, entity manger appends unique record condition expression to avoid overwriting items if they already exist
            // so handle that
            const mergedExp = this._expressionBuilder.andMergeConditionExpressions({
                ConditionExpression: dynamoPutItem.ConditionExpression,
                ExpressionAttributeNames: dynamoPutItem.ExpressionAttributeNames,
                ExpressionAttributeValues: dynamoPutItem.ExpressionAttributeValues,
            }, {
                ConditionExpression,
                ExpressionAttributeNames,
                ExpressionAttributeValues,
            });
            dynamoPutItem.ConditionExpression = mergedExp.ConditionExpression;
            dynamoPutItem.ExpressionAttributeNames =
                mergedExp.ExpressionAttributeNames;
            dynamoPutItem.ExpressionAttributeValues =
                mergedExp.ExpressionAttributeValues;
        }
        // no unique attributes exist, so return early
        if (!uniqueAttributes.length) {
            this.connection.logger.logTransform({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                operation: common_1.TRANSFORM_TYPE.PUT,
                prefix: 'After',
                entityName: name,
                primaryKey: null,
                body: dynamoPutItem,
            });
            return dynamoPutItem;
        }
        // if there are unique attributes, return transaction list item
        let uniqueAttributePutItems = [];
        if (uniqueAttributes.length) {
            uniqueAttributePutItems = uniqueAttributes.map(attr => {
                const attributeValue = entity[attr.name];
                if (!attributeValue) {
                    throw new Error(`All unique attributes are required, Could not resolve value for unique attribute "${attr.name}."`);
                }
                if (!attr.unique) {
                    throw new Error('All unique attributes metadata must be marked unique.');
                }
                const uniqueItemPrimaryKey = this.getParsedPrimaryKey(table, attr.unique, entity);
                return {
                    Put: Object.assign({ Item: uniqueItemPrimaryKey, TableName: table.name }, uniqueRecordConditionExpression),
                };
            });
        }
        const uniqueAttributesPutItems = [
            { Put: dynamoPutItem },
            ...uniqueAttributePutItems,
        ];
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.PUT,
            prefix: 'After',
            entityName: name,
            primaryKey: null,
            body: uniqueAttributesPutItems,
        });
        return uniqueAttributesPutItems;
    }
    toDynamoGetItem(entityClass, primaryKey, options, metadataOptions) {
        var _a;
        const metadata = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.GET,
            prefix: 'Before',
            entityName: metadata.name,
            primaryKey,
        });
        const tableName = this.getTableNameForEntity(entityClass);
        const parsedPrimaryKey = this.getParsedPrimaryKey(metadata.table, metadata.schema.primaryKey, primaryKey);
        if ((0, is_empty_object_1.isEmptyObject)(parsedPrimaryKey)) {
            throw new Error('Primary could not be resolved');
        }
        let transformBody = {
            TableName: tableName,
            Key: Object.assign({}, parsedPrimaryKey),
            ConsistentRead: options === null || options === void 0 ? void 0 : options.consistentRead,
            ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
        };
        // if restricted item projection was requested
        if ((_a = options === null || options === void 0 ? void 0 : options.select) === null || _a === void 0 ? void 0 : _a.length) {
            const projection = this.expressionInputParser.parseToProjection(options.select);
            if (!projection) {
                throw new Error(`Failed to build projection expression for input: ${JSON.stringify(options.select)}`);
            }
            const { ProjectionExpression, ExpressionAttributeNames } = this.expressionBuilder.buildProjectionExpression(projection);
            transformBody = Object.assign(Object.assign({}, transformBody), { ProjectionExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, transformBody.ExpressionAttributeNames), ExpressionAttributeNames) });
        }
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.GET,
            prefix: 'After',
            entityName: metadata.name,
            primaryKey: null,
            body: transformBody,
        });
        return transformBody;
    }
    toDynamoUpdateItem(entityClass, primaryKeyAttributes, body, options = {}, metadataOptions) {
        // default values
        const { nestedKeySeparator = '.' } = options;
        if (!this.connection.hasMetadata(entityClass)) {
            throw new Error(`No metadata found for class "${entityClass.name}".`);
        }
        const metadata = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.UPDATE,
            prefix: 'Before',
            entityName: metadata.name,
            primaryKey: primaryKeyAttributes,
            body,
            options,
        });
        const tableName = metadata.table.name;
        // FIXME: correctly apply decorated transformations on the primary key attributes
        // apply class transformation on attributes before further processing
        // primaryKeyAttributes = this.applyClassTransformerFormations(
        //   primaryKeyAttributes
        // ) as PrimaryKey;
        const parsedPrimaryKey = this.getParsedPrimaryKey(metadata.table, metadata.schema.primaryKey, primaryKeyAttributes);
        if ((0, is_empty_object_1.isEmptyObject)(parsedPrimaryKey)) {
            throw new Error('Primary could not be resolved');
        }
        // get all the attributes for entity that are marked as to be auto update
        const autoUpdateAttributes = this.connection.getAutoUpdateAttributes(entityClass);
        // check if auto update attributes are not referenced by primary key
        const formattedAutoUpdateAttributes = autoUpdateAttributes.reduce((acc, attr) => {
            acc[attr.name] = (0, auto_generate_attribute_value_1.autoGenerateValue)(attr.strategy);
            return acc;
        }, {});
        const rawAttributesToUpdate = Object.assign(Object.assign({}, body), formattedAutoUpdateAttributes);
        /**
         * 1.0 - analyze attributes' value type (static/dynamic)
         *
         * Here we parse all attributes to it's update value and determine
         * if it's value can be statically inferred
         * and also omit all attributes
         * from body that has the same defined in primary key
         *
         */
        const staticOrDynamicUpdateAttributesWithMetadata = Object.entries(Object.assign({}, rawAttributesToUpdate)).reduce((acc, [attrName, attrValue]) => {
            const valueWithType = this.expressionInputParser.parseAttributeToUpdateValue(attrName, attrValue);
            acc.transformed[attrName] = valueWithType.value;
            acc.typeMetadata[attrName] = valueWithType.type;
            return acc;
        }, { transformed: {}, typeMetadata: {} });
        /**
         * 2.0 - apply custom class transformation on static attributes
         *
         * we manually need to replace the constructor of the attributes to update
         * with the entity class, so that we can pass it through to class-transformer
         * to have all transformer metadata applied.
         */
        const onlyStaticAttributes = Object.entries(staticOrDynamicUpdateAttributesWithMetadata.transformed).reduce((acc, [attrKey, attrValue]) => {
            if (staticOrDynamicUpdateAttributesWithMetadata.typeMetadata[attrKey] ===
                'static') {
                acc[attrKey] = attrValue;
            }
            return acc;
        }, {});
        onlyStaticAttributes.constructor = entityClass;
        const classTransformedStaticAttributes = this.applyClassTransformerFormations(onlyStaticAttributes);
        staticOrDynamicUpdateAttributesWithMetadata.transformed = Object.assign(Object.assign({}, staticOrDynamicUpdateAttributesWithMetadata.transformed), classTransformedStaticAttributes);
        /**
         * 3.0 - Get referenced unique attributes and validate that current update body can be safely applied
         */
        const uniqueAttributesToUpdate = this.connection
            .getUniqueAttributesForEntity(entityClass)
            .filter(attr => !!body[attr.name])
            .map(attr => {
            // TODO: support updating unique attributes with dynamic exp
            // we can't allow updating unique attributes when they contain dynamic update value
            if (staticOrDynamicUpdateAttributesWithMetadata.typeMetadata[attr.name] === 'dynamic') {
                throw new common_1.InvalidDynamicUpdateAttributeValueError(attr.name, staticOrDynamicUpdateAttributesWithMetadata.transformed[attr.name]);
            }
            return attr;
        });
        /**
         * 3.1 - Get referenced primary key attributes and validate that current update body can be safely applied
         */
        const explicitAttributesToUpdate = Object.entries(Object.assign({}, staticOrDynamicUpdateAttributesWithMetadata.transformed)).reduce((acc, [attrKey, attrValue]) => {
            // Attribute in Body that are in primary key attributes and have the do not require any updates
            if (primaryKeyAttributes[attrKey] !== attrValue) {
                acc[attrKey] = attrValue;
            }
            return acc;
        }, {});
        const affectedPrimaryKeyAttributes = this.getAffectedPrimaryKeyAttributes(entityClass, explicitAttributesToUpdate, staticOrDynamicUpdateAttributesWithMetadata.typeMetadata, {
            additionalAttributesDict: staticOrDynamicUpdateAttributesWithMetadata.transformed,
        });
        // validate primary key attributes
        if (!(0, is_empty_object_1.isEmptyObject)(affectedPrimaryKeyAttributes)) {
            // updates are not allowed for attributes that unique and also references primary key.
            if (uniqueAttributesToUpdate.length) {
                throw new common_1.InvalidUniqueAttributeUpdateError(affectedPrimaryKeyAttributes, uniqueAttributesToUpdate.map(attr => attr.name));
            }
        }
        /**
         * 3.2 - Get referenced indexes' attributes and validate that current update body can be safely applied
         */
        const affectedIndexes = this.getAffectedIndexesForAttributes(entityClass, staticOrDynamicUpdateAttributesWithMetadata.transformed, staticOrDynamicUpdateAttributesWithMetadata.typeMetadata, {
            nestedKeySeparator,
            additionalAttributesDict: Object.assign({}, primaryKeyAttributes),
        });
        /**
         * 4.0 - Build update Item body with given condition and options
         */
        const itemToUpdate = {
            TableName: tableName,
            Key: Object.assign({}, parsedPrimaryKey),
            ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
            // request all new attributes
            ReturnValues: common_1.RETURN_VALUES.ALL_NEW,
        };
        /**
         * 4.1 - if 'where' was provided, build condition expression
         */
        if (options.where && !(0, is_empty_object_1.isEmptyObject)(options.where)) {
            const condition = this.expressionInputParser.parseToCondition(options.where);
            if (!condition) {
                throw new Error(`Failed to build condition expression for input: ${JSON.stringify(options.where)}`);
            }
            const { ConditionExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildConditionExpression(condition);
            // append condition expression if one was built
            itemToUpdate.ConditionExpression = ConditionExpression;
            itemToUpdate.ExpressionAttributeNames = Object.assign(Object.assign({}, ExpressionAttributeNames), itemToUpdate.ExpressionAttributeNames);
            itemToUpdate.ExpressionAttributeValues = Object.assign(Object.assign({}, ExpressionAttributeValues), itemToUpdate.ExpressionAttributeValues);
        }
        /**
         * 5.0 - update contains primary key attributes so it must be lazily updated
         * This requires deleting old item and writing new item to the table both in a transaction
         */
        if ((0, is_object_1.isObject)(affectedPrimaryKeyAttributes) &&
            !(0, is_empty_object_1.isEmptyObject)(affectedPrimaryKeyAttributes)) {
            const lazyLoadTransactionWriteItems = this.lazyToDynamoUpdatePrimaryKeyFactory(metadata.table, metadata.name, metadata.schema.primaryKey, {
                Item: Object.assign(Object.assign(Object.assign({}, affectedPrimaryKeyAttributes), affectedIndexes), staticOrDynamicUpdateAttributesWithMetadata.transformed),
                TableName: metadata.table.name,
                ReturnConsumedCapacity: itemToUpdate.ReturnConsumedCapacity,
                ReturnValues: itemToUpdate.ReturnValues,
                ConditionExpression: itemToUpdate.ConditionExpression,
                ExpressionAttributeNames: itemToUpdate.ExpressionAttributeNames,
                ExpressionAttributeValues: itemToUpdate.ExpressionAttributeValues,
            }, metadataOptions);
            return {
                primaryKeyAttributes,
                entityClass,
                lazyLoadTransactionWriteItems,
            };
        }
        /**
         * 5.0.1 - build update expression with user provided body and all other auto transformation
         */
        const update = this.expressionInputParser.parseToUpdate(Object.assign(Object.assign({}, rawAttributesToUpdate), affectedIndexes), staticOrDynamicUpdateAttributesWithMetadata.transformed);
        const { UpdateExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildUpdateExpression(update);
        itemToUpdate.UpdateExpression = UpdateExpression;
        itemToUpdate.ExpressionAttributeNames = Object.assign(Object.assign({}, ExpressionAttributeNames), itemToUpdate.ExpressionAttributeNames);
        itemToUpdate.ExpressionAttributeValues = Object.assign(Object.assign({}, ExpressionAttributeValues), itemToUpdate.ExpressionAttributeValues);
        /**
         * 5.1 - Update contains unique attributes, build a lazy unique attributes loader and return
         */
        if (uniqueAttributesToUpdate.length) {
            // if there are unique attributes, return a lazy loader, which will return write item list
            const lazyLoadTransactionWriteItems = this.lazyToDynamoUpdateUniqueItemFactory(metadata.table, metadata.name, uniqueAttributesToUpdate, (0, drop_prop_1.dropProp)(itemToUpdate, 'ReturnValues'), staticOrDynamicUpdateAttributesWithMetadata.transformed, metadataOptions);
            return {
                primaryKeyAttributes,
                entityClass,
                lazyLoadTransactionWriteItems,
            };
        }
        /**
         * 5.2 - return simple update body
         */
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.UPDATE,
            prefix: 'After',
            entityName: metadata.name,
            primaryKey: null,
            body: itemToUpdate,
        });
        return itemToUpdate;
    }
    toDynamoDeleteItem(entityClass, primaryKey, options, metadataOptions) {
        const metadata = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.DELETE,
            prefix: 'Before',
            entityName: metadata.name,
            primaryKey,
        });
        const tableName = metadata.table.name;
        const parsedPrimaryKey = this.getParsedPrimaryKey(metadata.table, metadata.schema.primaryKey, primaryKey);
        if ((0, is_empty_object_1.isEmptyObject)(parsedPrimaryKey)) {
            throw new Error('Primary could not be resolved');
        }
        const uniqueAttributesToRemove = this.connection.getUniqueAttributesForEntity(entityClass);
        const mainItemToRemove = {
            TableName: tableName,
            Key: Object.assign({}, parsedPrimaryKey),
            ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity,
        };
        if ((options === null || options === void 0 ? void 0 : options.where) && !(0, is_empty_object_1.isEmptyObject)(options.where)) {
            const condition = this.expressionInputParser.parseToCondition(options === null || options === void 0 ? void 0 : options.where);
            if (!condition) {
                throw new Error(`Failed to build condition expression for input: ${JSON.stringify(options === null || options === void 0 ? void 0 : options.where)}`);
            }
            const { ConditionExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildConditionExpression(condition);
            mainItemToRemove.ConditionExpression = ConditionExpression;
            mainItemToRemove.ExpressionAttributeNames = Object.assign(Object.assign({}, mainItemToRemove.ExpressionAttributeNames), ExpressionAttributeNames);
            mainItemToRemove.ExpressionAttributeValues = Object.assign(Object.assign({}, mainItemToRemove.ExpressionAttributeValues), ExpressionAttributeValues);
        }
        if (!(uniqueAttributesToRemove === null || uniqueAttributesToRemove === void 0 ? void 0 : uniqueAttributesToRemove.length)) {
            // if item does not have any unique attributes return it as is
            this.connection.logger.logTransform({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                operation: common_1.TRANSFORM_TYPE.DELETE,
                prefix: 'After',
                entityName: metadata.name,
                primaryKey,
            });
            return mainItemToRemove;
        }
        // or return lazy resolver
        const lazyLoadTransactionWriteItems = this.lazyToDynamoRemoveItemFactory(metadata.table, metadata.name, uniqueAttributesToRemove, mainItemToRemove, metadataOptions);
        return {
            primaryKeyAttributes: primaryKey,
            entityClass,
            lazyLoadTransactionWriteItems,
        };
    }
    toDynamoQueryItem(entityClass, partitionKeyAttributes, queryOptions, metadataOptions) {
        var _a;
        const { table, schema, name } = this.connection.getEntityByTarget(entityClass);
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.QUERY,
            prefix: 'Before',
            entityName: name,
            primaryKey: partitionKeyAttributes,
            options: queryOptions,
        });
        const queryIndexName = queryOptions === null || queryOptions === void 0 ? void 0 : queryOptions.queryIndex;
        let indexToQuery;
        if (queryIndexName) {
            const matchingIndex = table.getIndexByKey(queryIndexName);
            if (!matchingIndex) {
                throw new common_1.NoSuchIndexFoundError(table.name, queryIndexName);
            }
            const matchingIndexOnEntity = schema.indexes && schema.indexes[queryIndexName];
            if (!matchingIndexOnEntity) {
                throw new Error(`Requested to query items from index "${queryIndexName}", but no such index exists on entity.`);
            }
            indexToQuery = matchingIndex;
        }
        // query will be executed against main table or
        // if querying local  index, then partition key will be same as main table
        const parsedPartitionKey = {};
        if (!queryIndexName ||
            !indexToQuery ||
            (indexToQuery === null || indexToQuery === void 0 ? void 0 : indexToQuery.type) === common_1.INDEX_TYPE.LSI) {
            parsedPartitionKey.name = table.partitionKey;
            parsedPartitionKey.value =
                typeof partitionKeyAttributes === 'string'
                    ? partitionKeyAttributes
                    : (0, parse_key_1.parseKey)(schema.primaryKey.attributes[table.partitionKey], partitionKeyAttributes);
        }
        else {
            // query is to be executed against global secondary index
            parsedPartitionKey.name = indexToQuery.partitionKey;
            const schemaForIndexToQuery = ((_a = schema.indexes) !== null && _a !== void 0 ? _a : {})[queryIndexName];
            parsedPartitionKey.value =
                typeof partitionKeyAttributes === 'string'
                    ? partitionKeyAttributes
                    : (0, parse_key_1.parseKey)(schemaForIndexToQuery.attributes[indexToQuery.partitionKey], partitionKeyAttributes);
        }
        const partitionKeyCondition = new key_condition_1.KeyCondition().equals(parsedPartitionKey.name, parsedPartitionKey.value);
        const partitionKeyConditionExpression = this.expressionBuilder.buildKeyConditionExpression(partitionKeyCondition);
        const parsedSortKey = {};
        // if no we are not querying against index, validate if table is using composite key
        if (!indexToQuery) {
            if (!table.usesCompositeKey()) {
                throw new Error(`Table ${table.name} does not use composite key, thus querying a sort key is not allowed`);
            }
            parsedSortKey.name = table.sortKey;
        }
        else {
            parsedSortKey.name = indexToQuery.sortKey;
        }
        // at this point we have resolved partition key and table to query
        let queryInputParams = Object.assign({ TableName: table.name, IndexName: queryIndexName, ReturnConsumedCapacity: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.returnConsumedCapacity }, partitionKeyConditionExpression);
        if (queryOptions && !(0, is_empty_object_1.isEmptyObject)(queryOptions)) {
            const { orderBy: order, limit, keyCondition, where, select, onlyCount, consistentRead, } = queryOptions;
            queryInputParams = Object.assign(Object.assign({}, queryInputParams), { Limit: limit, ConsistentRead: consistentRead });
            if (order) {
                queryInputParams.ScanIndexForward = order === common_1.QUERY_ORDER.ASC;
            }
            // if key condition was provided
            if (keyCondition && !(0, is_empty_object_1.isEmptyObject)(keyCondition)) {
                // build sort key condition
                const sortKeyCondition = this.expressionInputParser.parseToKeyCondition(parsedSortKey.name, keyCondition);
                // if condition resolution was successful, we can merge both partition and sort key conditions now
                const { KeyConditionExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildKeyConditionExpression(partitionKeyCondition.merge(sortKeyCondition));
                queryInputParams = Object.assign(Object.assign({}, queryInputParams), { KeyConditionExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, queryInputParams.ExpressionAttributeNames), ExpressionAttributeNames), ExpressionAttributeValues: Object.assign(Object.assign({}, queryInputParams.ExpressionAttributeValues), ExpressionAttributeValues) });
            }
            // when filter conditions are given generate filter expression
            if (where && !(0, is_empty_object_1.isEmptyObject)(where)) {
                const filter = this.expressionInputParser.parseToFilter(where);
                if (!filter) {
                    throw new common_1.InvalidFilterInputError(where);
                }
                const { FilterExpression, ExpressionAttributeNames, ExpressionAttributeValues, } = this.expressionBuilder.buildFilterExpression(filter);
                queryInputParams = Object.assign(Object.assign({}, queryInputParams), { FilterExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, queryInputParams.ExpressionAttributeNames), ExpressionAttributeNames), ExpressionAttributeValues: Object.assign(Object.assign({}, queryInputParams.ExpressionAttributeValues), ExpressionAttributeValues) });
            }
            // check if only the count was requested
            if (onlyCount) {
                if (select === null || select === void 0 ? void 0 : select.length) {
                    throw new Error('Attributes projection and count can not be used together');
                }
                // count and projection selection can not be used together
                queryInputParams.Select = common_1.QUERY_SELECT_TYPE.COUNT;
            }
            // when projection keys are provided
            if (select && select.length) {
                const projection = this.expressionInputParser.parseToProjection(select);
                if (!projection) {
                    throw new common_1.InvalidSelectInputError(select);
                }
                const { ProjectionExpression, ExpressionAttributeNames } = this.expressionBuilder.buildProjectionExpression(projection);
                queryInputParams = Object.assign(Object.assign({}, queryInputParams), { ProjectionExpression, ExpressionAttributeNames: Object.assign(Object.assign({}, queryInputParams.ExpressionAttributeNames), ExpressionAttributeNames) });
            }
        }
        this.connection.logger.logTransform({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TYPE.QUERY,
            prefix: 'After',
            entityName: name,
            primaryKey: partitionKeyAttributes,
            body: queryInputParams,
        });
        return queryInputParams;
    }
    lazyToDynamoUpdatePrimaryKeyFactory(table, entityName, primaryKeySchema, newItemBody, metadataOptions) {
        return (previousItemBody) => {
            const updateTransactionItems = [
                {
                    Put: Object.assign(Object.assign({}, newItemBody), { 
                        // import existing current item
                        Item: Object.assign(Object.assign({}, previousItemBody), newItemBody.Item) }),
                },
            ];
            // if there was a previous existing item, basically remove it as part of this transaction
            if (previousItemBody && !(0, is_empty_object_1.isEmptyObject)(previousItemBody)) {
                updateTransactionItems.push({
                    Delete: {
                        TableName: table.name,
                        Key: Object.assign({}, this.getParsedPrimaryKey(table, primaryKeySchema, previousItemBody)),
                    },
                });
            }
            this.connection.logger.logTransform({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                operation: common_1.TRANSFORM_TYPE.UPDATE,
                prefix: 'After',
                entityName,
                primaryKey: null,
                body: updateTransactionItems,
            });
            return updateTransactionItems;
        };
    }
    /**
     * Lazy build update item input
     * This is helpful in cases where we don't you have all the attributes to build item input, and the caller will need to
     * to perform some sort of async call in order to fetch attributes and proceed with build
     *
     */
    lazyToDynamoUpdateUniqueItemFactory(table, entityName, uniqueAttributesToUpdate, mainItem, newBody, metadataOptions) {
        // returns transact write item list
        return (previousItemBody) => {
            // updating unique attributes also require checking if new value exists
            const uniqueRecordConditionExpression = this.expressionBuilder.buildUniqueRecordConditionExpression(table);
            // map all unique attributes to [put, delete] item tuple
            const uniqueAttributeInputs = uniqueAttributesToUpdate.flatMap(attr => {
                const uniqueAttributeWriteItems = [
                    {
                        Put: Object.assign({ TableName: table.name, Item: Object.assign({}, this.getParsedPrimaryKey(table, attr.unique, newBody)) }, uniqueRecordConditionExpression),
                    },
                ];
                // if unique attribute previously existed, remove it as part of the same transaction
                if (previousItemBody && previousItemBody[attr.name]) {
                    uniqueAttributeWriteItems.push({
                        Delete: {
                            TableName: table.name,
                            Key: Object.assign({}, this.getParsedPrimaryKey(table, attr.unique, previousItemBody)),
                        },
                    });
                }
                return uniqueAttributeWriteItems;
            });
            // in order for update express to succeed, all listed must succeed in a transaction
            const updateTransactionItems = [
                { Update: mainItem },
                ...uniqueAttributeInputs,
            ];
            this.connection.logger.logTransform({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                operation: common_1.TRANSFORM_TYPE.UPDATE,
                prefix: 'After',
                entityName,
                primaryKey: null,
                body: updateTransactionItems,
            });
            return updateTransactionItems;
        };
    }
    /**
     * lazily resolve all unique attribute items to remove
     * @param table
     * @param uniqueAttributesToRemove
     * @param mainItem
     */
    lazyToDynamoRemoveItemFactory(table, entityName, uniqueAttributesToRemove, mainItem, metadataOptions) {
        return (existingItemBody) => {
            let uniqueAttributeInputs = [];
            if (existingItemBody) {
                uniqueAttributeInputs = uniqueAttributesToRemove.map(attr => {
                    return {
                        Delete: {
                            TableName: table.name,
                            Key: Object.assign({}, this.getParsedPrimaryKey(table, attr.unique, existingItemBody)),
                        },
                    };
                });
            }
            const deleteTransactionItems = [
                {
                    Delete: mainItem,
                },
                ...uniqueAttributeInputs,
            ];
            this.connection.logger.logTransform({
                requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
                operation: common_1.TRANSFORM_TYPE.DELETE,
                prefix: 'After',
                entityName,
                primaryKey: null,
                body: deleteTransactionItems,
            });
            return deleteTransactionItems;
        };
    }
}
exports.DocumentClientRequestTransformer = DocumentClientRequestTransformer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LXJlcXVlc3QtdHJhbnNmb3JtZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9jb3JlL3NyYy9jbGFzc2VzL3RyYW5zZm9ybWVyL2RvY3VtZW50LWNsaWVudC1yZXF1ZXN0LXRyYW5zZm9ybWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQWUwQjtBQUMxQix1REFBaUQ7QUFDakQsNkZBQXFGO0FBQ3JGLG1FQUE0RDtBQUM1RCx1REFBaUQ7QUFDakQsK0RBQXlEO0FBRXpELHlFQUFtRTtBQUduRSx5REFBb0U7QUFJcEUsdURBQWlEO0FBRWpELCtGQUE4RTtBQThEOUUsTUFBYSxnQ0FBaUMsU0FBUSxrQ0FBZTtJQUduRSxZQUFZLFVBQXNCO1FBQ2hDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNsQixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxzQ0FBaUIsRUFBRSxDQUFDO0lBQ3BELENBQUM7SUFFRCxJQUFJLGlCQUFpQjtRQUNuQixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBSSxxQkFBcUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsc0JBQXNCLENBQUM7SUFDckMsQ0FBQztJQUVELGVBQWUsQ0FDYixNQUFjLEVBQ2QsT0FBdUMsRUFDdkMsZUFBaUM7UUFJakMsTUFBTSxXQUFXLEdBQUcsSUFBQSx3REFBeUIsRUFBQyxNQUFNLENBQUMsQ0FBQztRQUN0RCxNQUFNLEVBQUMsS0FBSyxFQUFFLGtCQUFrQixFQUFFLElBQUksRUFBQyxHQUNyQyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWpELElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNsQyxTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7WUFDckMsU0FBUyxFQUFFLHVCQUFjLENBQUMsR0FBRztZQUM3QixNQUFNLEVBQUUsUUFBUTtZQUNoQixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsSUFBSTtZQUNoQixJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsNEJBQTRCLENBQ25FLFdBQVcsQ0FDVyxDQUFDO1FBRXpCLDRDQUE0QztRQUM1QyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWpELE1BQU0sd0JBQXdCLEdBQUcsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3ZFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUM1QixPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFBRSxFQUFzQyxDQUFDLENBQUM7UUFFM0MsSUFBSSxhQUFhLEdBQUc7WUFDbEIsSUFBSSxrQ0FDQyx3QkFBd0IsR0FDeEIsWUFBWSxDQUNoQjtZQUNELFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSTtZQUNyQixzQkFBc0IsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsc0JBQXNCO1NBQzVCLENBQUM7UUFFdEMsMkRBQTJEO1FBQzNELE1BQU0sK0JBQStCLEdBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxvQ0FBb0MsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVyRSx3RUFBd0U7UUFDeEUsSUFBSSxDQUFDLENBQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLGlCQUFpQixDQUFBLEVBQUU7WUFDL0IsYUFBYSxtQ0FDUixhQUFhLEdBQ2IsK0JBQStCLENBQ25DLENBQUM7U0FDSDtRQUVELDJFQUEyRTtRQUMzRSxJQUFJLENBQUEsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLEtBQUssS0FBSSxDQUFDLElBQUEsK0JBQWEsRUFBQyxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsS0FBSyxDQUFDLEVBQUU7WUFDcEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGdCQUFnQixDQUMzRCxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsS0FBSyxDQUNmLENBQUM7WUFFRixJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNkLE1BQU0sSUFBSSxLQUFLLENBQ2IsbURBQW1ELElBQUksQ0FBQyxTQUFTLENBQy9ELE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxLQUFLLENBQ2YsRUFBRSxDQUNKLENBQUM7YUFDSDtZQUVELE1BQU0sRUFDSixtQkFBbUIsRUFDbkIsd0JBQXdCLEVBQ3hCLHlCQUF5QixHQUMxQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUvRCx3SEFBd0g7WUFDeEgsaUJBQWlCO1lBQ2pCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyw0QkFBNEIsQ0FDcEU7Z0JBQ0UsbUJBQW1CLEVBQUUsYUFBYSxDQUFDLG1CQUFtQjtnQkFDdEQsd0JBQXdCLEVBQUUsYUFBYSxDQUFDLHdCQUF3QjtnQkFDaEUseUJBQXlCLEVBQUUsYUFBYSxDQUFDLHlCQUF5QjthQUNuRSxFQUNEO2dCQUNFLG1CQUFtQjtnQkFDbkIsd0JBQXdCO2dCQUN4Qix5QkFBeUI7YUFDMUIsQ0FDRixDQUFDO1lBRUYsYUFBYSxDQUFDLG1CQUFtQixHQUFHLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQztZQUNsRSxhQUFhLENBQUMsd0JBQXdCO2dCQUNwQyxTQUFTLENBQUMsd0JBQXdCLENBQUM7WUFDckMsYUFBYSxDQUFDLHlCQUF5QjtnQkFDckMsU0FBUyxDQUFDLHlCQUF5QixDQUFDO1NBQ3ZDO1FBRUQsOENBQThDO1FBQzlDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUU7WUFDNUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO2dCQUNsQyxTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7Z0JBQ3JDLFNBQVMsRUFBRSx1QkFBYyxDQUFDLEdBQUc7Z0JBQzdCLE1BQU0sRUFBRSxPQUFPO2dCQUNmLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsSUFBSSxFQUFFLGFBQWE7YUFDcEIsQ0FBQyxDQUFDO1lBRUgsT0FBTyxhQUFhLENBQUM7U0FDdEI7UUFFRCwrREFBK0Q7UUFDL0QsSUFBSSx1QkFBdUIsR0FBOEMsRUFBRSxDQUFDO1FBQzVFLElBQUksZ0JBQWdCLENBQUMsTUFBTSxFQUFFO1lBQzNCLHVCQUF1QixHQUFHLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDcEQsTUFBTSxjQUFjLEdBQUksTUFBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFFbEQsSUFBSSxDQUFDLGNBQWMsRUFBRTtvQkFDbkIsTUFBTSxJQUFJLEtBQUssQ0FDYixxRkFBcUYsSUFBSSxDQUFDLElBQUksSUFBSSxDQUNuRyxDQUFDO2lCQUNIO2dCQUVELElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNoQixNQUFNLElBQUksS0FBSyxDQUNiLHVEQUF1RCxDQUN4RCxDQUFDO2lCQUNIO2dCQUVELE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUNuRCxLQUFLLEVBQ0wsSUFBSSxDQUFDLE1BQU0sRUFDWCxNQUFNLENBQ1AsQ0FBQztnQkFFRixPQUFPO29CQUNMLEdBQUcsa0JBQ0QsSUFBSSxFQUFFLG9CQUFvQixFQUMxQixTQUFTLEVBQUUsS0FBSyxDQUFDLElBQUksSUFDbEIsK0JBQStCLENBQ25DO2lCQUNGLENBQUM7WUFDSixDQUFDLENBQUMsQ0FBQztTQUNKO1FBRUQsTUFBTSx3QkFBd0IsR0FBRztZQUMvQixFQUFDLEdBQUcsRUFBRSxhQUFhLEVBQUM7WUFDcEIsR0FBRyx1QkFBdUI7U0FDM0IsQ0FBQztRQUVGLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNsQyxTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7WUFDckMsU0FBUyxFQUFFLHVCQUFjLENBQUMsR0FBRztZQUM3QixNQUFNLEVBQUUsT0FBTztZQUNmLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLElBQUksRUFBRSx3QkFBd0I7U0FDL0IsQ0FBQyxDQUFDO1FBRUgsT0FBTyx3QkFBd0IsQ0FBQztJQUNsQyxDQUFDO0lBRUQsZUFBZSxDQUNiLFdBQWlDLEVBQ2pDLFVBQXNCLEVBQ3RCLE9BQXVDLEVBQ3ZDLGVBQWlDOztRQUVqQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWhFLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNsQyxTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7WUFDckMsU0FBUyxFQUFFLHVCQUFjLENBQUMsR0FBRztZQUM3QixNQUFNLEVBQUUsUUFBUTtZQUNoQixVQUFVLEVBQUUsUUFBUSxDQUFDLElBQUk7WUFDekIsVUFBVTtTQUNYLENBQUMsQ0FBQztRQUVILE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUUxRCxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FDL0MsUUFBUSxDQUFDLEtBQUssRUFDZCxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFDMUIsVUFBVSxDQUNYLENBQUM7UUFFRixJQUFJLElBQUEsK0JBQWEsRUFBQyxnQkFBZ0IsQ0FBQyxFQUFFO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztTQUNsRDtRQUVELElBQUksYUFBYSxHQUFHO1lBQ2xCLFNBQVMsRUFBRSxTQUFTO1lBQ3BCLEdBQUcsb0JBQ0UsZ0JBQWdCLENBQ3BCO1lBQ0QsY0FBYyxFQUFFLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxjQUFjO1lBQ3ZDLHNCQUFzQixFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxzQkFBc0I7U0FDNUIsQ0FBQztRQUV0Qyw4Q0FBOEM7UUFDOUMsSUFBSSxNQUFBLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxNQUFNLDBDQUFFLE1BQU0sRUFBRTtZQUMzQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLENBQzdELE9BQU8sQ0FBQyxNQUFNLENBQ2YsQ0FBQztZQUVGLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ2YsTUFBTSxJQUFJLEtBQUssQ0FDYixvREFBb0QsSUFBSSxDQUFDLFNBQVMsQ0FDaEUsT0FBTyxDQUFDLE1BQU0sQ0FDZixFQUFFLENBQ0osQ0FBQzthQUNIO1lBRUQsTUFBTSxFQUFDLG9CQUFvQixFQUFFLHdCQUF3QixFQUFDLEdBQ3BELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUUvRCxhQUFhLG1DQUNSLGFBQWEsS0FDaEIsb0JBQW9CLEVBQ3BCLHdCQUF3QixrQ0FDbkIsYUFBYSxDQUFDLHdCQUF3QixHQUN0Qyx3QkFBd0IsSUFFOUIsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ2xDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztZQUNyQyxTQUFTLEVBQUUsdUJBQWMsQ0FBQyxHQUFHO1lBQzdCLE1BQU0sRUFBRSxPQUFPO1lBQ2YsVUFBVSxFQUFFLFFBQVEsQ0FBQyxJQUFJO1lBQ3pCLFVBQVUsRUFBRSxJQUFJO1lBQ2hCLElBQUksRUFBRSxhQUFhO1NBQ3BCLENBQUMsQ0FBQztRQUNILE9BQU8sYUFBYSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxrQkFBa0IsQ0FLaEIsV0FBaUMsRUFDakMsb0JBQWdDLEVBQ2hDLElBQThDLEVBQzlDLFVBQTZDLEVBQUUsRUFDL0MsZUFBaUM7UUFFakMsaUJBQWlCO1FBQ2pCLE1BQU0sRUFBQyxrQkFBa0IsR0FBRyxHQUFHLEVBQUMsR0FBRyxPQUFPLENBQUM7UUFFM0MsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQzdDLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLFdBQVcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO1lBQ3JDLFNBQVMsRUFBRSx1QkFBYyxDQUFDLE1BQU07WUFDaEMsTUFBTSxFQUFFLFFBQVE7WUFDaEIsVUFBVSxFQUFFLFFBQVEsQ0FBQyxJQUFJO1lBQ3pCLFVBQVUsRUFBRSxvQkFBb0I7WUFDaEMsSUFBSTtZQUNKLE9BQU87U0FDUixDQUFDLENBQUM7UUFDSCxNQUFNLFNBQVMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztRQUV0QyxpRkFBaUY7UUFDakYscUVBQXFFO1FBQ3JFLCtEQUErRDtRQUMvRCx5QkFBeUI7UUFDekIsbUJBQW1CO1FBRW5CLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUMvQyxRQUFRLENBQUMsS0FBSyxFQUNkLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUMxQixvQkFBb0IsQ0FDckIsQ0FBQztRQUVGLElBQUksSUFBQSwrQkFBYSxFQUFDLGdCQUFnQixDQUFDLEVBQUU7WUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQseUVBQXlFO1FBQ3pFLE1BQU0sb0JBQW9CLEdBQ3hCLElBQUksQ0FBQyxVQUFVLENBQUMsdUJBQXVCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFdkQsb0VBQW9FO1FBQ3BFLE1BQU0sNkJBQTZCLEdBQUcsb0JBQW9CLENBQUMsTUFBTSxDQUMvRCxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRTtZQUNaLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBQSxpREFBaUIsRUFBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDbEQsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQ0QsRUFBMEIsQ0FDM0IsQ0FBQztRQUVGLE1BQU0scUJBQXFCLG1DQUN0QixJQUFJLEdBQ0osNkJBQTZCLENBQ2pDLENBQUM7UUFFRjs7Ozs7Ozs7V0FRRztRQUNILE1BQU0sMkNBQTJDLEdBQUcsTUFBTSxDQUFDLE9BQU8sbUJBQzdELHFCQUFxQixFQUN4QixDQUFDLE1BQU0sQ0FDUCxDQUFDLEdBQUcsRUFBRSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsRUFBRSxFQUFFO1lBQzdCLE1BQU0sYUFBYSxHQUNqQixJQUFJLENBQUMscUJBQXFCLENBQUMsMkJBQTJCLENBQ3BELFFBQVEsRUFDUixTQUFTLENBQ2tDLENBQUM7WUFFaEQsR0FBRyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDO1lBQ2hELEdBQUcsQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQztZQUNoRCxPQUFPLEdBQUcsQ0FBQztRQUNiLENBQUMsRUFDRCxFQUFDLFdBQVcsRUFBRSxFQUFFLEVBQUUsWUFBWSxFQUFFLEVBQUUsRUFHakMsQ0FDRixDQUFDO1FBRUY7Ozs7OztXQU1HO1FBRUgsTUFBTSxvQkFBb0IsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUN6QywyQ0FBMkMsQ0FBQyxXQUFXLENBQ3hELENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQUU7WUFDckMsSUFDRSwyQ0FBMkMsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDO2dCQUNqRSxRQUFRLEVBQ1I7Z0JBQ0EsR0FBRyxDQUFDLE9BQU8sQ0FBQyxHQUFHLFNBQVMsQ0FBQzthQUMxQjtZQUNELE9BQU8sR0FBRyxDQUFDO1FBQ2IsQ0FBQyxFQUFFLEVBQVMsQ0FBQyxDQUFDO1FBQ2Qsb0JBQW9CLENBQUMsV0FBVyxHQUFHLFdBQVcsQ0FBQztRQUMvQyxNQUFNLGdDQUFnQyxHQUNwQyxJQUFJLENBQUMsK0JBQStCLENBQUMsb0JBQW9CLENBQVcsQ0FBQztRQUN2RSwyQ0FBMkMsQ0FBQyxXQUFXLG1DQUNsRCwyQ0FBMkMsQ0FBQyxXQUFXLEdBQ3ZELGdDQUFnQyxDQUNwQyxDQUFDO1FBRUY7O1dBRUc7UUFDSCxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQyxVQUFVO2FBQzdDLDRCQUE0QixDQUFDLFdBQVcsQ0FBQzthQUN6QyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUUsSUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDViw0REFBNEQ7WUFDNUQsbUZBQW1GO1lBQ25GLElBQ0UsMkNBQTJDLENBQUMsWUFBWSxDQUN0RCxJQUFJLENBQUMsSUFBSSxDQUNWLEtBQUssU0FBUyxFQUNmO2dCQUNBLE1BQU0sSUFBSSxnREFBdUMsQ0FDL0MsSUFBSSxDQUFDLElBQUksRUFDVCwyQ0FBMkMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUNuRSxDQUFDO2FBQ0g7WUFDRCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO1FBRUw7O1dBRUc7UUFDSCxNQUFNLDBCQUEwQixHQUFHLE1BQU0sQ0FBQyxPQUFPLG1CQUM1QywyQ0FBMkMsQ0FBQyxXQUFXLEVBQzFELENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxFQUFFLFNBQVMsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsK0ZBQStGO1lBQy9GLElBQ0csb0JBQWdELENBQUMsT0FBTyxDQUFDLEtBQUssU0FBUyxFQUN4RTtnQkFDQSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsU0FBUyxDQUFDO2FBQzFCO1lBQ0QsT0FBTyxHQUFHLENBQUM7UUFDYixDQUFDLEVBQUUsRUFBeUIsQ0FBQyxDQUFDO1FBRTlCLE1BQU0sNEJBQTRCLEdBQ2hDLElBQUksQ0FBQywrQkFBK0IsQ0FDbEMsV0FBVyxFQUNYLDBCQUEwQixFQUMxQiwyQ0FBMkMsQ0FBQyxZQUFZLEVBQ3hEO1lBQ0Usd0JBQXdCLEVBQ3RCLDJDQUEyQyxDQUFDLFdBQVc7U0FDMUQsQ0FDRixDQUFDO1FBRUosa0NBQWtDO1FBQ2xDLElBQUksQ0FBQyxJQUFBLCtCQUFhLEVBQUMsNEJBQTRCLENBQUMsRUFBRTtZQUNoRCxzRkFBc0Y7WUFDdEYsSUFBSSx3QkFBd0IsQ0FBQyxNQUFNLEVBQUU7Z0JBQ25DLE1BQU0sSUFBSSwwQ0FBaUMsQ0FDekMsNEJBQTZCLEVBQzdCLHdCQUF3QixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FDaEQsQ0FBQzthQUNIO1NBQ0Y7UUFFRDs7V0FFRztRQUNILE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQywrQkFBK0IsQ0FDMUQsV0FBVyxFQUNYLDJDQUEyQyxDQUFDLFdBQVcsRUFDdkQsMkNBQTJDLENBQUMsWUFBWSxFQUN4RDtZQUNFLGtCQUFrQjtZQUNsQix3QkFBd0IsRUFBRSxrQkFDckIsb0JBQW9CLENBQ0Q7U0FDekIsQ0FDRixDQUFDO1FBRUY7O1dBRUc7UUFDSCxNQUFNLFlBQVksR0FFcUI7WUFDckMsU0FBUyxFQUFFLFNBQVM7WUFDcEIsR0FBRyxvQkFDRSxnQkFBZ0IsQ0FDcEI7WUFDRCxzQkFBc0IsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsc0JBQXNCO1lBQy9ELDZCQUE2QjtZQUM3QixZQUFZLEVBQUUsc0JBQWEsQ0FBQyxPQUFPO1NBQ3BDLENBQUM7UUFFRjs7V0FFRztRQUNILElBQUksT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUEsK0JBQWEsRUFBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDbEQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGdCQUFnQixDQUMzRCxPQUFPLENBQUMsS0FBSyxDQUNkLENBQUM7WUFFRixJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNkLE1BQU0sSUFBSSxLQUFLLENBQ2IsbURBQW1ELElBQUksQ0FBQyxTQUFTLENBQy9ELE9BQU8sQ0FBQyxLQUFLLENBQ2QsRUFBRSxDQUNKLENBQUM7YUFDSDtZQUVELE1BQU0sRUFDSixtQkFBbUIsRUFDbkIsd0JBQXdCLEVBQ3hCLHlCQUF5QixHQUMxQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyx3QkFBd0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUvRCwrQ0FBK0M7WUFDL0MsWUFBWSxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDO1lBQ3ZELFlBQVksQ0FBQyx3QkFBd0IsbUNBQ2hDLHdCQUF3QixHQUN4QixZQUFZLENBQUMsd0JBQXdCLENBQ3pDLENBQUM7WUFDRixZQUFZLENBQUMseUJBQXlCLG1DQUNqQyx5QkFBeUIsR0FDekIsWUFBWSxDQUFDLHlCQUF5QixDQUMxQyxDQUFDO1NBQ0g7UUFFRDs7O1dBR0c7UUFDSCxJQUNFLElBQUEsb0JBQVEsRUFBQyw0QkFBNEIsQ0FBQztZQUN0QyxDQUFDLElBQUEsK0JBQWEsRUFBQyw0QkFBNEIsQ0FBQyxFQUM1QztZQUNBLE1BQU0sNkJBQTZCLEdBQ2pDLElBQUksQ0FBQyxtQ0FBbUMsQ0FDdEMsUUFBUSxDQUFDLEtBQUssRUFDZCxRQUFRLENBQUMsSUFBSSxFQUNiLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUMxQjtnQkFDRSxJQUFJLGdEQUNDLDRCQUE0QixHQUM1QixlQUFlLEdBQ2YsMkNBQTJDLENBQUMsV0FBVyxDQUMzRDtnQkFDRCxTQUFTLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJO2dCQUM5QixzQkFBc0IsRUFBRSxZQUFZLENBQUMsc0JBQXNCO2dCQUMzRCxZQUFZLEVBQUUsWUFBWSxDQUFDLFlBQVk7Z0JBQ3ZDLG1CQUFtQixFQUFFLFlBQVksQ0FBQyxtQkFBbUI7Z0JBQ3JELHdCQUF3QixFQUFFLFlBQVksQ0FBQyx3QkFBd0I7Z0JBQy9ELHlCQUF5QixFQUFFLFlBQVksQ0FBQyx5QkFBeUI7YUFDbEUsRUFDRCxlQUFlLENBQ2hCLENBQUM7WUFFSixPQUFPO2dCQUNMLG9CQUFvQjtnQkFDcEIsV0FBVztnQkFDWCw2QkFBNkI7YUFDOUIsQ0FBQztTQUNIO1FBRUQ7O1dBRUc7UUFDSCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsYUFBYSxpQ0FFaEQscUJBQXFCLEdBQ3JCLGVBQWUsR0FFcEIsMkNBQTJDLENBQUMsV0FBVyxDQUN4RCxDQUFDO1FBRUYsTUFBTSxFQUNKLGdCQUFnQixFQUNoQix3QkFBd0IsRUFDeEIseUJBQXlCLEdBQzFCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHFCQUFxQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pELFlBQVksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQztRQUNqRCxZQUFZLENBQUMsd0JBQXdCLG1DQUNoQyx3QkFBd0IsR0FDeEIsWUFBWSxDQUFDLHdCQUF3QixDQUN6QyxDQUFDO1FBQ0YsWUFBWSxDQUFDLHlCQUF5QixtQ0FDakMseUJBQXlCLEdBQ3pCLFlBQVksQ0FBQyx5QkFBeUIsQ0FDMUMsQ0FBQztRQUVGOztXQUVHO1FBQ0gsSUFBSSx3QkFBd0IsQ0FBQyxNQUFNLEVBQUU7WUFDbkMsMEZBQTBGO1lBQzFGLE1BQU0sNkJBQTZCLEdBQ2pDLElBQUksQ0FBQyxtQ0FBbUMsQ0FDdEMsUUFBUSxDQUFDLEtBQUssRUFDZCxRQUFRLENBQUMsSUFBSSxFQUNiLHdCQUF3QixFQUN4QixJQUFBLG9CQUFRLEVBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxFQUN0QywyQ0FBMkMsQ0FBQyxXQUFXLEVBQ3ZELGVBQWUsQ0FDaEIsQ0FBQztZQUVKLE9BQU87Z0JBQ0wsb0JBQW9CO2dCQUNwQixXQUFXO2dCQUNYLDZCQUE2QjthQUM5QixDQUFDO1NBQ0g7UUFFRDs7V0FFRztRQUNILElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNsQyxTQUFTLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLFNBQVM7WUFDckMsU0FBUyxFQUFFLHVCQUFjLENBQUMsTUFBTTtZQUNoQyxNQUFNLEVBQUUsT0FBTztZQUNmLFVBQVUsRUFBRSxRQUFRLENBQUMsSUFBSTtZQUN6QixVQUFVLEVBQUUsSUFBSTtZQUNoQixJQUFJLEVBQUUsWUFBWTtTQUNuQixDQUFDLENBQUM7UUFDSCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRUQsa0JBQWtCLENBQ2hCLFdBQWlDLEVBQ2pDLFVBQXNCLEVBQ3RCLE9BQTJDLEVBQzNDLGVBQWlDO1FBRWpDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ2xDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztZQUNyQyxTQUFTLEVBQUUsdUJBQWMsQ0FBQyxNQUFNO1lBQ2hDLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLFVBQVUsRUFBRSxRQUFRLENBQUMsSUFBSTtZQUN6QixVQUFVO1NBQ1gsQ0FBQyxDQUFDO1FBQ0gsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFFdEMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQy9DLFFBQVEsQ0FBQyxLQUFLLEVBQ2QsUUFBUSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQzFCLFVBQVUsQ0FDWCxDQUFDO1FBRUYsSUFBSSxJQUFBLCtCQUFhLEVBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUNuQyxNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixDQUFDLENBQUM7U0FDbEQ7UUFFRCxNQUFNLHdCQUF3QixHQUM1QixJQUFJLENBQUMsVUFBVSxDQUFDLDRCQUE0QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRTVELE1BQU0sZ0JBQWdCLEdBQXdDO1lBQzVELFNBQVMsRUFBRSxTQUFTO1lBQ3BCLEdBQUcsb0JBQ0UsZ0JBQWdCLENBQ3BCO1lBQ0Qsc0JBQXNCLEVBQUUsZUFBZSxhQUFmLGVBQWUsdUJBQWYsZUFBZSxDQUFFLHNCQUFzQjtTQUNoRSxDQUFDO1FBRUYsSUFBSSxDQUFBLE9BQU8sYUFBUCxPQUFPLHVCQUFQLE9BQU8sQ0FBRSxLQUFLLEtBQUksQ0FBQyxJQUFBLCtCQUFhLEVBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ25ELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxnQkFBZ0IsQ0FDM0QsT0FBTyxhQUFQLE9BQU8sdUJBQVAsT0FBTyxDQUFFLEtBQUssQ0FDZixDQUFDO1lBRUYsSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDZCxNQUFNLElBQUksS0FBSyxDQUNiLG1EQUFtRCxJQUFJLENBQUMsU0FBUyxDQUMvRCxPQUFPLGFBQVAsT0FBTyx1QkFBUCxPQUFPLENBQUUsS0FBSyxDQUNmLEVBQUUsQ0FDSixDQUFDO2FBQ0g7WUFFRCxNQUFNLEVBQ0osbUJBQW1CLEVBQ25CLHdCQUF3QixFQUN4Qix5QkFBeUIsR0FDMUIsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsd0JBQXdCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFL0QsZ0JBQWdCLENBQUMsbUJBQW1CLEdBQUcsbUJBQW1CLENBQUM7WUFDM0QsZ0JBQWdCLENBQUMsd0JBQXdCLG1DQUNwQyxnQkFBZ0IsQ0FBQyx3QkFBd0IsR0FDekMsd0JBQXdCLENBQzVCLENBQUM7WUFFRixnQkFBZ0IsQ0FBQyx5QkFBeUIsbUNBQ3JDLGdCQUFnQixDQUFDLHlCQUF5QixHQUMxQyx5QkFBeUIsQ0FDN0IsQ0FBQztTQUNIO1FBRUQsSUFBSSxDQUFDLENBQUEsd0JBQXdCLGFBQXhCLHdCQUF3Qix1QkFBeEIsd0JBQXdCLENBQUUsTUFBTSxDQUFBLEVBQUU7WUFDckMsOERBQThEO1lBQzlELElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztnQkFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO2dCQUNyQyxTQUFTLEVBQUUsdUJBQWMsQ0FBQyxNQUFNO2dCQUNoQyxNQUFNLEVBQUUsT0FBTztnQkFDZixVQUFVLEVBQUUsUUFBUSxDQUFDLElBQUk7Z0JBQ3pCLFVBQVU7YUFDWCxDQUFDLENBQUM7WUFDSCxPQUFPLGdCQUFnQixDQUFDO1NBQ3pCO1FBRUQsMEJBQTBCO1FBQzFCLE1BQU0sNkJBQTZCLEdBQUcsSUFBSSxDQUFDLDZCQUE2QixDQUN0RSxRQUFRLENBQUMsS0FBSyxFQUNkLFFBQVEsQ0FBQyxJQUFJLEVBQ2Isd0JBQXdCLEVBQ3hCLGdCQUFnQixFQUNoQixlQUFlLENBQ2hCLENBQUM7UUFFRixPQUFPO1lBQ0wsb0JBQW9CLEVBQUUsVUFBVTtZQUNoQyxXQUFXO1lBQ1gsNkJBQTZCO1NBQzlCLENBQUM7SUFDSixDQUFDO0lBRUQsaUJBQWlCLENBQ2YsV0FBaUMsRUFDakMsc0JBQXVELEVBQ3ZELFlBQStDLEVBQy9DLGVBQWlDOztRQUVqQyxNQUFNLEVBQUMsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUMsR0FDekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO1lBQ3JDLFNBQVMsRUFBRSx1QkFBYyxDQUFDLEtBQUs7WUFDL0IsTUFBTSxFQUFFLFFBQVE7WUFDaEIsVUFBVSxFQUFFLElBQUk7WUFDaEIsVUFBVSxFQUFFLHNCQUFzQjtZQUNsQyxPQUFPLEVBQUUsWUFBWTtTQUN0QixDQUFDLENBQUM7UUFDSCxNQUFNLGNBQWMsR0FBRyxZQUFZLGFBQVosWUFBWSx1QkFBWixZQUFZLENBQUUsVUFBVSxDQUFDO1FBQ2hELElBQUksWUFBc0MsQ0FBQztRQUMzQyxJQUFJLGNBQWMsRUFBRTtZQUNsQixNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQzFELElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ2xCLE1BQU0sSUFBSSw4QkFBcUIsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2FBQzdEO1lBRUQsTUFBTSxxQkFBcUIsR0FDekIsTUFBTSxDQUFDLE9BQU8sSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBRW5ELElBQUksQ0FBQyxxQkFBcUIsRUFBRTtnQkFDMUIsTUFBTSxJQUFJLEtBQUssQ0FDYix3Q0FBd0MsY0FBYyx3Q0FBd0MsQ0FDL0YsQ0FBQzthQUNIO1lBQ0QsWUFBWSxHQUFHLGFBQWEsQ0FBQztTQUM5QjtRQUVELCtDQUErQztRQUMvQywwRUFBMEU7UUFDMUUsTUFBTSxrQkFBa0IsR0FBRyxFQUFnQyxDQUFDO1FBQzVELElBQ0UsQ0FBQyxjQUFjO1lBQ2YsQ0FBQyxZQUFZO1lBQ2IsQ0FBQSxZQUFZLGFBQVosWUFBWSx1QkFBWixZQUFZLENBQUUsSUFBSSxNQUFLLG1CQUFVLENBQUMsR0FBRyxFQUNyQztZQUNBLGtCQUFrQixDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsWUFBWSxDQUFDO1lBQzdDLGtCQUFrQixDQUFDLEtBQUs7Z0JBQ3RCLE9BQU8sc0JBQXNCLEtBQUssUUFBUTtvQkFDeEMsQ0FBQyxDQUFDLHNCQUFzQjtvQkFDeEIsQ0FBQyxDQUFDLElBQUEsb0JBQVEsRUFDTixNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLEVBQ2hELHNCQUFzQixDQUN2QixDQUFDO1NBQ1Q7YUFBTTtZQUNMLHlEQUF5RDtZQUN6RCxrQkFBa0IsQ0FBQyxJQUFJLEdBQUcsWUFBWSxDQUFDLFlBQVksQ0FBQztZQUNwRCxNQUFNLHFCQUFxQixHQUFHLENBQUMsTUFBQSxNQUFNLENBQUMsT0FBTyxtQ0FBSSxFQUFFLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUVyRSxrQkFBa0IsQ0FBQyxLQUFLO2dCQUN0QixPQUFPLHNCQUFzQixLQUFLLFFBQVE7b0JBQ3hDLENBQUMsQ0FBQyxzQkFBc0I7b0JBQ3hCLENBQUMsQ0FBQyxJQUFBLG9CQUFRLEVBQ04scUJBQXFCLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsRUFDM0Qsc0JBQXNCLENBQ3ZCLENBQUM7U0FDVDtRQUVELE1BQU0scUJBQXFCLEdBQUcsSUFBSSw0QkFBWSxFQUFFLENBQUMsTUFBTSxDQUNyRCxrQkFBa0IsQ0FBQyxJQUFJLEVBQ3ZCLGtCQUFrQixDQUFDLEtBQUssQ0FDekIsQ0FBQztRQUVGLE1BQU0sK0JBQStCLEdBQ25DLElBQUksQ0FBQyxpQkFBaUIsQ0FBQywyQkFBMkIsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRTVFLE1BQU0sYUFBYSxHQUFHLEVBQW9CLENBQUM7UUFDM0Msb0ZBQW9GO1FBQ3BGLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDakIsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFO2dCQUM3QixNQUFNLElBQUksS0FBSyxDQUNiLFNBQVMsS0FBSyxDQUFDLElBQUksc0VBQXNFLENBQzFGLENBQUM7YUFDSDtZQUVELGFBQWEsQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztTQUNwQzthQUFNO1lBQ0wsYUFBYSxDQUFDLElBQUksR0FBRyxZQUFZLENBQUMsT0FBTyxDQUFDO1NBQzNDO1FBRUQsa0VBQWtFO1FBQ2xFLElBQUksZ0JBQWdCLEdBQUcsZ0JBQ3JCLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUNyQixTQUFTLEVBQUUsY0FBYyxFQUN6QixzQkFBc0IsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsc0JBQXNCLElBQzVELCtCQUErQixDQUNELENBQUM7UUFFcEMsSUFBSSxZQUFZLElBQUksQ0FBQyxJQUFBLCtCQUFhLEVBQUMsWUFBWSxDQUFDLEVBQUU7WUFDaEQsTUFBTSxFQUNKLE9BQU8sRUFBRSxLQUFLLEVBQ2QsS0FBSyxFQUNMLFlBQVksRUFDWixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsRUFDVCxjQUFjLEdBQ2YsR0FBRyxZQUFZLENBQUM7WUFFakIsZ0JBQWdCLG1DQUNYLGdCQUFnQixLQUNuQixLQUFLLEVBQUUsS0FBSyxFQUNaLGNBQWMsRUFBRSxjQUFjLEdBQy9CLENBQUM7WUFFRixJQUFJLEtBQUssRUFBRTtnQkFDVCxnQkFBZ0IsQ0FBQyxnQkFBZ0IsR0FBRyxLQUFLLEtBQUssb0JBQVcsQ0FBQyxHQUFHLENBQUM7YUFDL0Q7WUFFRCxnQ0FBZ0M7WUFDaEMsSUFBSSxZQUFZLElBQUksQ0FBQyxJQUFBLCtCQUFhLEVBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQ2hELDJCQUEyQjtnQkFDM0IsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsbUJBQW1CLENBQ3JFLGFBQWEsQ0FBQyxJQUFJLEVBQ2xCLFlBQVksQ0FDYixDQUFDO2dCQUVGLGtHQUFrRztnQkFDbEcsTUFBTSxFQUNKLHNCQUFzQixFQUN0Qix3QkFBd0IsRUFDeEIseUJBQXlCLEdBQzFCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLDJCQUEyQixDQUNwRCxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FDOUMsQ0FBQztnQkFFRixnQkFBZ0IsbUNBQ1gsZ0JBQWdCLEtBQ25CLHNCQUFzQixFQUN0Qix3QkFBd0Isa0NBQ25CLGdCQUFnQixDQUFDLHdCQUF3QixHQUN6Qyx3QkFBd0IsR0FFN0IseUJBQXlCLGtDQUNwQixnQkFBZ0IsQ0FBQyx5QkFBeUIsR0FDMUMseUJBQXlCLElBRS9CLENBQUM7YUFDSDtZQUVELDhEQUE4RDtZQUM5RCxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUEsK0JBQWEsRUFBQyxLQUFLLENBQUMsRUFBRTtnQkFDbEMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFFL0QsSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDWCxNQUFNLElBQUksZ0NBQXVCLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQzFDO2dCQUVELE1BQU0sRUFDSixnQkFBZ0IsRUFDaEIsd0JBQXdCLEVBQ3hCLHlCQUF5QixHQUMxQixHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxxQkFBcUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFFekQsZ0JBQWdCLG1DQUNYLGdCQUFnQixLQUNuQixnQkFBZ0IsRUFDaEIsd0JBQXdCLGtDQUNuQixnQkFBZ0IsQ0FBQyx3QkFBd0IsR0FDekMsd0JBQXdCLEdBRTdCLHlCQUF5QixrQ0FDcEIsZ0JBQWdCLENBQUMseUJBQXlCLEdBQzFDLHlCQUF5QixJQUUvQixDQUFDO2FBQ0g7WUFFRCx3Q0FBd0M7WUFDeEMsSUFBSSxTQUFTLEVBQUU7Z0JBQ2IsSUFBSSxNQUFNLGFBQU4sTUFBTSx1QkFBTixNQUFNLENBQUUsTUFBTSxFQUFFO29CQUNsQixNQUFNLElBQUksS0FBSyxDQUNiLDBEQUEwRCxDQUMzRCxDQUFDO2lCQUNIO2dCQUNELDBEQUEwRDtnQkFDMUQsZ0JBQWdCLENBQUMsTUFBTSxHQUFHLDBCQUFpQixDQUFDLEtBQUssQ0FBQzthQUNuRDtZQUVELG9DQUFvQztZQUNwQyxJQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO2dCQUMzQixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsaUJBQWlCLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBRXhFLElBQUksQ0FBQyxVQUFVLEVBQUU7b0JBQ2YsTUFBTSxJQUFJLGdDQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDO2lCQUMzQztnQkFFRCxNQUFNLEVBQUMsb0JBQW9CLEVBQUUsd0JBQXdCLEVBQUMsR0FDcEQsSUFBSSxDQUFDLGlCQUFpQixDQUFDLHlCQUF5QixDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUUvRCxnQkFBZ0IsbUNBQ1gsZ0JBQWdCLEtBQ25CLG9CQUFvQixFQUNwQix3QkFBd0Isa0NBQ25CLGdCQUFnQixDQUFDLHdCQUF3QixHQUN6Qyx3QkFBd0IsSUFFOUIsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO1lBQ3JDLFNBQVMsRUFBRSx1QkFBYyxDQUFDLEtBQUs7WUFDL0IsTUFBTSxFQUFFLE9BQU87WUFDZixVQUFVLEVBQUUsSUFBSTtZQUNoQixVQUFVLEVBQUUsc0JBQXNCO1lBQ2xDLElBQUksRUFBRSxnQkFBZ0I7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxnQkFBZ0IsQ0FBQztJQUMxQixDQUFDO0lBRU8sbUNBQW1DLENBQ3pDLEtBQVksRUFDWixVQUFrQixFQUNsQixnQkFBOEMsRUFDOUMsV0FBNkMsRUFDN0MsZUFBaUM7UUFFakMsT0FBTyxDQUFDLGdCQUFxQixFQUFFLEVBQUU7WUFDL0IsTUFBTSxzQkFBc0IsR0FDMUI7Z0JBQ0U7b0JBQ0UsR0FBRyxrQ0FDRSxXQUFXO3dCQUNkLCtCQUErQjt3QkFDL0IsSUFBSSxrQ0FBTSxnQkFBZ0IsR0FBSyxXQUFXLENBQUMsSUFBSSxJQUNoRDtpQkFDRjthQUMyQyxDQUFDO1lBRWpELHlGQUF5RjtZQUN6RixJQUFJLGdCQUFnQixJQUFJLENBQUMsSUFBQSwrQkFBYSxFQUFDLGdCQUFnQixDQUFDLEVBQUU7Z0JBQ3hELHNCQUFzQixDQUFDLElBQUksQ0FBQztvQkFDMUIsTUFBTSxFQUFFO3dCQUNOLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSTt3QkFDckIsR0FBRyxvQkFDRSxJQUFJLENBQUMsbUJBQW1CLENBQ3pCLEtBQUssRUFDTCxnQkFBZ0IsRUFDaEIsZ0JBQWdCLENBQ2pCLENBQ0Y7cUJBQ0Y7aUJBQ0YsQ0FBQyxDQUFDO2FBQ0o7WUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7Z0JBQ2xDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztnQkFDckMsU0FBUyxFQUFFLHVCQUFjLENBQUMsTUFBTTtnQkFDaEMsTUFBTSxFQUFFLE9BQU87Z0JBQ2YsVUFBVTtnQkFDVixVQUFVLEVBQUUsSUFBSTtnQkFDaEIsSUFBSSxFQUFFLHNCQUFzQjthQUM3QixDQUFDLENBQUM7WUFFSCxPQUFPLHNCQUFzQixDQUFDO1FBQ2hDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRDs7Ozs7T0FLRztJQUNLLG1DQUFtQyxDQUN6QyxLQUFZLEVBQ1osVUFBa0IsRUFDbEIsd0JBTUcsRUFDSCxRQUE2QyxFQUM3QyxPQUFZLEVBQ1osZUFBaUM7UUFFakMsbUNBQW1DO1FBQ25DLE9BQU8sQ0FBQyxnQkFBcUIsRUFBRSxFQUFFO1lBQy9CLHVFQUF1RTtZQUN2RSxNQUFNLCtCQUErQixHQUNuQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsb0NBQW9DLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFckUsd0RBQXdEO1lBQ3hELE1BQU0scUJBQXFCLEdBQ3pCLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDdEMsTUFBTSx5QkFBeUIsR0FDN0I7b0JBQ0U7d0JBQ0UsR0FBRyxrQkFDRCxTQUFTLEVBQUUsS0FBSyxDQUFDLElBQUksRUFDckIsSUFBSSxvQkFDQyxJQUFJLENBQUMsbUJBQW1CLENBQ3pCLEtBQUssRUFDTCxJQUFJLENBQUMsTUFBTSxFQUNYLE9BQTBCLENBQzNCLEtBRUEsK0JBQStCLENBQ25DO3FCQUNGO2lCQUNGLENBQUM7Z0JBRUosb0ZBQW9GO2dCQUNwRixJQUFJLGdCQUFnQixJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtvQkFDbkQseUJBQXlCLENBQUMsSUFBSSxDQUFDO3dCQUM3QixNQUFNLEVBQUU7NEJBQ04sU0FBUyxFQUFFLEtBQUssQ0FBQyxJQUFJOzRCQUNyQixHQUFHLG9CQUNFLElBQUksQ0FBQyxtQkFBbUIsQ0FDekIsS0FBSyxFQUNMLElBQUksQ0FBQyxNQUFNLEVBQ1gsZ0JBQWdCLENBQ2pCLENBQ0Y7eUJBQ0Y7cUJBQ0YsQ0FBQyxDQUFDO2lCQUNKO2dCQUVELE9BQU8seUJBQXlCLENBQUM7WUFDbkMsQ0FBQyxDQUFDLENBQUM7WUFFTCxtRkFBbUY7WUFDbkYsTUFBTSxzQkFBc0IsR0FBRztnQkFDN0IsRUFBQyxNQUFNLEVBQUUsUUFBUSxFQUFDO2dCQUNsQixHQUFHLHFCQUFxQjthQUNvQixDQUFDO1lBQy9DLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztnQkFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO2dCQUNyQyxTQUFTLEVBQUUsdUJBQWMsQ0FBQyxNQUFNO2dCQUNoQyxNQUFNLEVBQUUsT0FBTztnQkFDZixVQUFVO2dCQUNWLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixJQUFJLEVBQUUsc0JBQXNCO2FBQzdCLENBQUMsQ0FBQztZQUNILE9BQU8sc0JBQXNCLENBQUM7UUFDaEMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0ssNkJBQTZCLENBQ25DLEtBQVksRUFDWixVQUFrQixFQUNsQix3QkFNRyxFQUNILFFBQTZDLEVBQzdDLGVBQWlDO1FBRWpDLE9BQU8sQ0FBQyxnQkFBcUIsRUFBRSxFQUFFO1lBQy9CLElBQUkscUJBQXFCLEdBQThDLEVBQUUsQ0FBQztZQUMxRSxJQUFJLGdCQUFnQixFQUFFO2dCQUNwQixxQkFBcUIsR0FBRyx3QkFBd0IsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUU7b0JBQzFELE9BQU87d0JBQ0wsTUFBTSxFQUFFOzRCQUNOLFNBQVMsRUFBRSxLQUFLLENBQUMsSUFBSTs0QkFDckIsR0FBRyxvQkFDRSxJQUFJLENBQUMsbUJBQW1CLENBQ3pCLEtBQUssRUFDTCxJQUFJLENBQUMsTUFBTSxFQUNYLGdCQUFnQixDQUNqQixDQUNGO3lCQUNGO3FCQUNGLENBQUM7Z0JBQ0osQ0FBQyxDQUFDLENBQUM7YUFDSjtZQUVELE1BQU0sc0JBQXNCLEdBQUc7Z0JBQzdCO29CQUNFLE1BQU0sRUFBRSxRQUFRO2lCQUNqQjtnQkFDRCxHQUFHLHFCQUFxQjthQUNvQixDQUFDO1lBRS9DLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztnQkFDbEMsU0FBUyxFQUFFLGVBQWUsYUFBZixlQUFlLHVCQUFmLGVBQWUsQ0FBRSxTQUFTO2dCQUNyQyxTQUFTLEVBQUUsdUJBQWMsQ0FBQyxNQUFNO2dCQUNoQyxNQUFNLEVBQUUsT0FBTztnQkFDZixVQUFVO2dCQUNWLFVBQVUsRUFBRSxJQUFJO2dCQUNoQixJQUFJLEVBQUUsc0JBQXNCO2FBQzdCLENBQUMsQ0FBQztZQUVILE9BQU8sc0JBQXNCLENBQUM7UUFDaEMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBeGtDRCw0RUF3a0NDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRW50aXR5VGFyZ2V0LFxuICBJTkRFWF9UWVBFLFxuICBRVUVSWV9PUkRFUixcbiAgUmVwbGFjZSxcbiAgUkVUVVJOX1ZBTFVFUyxcbiAgVGFibGUsXG4gIFRSQU5TRk9STV9UWVBFLFxuICBJbmRleE9wdGlvbnMsXG4gIFFVRVJZX1NFTEVDVF9UWVBFLFxuICBOb1N1Y2hJbmRleEZvdW5kRXJyb3IsXG4gIEludmFsaWRGaWx0ZXJJbnB1dEVycm9yLFxuICBJbnZhbGlkU2VsZWN0SW5wdXRFcnJvcixcbiAgSW52YWxpZFVuaXF1ZUF0dHJpYnV0ZVVwZGF0ZUVycm9yLFxuICBJbnZhbGlkRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZVZhbHVlRXJyb3IsXG59IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtkcm9wUHJvcH0gZnJvbSAnLi4vLi4vaGVscGVycy9kcm9wLXByb3AnO1xuaW1wb3J0IHtnZXRDb25zdHJ1Y3RvckZvckluc3RhbmNlfSBmcm9tICcuLi8uLi9oZWxwZXJzL2dldC1jb25zdHJ1Y3Rvci1mb3ItaW5zdGFuY2UnO1xuaW1wb3J0IHtpc0VtcHR5T2JqZWN0fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLWVtcHR5LW9iamVjdCc7XG5pbXBvcnQge3BhcnNlS2V5fSBmcm9tICcuLi8uLi9oZWxwZXJzL3BhcnNlLWtleSc7XG5pbXBvcnQge0tleUNvbmRpdGlvbn0gZnJvbSAnLi4vZXhwcmVzc2lvbi9rZXktY29uZGl0aW9uJztcbmltcG9ydCB7Q29ubmVjdGlvbn0gZnJvbSAnLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uJztcbmltcG9ydCB7RXhwcmVzc2lvbkJ1aWxkZXJ9IGZyb20gJy4uL2V4cHJlc3Npb24vZXhwcmVzc2lvbi1idWlsZGVyJztcbmltcG9ydCB7QXR0cmlidXRlTWV0YWRhdGF9IGZyb20gJy4uL21ldGFkYXRhL2F0dHJpYnV0ZS1tZXRhZGF0YSc7XG5pbXBvcnQge0R5bmFtb0VudGl0eVNjaGVtYVByaW1hcnlLZXl9IGZyb20gJy4uL21ldGFkYXRhL2VudGl0eS1tZXRhZGF0YSc7XG5pbXBvcnQge0Jhc2VUcmFuc2Zvcm1lciwgTWV0YWRhdGFPcHRpb25zfSBmcm9tICcuL2Jhc2UtdHJhbnNmb3JtZXInO1xuaW1wb3J0IHtMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyfSBmcm9tICcuL2lzLWxhenktdHJhbnNhY3Rpb24td3JpdGUtaXRlbS1saXN0LWxvYWRlcic7XG5pbXBvcnQge0tleUNvbmRpdGlvbk9wdGlvbnN9IGZyb20gJy4uL2V4cHJlc3Npb24va2V5LWNvbmRpdGlvbi1vcHRpb25zLXR5cGUnO1xuaW1wb3J0IHtVcGRhdGVCb2R5fSBmcm9tICcuLi9leHByZXNzaW9uL3VwZGF0ZS1ib2R5LXR5cGUnO1xuaW1wb3J0IHtpc09iamVjdH0gZnJvbSAnLi4vLi4vaGVscGVycy9pcy1vYmplY3QnO1xuaW1wb3J0IHtEb2N1bWVudENsaWVudFR5cGVzfSBmcm9tICdAdHlwZWRvcm0vZG9jdW1lbnQtY2xpZW50JztcbmltcG9ydCB7YXV0b0dlbmVyYXRlVmFsdWV9IGZyb20gJy4uLy4uL2hlbHBlcnMvYXV0by1nZW5lcmF0ZS1hdHRyaWJ1dGUtdmFsdWUnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE1hbmFnZXJUb0R5bmFtb1B1dEl0ZW1PcHRpb25zIHtcbiAgLyoqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICBvdmVyd3JpdGVJZkV4aXN0cz86IGJvb2xlYW47XG5cbiAgd2hlcmU/OiBhbnk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFuYWdlclRvRHluYW1vVXBkYXRlSXRlbXNPcHRpb25zIHtcbiAgLyoqXG4gICAqIGtleSBzZXBhcmF0b3JcbiAgICogQGRlZmF1bHQgJy4nJ1xuICAgKi9cbiAgbmVzdGVkS2V5U2VwYXJhdG9yPzogc3RyaW5nO1xuXG4gIHdoZXJlPzogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1hbmFnZXJUb0R5bmFtb0RlbGV0ZUl0ZW1zT3B0aW9ucyB7XG4gIHdoZXJlPzogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE1hbmFnZXJUb0R5bmFtb1F1ZXJ5SXRlbXNPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluZGV4IHRvIHF1ZXJ5LCB3aGVuIG9taXR0ZWQsIHF1ZXJ5IHdpbGwgYmUgcnVuIGFnYWluc3QgbWFpbiB0YWJsZVxuICAgKi9cbiAgcXVlcnlJbmRleD86IHN0cmluZztcbiAgLyoqXG4gICAqIFNvcnQga2V5IGNvbmRpdGlvblxuICAgKiBAZGVmYXVsdCBub25lIC0gbm8gc29ydCBrZXkgY29uZGl0aW9uIGlzIGFwcGxpZWRcbiAgICovXG4gIGtleUNvbmRpdGlvbj86IEtleUNvbmRpdGlvbk9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIE1heCBudW1iZXIgb2YgcmVjb3JkcyB0byBxdWVyeVxuICAgKiBAZGVmYXVsdCAtIGltcGxpY2l0IGR5bmFtbyBkYiBxdWVyeSBsaW1pdCBpcyBhcHBsaWVkXG4gICAqL1xuICBsaW1pdD86IG51bWJlcjtcblxuICAvKipcbiAgICogT3JkZXIgdG8gcXVlcnkgaXRlbXMgaW5cbiAgICogQGRlZmF1bHQgQVNDXG4gICAqL1xuICBvcmRlckJ5PzogUVVFUllfT1JERVI7XG5cbiAgd2hlcmU/OiBhbnk7XG5cbiAgc2VsZWN0PzogYW55W107XG5cbiAgb25seUNvdW50PzogYm9vbGVhbjtcblxuICBjb25zaXN0ZW50UmVhZD86IGJvb2xlYW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFuYWdlclRvRHluYW1vR2V0SXRlbU9wdGlvbnMge1xuICBzZWxlY3Q/OiBhbnlbXTtcbiAgY29uc2lzdGVudFJlYWQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgY2xhc3MgRG9jdW1lbnRDbGllbnRSZXF1ZXN0VHJhbnNmb3JtZXIgZXh0ZW5kcyBCYXNlVHJhbnNmb3JtZXIge1xuICBwcm90ZWN0ZWQgX2V4cHJlc3Npb25CdWlsZGVyOiBFeHByZXNzaW9uQnVpbGRlcjtcblxuICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uOiBDb25uZWN0aW9uKSB7XG4gICAgc3VwZXIoY29ubmVjdGlvbik7XG4gICAgdGhpcy5fZXhwcmVzc2lvbkJ1aWxkZXIgPSBuZXcgRXhwcmVzc2lvbkJ1aWxkZXIoKTtcbiAgfVxuXG4gIGdldCBleHByZXNzaW9uQnVpbGRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhwcmVzc2lvbkJ1aWxkZXI7XG4gIH1cblxuICBnZXQgZXhwcmVzc2lvbklucHV0UGFyc2VyKCkge1xuICAgIHJldHVybiB0aGlzLl9leHByZXNzaW9uSW5wdXRQYXJzZXI7XG4gIH1cblxuICB0b0R5bmFtb1B1dEl0ZW08RW50aXR5PihcbiAgICBlbnRpdHk6IEVudGl0eSxcbiAgICBvcHRpb25zPzogTWFuYWdlclRvRHluYW1vUHV0SXRlbU9wdGlvbnMsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICk6XG4gICAgfCBEb2N1bWVudENsaWVudFR5cGVzLlB1dEl0ZW1JbnB1dFxuICAgIHwgRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3Qge1xuICAgIGNvbnN0IGVudGl0eUNsYXNzID0gZ2V0Q29uc3RydWN0b3JGb3JJbnN0YW5jZShlbnRpdHkpO1xuICAgIGNvbnN0IHt0YWJsZSwgaW50ZXJuYWxBdHRyaWJ1dGVzLCBuYW1lfSA9XG4gICAgICB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RZUEUuUFVULFxuICAgICAgcHJlZml4OiAnQmVmb3JlJyxcbiAgICAgIGVudGl0eU5hbWU6IG5hbWUsXG4gICAgICBwcmltYXJ5S2V5OiBudWxsLFxuICAgICAgYm9keTogZW50aXR5LFxuICAgICAgb3B0aW9ucyxcbiAgICB9KTtcblxuICAgIGNvbnN0IHVuaXF1ZUF0dHJpYnV0ZXMgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0VW5pcXVlQXR0cmlidXRlc0ZvckVudGl0eShcbiAgICAgIGVudGl0eUNsYXNzXG4gICAgKSBhcyBBdHRyaWJ1dGVNZXRhZGF0YVtdO1xuXG4gICAgLy8gaW5jbHVkZSBhdHRyaWJ1dGVzIHdpdGggZGVmYXVsdCB2YWx1ZXMgaW5cbiAgICBjb25zdCBkeW5hbW9FbnRpdHkgPSB0aGlzLnRvRHluYW1vRW50aXR5KGVudGl0eSk7XG5cbiAgICBjb25zdCBlbnRpdHlJbnRlcm5hbEF0dHJpYnV0ZXMgPSBpbnRlcm5hbEF0dHJpYnV0ZXMucmVkdWNlKChhY2MsIGF0dHIpID0+IHtcbiAgICAgIGFjY1thdHRyLm5hbWVdID0gYXR0ci52YWx1ZTtcbiAgICAgIHJldHVybiBhY2M7XG4gICAgfSwge30gYXMgRG9jdW1lbnRDbGllbnRUeXBlcy5BdHRyaWJ1dGVNYXApO1xuXG4gICAgbGV0IGR5bmFtb1B1dEl0ZW0gPSB7XG4gICAgICBJdGVtOiB7XG4gICAgICAgIC4uLmVudGl0eUludGVybmFsQXR0cmlidXRlcyxcbiAgICAgICAgLi4uZHluYW1vRW50aXR5LFxuICAgICAgfSxcbiAgICAgIFRhYmxlTmFtZTogdGFibGUubmFtZSxcbiAgICAgIFJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICB9IGFzIERvY3VtZW50Q2xpZW50VHlwZXMuUHV0SXRlbUlucHV0O1xuXG4gICAgLy8gYXBwbHkgYXR0cmlidXRlIG5vdCBleGlzdCBjb25kaXRpb24gd2hlbiBjcmVhdGluZyB1bmlxdWVcbiAgICBjb25zdCB1bmlxdWVSZWNvcmRDb25kaXRpb25FeHByZXNzaW9uID1cbiAgICAgIHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIuYnVpbGRVbmlxdWVSZWNvcmRDb25kaXRpb25FeHByZXNzaW9uKHRhYmxlKTtcblxuICAgIC8vIGFsd2F5cyBwcmV2ZW50IG92ZXJ3cml0aW5nIGRhdGEgdW50aWwgZXhwbGljaXRseSB0b2xkIHRvIGRvIG90aGVyd2lzZVxuICAgIGlmICghb3B0aW9ucz8ub3ZlcndyaXRlSWZFeGlzdHMpIHtcbiAgICAgIGR5bmFtb1B1dEl0ZW0gPSB7XG4gICAgICAgIC4uLmR5bmFtb1B1dEl0ZW0sXG4gICAgICAgIC4uLnVuaXF1ZVJlY29yZENvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGlzIGB3aGVyZWAgY29uZGl0aW9uIG9wdGlvbnMgZXhpc3RzLCBidWlsZCBjb25kaXRpb24gZXhwcmVzc2lvblxuICAgIGlmIChvcHRpb25zPy53aGVyZSAmJiAhaXNFbXB0eU9iamVjdChvcHRpb25zPy53aGVyZSkpIHtcbiAgICAgIGNvbnN0IGNvbmRpdGlvbiA9IHRoaXMuZXhwcmVzc2lvbklucHV0UGFyc2VyLnBhcnNlVG9Db25kaXRpb24oXG4gICAgICAgIG9wdGlvbnM/LndoZXJlXG4gICAgICApO1xuXG4gICAgICBpZiAoIWNvbmRpdGlvbikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byBidWlsZCBjb25kaXRpb24gZXhwcmVzc2lvbiBmb3IgaW5wdXQ6ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgICAgICBvcHRpb25zPy53aGVyZVxuICAgICAgICAgICl9YFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7XG4gICAgICAgIENvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIH0gPSB0aGlzLmV4cHJlc3Npb25CdWlsZGVyLmJ1aWxkQ29uZGl0aW9uRXhwcmVzc2lvbihjb25kaXRpb24pO1xuXG4gICAgICAvLyBieSBkZWZhdWx0LCBlbnRpdHkgbWFuZ2VyIGFwcGVuZHMgdW5pcXVlIHJlY29yZCBjb25kaXRpb24gZXhwcmVzc2lvbiB0byBhdm9pZCBvdmVyd3JpdGluZyBpdGVtcyBpZiB0aGV5IGFscmVhZHkgZXhpc3RcbiAgICAgIC8vIHNvIGhhbmRsZSB0aGF0XG4gICAgICBjb25zdCBtZXJnZWRFeHAgPSB0aGlzLl9leHByZXNzaW9uQnVpbGRlci5hbmRNZXJnZUNvbmRpdGlvbkV4cHJlc3Npb25zKFxuICAgICAgICB7XG4gICAgICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbjogZHluYW1vUHV0SXRlbS5Db25kaXRpb25FeHByZXNzaW9uLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogZHluYW1vUHV0SXRlbS5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZHluYW1vUHV0SXRlbS5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgZHluYW1vUHV0SXRlbS5Db25kaXRpb25FeHByZXNzaW9uID0gbWVyZ2VkRXhwLkNvbmRpdGlvbkV4cHJlc3Npb247XG4gICAgICBkeW5hbW9QdXRJdGVtLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9XG4gICAgICAgIG1lcmdlZEV4cC5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXM7XG4gICAgICBkeW5hbW9QdXRJdGVtLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMgPVxuICAgICAgICBtZXJnZWRFeHAuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcztcbiAgICB9XG5cbiAgICAvLyBubyB1bmlxdWUgYXR0cmlidXRlcyBleGlzdCwgc28gcmV0dXJuIGVhcmx5XG4gICAgaWYgKCF1bmlxdWVBdHRyaWJ1dGVzLmxlbmd0aCkge1xuICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UWVBFLlBVVCxcbiAgICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgICBlbnRpdHlOYW1lOiBuYW1lLFxuICAgICAgICBwcmltYXJ5S2V5OiBudWxsLFxuICAgICAgICBib2R5OiBkeW5hbW9QdXRJdGVtLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBkeW5hbW9QdXRJdGVtO1xuICAgIH1cblxuICAgIC8vIGlmIHRoZXJlIGFyZSB1bmlxdWUgYXR0cmlidXRlcywgcmV0dXJuIHRyYW5zYWN0aW9uIGxpc3QgaXRlbVxuICAgIGxldCB1bmlxdWVBdHRyaWJ1dGVQdXRJdGVtczogRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3QgPSBbXTtcbiAgICBpZiAodW5pcXVlQXR0cmlidXRlcy5sZW5ndGgpIHtcbiAgICAgIHVuaXF1ZUF0dHJpYnV0ZVB1dEl0ZW1zID0gdW5pcXVlQXR0cmlidXRlcy5tYXAoYXR0ciA9PiB7XG4gICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gKGVudGl0eSBhcyBhbnkpW2F0dHIubmFtZV07XG5cbiAgICAgICAgaWYgKCFhdHRyaWJ1dGVWYWx1ZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgIGBBbGwgdW5pcXVlIGF0dHJpYnV0ZXMgYXJlIHJlcXVpcmVkLCBDb3VsZCBub3QgcmVzb2x2ZSB2YWx1ZSBmb3IgdW5pcXVlIGF0dHJpYnV0ZSBcIiR7YXR0ci5uYW1lfS5cImBcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFhdHRyLnVuaXF1ZSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICdBbGwgdW5pcXVlIGF0dHJpYnV0ZXMgbWV0YWRhdGEgbXVzdCBiZSBtYXJrZWQgdW5pcXVlLidcbiAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdW5pcXVlSXRlbVByaW1hcnlLZXkgPSB0aGlzLmdldFBhcnNlZFByaW1hcnlLZXk8RW50aXR5PihcbiAgICAgICAgICB0YWJsZSxcbiAgICAgICAgICBhdHRyLnVuaXF1ZSxcbiAgICAgICAgICBlbnRpdHlcbiAgICAgICAgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIFB1dDoge1xuICAgICAgICAgICAgSXRlbTogdW5pcXVlSXRlbVByaW1hcnlLZXksXG4gICAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLm5hbWUsXG4gICAgICAgICAgICAuLi51bmlxdWVSZWNvcmRDb25kaXRpb25FeHByZXNzaW9uLFxuICAgICAgICAgIH0sXG4gICAgICAgIH07XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCB1bmlxdWVBdHRyaWJ1dGVzUHV0SXRlbXMgPSBbXG4gICAgICB7UHV0OiBkeW5hbW9QdXRJdGVtfSxcbiAgICAgIC4uLnVuaXF1ZUF0dHJpYnV0ZVB1dEl0ZW1zLFxuICAgIF07XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5QVVQsXG4gICAgICBwcmVmaXg6ICdBZnRlcicsXG4gICAgICBlbnRpdHlOYW1lOiBuYW1lLFxuICAgICAgcHJpbWFyeUtleTogbnVsbCxcbiAgICAgIGJvZHk6IHVuaXF1ZUF0dHJpYnV0ZXNQdXRJdGVtcyxcbiAgICB9KTtcblxuICAgIHJldHVybiB1bmlxdWVBdHRyaWJ1dGVzUHV0SXRlbXM7XG4gIH1cblxuICB0b0R5bmFtb0dldEl0ZW08RW50aXR5LCBQcmltYXJ5S2V5PihcbiAgICBlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4sXG4gICAgcHJpbWFyeUtleTogUHJpbWFyeUtleSxcbiAgICBvcHRpb25zPzogTWFuYWdlclRvRHluYW1vR2V0SXRlbU9wdGlvbnMsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICk6IERvY3VtZW50Q2xpZW50VHlwZXMuR2V0SXRlbUlucHV0IHtcbiAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuY29ubmVjdGlvbi5nZXRFbnRpdHlCeVRhcmdldChlbnRpdHlDbGFzcyk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5HRVQsXG4gICAgICBwcmVmaXg6ICdCZWZvcmUnLFxuICAgICAgZW50aXR5TmFtZTogbWV0YWRhdGEubmFtZSxcbiAgICAgIHByaW1hcnlLZXksXG4gICAgfSk7XG5cbiAgICBjb25zdCB0YWJsZU5hbWUgPSB0aGlzLmdldFRhYmxlTmFtZUZvckVudGl0eShlbnRpdHlDbGFzcyk7XG5cbiAgICBjb25zdCBwYXJzZWRQcmltYXJ5S2V5ID0gdGhpcy5nZXRQYXJzZWRQcmltYXJ5S2V5PFByaW1hcnlLZXk+KFxuICAgICAgbWV0YWRhdGEudGFibGUsXG4gICAgICBtZXRhZGF0YS5zY2hlbWEucHJpbWFyeUtleSxcbiAgICAgIHByaW1hcnlLZXlcbiAgICApO1xuXG4gICAgaWYgKGlzRW1wdHlPYmplY3QocGFyc2VkUHJpbWFyeUtleSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUHJpbWFyeSBjb3VsZCBub3QgYmUgcmVzb2x2ZWQnKTtcbiAgICB9XG5cbiAgICBsZXQgdHJhbnNmb3JtQm9keSA9IHtcbiAgICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgICAgS2V5OiB7XG4gICAgICAgIC4uLnBhcnNlZFByaW1hcnlLZXksXG4gICAgICB9LFxuICAgICAgQ29uc2lzdGVudFJlYWQ6IG9wdGlvbnM/LmNvbnNpc3RlbnRSZWFkLFxuICAgICAgUmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgIH0gYXMgRG9jdW1lbnRDbGllbnRUeXBlcy5HZXRJdGVtSW5wdXQ7XG5cbiAgICAvLyBpZiByZXN0cmljdGVkIGl0ZW0gcHJvamVjdGlvbiB3YXMgcmVxdWVzdGVkXG4gICAgaWYgKG9wdGlvbnM/LnNlbGVjdD8ubGVuZ3RoKSB7XG4gICAgICBjb25zdCBwcm9qZWN0aW9uID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb1Byb2plY3Rpb24oXG4gICAgICAgIG9wdGlvbnMuc2VsZWN0XG4gICAgICApO1xuXG4gICAgICBpZiAoIXByb2plY3Rpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBGYWlsZWQgdG8gYnVpbGQgcHJvamVjdGlvbiBleHByZXNzaW9uIGZvciBpbnB1dDogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIG9wdGlvbnMuc2VsZWN0XG4gICAgICAgICAgKX1gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHtQcm9qZWN0aW9uRXhwcmVzc2lvbiwgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzfSA9XG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIuYnVpbGRQcm9qZWN0aW9uRXhwcmVzc2lvbihwcm9qZWN0aW9uKTtcblxuICAgICAgdHJhbnNmb3JtQm9keSA9IHtcbiAgICAgICAgLi4udHJhbnNmb3JtQm9keSxcbiAgICAgICAgUHJvamVjdGlvbkV4cHJlc3Npb24sXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgIC4uLnRyYW5zZm9ybUJvZHkuRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgfSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RZUEUuR0VULFxuICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgZW50aXR5TmFtZTogbWV0YWRhdGEubmFtZSxcbiAgICAgIHByaW1hcnlLZXk6IG51bGwsXG4gICAgICBib2R5OiB0cmFuc2Zvcm1Cb2R5LFxuICAgIH0pO1xuICAgIHJldHVybiB0cmFuc2Zvcm1Cb2R5O1xuICB9XG5cbiAgdG9EeW5hbW9VcGRhdGVJdGVtPFxuICAgIEVudGl0eSxcbiAgICBQcmltYXJ5S2V5ID0gUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgQWRkaXRpb25hbFByb3BlcnRpZXMgPSBFbnRpdHlcbiAgPihcbiAgICBlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4sXG4gICAgcHJpbWFyeUtleUF0dHJpYnV0ZXM6IFByaW1hcnlLZXksXG4gICAgYm9keTogVXBkYXRlQm9keTxFbnRpdHksIEFkZGl0aW9uYWxQcm9wZXJ0aWVzPixcbiAgICBvcHRpb25zOiBNYW5hZ2VyVG9EeW5hbW9VcGRhdGVJdGVtc09wdGlvbnMgPSB7fSxcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnNcbiAgKTogRG9jdW1lbnRDbGllbnRUeXBlcy5VcGRhdGVJdGVtSW5wdXQgfCBMYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVyIHtcbiAgICAvLyBkZWZhdWx0IHZhbHVlc1xuICAgIGNvbnN0IHtuZXN0ZWRLZXlTZXBhcmF0b3IgPSAnLid9ID0gb3B0aW9ucztcblxuICAgIGlmICghdGhpcy5jb25uZWN0aW9uLmhhc01ldGFkYXRhKGVudGl0eUNsYXNzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBObyBtZXRhZGF0YSBmb3VuZCBmb3IgY2xhc3MgXCIke2VudGl0eUNsYXNzLm5hbWV9XCIuYCk7XG4gICAgfVxuXG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UWVBFLlVQREFURSxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBlbnRpdHlOYW1lOiBtZXRhZGF0YS5uYW1lLFxuICAgICAgcHJpbWFyeUtleTogcHJpbWFyeUtleUF0dHJpYnV0ZXMsXG4gICAgICBib2R5LFxuICAgICAgb3B0aW9ucyxcbiAgICB9KTtcbiAgICBjb25zdCB0YWJsZU5hbWUgPSBtZXRhZGF0YS50YWJsZS5uYW1lO1xuXG4gICAgLy8gRklYTUU6IGNvcnJlY3RseSBhcHBseSBkZWNvcmF0ZWQgdHJhbnNmb3JtYXRpb25zIG9uIHRoZSBwcmltYXJ5IGtleSBhdHRyaWJ1dGVzXG4gICAgLy8gYXBwbHkgY2xhc3MgdHJhbnNmb3JtYXRpb24gb24gYXR0cmlidXRlcyBiZWZvcmUgZnVydGhlciBwcm9jZXNzaW5nXG4gICAgLy8gcHJpbWFyeUtleUF0dHJpYnV0ZXMgPSB0aGlzLmFwcGx5Q2xhc3NUcmFuc2Zvcm1lckZvcm1hdGlvbnMoXG4gICAgLy8gICBwcmltYXJ5S2V5QXR0cmlidXRlc1xuICAgIC8vICkgYXMgUHJpbWFyeUtleTtcblxuICAgIGNvbnN0IHBhcnNlZFByaW1hcnlLZXkgPSB0aGlzLmdldFBhcnNlZFByaW1hcnlLZXk8UHJpbWFyeUtleT4oXG4gICAgICBtZXRhZGF0YS50YWJsZSxcbiAgICAgIG1ldGFkYXRhLnNjaGVtYS5wcmltYXJ5S2V5LFxuICAgICAgcHJpbWFyeUtleUF0dHJpYnV0ZXNcbiAgICApO1xuXG4gICAgaWYgKGlzRW1wdHlPYmplY3QocGFyc2VkUHJpbWFyeUtleSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUHJpbWFyeSBjb3VsZCBub3QgYmUgcmVzb2x2ZWQnKTtcbiAgICB9XG5cbiAgICAvLyBnZXQgYWxsIHRoZSBhdHRyaWJ1dGVzIGZvciBlbnRpdHkgdGhhdCBhcmUgbWFya2VkIGFzIHRvIGJlIGF1dG8gdXBkYXRlXG4gICAgY29uc3QgYXV0b1VwZGF0ZUF0dHJpYnV0ZXMgPVxuICAgICAgdGhpcy5jb25uZWN0aW9uLmdldEF1dG9VcGRhdGVBdHRyaWJ1dGVzKGVudGl0eUNsYXNzKTtcblxuICAgIC8vIGNoZWNrIGlmIGF1dG8gdXBkYXRlIGF0dHJpYnV0ZXMgYXJlIG5vdCByZWZlcmVuY2VkIGJ5IHByaW1hcnkga2V5XG4gICAgY29uc3QgZm9ybWF0dGVkQXV0b1VwZGF0ZUF0dHJpYnV0ZXMgPSBhdXRvVXBkYXRlQXR0cmlidXRlcy5yZWR1Y2UoXG4gICAgICAoYWNjLCBhdHRyKSA9PiB7XG4gICAgICAgIGFjY1thdHRyLm5hbWVdID0gYXV0b0dlbmVyYXRlVmFsdWUoYXR0ci5zdHJhdGVneSk7XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge30gYXMge1trZXk6IHN0cmluZ106IGFueX1cbiAgICApO1xuXG4gICAgY29uc3QgcmF3QXR0cmlidXRlc1RvVXBkYXRlID0ge1xuICAgICAgLi4uYm9keSxcbiAgICAgIC4uLmZvcm1hdHRlZEF1dG9VcGRhdGVBdHRyaWJ1dGVzLFxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiAxLjAgLSBhbmFseXplIGF0dHJpYnV0ZXMnIHZhbHVlIHR5cGUgKHN0YXRpYy9keW5hbWljKVxuICAgICAqXG4gICAgICogSGVyZSB3ZSBwYXJzZSBhbGwgYXR0cmlidXRlcyB0byBpdCdzIHVwZGF0ZSB2YWx1ZSBhbmQgZGV0ZXJtaW5lXG4gICAgICogaWYgaXQncyB2YWx1ZSBjYW4gYmUgc3RhdGljYWxseSBpbmZlcnJlZFxuICAgICAqIGFuZCBhbHNvIG9taXQgYWxsIGF0dHJpYnV0ZXNcbiAgICAgKiBmcm9tIGJvZHkgdGhhdCBoYXMgdGhlIHNhbWUgZGVmaW5lZCBpbiBwcmltYXJ5IGtleVxuICAgICAqXG4gICAgICovXG4gICAgY29uc3Qgc3RhdGljT3JEeW5hbWljVXBkYXRlQXR0cmlidXRlc1dpdGhNZXRhZGF0YSA9IE9iamVjdC5lbnRyaWVzKHtcbiAgICAgIC4uLnJhd0F0dHJpYnV0ZXNUb1VwZGF0ZSxcbiAgICB9KS5yZWR1Y2UoXG4gICAgICAoYWNjLCBbYXR0ck5hbWUsIGF0dHJWYWx1ZV0pID0+IHtcbiAgICAgICAgY29uc3QgdmFsdWVXaXRoVHlwZSA9XG4gICAgICAgICAgdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VBdHRyaWJ1dGVUb1VwZGF0ZVZhbHVlKFxuICAgICAgICAgICAgYXR0ck5hbWUsXG4gICAgICAgICAgICBhdHRyVmFsdWVcbiAgICAgICAgICApIGFzIHt2YWx1ZTogYW55OyB0eXBlOiAnc3RhdGljJyB8ICdkeW5hbWljJ307XG5cbiAgICAgICAgYWNjLnRyYW5zZm9ybWVkW2F0dHJOYW1lXSA9IHZhbHVlV2l0aFR5cGUudmFsdWU7XG4gICAgICAgIGFjYy50eXBlTWV0YWRhdGFbYXR0ck5hbWVdID0gdmFsdWVXaXRoVHlwZS50eXBlO1xuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHt0cmFuc2Zvcm1lZDoge30sIHR5cGVNZXRhZGF0YToge319IGFzIHtcbiAgICAgICAgdHJhbnNmb3JtZWQ6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgICAgIHR5cGVNZXRhZGF0YTogUmVjb3JkPHN0cmluZywgJ2R5bmFtaWMnIHwgJ3N0YXRpYyc+O1xuICAgICAgfVxuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiAyLjAgLSBhcHBseSBjdXN0b20gY2xhc3MgdHJhbnNmb3JtYXRpb24gb24gc3RhdGljIGF0dHJpYnV0ZXNcbiAgICAgKlxuICAgICAqIHdlIG1hbnVhbGx5IG5lZWQgdG8gcmVwbGFjZSB0aGUgY29uc3RydWN0b3Igb2YgdGhlIGF0dHJpYnV0ZXMgdG8gdXBkYXRlXG4gICAgICogd2l0aCB0aGUgZW50aXR5IGNsYXNzLCBzbyB0aGF0IHdlIGNhbiBwYXNzIGl0IHRocm91Z2ggdG8gY2xhc3MtdHJhbnNmb3JtZXJcbiAgICAgKiB0byBoYXZlIGFsbCB0cmFuc2Zvcm1lciBtZXRhZGF0YSBhcHBsaWVkLlxuICAgICAqL1xuXG4gICAgY29uc3Qgb25seVN0YXRpY0F0dHJpYnV0ZXMgPSBPYmplY3QuZW50cmllcyhcbiAgICAgIHN0YXRpY09yRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZXNXaXRoTWV0YWRhdGEudHJhbnNmb3JtZWRcbiAgICApLnJlZHVjZSgoYWNjLCBbYXR0cktleSwgYXR0clZhbHVlXSkgPT4ge1xuICAgICAgaWYgKFxuICAgICAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnR5cGVNZXRhZGF0YVthdHRyS2V5XSA9PT1cbiAgICAgICAgJ3N0YXRpYydcbiAgICAgICkge1xuICAgICAgICBhY2NbYXR0cktleV0gPSBhdHRyVmFsdWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIGFueSk7XG4gICAgb25seVN0YXRpY0F0dHJpYnV0ZXMuY29uc3RydWN0b3IgPSBlbnRpdHlDbGFzcztcbiAgICBjb25zdCBjbGFzc1RyYW5zZm9ybWVkU3RhdGljQXR0cmlidXRlcyA9XG4gICAgICB0aGlzLmFwcGx5Q2xhc3NUcmFuc2Zvcm1lckZvcm1hdGlvbnMob25seVN0YXRpY0F0dHJpYnV0ZXMpIGFzIEVudGl0eTtcbiAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnRyYW5zZm9ybWVkID0ge1xuICAgICAgLi4uc3RhdGljT3JEeW5hbWljVXBkYXRlQXR0cmlidXRlc1dpdGhNZXRhZGF0YS50cmFuc2Zvcm1lZCxcbiAgICAgIC4uLmNsYXNzVHJhbnNmb3JtZWRTdGF0aWNBdHRyaWJ1dGVzLFxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiAzLjAgLSBHZXQgcmVmZXJlbmNlZCB1bmlxdWUgYXR0cmlidXRlcyBhbmQgdmFsaWRhdGUgdGhhdCBjdXJyZW50IHVwZGF0ZSBib2R5IGNhbiBiZSBzYWZlbHkgYXBwbGllZFxuICAgICAqL1xuICAgIGNvbnN0IHVuaXF1ZUF0dHJpYnV0ZXNUb1VwZGF0ZSA9IHRoaXMuY29ubmVjdGlvblxuICAgICAgLmdldFVuaXF1ZUF0dHJpYnV0ZXNGb3JFbnRpdHkoZW50aXR5Q2xhc3MpXG4gICAgICAuZmlsdGVyKGF0dHIgPT4gISEoYm9keSBhcyBhbnkpW2F0dHIubmFtZV0pXG4gICAgICAubWFwKGF0dHIgPT4ge1xuICAgICAgICAvLyBUT0RPOiBzdXBwb3J0IHVwZGF0aW5nIHVuaXF1ZSBhdHRyaWJ1dGVzIHdpdGggZHluYW1pYyBleHBcbiAgICAgICAgLy8gd2UgY2FuJ3QgYWxsb3cgdXBkYXRpbmcgdW5pcXVlIGF0dHJpYnV0ZXMgd2hlbiB0aGV5IGNvbnRhaW4gZHluYW1pYyB1cGRhdGUgdmFsdWVcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHN0YXRpY09yRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZXNXaXRoTWV0YWRhdGEudHlwZU1ldGFkYXRhW1xuICAgICAgICAgICAgYXR0ci5uYW1lXG4gICAgICAgICAgXSA9PT0gJ2R5bmFtaWMnXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZVZhbHVlRXJyb3IoXG4gICAgICAgICAgICBhdHRyLm5hbWUsXG4gICAgICAgICAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnRyYW5zZm9ybWVkW2F0dHIubmFtZV1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhdHRyO1xuICAgICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiAzLjEgLSBHZXQgcmVmZXJlbmNlZCBwcmltYXJ5IGtleSBhdHRyaWJ1dGVzIGFuZCB2YWxpZGF0ZSB0aGF0IGN1cnJlbnQgdXBkYXRlIGJvZHkgY2FuIGJlIHNhZmVseSBhcHBsaWVkXG4gICAgICovXG4gICAgY29uc3QgZXhwbGljaXRBdHRyaWJ1dGVzVG9VcGRhdGUgPSBPYmplY3QuZW50cmllcyh7XG4gICAgICAuLi5zdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnRyYW5zZm9ybWVkLFxuICAgIH0pLnJlZHVjZSgoYWNjLCBbYXR0cktleSwgYXR0clZhbHVlXSkgPT4ge1xuICAgICAgLy8gQXR0cmlidXRlIGluIEJvZHkgdGhhdCBhcmUgaW4gcHJpbWFyeSBrZXkgYXR0cmlidXRlcyBhbmQgaGF2ZSB0aGUgZG8gbm90IHJlcXVpcmUgYW55IHVwZGF0ZXNcbiAgICAgIGlmIChcbiAgICAgICAgKHByaW1hcnlLZXlBdHRyaWJ1dGVzIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KVthdHRyS2V5XSAhPT0gYXR0clZhbHVlXG4gICAgICApIHtcbiAgICAgICAgYWNjW2F0dHJLZXldID0gYXR0clZhbHVlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGFjYztcbiAgICB9LCB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+KTtcblxuICAgIGNvbnN0IGFmZmVjdGVkUHJpbWFyeUtleUF0dHJpYnV0ZXMgPVxuICAgICAgdGhpcy5nZXRBZmZlY3RlZFByaW1hcnlLZXlBdHRyaWJ1dGVzPEVudGl0eT4oXG4gICAgICAgIGVudGl0eUNsYXNzLFxuICAgICAgICBleHBsaWNpdEF0dHJpYnV0ZXNUb1VwZGF0ZSxcbiAgICAgICAgc3RhdGljT3JEeW5hbWljVXBkYXRlQXR0cmlidXRlc1dpdGhNZXRhZGF0YS50eXBlTWV0YWRhdGEsXG4gICAgICAgIHtcbiAgICAgICAgICBhZGRpdGlvbmFsQXR0cmlidXRlc0RpY3Q6XG4gICAgICAgICAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnRyYW5zZm9ybWVkLFxuICAgICAgICB9XG4gICAgICApO1xuXG4gICAgLy8gdmFsaWRhdGUgcHJpbWFyeSBrZXkgYXR0cmlidXRlc1xuICAgIGlmICghaXNFbXB0eU9iamVjdChhZmZlY3RlZFByaW1hcnlLZXlBdHRyaWJ1dGVzKSkge1xuICAgICAgLy8gdXBkYXRlcyBhcmUgbm90IGFsbG93ZWQgZm9yIGF0dHJpYnV0ZXMgdGhhdCB1bmlxdWUgYW5kIGFsc28gcmVmZXJlbmNlcyBwcmltYXJ5IGtleS5cbiAgICAgIGlmICh1bmlxdWVBdHRyaWJ1dGVzVG9VcGRhdGUubGVuZ3RoKSB7XG4gICAgICAgIHRocm93IG5ldyBJbnZhbGlkVW5pcXVlQXR0cmlidXRlVXBkYXRlRXJyb3IoXG4gICAgICAgICAgYWZmZWN0ZWRQcmltYXJ5S2V5QXR0cmlidXRlcyEsXG4gICAgICAgICAgdW5pcXVlQXR0cmlidXRlc1RvVXBkYXRlLm1hcChhdHRyID0+IGF0dHIubmFtZSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiAzLjIgLSBHZXQgcmVmZXJlbmNlZCBpbmRleGVzJyBhdHRyaWJ1dGVzIGFuZCB2YWxpZGF0ZSB0aGF0IGN1cnJlbnQgdXBkYXRlIGJvZHkgY2FuIGJlIHNhZmVseSBhcHBsaWVkXG4gICAgICovXG4gICAgY29uc3QgYWZmZWN0ZWRJbmRleGVzID0gdGhpcy5nZXRBZmZlY3RlZEluZGV4ZXNGb3JBdHRyaWJ1dGVzPEVudGl0eT4oXG4gICAgICBlbnRpdHlDbGFzcyxcbiAgICAgIHN0YXRpY09yRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZXNXaXRoTWV0YWRhdGEudHJhbnNmb3JtZWQsXG4gICAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnR5cGVNZXRhZGF0YSxcbiAgICAgIHtcbiAgICAgICAgbmVzdGVkS2V5U2VwYXJhdG9yLFxuICAgICAgICBhZGRpdGlvbmFsQXR0cmlidXRlc0RpY3Q6IHtcbiAgICAgICAgICAuLi5wcmltYXJ5S2V5QXR0cmlidXRlcyxcbiAgICAgICAgfSBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgICAgfVxuICAgICk7XG5cbiAgICAvKipcbiAgICAgKiA0LjAgLSBCdWlsZCB1cGRhdGUgSXRlbSBib2R5IHdpdGggZ2l2ZW4gY29uZGl0aW9uIGFuZCBvcHRpb25zXG4gICAgICovXG4gICAgY29uc3QgaXRlbVRvVXBkYXRlOlxuICAgICAgfCBEb2N1bWVudENsaWVudFR5cGVzLlVwZGF0ZUl0ZW1JbnB1dFxuICAgICAgfCBEb2N1bWVudENsaWVudFR5cGVzLlB1dEl0ZW1JbnB1dCA9IHtcbiAgICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgICAgS2V5OiB7XG4gICAgICAgIC4uLnBhcnNlZFByaW1hcnlLZXksXG4gICAgICB9LFxuICAgICAgUmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogbWV0YWRhdGFPcHRpb25zPy5yZXR1cm5Db25zdW1lZENhcGFjaXR5LFxuICAgICAgLy8gcmVxdWVzdCBhbGwgbmV3IGF0dHJpYnV0ZXNcbiAgICAgIFJldHVyblZhbHVlczogUkVUVVJOX1ZBTFVFUy5BTExfTkVXLFxuICAgIH07XG5cbiAgICAvKipcbiAgICAgKiA0LjEgLSBpZiAnd2hlcmUnIHdhcyBwcm92aWRlZCwgYnVpbGQgY29uZGl0aW9uIGV4cHJlc3Npb25cbiAgICAgKi9cbiAgICBpZiAob3B0aW9ucy53aGVyZSAmJiAhaXNFbXB0eU9iamVjdChvcHRpb25zLndoZXJlKSkge1xuICAgICAgY29uc3QgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb0NvbmRpdGlvbihcbiAgICAgICAgb3B0aW9ucy53aGVyZVxuICAgICAgKTtcblxuICAgICAgaWYgKCFjb25kaXRpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBGYWlsZWQgdG8gYnVpbGQgY29uZGl0aW9uIGV4cHJlc3Npb24gZm9yIGlucHV0OiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgICAgb3B0aW9ucy53aGVyZVxuICAgICAgICAgICl9YFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB7XG4gICAgICAgIENvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIH0gPSB0aGlzLmV4cHJlc3Npb25CdWlsZGVyLmJ1aWxkQ29uZGl0aW9uRXhwcmVzc2lvbihjb25kaXRpb24pO1xuXG4gICAgICAvLyBhcHBlbmQgY29uZGl0aW9uIGV4cHJlc3Npb24gaWYgb25lIHdhcyBidWlsdFxuICAgICAgaXRlbVRvVXBkYXRlLkNvbmRpdGlvbkV4cHJlc3Npb24gPSBDb25kaXRpb25FeHByZXNzaW9uO1xuICAgICAgaXRlbVRvVXBkYXRlLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IHtcbiAgICAgICAgLi4uRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAuLi5pdGVtVG9VcGRhdGUuRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgfTtcbiAgICAgIGl0ZW1Ub1VwZGF0ZS5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzID0ge1xuICAgICAgICAuLi5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAuLi5pdGVtVG9VcGRhdGUuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogNS4wIC0gdXBkYXRlIGNvbnRhaW5zIHByaW1hcnkga2V5IGF0dHJpYnV0ZXMgc28gaXQgbXVzdCBiZSBsYXppbHkgdXBkYXRlZFxuICAgICAqIFRoaXMgcmVxdWlyZXMgZGVsZXRpbmcgb2xkIGl0ZW0gYW5kIHdyaXRpbmcgbmV3IGl0ZW0gdG8gdGhlIHRhYmxlIGJvdGggaW4gYSB0cmFuc2FjdGlvblxuICAgICAqL1xuICAgIGlmIChcbiAgICAgIGlzT2JqZWN0KGFmZmVjdGVkUHJpbWFyeUtleUF0dHJpYnV0ZXMpICYmXG4gICAgICAhaXNFbXB0eU9iamVjdChhZmZlY3RlZFByaW1hcnlLZXlBdHRyaWJ1dGVzKVxuICAgICkge1xuICAgICAgY29uc3QgbGF6eUxvYWRUcmFuc2FjdGlvbldyaXRlSXRlbXMgPVxuICAgICAgICB0aGlzLmxhenlUb0R5bmFtb1VwZGF0ZVByaW1hcnlLZXlGYWN0b3J5KFxuICAgICAgICAgIG1ldGFkYXRhLnRhYmxlLFxuICAgICAgICAgIG1ldGFkYXRhLm5hbWUsXG4gICAgICAgICAgbWV0YWRhdGEuc2NoZW1hLnByaW1hcnlLZXksXG4gICAgICAgICAge1xuICAgICAgICAgICAgSXRlbToge1xuICAgICAgICAgICAgICAuLi5hZmZlY3RlZFByaW1hcnlLZXlBdHRyaWJ1dGVzLFxuICAgICAgICAgICAgICAuLi5hZmZlY3RlZEluZGV4ZXMsXG4gICAgICAgICAgICAgIC4uLnN0YXRpY09yRHluYW1pY1VwZGF0ZUF0dHJpYnV0ZXNXaXRoTWV0YWRhdGEudHJhbnNmb3JtZWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgVGFibGVOYW1lOiBtZXRhZGF0YS50YWJsZS5uYW1lLFxuICAgICAgICAgICAgUmV0dXJuQ29uc3VtZWRDYXBhY2l0eTogaXRlbVRvVXBkYXRlLlJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgICAgICAgICBSZXR1cm5WYWx1ZXM6IGl0ZW1Ub1VwZGF0ZS5SZXR1cm5WYWx1ZXMsXG4gICAgICAgICAgICBDb25kaXRpb25FeHByZXNzaW9uOiBpdGVtVG9VcGRhdGUuQ29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogaXRlbVRvVXBkYXRlLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGl0ZW1Ub1VwZGF0ZS5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgbWV0YWRhdGFPcHRpb25zXG4gICAgICAgICk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByaW1hcnlLZXlBdHRyaWJ1dGVzLFxuICAgICAgICBlbnRpdHlDbGFzcyxcbiAgICAgICAgbGF6eUxvYWRUcmFuc2FjdGlvbldyaXRlSXRlbXMsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIDUuMC4xIC0gYnVpbGQgdXBkYXRlIGV4cHJlc3Npb24gd2l0aCB1c2VyIHByb3ZpZGVkIGJvZHkgYW5kIGFsbCBvdGhlciBhdXRvIHRyYW5zZm9ybWF0aW9uXG4gICAgICovXG4gICAgY29uc3QgdXBkYXRlID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb1VwZGF0ZShcbiAgICAgIHtcbiAgICAgICAgLi4ucmF3QXR0cmlidXRlc1RvVXBkYXRlLFxuICAgICAgICAuLi5hZmZlY3RlZEluZGV4ZXMsXG4gICAgICB9LFxuICAgICAgc3RhdGljT3JEeW5hbWljVXBkYXRlQXR0cmlidXRlc1dpdGhNZXRhZGF0YS50cmFuc2Zvcm1lZFxuICAgICk7XG5cbiAgICBjb25zdCB7XG4gICAgICBVcGRhdGVFeHByZXNzaW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICB9ID0gdGhpcy5leHByZXNzaW9uQnVpbGRlci5idWlsZFVwZGF0ZUV4cHJlc3Npb24odXBkYXRlKTtcbiAgICBpdGVtVG9VcGRhdGUuVXBkYXRlRXhwcmVzc2lvbiA9IFVwZGF0ZUV4cHJlc3Npb247XG4gICAgaXRlbVRvVXBkYXRlLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IHtcbiAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgIC4uLml0ZW1Ub1VwZGF0ZS5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgfTtcbiAgICBpdGVtVG9VcGRhdGUuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IHtcbiAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAuLi5pdGVtVG9VcGRhdGUuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogNS4xIC0gVXBkYXRlIGNvbnRhaW5zIHVuaXF1ZSBhdHRyaWJ1dGVzLCBidWlsZCBhIGxhenkgdW5pcXVlIGF0dHJpYnV0ZXMgbG9hZGVyIGFuZCByZXR1cm5cbiAgICAgKi9cbiAgICBpZiAodW5pcXVlQXR0cmlidXRlc1RvVXBkYXRlLmxlbmd0aCkge1xuICAgICAgLy8gaWYgdGhlcmUgYXJlIHVuaXF1ZSBhdHRyaWJ1dGVzLCByZXR1cm4gYSBsYXp5IGxvYWRlciwgd2hpY2ggd2lsbCByZXR1cm4gd3JpdGUgaXRlbSBsaXN0XG4gICAgICBjb25zdCBsYXp5TG9hZFRyYW5zYWN0aW9uV3JpdGVJdGVtcyA9XG4gICAgICAgIHRoaXMubGF6eVRvRHluYW1vVXBkYXRlVW5pcXVlSXRlbUZhY3Rvcnk8RW50aXR5PihcbiAgICAgICAgICBtZXRhZGF0YS50YWJsZSxcbiAgICAgICAgICBtZXRhZGF0YS5uYW1lLFxuICAgICAgICAgIHVuaXF1ZUF0dHJpYnV0ZXNUb1VwZGF0ZSxcbiAgICAgICAgICBkcm9wUHJvcChpdGVtVG9VcGRhdGUsICdSZXR1cm5WYWx1ZXMnKSxcbiAgICAgICAgICBzdGF0aWNPckR5bmFtaWNVcGRhdGVBdHRyaWJ1dGVzV2l0aE1ldGFkYXRhLnRyYW5zZm9ybWVkLFxuICAgICAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICAgICApO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBwcmltYXJ5S2V5QXR0cmlidXRlcyxcbiAgICAgICAgZW50aXR5Q2xhc3MsXG4gICAgICAgIGxhenlMb2FkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1zLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiA1LjIgLSByZXR1cm4gc2ltcGxlIHVwZGF0ZSBib2R5XG4gICAgICovXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RZUEUuVVBEQVRFLFxuICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgZW50aXR5TmFtZTogbWV0YWRhdGEubmFtZSxcbiAgICAgIHByaW1hcnlLZXk6IG51bGwsXG4gICAgICBib2R5OiBpdGVtVG9VcGRhdGUsXG4gICAgfSk7XG4gICAgcmV0dXJuIGl0ZW1Ub1VwZGF0ZTtcbiAgfVxuXG4gIHRvRHluYW1vRGVsZXRlSXRlbTxFbnRpdHksIFByaW1hcnlLZXk+KFxuICAgIGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5PixcbiAgICBwcmltYXJ5S2V5OiBQcmltYXJ5S2V5LFxuICAgIG9wdGlvbnM/OiBNYW5hZ2VyVG9EeW5hbW9EZWxldGVJdGVtc09wdGlvbnMsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICk6IERvY3VtZW50Q2xpZW50VHlwZXMuRGVsZXRlSXRlbUlucHV0IHwgTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlciB7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmNvbm5lY3Rpb24uZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5Q2xhc3MpO1xuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UWVBFLkRFTEVURSxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBlbnRpdHlOYW1lOiBtZXRhZGF0YS5uYW1lLFxuICAgICAgcHJpbWFyeUtleSxcbiAgICB9KTtcbiAgICBjb25zdCB0YWJsZU5hbWUgPSBtZXRhZGF0YS50YWJsZS5uYW1lO1xuXG4gICAgY29uc3QgcGFyc2VkUHJpbWFyeUtleSA9IHRoaXMuZ2V0UGFyc2VkUHJpbWFyeUtleTxQcmltYXJ5S2V5PihcbiAgICAgIG1ldGFkYXRhLnRhYmxlLFxuICAgICAgbWV0YWRhdGEuc2NoZW1hLnByaW1hcnlLZXksXG4gICAgICBwcmltYXJ5S2V5XG4gICAgKTtcblxuICAgIGlmIChpc0VtcHR5T2JqZWN0KHBhcnNlZFByaW1hcnlLZXkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1ByaW1hcnkgY291bGQgbm90IGJlIHJlc29sdmVkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdW5pcXVlQXR0cmlidXRlc1RvUmVtb3ZlID1cbiAgICAgIHRoaXMuY29ubmVjdGlvbi5nZXRVbmlxdWVBdHRyaWJ1dGVzRm9yRW50aXR5KGVudGl0eUNsYXNzKTtcblxuICAgIGNvbnN0IG1haW5JdGVtVG9SZW1vdmU6IERvY3VtZW50Q2xpZW50VHlwZXMuRGVsZXRlSXRlbUlucHV0ID0ge1xuICAgICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgICBLZXk6IHtcbiAgICAgICAgLi4ucGFyc2VkUHJpbWFyeUtleSxcbiAgICAgIH0sXG4gICAgICBSZXR1cm5Db25zdW1lZENhcGFjaXR5OiBtZXRhZGF0YU9wdGlvbnM/LnJldHVybkNvbnN1bWVkQ2FwYWNpdHksXG4gICAgfTtcblxuICAgIGlmIChvcHRpb25zPy53aGVyZSAmJiAhaXNFbXB0eU9iamVjdChvcHRpb25zLndoZXJlKSkge1xuICAgICAgY29uc3QgY29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb0NvbmRpdGlvbihcbiAgICAgICAgb3B0aW9ucz8ud2hlcmVcbiAgICAgICk7XG5cbiAgICAgIGlmICghY29uZGl0aW9uKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRmFpbGVkIHRvIGJ1aWxkIGNvbmRpdGlvbiBleHByZXNzaW9uIGZvciBpbnB1dDogJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICAgIG9wdGlvbnM/LndoZXJlXG4gICAgICAgICAgKX1gXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgQ29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgfSA9IHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIuYnVpbGRDb25kaXRpb25FeHByZXNzaW9uKGNvbmRpdGlvbik7XG5cbiAgICAgIG1haW5JdGVtVG9SZW1vdmUuQ29uZGl0aW9uRXhwcmVzc2lvbiA9IENvbmRpdGlvbkV4cHJlc3Npb247XG4gICAgICBtYWluSXRlbVRvUmVtb3ZlLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyA9IHtcbiAgICAgICAgLi4ubWFpbkl0ZW1Ub1JlbW92ZS5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgIH07XG5cbiAgICAgIG1haW5JdGVtVG9SZW1vdmUuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyA9IHtcbiAgICAgICAgLi4ubWFpbkl0ZW1Ub1JlbW92ZS5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAuLi5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIXVuaXF1ZUF0dHJpYnV0ZXNUb1JlbW92ZT8ubGVuZ3RoKSB7XG4gICAgICAvLyBpZiBpdGVtIGRvZXMgbm90IGhhdmUgYW55IHVuaXF1ZSBhdHRyaWJ1dGVzIHJldHVybiBpdCBhcyBpc1xuICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UWVBFLkRFTEVURSxcbiAgICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgICBlbnRpdHlOYW1lOiBtZXRhZGF0YS5uYW1lLFxuICAgICAgICBwcmltYXJ5S2V5LFxuICAgICAgfSk7XG4gICAgICByZXR1cm4gbWFpbkl0ZW1Ub1JlbW92ZTtcbiAgICB9XG5cbiAgICAvLyBvciByZXR1cm4gbGF6eSByZXNvbHZlclxuICAgIGNvbnN0IGxhenlMb2FkVHJhbnNhY3Rpb25Xcml0ZUl0ZW1zID0gdGhpcy5sYXp5VG9EeW5hbW9SZW1vdmVJdGVtRmFjdG9yeShcbiAgICAgIG1ldGFkYXRhLnRhYmxlLFxuICAgICAgbWV0YWRhdGEubmFtZSxcbiAgICAgIHVuaXF1ZUF0dHJpYnV0ZXNUb1JlbW92ZSxcbiAgICAgIG1haW5JdGVtVG9SZW1vdmUsXG4gICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHByaW1hcnlLZXlBdHRyaWJ1dGVzOiBwcmltYXJ5S2V5LFxuICAgICAgZW50aXR5Q2xhc3MsXG4gICAgICBsYXp5TG9hZFRyYW5zYWN0aW9uV3JpdGVJdGVtcyxcbiAgICB9O1xuICB9XG5cbiAgdG9EeW5hbW9RdWVyeUl0ZW08RW50aXR5LCBQYXJ0aXRpb25LZXlBdHRyaWJ1dGVzPihcbiAgICBlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4sXG4gICAgcGFydGl0aW9uS2V5QXR0cmlidXRlczogUGFydGl0aW9uS2V5QXR0cmlidXRlcyB8IHN0cmluZyxcbiAgICBxdWVyeU9wdGlvbnM/OiBNYW5hZ2VyVG9EeW5hbW9RdWVyeUl0ZW1zT3B0aW9ucyxcbiAgICBtZXRhZGF0YU9wdGlvbnM/OiBNZXRhZGF0YU9wdGlvbnNcbiAgKTogRG9jdW1lbnRDbGllbnRUeXBlcy5RdWVyeUlucHV0IHtcbiAgICBjb25zdCB7dGFibGUsIHNjaGVtYSwgbmFtZX0gPVxuICAgICAgdGhpcy5jb25uZWN0aW9uLmdldEVudGl0eUJ5VGFyZ2V0KGVudGl0eUNsYXNzKTtcbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5RVUVSWSxcbiAgICAgIHByZWZpeDogJ0JlZm9yZScsXG4gICAgICBlbnRpdHlOYW1lOiBuYW1lLFxuICAgICAgcHJpbWFyeUtleTogcGFydGl0aW9uS2V5QXR0cmlidXRlcyxcbiAgICAgIG9wdGlvbnM6IHF1ZXJ5T3B0aW9ucyxcbiAgICB9KTtcbiAgICBjb25zdCBxdWVyeUluZGV4TmFtZSA9IHF1ZXJ5T3B0aW9ucz8ucXVlcnlJbmRleDtcbiAgICBsZXQgaW5kZXhUb1F1ZXJ5OiBJbmRleE9wdGlvbnMgfCB1bmRlZmluZWQ7XG4gICAgaWYgKHF1ZXJ5SW5kZXhOYW1lKSB7XG4gICAgICBjb25zdCBtYXRjaGluZ0luZGV4ID0gdGFibGUuZ2V0SW5kZXhCeUtleShxdWVyeUluZGV4TmFtZSk7XG4gICAgICBpZiAoIW1hdGNoaW5nSW5kZXgpIHtcbiAgICAgICAgdGhyb3cgbmV3IE5vU3VjaEluZGV4Rm91bmRFcnJvcih0YWJsZS5uYW1lLCBxdWVyeUluZGV4TmFtZSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG1hdGNoaW5nSW5kZXhPbkVudGl0eSA9XG4gICAgICAgIHNjaGVtYS5pbmRleGVzICYmIHNjaGVtYS5pbmRleGVzW3F1ZXJ5SW5kZXhOYW1lXTtcblxuICAgICAgaWYgKCFtYXRjaGluZ0luZGV4T25FbnRpdHkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBSZXF1ZXN0ZWQgdG8gcXVlcnkgaXRlbXMgZnJvbSBpbmRleCBcIiR7cXVlcnlJbmRleE5hbWV9XCIsIGJ1dCBubyBzdWNoIGluZGV4IGV4aXN0cyBvbiBlbnRpdHkuYFxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaW5kZXhUb1F1ZXJ5ID0gbWF0Y2hpbmdJbmRleDtcbiAgICB9XG5cbiAgICAvLyBxdWVyeSB3aWxsIGJlIGV4ZWN1dGVkIGFnYWluc3QgbWFpbiB0YWJsZSBvclxuICAgIC8vIGlmIHF1ZXJ5aW5nIGxvY2FsICBpbmRleCwgdGhlbiBwYXJ0aXRpb24ga2V5IHdpbGwgYmUgc2FtZSBhcyBtYWluIHRhYmxlXG4gICAgY29uc3QgcGFyc2VkUGFydGl0aW9uS2V5ID0ge30gYXMge25hbWU6IHN0cmluZzsgdmFsdWU6IGFueX07XG4gICAgaWYgKFxuICAgICAgIXF1ZXJ5SW5kZXhOYW1lIHx8XG4gICAgICAhaW5kZXhUb1F1ZXJ5IHx8XG4gICAgICBpbmRleFRvUXVlcnk/LnR5cGUgPT09IElOREVYX1RZUEUuTFNJXG4gICAgKSB7XG4gICAgICBwYXJzZWRQYXJ0aXRpb25LZXkubmFtZSA9IHRhYmxlLnBhcnRpdGlvbktleTtcbiAgICAgIHBhcnNlZFBhcnRpdGlvbktleS52YWx1ZSA9XG4gICAgICAgIHR5cGVvZiBwYXJ0aXRpb25LZXlBdHRyaWJ1dGVzID09PSAnc3RyaW5nJ1xuICAgICAgICAgID8gcGFydGl0aW9uS2V5QXR0cmlidXRlc1xuICAgICAgICAgIDogcGFyc2VLZXkoXG4gICAgICAgICAgICAgIHNjaGVtYS5wcmltYXJ5S2V5LmF0dHJpYnV0ZXNbdGFibGUucGFydGl0aW9uS2V5XSxcbiAgICAgICAgICAgICAgcGFydGl0aW9uS2V5QXR0cmlidXRlc1xuICAgICAgICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gcXVlcnkgaXMgdG8gYmUgZXhlY3V0ZWQgYWdhaW5zdCBnbG9iYWwgc2Vjb25kYXJ5IGluZGV4XG4gICAgICBwYXJzZWRQYXJ0aXRpb25LZXkubmFtZSA9IGluZGV4VG9RdWVyeS5wYXJ0aXRpb25LZXk7XG4gICAgICBjb25zdCBzY2hlbWFGb3JJbmRleFRvUXVlcnkgPSAoc2NoZW1hLmluZGV4ZXMgPz8ge30pW3F1ZXJ5SW5kZXhOYW1lXTtcblxuICAgICAgcGFyc2VkUGFydGl0aW9uS2V5LnZhbHVlID1cbiAgICAgICAgdHlwZW9mIHBhcnRpdGlvbktleUF0dHJpYnV0ZXMgPT09ICdzdHJpbmcnXG4gICAgICAgICAgPyBwYXJ0aXRpb25LZXlBdHRyaWJ1dGVzXG4gICAgICAgICAgOiBwYXJzZUtleShcbiAgICAgICAgICAgICAgc2NoZW1hRm9ySW5kZXhUb1F1ZXJ5LmF0dHJpYnV0ZXNbaW5kZXhUb1F1ZXJ5LnBhcnRpdGlvbktleV0sXG4gICAgICAgICAgICAgIHBhcnRpdGlvbktleUF0dHJpYnV0ZXNcbiAgICAgICAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgcGFydGl0aW9uS2V5Q29uZGl0aW9uID0gbmV3IEtleUNvbmRpdGlvbigpLmVxdWFscyhcbiAgICAgIHBhcnNlZFBhcnRpdGlvbktleS5uYW1lLFxuICAgICAgcGFyc2VkUGFydGl0aW9uS2V5LnZhbHVlXG4gICAgKTtcblxuICAgIGNvbnN0IHBhcnRpdGlvbktleUNvbmRpdGlvbkV4cHJlc3Npb24gPVxuICAgICAgdGhpcy5leHByZXNzaW9uQnVpbGRlci5idWlsZEtleUNvbmRpdGlvbkV4cHJlc3Npb24ocGFydGl0aW9uS2V5Q29uZGl0aW9uKTtcblxuICAgIGNvbnN0IHBhcnNlZFNvcnRLZXkgPSB7fSBhcyB7bmFtZTogc3RyaW5nfTtcbiAgICAvLyBpZiBubyB3ZSBhcmUgbm90IHF1ZXJ5aW5nIGFnYWluc3QgaW5kZXgsIHZhbGlkYXRlIGlmIHRhYmxlIGlzIHVzaW5nIGNvbXBvc2l0ZSBrZXlcbiAgICBpZiAoIWluZGV4VG9RdWVyeSkge1xuICAgICAgaWYgKCF0YWJsZS51c2VzQ29tcG9zaXRlS2V5KCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBUYWJsZSAke3RhYmxlLm5hbWV9IGRvZXMgbm90IHVzZSBjb21wb3NpdGUga2V5LCB0aHVzIHF1ZXJ5aW5nIGEgc29ydCBrZXkgaXMgbm90IGFsbG93ZWRgXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHBhcnNlZFNvcnRLZXkubmFtZSA9IHRhYmxlLnNvcnRLZXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcnNlZFNvcnRLZXkubmFtZSA9IGluZGV4VG9RdWVyeS5zb3J0S2V5O1xuICAgIH1cblxuICAgIC8vIGF0IHRoaXMgcG9pbnQgd2UgaGF2ZSByZXNvbHZlZCBwYXJ0aXRpb24ga2V5IGFuZCB0YWJsZSB0byBxdWVyeVxuICAgIGxldCBxdWVyeUlucHV0UGFyYW1zID0ge1xuICAgICAgVGFibGVOYW1lOiB0YWJsZS5uYW1lLFxuICAgICAgSW5kZXhOYW1lOiBxdWVyeUluZGV4TmFtZSxcbiAgICAgIFJldHVybkNvbnN1bWVkQ2FwYWNpdHk6IG1ldGFkYXRhT3B0aW9ucz8ucmV0dXJuQ29uc3VtZWRDYXBhY2l0eSxcbiAgICAgIC4uLnBhcnRpdGlvbktleUNvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgfSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlF1ZXJ5SW5wdXQ7XG5cbiAgICBpZiAocXVlcnlPcHRpb25zICYmICFpc0VtcHR5T2JqZWN0KHF1ZXJ5T3B0aW9ucykpIHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgb3JkZXJCeTogb3JkZXIsXG4gICAgICAgIGxpbWl0LFxuICAgICAgICBrZXlDb25kaXRpb24sXG4gICAgICAgIHdoZXJlLFxuICAgICAgICBzZWxlY3QsXG4gICAgICAgIG9ubHlDb3VudCxcbiAgICAgICAgY29uc2lzdGVudFJlYWQsXG4gICAgICB9ID0gcXVlcnlPcHRpb25zO1xuXG4gICAgICBxdWVyeUlucHV0UGFyYW1zID0ge1xuICAgICAgICAuLi5xdWVyeUlucHV0UGFyYW1zLFxuICAgICAgICBMaW1pdDogbGltaXQsXG4gICAgICAgIENvbnNpc3RlbnRSZWFkOiBjb25zaXN0ZW50UmVhZCxcbiAgICAgIH07XG5cbiAgICAgIGlmIChvcmRlcikge1xuICAgICAgICBxdWVyeUlucHV0UGFyYW1zLlNjYW5JbmRleEZvcndhcmQgPSBvcmRlciA9PT0gUVVFUllfT1JERVIuQVNDO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBrZXkgY29uZGl0aW9uIHdhcyBwcm92aWRlZFxuICAgICAgaWYgKGtleUNvbmRpdGlvbiAmJiAhaXNFbXB0eU9iamVjdChrZXlDb25kaXRpb24pKSB7XG4gICAgICAgIC8vIGJ1aWxkIHNvcnQga2V5IGNvbmRpdGlvblxuICAgICAgICBjb25zdCBzb3J0S2V5Q29uZGl0aW9uID0gdGhpcy5leHByZXNzaW9uSW5wdXRQYXJzZXIucGFyc2VUb0tleUNvbmRpdGlvbihcbiAgICAgICAgICBwYXJzZWRTb3J0S2V5Lm5hbWUsXG4gICAgICAgICAga2V5Q29uZGl0aW9uXG4gICAgICAgICk7XG5cbiAgICAgICAgLy8gaWYgY29uZGl0aW9uIHJlc29sdXRpb24gd2FzIHN1Y2Nlc3NmdWwsIHdlIGNhbiBtZXJnZSBib3RoIHBhcnRpdGlvbiBhbmQgc29ydCBrZXkgY29uZGl0aW9ucyBub3dcbiAgICAgICAgY29uc3Qge1xuICAgICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb24sXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAgIH0gPSB0aGlzLmV4cHJlc3Npb25CdWlsZGVyLmJ1aWxkS2V5Q29uZGl0aW9uRXhwcmVzc2lvbihcbiAgICAgICAgICBwYXJ0aXRpb25LZXlDb25kaXRpb24ubWVyZ2Uoc29ydEtleUNvbmRpdGlvbilcbiAgICAgICAgKTtcblxuICAgICAgICBxdWVyeUlucHV0UGFyYW1zID0ge1xuICAgICAgICAgIC4uLnF1ZXJ5SW5wdXRQYXJhbXMsXG4gICAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgICAgIC4uLnF1ZXJ5SW5wdXRQYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgICAgLi4uRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICAgLi4ucXVlcnlJbnB1dFBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICAgICAgICAgLi4uRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyB3aGVuIGZpbHRlciBjb25kaXRpb25zIGFyZSBnaXZlbiBnZW5lcmF0ZSBmaWx0ZXIgZXhwcmVzc2lvblxuICAgICAgaWYgKHdoZXJlICYmICFpc0VtcHR5T2JqZWN0KHdoZXJlKSkge1xuICAgICAgICBjb25zdCBmaWx0ZXIgPSB0aGlzLmV4cHJlc3Npb25JbnB1dFBhcnNlci5wYXJzZVRvRmlsdGVyKHdoZXJlKTtcblxuICAgICAgICBpZiAoIWZpbHRlcikge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkRmlsdGVySW5wdXRFcnJvcih3aGVyZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgRmlsdGVyRXhwcmVzc2lvbixcbiAgICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgfSA9IHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIuYnVpbGRGaWx0ZXJFeHByZXNzaW9uKGZpbHRlcik7XG5cbiAgICAgICAgcXVlcnlJbnB1dFBhcmFtcyA9IHtcbiAgICAgICAgICAuLi5xdWVyeUlucHV0UGFyYW1zLFxuICAgICAgICAgIEZpbHRlckV4cHJlc3Npb24sXG4gICAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7XG4gICAgICAgICAgICAuLi5xdWVyeUlucHV0UGFyYW1zLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgICB9LFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgIC4uLnF1ZXJ5SW5wdXRQYXJhbXMuRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgICAgICAgIC4uLkV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gY2hlY2sgaWYgb25seSB0aGUgY291bnQgd2FzIHJlcXVlc3RlZFxuICAgICAgaWYgKG9ubHlDb3VudCkge1xuICAgICAgICBpZiAoc2VsZWN0Py5sZW5ndGgpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAnQXR0cmlidXRlcyBwcm9qZWN0aW9uIGFuZCBjb3VudCBjYW4gbm90IGJlIHVzZWQgdG9nZXRoZXInXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBjb3VudCBhbmQgcHJvamVjdGlvbiBzZWxlY3Rpb24gY2FuIG5vdCBiZSB1c2VkIHRvZ2V0aGVyXG4gICAgICAgIHF1ZXJ5SW5wdXRQYXJhbXMuU2VsZWN0ID0gUVVFUllfU0VMRUNUX1RZUEUuQ09VTlQ7XG4gICAgICB9XG5cbiAgICAgIC8vIHdoZW4gcHJvamVjdGlvbiBrZXlzIGFyZSBwcm92aWRlZFxuICAgICAgaWYgKHNlbGVjdCAmJiBzZWxlY3QubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHByb2plY3Rpb24gPSB0aGlzLmV4cHJlc3Npb25JbnB1dFBhcnNlci5wYXJzZVRvUHJvamVjdGlvbihzZWxlY3QpO1xuXG4gICAgICAgIGlmICghcHJvamVjdGlvbikge1xuICAgICAgICAgIHRocm93IG5ldyBJbnZhbGlkU2VsZWN0SW5wdXRFcnJvcihzZWxlY3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qge1Byb2plY3Rpb25FeHByZXNzaW9uLCBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXN9ID1cbiAgICAgICAgICB0aGlzLmV4cHJlc3Npb25CdWlsZGVyLmJ1aWxkUHJvamVjdGlvbkV4cHJlc3Npb24ocHJvamVjdGlvbik7XG5cbiAgICAgICAgcXVlcnlJbnB1dFBhcmFtcyA9IHtcbiAgICAgICAgICAuLi5xdWVyeUlucHV0UGFyYW1zLFxuICAgICAgICAgIFByb2plY3Rpb25FeHByZXNzaW9uLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAgICAgLi4ucXVlcnlJbnB1dFBhcmFtcy5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgICAuLi5FeHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgICAgICAgfSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybSh7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5RVUVSWSxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGVudGl0eU5hbWU6IG5hbWUsXG4gICAgICBwcmltYXJ5S2V5OiBwYXJ0aXRpb25LZXlBdHRyaWJ1dGVzLFxuICAgICAgYm9keTogcXVlcnlJbnB1dFBhcmFtcyxcbiAgICB9KTtcblxuICAgIHJldHVybiBxdWVyeUlucHV0UGFyYW1zO1xuICB9XG5cbiAgcHJpdmF0ZSBsYXp5VG9EeW5hbW9VcGRhdGVQcmltYXJ5S2V5RmFjdG9yeShcbiAgICB0YWJsZTogVGFibGUsXG4gICAgZW50aXR5TmFtZTogc3RyaW5nLFxuICAgIHByaW1hcnlLZXlTY2hlbWE6IER5bmFtb0VudGl0eVNjaGVtYVByaW1hcnlLZXksXG4gICAgbmV3SXRlbUJvZHk6IERvY3VtZW50Q2xpZW50VHlwZXMuUHV0SXRlbUlucHV0LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICByZXR1cm4gKHByZXZpb3VzSXRlbUJvZHk6IGFueSkgPT4ge1xuICAgICAgY29uc3QgdXBkYXRlVHJhbnNhY3Rpb25JdGVtczogRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3QgPVxuICAgICAgICBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgUHV0OiB7XG4gICAgICAgICAgICAgIC4uLm5ld0l0ZW1Cb2R5LFxuICAgICAgICAgICAgICAvLyBpbXBvcnQgZXhpc3RpbmcgY3VycmVudCBpdGVtXG4gICAgICAgICAgICAgIEl0ZW06IHsuLi5wcmV2aW91c0l0ZW1Cb2R5LCAuLi5uZXdJdGVtQm9keS5JdGVtfSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgXSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtTGlzdDtcblxuICAgICAgLy8gaWYgdGhlcmUgd2FzIGEgcHJldmlvdXMgZXhpc3RpbmcgaXRlbSwgYmFzaWNhbGx5IHJlbW92ZSBpdCBhcyBwYXJ0IG9mIHRoaXMgdHJhbnNhY3Rpb25cbiAgICAgIGlmIChwcmV2aW91c0l0ZW1Cb2R5ICYmICFpc0VtcHR5T2JqZWN0KHByZXZpb3VzSXRlbUJvZHkpKSB7XG4gICAgICAgIHVwZGF0ZVRyYW5zYWN0aW9uSXRlbXMucHVzaCh7XG4gICAgICAgICAgRGVsZXRlOiB7XG4gICAgICAgICAgICBUYWJsZU5hbWU6IHRhYmxlLm5hbWUsXG4gICAgICAgICAgICBLZXk6IHtcbiAgICAgICAgICAgICAgLi4udGhpcy5nZXRQYXJzZWRQcmltYXJ5S2V5KFxuICAgICAgICAgICAgICAgIHRhYmxlLFxuICAgICAgICAgICAgICAgIHByaW1hcnlLZXlTY2hlbWEsXG4gICAgICAgICAgICAgICAgcHJldmlvdXNJdGVtQm9keVxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm0oe1xuICAgICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UWVBFLlVQREFURSxcbiAgICAgICAgcHJlZml4OiAnQWZ0ZXInLFxuICAgICAgICBlbnRpdHlOYW1lLFxuICAgICAgICBwcmltYXJ5S2V5OiBudWxsLFxuICAgICAgICBib2R5OiB1cGRhdGVUcmFuc2FjdGlvbkl0ZW1zLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB1cGRhdGVUcmFuc2FjdGlvbkl0ZW1zO1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogTGF6eSBidWlsZCB1cGRhdGUgaXRlbSBpbnB1dFxuICAgKiBUaGlzIGlzIGhlbHBmdWwgaW4gY2FzZXMgd2hlcmUgd2UgZG9uJ3QgeW91IGhhdmUgYWxsIHRoZSBhdHRyaWJ1dGVzIHRvIGJ1aWxkIGl0ZW0gaW5wdXQsIGFuZCB0aGUgY2FsbGVyIHdpbGwgbmVlZCB0b1xuICAgKiB0byBwZXJmb3JtIHNvbWUgc29ydCBvZiBhc3luYyBjYWxsIGluIG9yZGVyIHRvIGZldGNoIGF0dHJpYnV0ZXMgYW5kIHByb2NlZWQgd2l0aCBidWlsZFxuICAgKlxuICAgKi9cbiAgcHJpdmF0ZSBsYXp5VG9EeW5hbW9VcGRhdGVVbmlxdWVJdGVtRmFjdG9yeTxFbnRpdHk+KFxuICAgIHRhYmxlOiBUYWJsZSxcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmcsXG4gICAgdW5pcXVlQXR0cmlidXRlc1RvVXBkYXRlOiBSZXBsYWNlPFxuICAgICAgQXR0cmlidXRlTWV0YWRhdGEsXG4gICAgICAndW5pcXVlJyxcbiAgICAgIHtcbiAgICAgICAgdW5pcXVlOiBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5O1xuICAgICAgfVxuICAgID5bXSxcbiAgICBtYWluSXRlbTogRG9jdW1lbnRDbGllbnRUeXBlcy5VcGRhdGVJdGVtSW5wdXQsXG4gICAgbmV3Qm9keTogYW55LFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICAvLyByZXR1cm5zIHRyYW5zYWN0IHdyaXRlIGl0ZW0gbGlzdFxuICAgIHJldHVybiAocHJldmlvdXNJdGVtQm9keTogYW55KSA9PiB7XG4gICAgICAvLyB1cGRhdGluZyB1bmlxdWUgYXR0cmlidXRlcyBhbHNvIHJlcXVpcmUgY2hlY2tpbmcgaWYgbmV3IHZhbHVlIGV4aXN0c1xuICAgICAgY29uc3QgdW5pcXVlUmVjb3JkQ29uZGl0aW9uRXhwcmVzc2lvbiA9XG4gICAgICAgIHRoaXMuZXhwcmVzc2lvbkJ1aWxkZXIuYnVpbGRVbmlxdWVSZWNvcmRDb25kaXRpb25FeHByZXNzaW9uKHRhYmxlKTtcblxuICAgICAgLy8gbWFwIGFsbCB1bmlxdWUgYXR0cmlidXRlcyB0byBbcHV0LCBkZWxldGVdIGl0ZW0gdHVwbGVcbiAgICAgIGNvbnN0IHVuaXF1ZUF0dHJpYnV0ZUlucHV0czogRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3QgPVxuICAgICAgICB1bmlxdWVBdHRyaWJ1dGVzVG9VcGRhdGUuZmxhdE1hcChhdHRyID0+IHtcbiAgICAgICAgICBjb25zdCB1bmlxdWVBdHRyaWJ1dGVXcml0ZUl0ZW1zOiBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtTGlzdCA9XG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBQdXQ6IHtcbiAgICAgICAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUubmFtZSxcbiAgICAgICAgICAgICAgICAgIEl0ZW06IHtcbiAgICAgICAgICAgICAgICAgICAgLi4udGhpcy5nZXRQYXJzZWRQcmltYXJ5S2V5KFxuICAgICAgICAgICAgICAgICAgICAgIHRhYmxlLFxuICAgICAgICAgICAgICAgICAgICAgIGF0dHIudW5pcXVlLFxuICAgICAgICAgICAgICAgICAgICAgIG5ld0JvZHkgYXMgUGFydGlhbDxFbnRpdHk+XG4gICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgLi4udW5pcXVlUmVjb3JkQ29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgXTtcblxuICAgICAgICAgIC8vIGlmIHVuaXF1ZSBhdHRyaWJ1dGUgcHJldmlvdXNseSBleGlzdGVkLCByZW1vdmUgaXQgYXMgcGFydCBvZiB0aGUgc2FtZSB0cmFuc2FjdGlvblxuICAgICAgICAgIGlmIChwcmV2aW91c0l0ZW1Cb2R5ICYmIHByZXZpb3VzSXRlbUJvZHlbYXR0ci5uYW1lXSkge1xuICAgICAgICAgICAgdW5pcXVlQXR0cmlidXRlV3JpdGVJdGVtcy5wdXNoKHtcbiAgICAgICAgICAgICAgRGVsZXRlOiB7XG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiB0YWJsZS5uYW1lLFxuICAgICAgICAgICAgICAgIEtleToge1xuICAgICAgICAgICAgICAgICAgLi4udGhpcy5nZXRQYXJzZWRQcmltYXJ5S2V5KFxuICAgICAgICAgICAgICAgICAgICB0YWJsZSxcbiAgICAgICAgICAgICAgICAgICAgYXR0ci51bmlxdWUsXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzSXRlbUJvZHlcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiB1bmlxdWVBdHRyaWJ1dGVXcml0ZUl0ZW1zO1xuICAgICAgICB9KTtcblxuICAgICAgLy8gaW4gb3JkZXIgZm9yIHVwZGF0ZSBleHByZXNzIHRvIHN1Y2NlZWQsIGFsbCBsaXN0ZWQgbXVzdCBzdWNjZWVkIGluIGEgdHJhbnNhY3Rpb25cbiAgICAgIGNvbnN0IHVwZGF0ZVRyYW5zYWN0aW9uSXRlbXMgPSBbXG4gICAgICAgIHtVcGRhdGU6IG1haW5JdGVtfSxcbiAgICAgICAgLi4udW5pcXVlQXR0cmlidXRlSW5wdXRzLFxuICAgICAgXSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtTGlzdDtcbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtKHtcbiAgICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5VUERBVEUsXG4gICAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgICAgZW50aXR5TmFtZSxcbiAgICAgICAgcHJpbWFyeUtleTogbnVsbCxcbiAgICAgICAgYm9keTogdXBkYXRlVHJhbnNhY3Rpb25JdGVtcyxcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHVwZGF0ZVRyYW5zYWN0aW9uSXRlbXM7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBsYXppbHkgcmVzb2x2ZSBhbGwgdW5pcXVlIGF0dHJpYnV0ZSBpdGVtcyB0byByZW1vdmVcbiAgICogQHBhcmFtIHRhYmxlXG4gICAqIEBwYXJhbSB1bmlxdWVBdHRyaWJ1dGVzVG9SZW1vdmVcbiAgICogQHBhcmFtIG1haW5JdGVtXG4gICAqL1xuICBwcml2YXRlIGxhenlUb0R5bmFtb1JlbW92ZUl0ZW1GYWN0b3J5KFxuICAgIHRhYmxlOiBUYWJsZSxcbiAgICBlbnRpdHlOYW1lOiBzdHJpbmcsXG4gICAgdW5pcXVlQXR0cmlidXRlc1RvUmVtb3ZlOiBSZXBsYWNlPFxuICAgICAgQXR0cmlidXRlTWV0YWRhdGEsXG4gICAgICAndW5pcXVlJyxcbiAgICAgIHtcbiAgICAgICAgdW5pcXVlOiBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5O1xuICAgICAgfVxuICAgID5bXSxcbiAgICBtYWluSXRlbTogRG9jdW1lbnRDbGllbnRUeXBlcy5EZWxldGVJdGVtSW5wdXQsXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIHJldHVybiAoZXhpc3RpbmdJdGVtQm9keTogYW55KSA9PiB7XG4gICAgICBsZXQgdW5pcXVlQXR0cmlidXRlSW5wdXRzOiBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0V3JpdGVJdGVtTGlzdCA9IFtdO1xuICAgICAgaWYgKGV4aXN0aW5nSXRlbUJvZHkpIHtcbiAgICAgICAgdW5pcXVlQXR0cmlidXRlSW5wdXRzID0gdW5pcXVlQXR0cmlidXRlc1RvUmVtb3ZlLm1hcChhdHRyID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgRGVsZXRlOiB7XG4gICAgICAgICAgICAgIFRhYmxlTmFtZTogdGFibGUubmFtZSxcbiAgICAgICAgICAgICAgS2V5OiB7XG4gICAgICAgICAgICAgICAgLi4udGhpcy5nZXRQYXJzZWRQcmltYXJ5S2V5KFxuICAgICAgICAgICAgICAgICAgdGFibGUsXG4gICAgICAgICAgICAgICAgICBhdHRyLnVuaXF1ZSxcbiAgICAgICAgICAgICAgICAgIGV4aXN0aW5nSXRlbUJvZHlcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGVsZXRlVHJhbnNhY3Rpb25JdGVtcyA9IFtcbiAgICAgICAge1xuICAgICAgICAgIERlbGV0ZTogbWFpbkl0ZW0sXG4gICAgICAgIH0sXG4gICAgICAgIC4uLnVuaXF1ZUF0dHJpYnV0ZUlucHV0cyxcbiAgICAgIF0gYXMgRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3Q7XG5cbiAgICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtKHtcbiAgICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFlQRS5ERUxFVEUsXG4gICAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgICAgZW50aXR5TmFtZSxcbiAgICAgICAgcHJpbWFyeUtleTogbnVsbCxcbiAgICAgICAgYm9keTogZGVsZXRlVHJhbnNhY3Rpb25JdGVtcyxcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4gZGVsZXRlVHJhbnNhY3Rpb25JdGVtcztcbiAgICB9O1xuICB9XG59XG4iXX0=