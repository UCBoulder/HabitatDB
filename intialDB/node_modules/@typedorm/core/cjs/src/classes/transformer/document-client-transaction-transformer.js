"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentClientTransactionTransformer = void 0;
const is_lazy_transaction_write_item_list_loader_1 = require("./is-lazy-transaction-write-item-list-loader");
const type_guards_1 = require("./../transaction/type-guards");
const common_1 = require("@typedorm/common");
const low_order_transformers_1 = require("./low-order-transformers");
const type_guards_2 = require("../transaction/type-guards");
const drop_prop_1 = require("../../helpers/drop-prop");
class DocumentClientTransactionTransformer extends low_order_transformers_1.LowOrderTransformers {
    constructor(connection) {
        super(connection);
    }
    toDynamoWriteTransactionItems(writeTransaction, metadataOptions) {
        const { items } = writeTransaction;
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TRANSACTION_TYPE.TRANSACTION_WRITE,
            prefix: 'Before',
            body: items,
        });
        const transformed = this.innerTransformTransactionWriteItems(items);
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TRANSACTION_TYPE.TRANSACTION_WRITE,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    toDynamoReadTransactionItems(readTransaction, metadataOptions) {
        const { items } = readTransaction;
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TRANSACTION_TYPE.TRANSACTION_READ,
            prefix: 'Before',
            body: items,
        });
        const transformed = this.innerTransformTransactionReadItems(items);
        this.connection.logger.logTransformTransaction({
            requestId: metadataOptions === null || metadataOptions === void 0 ? void 0 : metadataOptions.requestId,
            operation: common_1.TRANSFORM_TRANSACTION_TYPE.TRANSACTION_READ,
            prefix: 'After',
            body: transformed,
        });
        return transformed;
    }
    /**
     * Parse each item in the request to be in one of the following collections
     * - transactionItemList: items that must be processed in a transaction
     */
    innerTransformTransactionReadItems(transactionItems, metadataOptions) {
        return transactionItems.reduce((acc, transactionItem) => {
            if ((0, type_guards_1.isTransactionAddGetItem)(transactionItem)) {
                const { get: { item, primaryKey, options }, } = transactionItem;
                const dynamoGetItemInput = this.toDynamoGetItem(item, primaryKey, options, metadataOptions);
                acc.transactionItemList.push({
                    Get: dynamoGetItemInput,
                });
            }
            else {
                throw new common_1.InvalidTransactionReadItemError(transactionItem);
            }
            return acc;
        }, {
            transactionItemList: [],
        });
    }
    /**
     * Parse each item in the request to be in one of the following collections
     * - transactionItemList: items that must be processed in a transaction
     * - lazyTransactionWriteItemListLoaderItems: items that are must be processed in transaction but also requires other requests to be made first (i.e delete of unique items)
     */
    innerTransformTransactionWriteItems(transactionItems, metadataOptions) {
        return transactionItems.reduce((acc, transactionItem) => {
            if ((0, type_guards_2.isTransactionAddCreateItem)(transactionItem)) {
                const { create: { item, options }, } = transactionItem;
                const dynamoPutItemInput = this.toDynamoPutItem(item, options, metadataOptions); // update
                if (!(0, type_guards_1.isWriteTransactionItemList)(dynamoPutItemInput)) {
                    acc.transactionItemList.push({
                        Put: dynamoPutItemInput,
                    });
                }
                else {
                    acc.transactionItemList.push(...dynamoPutItemInput);
                }
            }
            else if ((0, type_guards_1.isTransactionAddUpdateItem)(transactionItem)) {
                const { update: { item, primaryKey, body, options }, } = transactionItem;
                const dynamoUpdateItemInput = this.toDynamoUpdateItem(item, primaryKey, body, options, metadataOptions);
                if (!(0, is_lazy_transaction_write_item_list_loader_1.isLazyTransactionWriteItemListLoader)(dynamoUpdateItemInput)) {
                    acc.transactionItemList.push({
                        Update: (0, drop_prop_1.dropProp)(dynamoUpdateItemInput, 'ReturnValues'),
                    });
                }
                else {
                    acc.lazyTransactionWriteItemListLoader.push(dynamoUpdateItemInput);
                }
            }
            else if ((0, type_guards_1.isTransactionAddDeleteItem)(transactionItem)) {
                const { delete: { item, primaryKey, options }, } = transactionItem;
                const dynamoDeleteItemInput = this.toDynamoDeleteItem(item, primaryKey, options, metadataOptions);
                if (!(0, is_lazy_transaction_write_item_list_loader_1.isLazyTransactionWriteItemListLoader)(dynamoDeleteItemInput)) {
                    acc.transactionItemList.push({
                        Delete: dynamoDeleteItemInput,
                    });
                }
                else {
                    acc.lazyTransactionWriteItemListLoader.push(dynamoDeleteItemInput);
                }
            }
            else {
                throw new common_1.InvalidTransactionWriteItemError(transactionItem);
            }
            return acc;
        }, {
            transactionItemList: [],
            lazyTransactionWriteItemListLoader: [],
        });
    }
}
exports.DocumentClientTransactionTransformer = DocumentClientTransactionTransformer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LXRyYW5zYWN0aW9uLXRyYW5zZm9ybWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvY29yZS9zcmMvY2xhc3Nlcy90cmFuc2Zvcm1lci9kb2N1bWVudC1jbGllbnQtdHJhbnNhY3Rpb24tdHJhbnNmb3JtZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsNkdBR3NEO0FBQ3RELDhEQUtzQztBQUN0Qyw2Q0FJMEI7QUFNMUIscUVBQThEO0FBQzlELDREQUFzRTtBQUN0RSx1REFBaUQ7QUFRakQsTUFBYSxvQ0FBcUMsU0FBUSw2Q0FBb0I7SUFDNUUsWUFBWSxVQUFzQjtRQUNoQyxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDcEIsQ0FBQztJQUVELDZCQUE2QixDQUMzQixnQkFBa0MsRUFDbEMsZUFBaUM7UUFFakMsTUFBTSxFQUFDLEtBQUssRUFBQyxHQUFHLGdCQUFnQixDQUFDO1FBRWpDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDO1lBQzdDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztZQUNyQyxTQUFTLEVBQUUsbUNBQTBCLENBQUMsaUJBQWlCO1lBQ3ZELE1BQU0sRUFBRSxRQUFRO1lBQ2hCLElBQUksRUFBRSxLQUFLO1NBQ1osQ0FBQyxDQUFDO1FBRUgsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRXBFLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLHVCQUF1QixDQUFDO1lBQzdDLFNBQVMsRUFBRSxlQUFlLGFBQWYsZUFBZSx1QkFBZixlQUFlLENBQUUsU0FBUztZQUNyQyxTQUFTLEVBQUUsbUNBQTBCLENBQUMsaUJBQWlCO1lBQ3ZELE1BQU0sRUFBRSxPQUFPO1lBQ2YsSUFBSSxFQUFFLFdBQVc7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QUErQztZQUNwRSxrQ0FBa0MsRUFDaEMsRUFBMEM7U0FDN0MsQ0FDRixDQUFDO0lBQ0osQ0FBQztDQUNGO0FBM0tELG9GQTJLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIExhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIsXG4gIGlzTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcixcbn0gZnJvbSAnLi9pcy1sYXp5LXRyYW5zYWN0aW9uLXdyaXRlLWl0ZW0tbGlzdC1sb2FkZXInO1xuaW1wb3J0IHtcbiAgaXNUcmFuc2FjdGlvbkFkZERlbGV0ZUl0ZW0sXG4gIGlzVHJhbnNhY3Rpb25BZGRHZXRJdGVtLFxuICBpc1RyYW5zYWN0aW9uQWRkVXBkYXRlSXRlbSxcbiAgaXNXcml0ZVRyYW5zYWN0aW9uSXRlbUxpc3QsXG59IGZyb20gJy4vLi4vdHJhbnNhY3Rpb24vdHlwZS1ndWFyZHMnO1xuaW1wb3J0IHtcbiAgSW52YWxpZFRyYW5zYWN0aW9uUmVhZEl0ZW1FcnJvcixcbiAgSW52YWxpZFRyYW5zYWN0aW9uV3JpdGVJdGVtRXJyb3IsXG4gIFRSQU5TRk9STV9UUkFOU0FDVElPTl9UWVBFLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7XG4gIFdyaXRlVHJhbnNhY3Rpb24sXG4gIFdyaXRlVHJhbnNhY3Rpb25JdGVtLFxufSBmcm9tICcuLy4uL3RyYW5zYWN0aW9uL3dyaXRlLXRyYW5zYWN0aW9uJztcbmltcG9ydCB7Q29ubmVjdGlvbn0gZnJvbSAnLi4vY29ubmVjdGlvbi9jb25uZWN0aW9uJztcbmltcG9ydCB7TG93T3JkZXJUcmFuc2Zvcm1lcnN9IGZyb20gJy4vbG93LW9yZGVyLXRyYW5zZm9ybWVycyc7XG5pbXBvcnQge2lzVHJhbnNhY3Rpb25BZGRDcmVhdGVJdGVtfSBmcm9tICcuLi90cmFuc2FjdGlvbi90eXBlLWd1YXJkcyc7XG5pbXBvcnQge2Ryb3BQcm9wfSBmcm9tICcuLi8uLi9oZWxwZXJzL2Ryb3AtcHJvcCc7XG5pbXBvcnQge1xuICBSZWFkVHJhbnNhY3Rpb24sXG4gIFJlYWRUcmFuc2FjdGlvbkl0ZW0sXG59IGZyb20gJy4uL3RyYW5zYWN0aW9uL3JlYWQtdHJhbnNhY3Rpb24nO1xuaW1wb3J0IHtNZXRhZGF0YU9wdGlvbnN9IGZyb20gJy4vYmFzZS10cmFuc2Zvcm1lcic7XG5pbXBvcnQge0RvY3VtZW50Q2xpZW50VHlwZXN9IGZyb20gJ0B0eXBlZG9ybS9kb2N1bWVudC1jbGllbnQnO1xuXG5leHBvcnQgY2xhc3MgRG9jdW1lbnRDbGllbnRUcmFuc2FjdGlvblRyYW5zZm9ybWVyIGV4dGVuZHMgTG93T3JkZXJUcmFuc2Zvcm1lcnMge1xuICBjb25zdHJ1Y3Rvcihjb25uZWN0aW9uOiBDb25uZWN0aW9uKSB7XG4gICAgc3VwZXIoY29ubmVjdGlvbik7XG4gIH1cblxuICB0b0R5bmFtb1dyaXRlVHJhbnNhY3Rpb25JdGVtcyhcbiAgICB3cml0ZVRyYW5zYWN0aW9uOiBXcml0ZVRyYW5zYWN0aW9uLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICBjb25zdCB7aXRlbXN9ID0gd3JpdGVUcmFuc2FjdGlvbjtcblxuICAgIHRoaXMuY29ubmVjdGlvbi5sb2dnZXIubG9nVHJhbnNmb3JtVHJhbnNhY3Rpb24oe1xuICAgICAgcmVxdWVzdElkOiBtZXRhZGF0YU9wdGlvbnM/LnJlcXVlc3RJZCxcbiAgICAgIG9wZXJhdGlvbjogVFJBTlNGT1JNX1RSQU5TQUNUSU9OX1RZUEUuVFJBTlNBQ1RJT05fV1JJVEUsXG4gICAgICBwcmVmaXg6ICdCZWZvcmUnLFxuICAgICAgYm9keTogaXRlbXMsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRoaXMuaW5uZXJUcmFuc2Zvcm1UcmFuc2FjdGlvbldyaXRlSXRlbXMoaXRlbXMpO1xuXG4gICAgdGhpcy5jb25uZWN0aW9uLmxvZ2dlci5sb2dUcmFuc2Zvcm1UcmFuc2FjdGlvbih7XG4gICAgICByZXF1ZXN0SWQ6IG1ldGFkYXRhT3B0aW9ucz8ucmVxdWVzdElkLFxuICAgICAgb3BlcmF0aW9uOiBUUkFOU0ZPUk1fVFJBTlNBQ1RJT05fVFlQRS5UUkFOU0FDVElPTl9XUklURSxcbiAgICAgIHByZWZpeDogJ0FmdGVyJyxcbiAgICAgIGJvZHk6IHRyYW5zZm9ybWVkLFxuICAgIH0pO1xuICAgIHJldHVybiB0cmFuc2Zvcm1lZDtcbiAgfVxuXG4gIHRvRHluYW1vUmVhZFRyYW5zYWN0aW9uSXRlbXMoXG4gICAgcmVhZFRyYW5zYWN0aW9uOiBSZWFkVHJhbnNhY3Rpb24sXG4gICAgbWV0YWRhdGFPcHRpb25zPzogTWV0YWRhdGFPcHRpb25zXG4gICkge1xuICAgIGNvbnN0IHtpdGVtc30gPSByZWFkVHJhbnNhY3Rpb247XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybVRyYW5zYWN0aW9uKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UUkFOU0FDVElPTl9UWVBFLlRSQU5TQUNUSU9OX1JFQUQsXG4gICAgICBwcmVmaXg6ICdCZWZvcmUnLFxuICAgICAgYm9keTogaXRlbXMsXG4gICAgfSk7XG5cbiAgICBjb25zdCB0cmFuc2Zvcm1lZCA9IHRoaXMuaW5uZXJUcmFuc2Zvcm1UcmFuc2FjdGlvblJlYWRJdGVtcyhpdGVtcyk7XG5cbiAgICB0aGlzLmNvbm5lY3Rpb24ubG9nZ2VyLmxvZ1RyYW5zZm9ybVRyYW5zYWN0aW9uKHtcbiAgICAgIHJlcXVlc3RJZDogbWV0YWRhdGFPcHRpb25zPy5yZXF1ZXN0SWQsXG4gICAgICBvcGVyYXRpb246IFRSQU5TRk9STV9UUkFOU0FDVElPTl9UWVBFLlRSQU5TQUNUSU9OX1JFQUQsXG4gICAgICBwcmVmaXg6ICdBZnRlcicsXG4gICAgICBib2R5OiB0cmFuc2Zvcm1lZCxcbiAgICB9KTtcblxuICAgIHJldHVybiB0cmFuc2Zvcm1lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBlYWNoIGl0ZW0gaW4gdGhlIHJlcXVlc3QgdG8gYmUgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgY29sbGVjdGlvbnNcbiAgICogLSB0cmFuc2FjdGlvbkl0ZW1MaXN0OiBpdGVtcyB0aGF0IG11c3QgYmUgcHJvY2Vzc2VkIGluIGEgdHJhbnNhY3Rpb25cbiAgICovXG4gIHByaXZhdGUgaW5uZXJUcmFuc2Zvcm1UcmFuc2FjdGlvblJlYWRJdGVtcyhcbiAgICB0cmFuc2FjdGlvbkl0ZW1zOiBSZWFkVHJhbnNhY3Rpb25JdGVtPGFueSwgYW55PltdLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICByZXR1cm4gdHJhbnNhY3Rpb25JdGVtcy5yZWR1Y2UoXG4gICAgICAoYWNjLCB0cmFuc2FjdGlvbkl0ZW0pID0+IHtcbiAgICAgICAgaWYgKGlzVHJhbnNhY3Rpb25BZGRHZXRJdGVtKHRyYW5zYWN0aW9uSXRlbSkpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBnZXQ6IHtpdGVtLCBwcmltYXJ5S2V5LCBvcHRpb25zfSxcbiAgICAgICAgICB9ID0gdHJhbnNhY3Rpb25JdGVtO1xuXG4gICAgICAgICAgY29uc3QgZHluYW1vR2V0SXRlbUlucHV0ID0gdGhpcy50b0R5bmFtb0dldEl0ZW0oXG4gICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgcHJpbWFyeUtleSxcbiAgICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgICBtZXRhZGF0YU9wdGlvbnNcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgYWNjLnRyYW5zYWN0aW9uSXRlbUxpc3QucHVzaCh7XG4gICAgICAgICAgICBHZXQ6IGR5bmFtb0dldEl0ZW1JbnB1dCxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uUmVhZEl0ZW1FcnJvcih0cmFuc2FjdGlvbkl0ZW0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICB0cmFuc2FjdGlvbkl0ZW1MaXN0OiBbXSBhcyBEb2N1bWVudENsaWVudFR5cGVzLlRyYW5zYWN0R2V0SXRlbUxpc3QsXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSBlYWNoIGl0ZW0gaW4gdGhlIHJlcXVlc3QgdG8gYmUgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgY29sbGVjdGlvbnNcbiAgICogLSB0cmFuc2FjdGlvbkl0ZW1MaXN0OiBpdGVtcyB0aGF0IG11c3QgYmUgcHJvY2Vzc2VkIGluIGEgdHJhbnNhY3Rpb25cbiAgICogLSBsYXp5VHJhbnNhY3Rpb25Xcml0ZUl0ZW1MaXN0TG9hZGVySXRlbXM6IGl0ZW1zIHRoYXQgYXJlIG11c3QgYmUgcHJvY2Vzc2VkIGluIHRyYW5zYWN0aW9uIGJ1dCBhbHNvIHJlcXVpcmVzIG90aGVyIHJlcXVlc3RzIHRvIGJlIG1hZGUgZmlyc3QgKGkuZSBkZWxldGUgb2YgdW5pcXVlIGl0ZW1zKVxuICAgKi9cbiAgcHJpdmF0ZSBpbm5lclRyYW5zZm9ybVRyYW5zYWN0aW9uV3JpdGVJdGVtcyhcbiAgICB0cmFuc2FjdGlvbkl0ZW1zOiBXcml0ZVRyYW5zYWN0aW9uSXRlbTxhbnksIGFueSwgYW55PltdLFxuICAgIG1ldGFkYXRhT3B0aW9ucz86IE1ldGFkYXRhT3B0aW9uc1xuICApIHtcbiAgICByZXR1cm4gdHJhbnNhY3Rpb25JdGVtcy5yZWR1Y2UoXG4gICAgICAoYWNjLCB0cmFuc2FjdGlvbkl0ZW0pID0+IHtcbiAgICAgICAgaWYgKGlzVHJhbnNhY3Rpb25BZGRDcmVhdGVJdGVtKHRyYW5zYWN0aW9uSXRlbSkpIHtcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICBjcmVhdGU6IHtpdGVtLCBvcHRpb25zfSxcbiAgICAgICAgICB9ID0gdHJhbnNhY3Rpb25JdGVtO1xuXG4gICAgICAgICAgY29uc3QgZHluYW1vUHV0SXRlbUlucHV0ID0gdGhpcy50b0R5bmFtb1B1dEl0ZW0oXG4gICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICAgICAgICk7IC8vIHVwZGF0ZVxuXG4gICAgICAgICAgaWYgKCFpc1dyaXRlVHJhbnNhY3Rpb25JdGVtTGlzdChkeW5hbW9QdXRJdGVtSW5wdXQpKSB7XG4gICAgICAgICAgICBhY2MudHJhbnNhY3Rpb25JdGVtTGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgUHV0OiBkeW5hbW9QdXRJdGVtSW5wdXQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWNjLnRyYW5zYWN0aW9uSXRlbUxpc3QucHVzaCguLi5keW5hbW9QdXRJdGVtSW5wdXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChpc1RyYW5zYWN0aW9uQWRkVXBkYXRlSXRlbSh0cmFuc2FjdGlvbkl0ZW0pKSB7XG4gICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgdXBkYXRlOiB7aXRlbSwgcHJpbWFyeUtleSwgYm9keSwgb3B0aW9uc30sXG4gICAgICAgICAgfSA9IHRyYW5zYWN0aW9uSXRlbTtcblxuICAgICAgICAgIGNvbnN0IGR5bmFtb1VwZGF0ZUl0ZW1JbnB1dCA9IHRoaXMudG9EeW5hbW9VcGRhdGVJdGVtKFxuICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgIHByaW1hcnlLZXksXG4gICAgICAgICAgICBib2R5LFxuICAgICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICAgIG1ldGFkYXRhT3B0aW9uc1xuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKCFpc0xhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIoZHluYW1vVXBkYXRlSXRlbUlucHV0KSkge1xuICAgICAgICAgICAgYWNjLnRyYW5zYWN0aW9uSXRlbUxpc3QucHVzaCh7XG4gICAgICAgICAgICAgIFVwZGF0ZTogZHJvcFByb3AoXG4gICAgICAgICAgICAgICAgZHluYW1vVXBkYXRlSXRlbUlucHV0LFxuICAgICAgICAgICAgICAgICdSZXR1cm5WYWx1ZXMnXG4gICAgICAgICAgICAgICkgYXMgRG9jdW1lbnRDbGllbnRUeXBlcy5VcGRhdGUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWNjLmxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIucHVzaChkeW5hbW9VcGRhdGVJdGVtSW5wdXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChpc1RyYW5zYWN0aW9uQWRkRGVsZXRlSXRlbSh0cmFuc2FjdGlvbkl0ZW0pKSB7XG4gICAgICAgICAgY29uc3Qge1xuICAgICAgICAgICAgZGVsZXRlOiB7aXRlbSwgcHJpbWFyeUtleSwgb3B0aW9uc30sXG4gICAgICAgICAgfSA9IHRyYW5zYWN0aW9uSXRlbTtcblxuICAgICAgICAgIGNvbnN0IGR5bmFtb0RlbGV0ZUl0ZW1JbnB1dCA9IHRoaXMudG9EeW5hbW9EZWxldGVJdGVtKFxuICAgICAgICAgICAgaXRlbSxcbiAgICAgICAgICAgIHByaW1hcnlLZXksXG4gICAgICAgICAgICBvcHRpb25zLFxuICAgICAgICAgICAgbWV0YWRhdGFPcHRpb25zXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoIWlzTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcihkeW5hbW9EZWxldGVJdGVtSW5wdXQpKSB7XG4gICAgICAgICAgICBhY2MudHJhbnNhY3Rpb25JdGVtTGlzdC5wdXNoKHtcbiAgICAgICAgICAgICAgRGVsZXRlOiBkeW5hbW9EZWxldGVJdGVtSW5wdXQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWNjLmxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXIucHVzaChkeW5hbW9EZWxldGVJdGVtSW5wdXQpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBuZXcgSW52YWxpZFRyYW5zYWN0aW9uV3JpdGVJdGVtRXJyb3IodHJhbnNhY3Rpb25JdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdHJhbnNhY3Rpb25JdGVtTGlzdDogW10gYXMgRG9jdW1lbnRDbGllbnRUeXBlcy5UcmFuc2FjdFdyaXRlSXRlbUxpc3QsXG4gICAgICAgIGxhenlUcmFuc2FjdGlvbldyaXRlSXRlbUxpc3RMb2FkZXI6XG4gICAgICAgICAgW10gYXMgTGF6eVRyYW5zYWN0aW9uV3JpdGVJdGVtTGlzdExvYWRlcltdLFxuICAgICAgfVxuICAgICk7XG4gIH1cbn1cbiJdfQ==