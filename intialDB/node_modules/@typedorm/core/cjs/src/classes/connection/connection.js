"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Connection = void 0;
const common_1 = require("@typedorm/common");
const common_2 = require("@typedorm/common");
const document_client_1 = require("@typedorm/document-client");
const is_used_for_primary_key_1 = require("../../helpers/is-used-for-primary-key");
const batch_manager_1 = require("../manager/batch-manager");
const entity_manager_1 = require("../manager/entity-manager");
const scan_manager_1 = require("../manager/scan-manager");
const transaction_manager_1 = require("../manager/transaction-manager");
const connection_metadata_builder_1 = require("./connection-metadata-builder");
class Connection {
    constructor(options, destroySelf) {
        var _a;
        this.options = options;
        this.destroySelf = destroySelf;
        const { table, name = 'default' } = options;
        if (table) {
            this.table = table;
        }
        this.name = name;
        this.entityManager = new entity_manager_1.EntityManager(this);
        this.batchManager = new batch_manager_1.BatchManager(this);
        this.transactionManger = new transaction_manager_1.TransactionManager(this);
        this.scanManager = new scan_manager_1.ScanManager(this);
        this.defaultConfig = {
            queryItemsImplicitLimit: (_a = options.dynamoQueryItemsImplicitLimit) !== null && _a !== void 0 ? _a : common_1.DYNAMO_QUERY_ITEMS_IMPLICIT_LIMIT,
        };
        this.documentClient = this.loadOrInitiateDocumentClient(options.documentClient);
        /**
         * This makes sure that we only ever build entity metadatas once per connection
         */
        this.isConnected = false;
        this.logger = new common_1.DebugLogger();
    }
    connect() {
        if (this.isConnected) {
            throw new Error('There is already an active connection, Connect should only be called once per application.');
        }
        try {
            this._entityMetadatas = new Map(this.buildMetadatas().map(entityMeta => [
                entityMeta.target.name,
                entityMeta,
            ]));
            this.isConnected = true;
            return this;
        }
        catch (err) {
            // Failed to connect to connection, clear self from connection manager
            this.destroySelf(this.name);
            throw err;
        }
    }
    get entityMetadatas() {
        return Array.from(this._entityMetadatas.values());
    }
    hasMetadata(entityClass) {
        return !!this.getEntityByTarget(entityClass);
    }
    getAttributesForEntity(entityClass) {
        const attributesMap = this._entityMetadatas.get(entityClass.name);
        if (!attributesMap) {
            throw new Error(`Cannot find attributes for entity "${entityClass.name}".`);
        }
        return attributesMap.attributes;
    }
    get globalTable() {
        return this.table;
    }
    /**
     * Returns any attributes marked as unique
     * If attribute used in a primary key is marked as unique, it is ignored, since all primary key are always unique
     * @param entityClass
     */
    getUniqueAttributesForEntity(entityClass) {
        const entityMetadata = this.getEntityByTarget(entityClass);
        return this.getAttributesForEntity(entityClass).filter(attr => {
            // only attributes that are not part of primary key should be included
            return ((attr === null || attr === void 0 ? void 0 : attr.unique) &&
                !(0, is_used_for_primary_key_1.isUsedForPrimaryKey)(entityMetadata.schema.primaryKey, attr.name));
        });
    }
    /**
     * Returns a list of attribute names that are referenced in primary key
     * @param entityClass Entity to get primary key attributes for
     * @returns
     */
    getPrimaryKeyAttributeInterpolationsForEntity(entityClass) {
        var _a;
        const entityMetadata = this.getEntityByTarget(entityClass);
        return [
            ...new Set(Object.values((_a = entityMetadata.schema.primaryKey.metadata._interpolations) !== null && _a !== void 0 ? _a : {}).flat()),
        ];
    }
    getEntityByTarget(entityClass) {
        const metadata = this._entityMetadatas.get(entityClass.name);
        if (!metadata) {
            throw new Error(`No such entity named "${entityClass.name}" is known to TypeDORM, make sure it is declared at the connection creation time.`);
        }
        return metadata;
    }
    getEntityByPhysicalName(name) {
        const entitySpec = (0, common_1.getEntityDefinition)(name);
        if (!entitySpec) {
            throw new common_1.NoSuchEntityExistsError(name);
        }
        return this.getEntityByTarget(entitySpec.target);
    }
    getAutoUpdateAttributes(entityClass) {
        return this.getAttributesForEntity(entityClass).filter(attr => attr === null || attr === void 0 ? void 0 : attr.autoUpdate);
    }
    isUsedForPrimaryKey(primaryKey, attributeName) {
        var _a;
        const primaryKeyInterpolations = (_a = primaryKey.metadata._interpolations) !== null && _a !== void 0 ? _a : {};
        return Object.keys(primaryKeyInterpolations).some(key => {
            const currInterpolation = primaryKeyInterpolations[key];
            return currInterpolation.includes(attributeName);
        });
    }
    buildMetadatas() {
        return new connection_metadata_builder_1.ConnectionMetadataBuilder(this).buildEntityMetadatas(this.options.entities);
    }
    loadOrInitiateDocumentClient(documentClient) {
        if (!documentClient) {
            const AWSModule = (0, common_2.loadPackage)('aws-sdk');
            return new document_client_1.DocumentClientV2(new AWSModule.DynamoDB.DocumentClient());
        }
        if (documentClient instanceof document_client_1.DocumentClientV2) {
            return documentClient;
        }
        else if (documentClient instanceof document_client_1.DocumentClientV3) {
            return documentClient;
        }
        else {
            return new document_client_1.DocumentClientV2(documentClient);
        }
    }
}
exports.Connection = Connection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL2NvcmUvc3JjL2NsYXNzZXMvY29ubmVjdGlvbi9jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDZDQVEwQjtBQUMxQiw2Q0FBNkM7QUFDN0MsK0RBSW1DO0FBQ25DLG1GQUEwRTtBQUMxRSw0REFBc0Q7QUFDdEQsOERBQXdEO0FBQ3hELDBEQUFvRDtBQUNwRCx3RUFBa0U7QUFPbEUsK0VBQXdFO0FBR3hFLE1BQWEsVUFBVTtJQWNyQixZQUNVLE9BQTBCLEVBQzFCLFdBQW1DOztRQURuQyxZQUFPLEdBQVAsT0FBTyxDQUFtQjtRQUMxQixnQkFBVyxHQUFYLFdBQVcsQ0FBd0I7UUFFM0MsTUFBTSxFQUFDLEtBQUssRUFBRSxJQUFJLEdBQUcsU0FBUyxFQUFDLEdBQUcsT0FBTyxDQUFDO1FBQzFDLElBQUksS0FBSyxFQUFFO1lBQ1QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksOEJBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksNEJBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSx3Q0FBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0RCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksMEJBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsYUFBYSxHQUFHO1lBQ25CLHVCQUF1QixFQUNyQixNQUFBLE9BQU8sQ0FBQyw2QkFBNkIsbUNBQ3JDLDBDQUFpQztTQUNwQyxDQUFDO1FBRUYsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENB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Q0FBQztJQUNKLENBQUM7SUFFRCw0QkFBNEIsQ0FBQyxjQUF3QjtRQUNuRCxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLE1BQU0sU0FBUyxHQUFHLElBQUEsb0JBQVcsRUFBQyxTQUFTLENBQUMsQ0FBQztZQUN6QyxPQUFPLElBQUksa0NBQWdCLENBQUMsSUFBSSxTQUFTLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxDQUFDLENBQUM7U0FDdEU7UUFFRCxJQUFJLGNBQWMsWUFBWSxrQ0FBZ0IsRUFBRTtZQUM5QyxPQUFPLGNBQWMsQ0FBQztTQUN2QjthQUFNLElBQUksY0FBYyxZQUFZLGtDQUFnQixFQUFFO1lBQ3JELE9BQU8sY0FBYyxDQUFDO1NBQ3ZCO2FBQU07WUFDTCxPQUFPLElBQUksa0NBQWdCLENBQUMsY0FBcUIsQ0FBQyxDQUFDO1NBQ3BEO0lBQ0gsQ0FBQztDQUNGO0FBekxELGdDQXlMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERZTkFNT19RVUVSWV9JVEVNU19JTVBMSUNJVF9MSU1JVCxcbiAgRW50aXR5VGFyZ2V0LFxuICBSZXBsYWNlLFxuICBUYWJsZSxcbiAgRGVidWdMb2dnZXIsXG4gIGdldEVudGl0eURlZmluaXRpb24sXG4gIE5vU3VjaEVudGl0eUV4aXN0c0Vycm9yLFxufSBmcm9tICdAdHlwZWRvcm0vY29tbW9uJztcbmltcG9ydCB7bG9hZFBhY2thZ2V9IGZyb20gJ0B0eXBlZG9ybS9jb21tb24nO1xuaW1wb3J0IHtcbiAgRG9jdW1lbnRDbGllbnQsXG4gIERvY3VtZW50Q2xpZW50VjIsXG4gIERvY3VtZW50Q2xpZW50VjMsXG59IGZyb20gJ0B0eXBlZG9ybS9kb2N1bWVudC1jbGllbnQnO1xuaW1wb3J0IHtpc1VzZWRGb3JQcmltYXJ5S2V5fSBmcm9tICcuLi8uLi9oZWxwZXJzL2lzLXVzZWQtZm9yLXByaW1hcnkta2V5JztcbmltcG9ydCB7QmF0Y2hNYW5hZ2VyfSBmcm9tICcuLi9tYW5hZ2VyL2JhdGNoLW1hbmFnZXInO1xuaW1wb3J0IHtFbnRpdHlNYW5hZ2VyfSBmcm9tICcuLi9tYW5hZ2VyL2VudGl0eS1tYW5hZ2VyJztcbmltcG9ydCB7U2Nhbk1hbmFnZXJ9IGZyb20gJy4uL21hbmFnZXIvc2Nhbi1tYW5hZ2VyJztcbmltcG9ydCB7VHJhbnNhY3Rpb25NYW5hZ2VyfSBmcm9tICcuLi9tYW5hZ2VyL3RyYW5zYWN0aW9uLW1hbmFnZXInO1xuaW1wb3J0IHtBdHRyaWJ1dGVNZXRhZGF0YX0gZnJvbSAnLi4vbWV0YWRhdGEvYXR0cmlidXRlLW1ldGFkYXRhJztcbmltcG9ydCB7QXV0b0dlbmVyYXRlZEF0dHJpYnV0ZU1ldGFkYXRhfSBmcm9tICcuLi9tZXRhZGF0YS9hdXRvLWdlbmVyYXRlZC1hdHRyaWJ1dGUtbWV0YWRhdGEnO1xuaW1wb3J0IHtcbiAgRW50aXR5TWV0YWRhdGEsXG4gIER5bmFtb0VudGl0eVNjaGVtYVByaW1hcnlLZXksXG59IGZyb20gJy4uL21ldGFkYXRhL2VudGl0eS1tZXRhZGF0YSc7XG5pbXBvcnQge0Nvbm5lY3Rpb25NZXRhZGF0YUJ1aWxkZXJ9IGZyb20gJy4vY29ubmVjdGlvbi1tZXRhZGF0YS1idWlsZGVyJztcbmltcG9ydCB7Q29ubmVjdGlvbk9wdGlvbnN9IGZyb20gJy4vY29ubmVjdGlvbi1vcHRpb25zJztcblxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb24ge1xuICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IHRhYmxlOiBUYWJsZTtcbiAgcmVhZG9ubHkgZW50aXR5TWFuYWdlcjogRW50aXR5TWFuYWdlcjtcbiAgcmVhZG9ubHkgdHJhbnNhY3Rpb25NYW5nZXI6IFRyYW5zYWN0aW9uTWFuYWdlcjtcbiAgcmVhZG9ubHkgYmF0Y2hNYW5hZ2VyOiBCYXRjaE1hbmFnZXI7XG4gIHJlYWRvbmx5IHNjYW5NYW5hZ2VyOiBTY2FuTWFuYWdlcjtcbiAgcmVhZG9ubHkgZGVmYXVsdENvbmZpZzoge3F1ZXJ5SXRlbXNJbXBsaWNpdExpbWl0OiBudW1iZXJ9O1xuICByZWFkb25seSBkb2N1bWVudENsaWVudDogRG9jdW1lbnRDbGllbnQ7XG4gIHJlYWRvbmx5IGxvZ2dlcjogRGVidWdMb2dnZXI7XG5cbiAgcHJpdmF0ZSBfZW50aXR5TWV0YWRhdGFzOiBNYXA8c3RyaW5nLCBFbnRpdHlNZXRhZGF0YT47XG4gIHByaXZhdGUgaXNDb25uZWN0ZWQ6IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBvcHRpb25zOiBDb25uZWN0aW9uT3B0aW9ucyxcbiAgICBwcml2YXRlIGRlc3Ryb3lTZWxmOiAobmFtZTogc3RyaW5nKSA9PiB2b2lkXG4gICkge1xuICAgIGNvbnN0IHt0YWJsZSwgbmFtZSA9ICdkZWZhdWx0J30gPSBvcHRpb25zO1xuICAgIGlmICh0YWJsZSkge1xuICAgICAgdGhpcy50YWJsZSA9IHRhYmxlO1xuICAgIH1cbiAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIHRoaXMuZW50aXR5TWFuYWdlciA9IG5ldyBFbnRpdHlNYW5hZ2VyKHRoaXMpO1xuICAgIHRoaXMuYmF0Y2hNYW5hZ2VyID0gbmV3IEJhdGNoTWFuYWdlcih0aGlzKTtcbiAgICB0aGlzLnRyYW5zYWN0aW9uTWFuZ2VyID0gbmV3IFRyYW5zYWN0aW9uTWFuYWdlcih0aGlzKTtcbiAgICB0aGlzLnNjYW5NYW5hZ2VyID0gbmV3IFNjYW5NYW5hZ2VyKHRoaXMpO1xuICAgIHRoaXMuZGVmYXVsdENvbmZpZyA9IHtcbiAgICAgIHF1ZXJ5SXRlbXNJbXBsaWNpdExpbWl0OlxuICAgICAgICBvcHRpb25zLmR5bmFtb1F1ZXJ5SXRlbXNJbXBsaWNpdExpbWl0ID8/XG4gICAgICAgIERZTkFNT19RVUVSWV9JVEVNU19JTVBMSUNJVF9MSU1JVCxcbiAgICB9O1xuXG4gICAgdGhpcy5kb2N1bWVudENsaWVudCA9IHRoaXMubG9hZE9ySW5pdGlhdGVEb2N1bWVudENsaWVudChcbiAgICAgIG9wdGlvbnMuZG9jdW1lbnRDbGllbnRcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBtYWtlcyBzdXJlIHRoYXQgd2Ugb25seSBldmVyIGJ1aWxkIGVudGl0eSBtZXRhZGF0YXMgb25jZSBwZXIgY29ubmVjdGlvblxuICAgICAqL1xuICAgIHRoaXMuaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLmxvZ2dlciA9IG5ldyBEZWJ1Z0xvZ2dlcigpO1xuICB9XG5cbiAgY29ubmVjdCgpIHtcbiAgICBpZiAodGhpcy5pc0Nvbm5lY3RlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnVGhlcmUgaXMgYWxyZWFkeSBhbiBhY3RpdmUgY29ubmVjdGlvbiwgQ29ubmVjdCBzaG91bGQgb25seSBiZSBjYWxsZWQgb25jZSBwZXIgYXBwbGljYXRpb24uJ1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5fZW50aXR5TWV0YWRhdGFzID0gbmV3IE1hcChcbiAgICAgICAgdGhpcy5idWlsZE1ldGFkYXRhcygpLm1hcChlbnRpdHlNZXRhID0+IFtcbiAgICAgICAgICBlbnRpdHlNZXRhLnRhcmdldC5uYW1lLFxuICAgICAgICAgIGVudGl0eU1ldGEsXG4gICAgICAgIF0pXG4gICAgICApO1xuXG4gICAgICB0aGlzLmlzQ29ubmVjdGVkID0gdHJ1ZTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gRmFpbGVkIHRvIGNvbm5lY3QgdG8gY29ubmVjdGlvbiwgY2xlYXIgc2VsZiBmcm9tIGNvbm5lY3Rpb24gbWFuYWdlclxuICAgICAgdGhpcy5kZXN0cm95U2VsZih0aGlzLm5hbWUpO1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuXG4gIGdldCBlbnRpdHlNZXRhZGF0YXMoKSB7XG4gICAgcmV0dXJuIEFycmF5LmZyb20odGhpcy5fZW50aXR5TWV0YWRhdGFzLnZhbHVlcygpKTtcbiAgfVxuXG4gIGhhc01ldGFkYXRhPEVudGl0eT4oZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+KSB7XG4gICAgcmV0dXJuICEhdGhpcy5nZXRFbnRpdHlCeVRhcmdldChlbnRpdHlDbGFzcyk7XG4gIH1cblxuICBnZXRBdHRyaWJ1dGVzRm9yRW50aXR5PEVudGl0eT4oZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+KSB7XG4gICAgY29uc3QgYXR0cmlidXRlc01hcCA9IHRoaXMuX2VudGl0eU1ldGFkYXRhcy5nZXQoZW50aXR5Q2xhc3MubmFtZSk7XG4gICAgaWYgKCFhdHRyaWJ1dGVzTWFwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDYW5ub3QgZmluZCBhdHRyaWJ1dGVzIGZvciBlbnRpdHkgXCIke2VudGl0eUNsYXNzLm5hbWV9XCIuYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGF0dHJpYnV0ZXNNYXAuYXR0cmlidXRlcztcbiAgfVxuXG4gIGdldCBnbG9iYWxUYWJsZSgpIHtcbiAgICByZXR1cm4gdGhpcy50YWJsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFueSBhdHRyaWJ1dGVzIG1hcmtlZCBhcyB1bmlxdWVcbiAgICogSWYgYXR0cmlidXRlIHVzZWQgaW4gYSBwcmltYXJ5IGtleSBpcyBtYXJrZWQgYXMgdW5pcXVlLCBpdCBpcyBpZ25vcmVkLCBzaW5jZSBhbGwgcHJpbWFyeSBrZXkgYXJlIGFsd2F5cyB1bmlxdWVcbiAgICogQHBhcmFtIGVudGl0eUNsYXNzXG4gICAqL1xuICBnZXRVbmlxdWVBdHRyaWJ1dGVzRm9yRW50aXR5PEVudGl0eT4oZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+KSB7XG4gICAgY29uc3QgZW50aXR5TWV0YWRhdGEgPSB0aGlzLmdldEVudGl0eUJ5VGFyZ2V0KGVudGl0eUNsYXNzKTtcblxuICAgIHJldHVybiB0aGlzLmdldEF0dHJpYnV0ZXNGb3JFbnRpdHk8RW50aXR5PihlbnRpdHlDbGFzcykuZmlsdGVyKGF0dHIgPT4ge1xuICAgICAgLy8gb25seSBhdHRyaWJ1dGVzIHRoYXQgYXJlIG5vdCBwYXJ0IG9mIHByaW1hcnkga2V5IHNob3VsZCBiZSBpbmNsdWRlZFxuICAgICAgcmV0dXJuIChcbiAgICAgICAgKGF0dHIgYXMgQXR0cmlidXRlTWV0YWRhdGEpPy51bmlxdWUgJiZcbiAgICAgICAgIWlzVXNlZEZvclByaW1hcnlLZXkoZW50aXR5TWV0YWRhdGEuc2NoZW1hLnByaW1hcnlLZXksIGF0dHIubmFtZSlcbiAgICAgICk7XG4gICAgfSkgYXMgUmVwbGFjZTxcbiAgICAgIEF0dHJpYnV0ZU1ldGFkYXRhLFxuICAgICAgJ3VuaXF1ZScsXG4gICAgICB7dW5pcXVlOiBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5fVxuICAgID5bXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgbGlzdCBvZiBhdHRyaWJ1dGUgbmFtZXMgdGhhdCBhcmUgcmVmZXJlbmNlZCBpbiBwcmltYXJ5IGtleVxuICAgKiBAcGFyYW0gZW50aXR5Q2xhc3MgRW50aXR5IHRvIGdldCBwcmltYXJ5IGtleSBhdHRyaWJ1dGVzIGZvclxuICAgKiBAcmV0dXJuc1xuICAgKi9cbiAgZ2V0UHJpbWFyeUtleUF0dHJpYnV0ZUludGVycG9sYXRpb25zRm9yRW50aXR5PEVudGl0eT4oXG4gICAgZW50aXR5Q2xhc3M6IEVudGl0eVRhcmdldDxFbnRpdHk+XG4gICkge1xuICAgIGNvbnN0IGVudGl0eU1ldGFkYXRhID0gdGhpcy5nZXRFbnRpdHlCeVRhcmdldChlbnRpdHlDbGFzcyk7XG4gICAgcmV0dXJuIFtcbiAgICAgIC4uLm5ldyBTZXQoXG4gICAgICAgIE9iamVjdC52YWx1ZXMoXG4gICAgICAgICAgZW50aXR5TWV0YWRhdGEuc2NoZW1hLnByaW1hcnlLZXkubWV0YWRhdGEuX2ludGVycG9sYXRpb25zID8/IHt9XG4gICAgICAgICkuZmxhdCgpXG4gICAgICApLFxuICAgIF07XG4gIH1cblxuICBnZXRFbnRpdHlCeVRhcmdldDxFbnRpdHk+KGVudGl0eUNsYXNzOiBFbnRpdHlUYXJnZXQ8RW50aXR5Pikge1xuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5fZW50aXR5TWV0YWRhdGFzLmdldChlbnRpdHlDbGFzcy5uYW1lKTtcbiAgICBpZiAoIW1ldGFkYXRhKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBObyBzdWNoIGVudGl0eSBuYW1lZCBcIiR7ZW50aXR5Q2xhc3MubmFtZX1cIiBpcyBrbm93biB0byBUeXBlRE9STSwgbWFrZSBzdXJlIGl0IGlzIGRlY2xhcmVkIGF0IHRoZSBjb25uZWN0aW9uIGNyZWF0aW9uIHRpbWUuYFxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIG1ldGFkYXRhO1xuICB9XG5cbiAgZ2V0RW50aXR5QnlQaHlzaWNhbE5hbWUobmFtZTogc3RyaW5nKSB7XG4gICAgY29uc3QgZW50aXR5U3BlYyA9IGdldEVudGl0eURlZmluaXRpb24obmFtZSk7XG5cbiAgICBpZiAoIWVudGl0eVNwZWMpIHtcbiAgICAgIHRocm93IG5ldyBOb1N1Y2hFbnRpdHlFeGlzdHNFcnJvcihuYW1lKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZ2V0RW50aXR5QnlUYXJnZXQoZW50aXR5U3BlYy50YXJnZXQpO1xuICB9XG5cbiAgZ2V0QXV0b1VwZGF0ZUF0dHJpYnV0ZXM8RW50aXR5PihlbnRpdHlDbGFzczogRW50aXR5VGFyZ2V0PEVudGl0eT4pIHtcbiAgICByZXR1cm4gdGhpcy5nZXRBdHRyaWJ1dGVzRm9yRW50aXR5KGVudGl0eUNsYXNzKS5maWx0ZXIoXG4gICAgICBhdHRyID0+IChhdHRyIGFzIEF1dG9HZW5lcmF0ZWRBdHRyaWJ1dGVNZXRhZGF0YSk/LmF1dG9VcGRhdGVcbiAgICApIGFzIEF1dG9HZW5lcmF0ZWRBdHRyaWJ1dGVNZXRhZGF0YVtdO1xuICB9XG5cbiAgaXNVc2VkRm9yUHJpbWFyeUtleShcbiAgICBwcmltYXJ5S2V5OiBEeW5hbW9FbnRpdHlTY2hlbWFQcmltYXJ5S2V5LFxuICAgIGF0dHJpYnV0ZU5hbWU6IHN0cmluZ1xuICApIHtcbiAgICBjb25zdCBwcmltYXJ5S2V5SW50ZXJwb2xhdGlvbnMgPSBwcmltYXJ5S2V5Lm1ldGFkYXRhLl9pbnRlcnBvbGF0aW9ucyA/PyB7fTtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMocHJpbWFyeUtleUludGVycG9sYXRpb25zKS5zb21lKGtleSA9PiB7XG4gICAgICBjb25zdCBjdXJySW50ZXJwb2xhdGlvbiA9IHByaW1hcnlLZXlJbnRlcnBvbGF0aW9uc1trZXldO1xuICAgICAgcmV0dXJuIGN1cnJJbnRlcnBvbGF0aW9uLmluY2x1ZGVzKGF0dHJpYnV0ZU5hbWUpO1xuICAgIH0pO1xuICB9XG5cbiAgYnVpbGRNZXRhZGF0YXMoKSB7XG4gICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uTWV0YWRhdGFCdWlsZGVyKHRoaXMpLmJ1aWxkRW50aXR5TWV0YWRhdGFzKFxuICAgICAgdGhpcy5vcHRpb25zLmVudGl0aWVzXG4gICAgKTtcbiAgfVxuXG4gIGxvYWRPckluaXRpYXRlRG9jdW1lbnRDbGllbnQoZG9jdW1lbnRDbGllbnQ/OiB1bmtub3duKSB7XG4gICAgaWYgKCFkb2N1bWVudENsaWVudCkge1xuICAgICAgY29uc3QgQVdTTW9kdWxlID0gbG9hZFBhY2thZ2UoJ2F3cy1zZGsnKTtcbiAgICAgIHJldHVybiBuZXcgRG9jdW1lbnRDbGllbnRWMihuZXcgQVdTTW9kdWxlLkR5bmFtb0RCLkRvY3VtZW50Q2xpZW50KCkpO1xuICAgIH1cblxuICAgIGlmIChkb2N1bWVudENsaWVudCBpbnN0YW5jZW9mIERvY3VtZW50Q2xpZW50VjIpIHtcbiAgICAgIHJldHVybiBkb2N1bWVudENsaWVudDtcbiAgICB9IGVsc2UgaWYgKGRvY3VtZW50Q2xpZW50IGluc3RhbmNlb2YgRG9jdW1lbnRDbGllbnRWMykge1xuICAgICAgcmV0dXJuIGRvY3VtZW50Q2xpZW50O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gbmV3IERvY3VtZW50Q2xpZW50VjIoZG9jdW1lbnRDbGllbnQgYXMgYW55KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==