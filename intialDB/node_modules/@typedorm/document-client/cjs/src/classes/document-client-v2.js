"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentClientV2 = void 0;
const exceptions_1 = require("../exceptions");
const base_document_client_1 = require("./base-document-client");
class DocumentClientV2 extends base_document_client_1.DocumentClient {
    constructor(dynamoDBClient) {
        super();
        this.version = 2;
        this.documentClient = dynamoDBClient;
    }
    put(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.put(input).promise();
        });
    }
    get(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.get(input).promise();
        });
    }
    query(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.query(input).promise();
        });
    }
    update(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.update(input).promise();
        });
    }
    delete(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.delete(input).promise();
        });
    }
    batchWrite(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.batchWrite(input).promise();
        });
    }
    batchGet(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.batchGet(input).promise();
        });
    }
    transactGet(input) {
        return __awaiter(this, void 0, void 0, function* () {
            const transactionResult = this.transactGetRaw(input);
            return this.handleTransactionResult(transactionResult);
        });
    }
    transactWrite(input) {
        return __awaiter(this, void 0, void 0, function* () {
            const transactionResult = this.transactWriteRaw(input);
            return this.handleTransactionResult(transactionResult);
        });
    }
    scan(input) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.documentClient.scan(input).promise();
        });
    }
    ///
    /// Private Methods
    ///
    transactGetRaw(input) {
        return this.documentClient.transactGet(input);
    }
    transactWriteRaw(input) {
        return this.documentClient.transactWrite(input);
    }
    handleTransactionResult(transactionRequest) {
        let cancellationReasons;
        transactionRequest.on('extractError', response => {
            try {
                cancellationReasons = JSON.parse(response.httpResponse.body.toString()).CancellationReasons;
            }
            catch (err) {
                // suppress this just in case some types of errors aren't JSON parsable
                console.error('Error extracting cancellation error', err);
            }
        });
        return new Promise((resolve, reject) => {
            transactionRequest.send((err, response) => {
                if (err) {
                    // pull all reasons from response and map them to errors
                    const reasons = cancellationReasons.map(reason => {
                        return {
                            code: reason.Code,
                            message: reason.Message,
                            item: reason.Item,
                        };
                    });
                    return reject(new exceptions_1.TransactionCancelledException(err.code, reasons));
                }
                return resolve(response);
            });
        });
    }
}
exports.DocumentClientV2 = DocumentClientV2;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jdW1lbnQtY2xpZW50LXYyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcGFja2FnZXMvZG9jdW1lbnQtY2xpZW50L3NyYy9jbGFzc2VzL2RvY3VtZW50LWNsaWVudC12Mi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFDQSw4Q0FBNEQ7QUFDNUQsaUVBQXNEO0FBQ3RELE1BQWEsZ0JBRVgsU0FBUSxxQ0FBYztJQUl0QixZQUFZLGNBQWtDO1FBQzVDLEtBQUssRUFBRSxDQUFDO1FBSEQsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUluQixJQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztJQUN2QyxDQUFDO0lBRUssR0FBRyxDQUNQLEtBQTJDOztZQUUzQyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2xELENBQUM7S0FBQTtJQUVLLEdBQUcsQ0FDUCxLQUEyQzs7WUFFM0MsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNsRCxDQUFDO0tBQUE7SUFFSyxLQUFLLENBQ1QsS0FBeUM7O1lBRXpDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEQsQ0FBQztLQUFBO0lBRUssTUFBTSxDQUNWLEtBQThDOztZQUU5QyxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3JELENBQUM7S0FBQTtJQUVLLE1BQU0sQ0FDVixLQUE4Qzs7WUFFOUMsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNyRCxDQUFDO0tBQUE7SUFFSyxVQUFVLENBQ2QsS0FBa0Q7O1lBRWxELE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDekQsQ0FBQztLQUFBO0lBRUssUUFBUSxDQUNaLEtBQWdEOztZQUVoRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3ZELENBQUM7S0FBQTtJQUVLLFdBQVcsQ0FDZixLQUFvRDs7WUFFcEQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3JELE9BQU8sSUFBSSxDQUFDLHVCQUF1QixDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDekQsQ0FBQztLQUFBO0lBRUssYUFBYSxDQUNqQixLQUFzRDs7WUFFdEQsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdkQsT0FBTyxJQUFJLENBQUMsdUJBQXVCLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUN6RCxDQUFDO0tBQUE7SUFFSyxJQUFJLENBQ1IsS0FBd0M7O1lBRXhDLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDbkQsQ0FBQztLQUFBO0lBRUQsR0FBRztJQUNILG1CQUFtQjtJQUNuQixHQUFHO0lBQ0ssY0FBYyxDQUNwQixLQUFvRDtRQUVwRCxPQUFPLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFFTyxnQkFBZ0IsQ0FDdEIsS0FBc0Q7UUFFdEQsT0FBTyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRU8sdUJBQXVCLENBQUksa0JBQXdDO1FBQ3pFLElBQUksbUJBSUQsQ0FBQztRQUNKLGtCQUFrQixDQUFDLEVBQUUsQ0FBQyxjQUFjLEVBQUUsUUFBUSxDQUFDLEVBQUU7WUFDL0MsSUFBSTtnQkFDRixtQkFBbUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUM5QixRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FDdEMsQ0FBQyxtQkFBbUIsQ0FBQzthQUN2QjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLHVFQUF1RTtnQkFDdkUsT0FBTyxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLENBQUMsQ0FBQzthQUMzRDtRQUNILENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtZQUNyQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLEVBQUU7Z0JBQ3hDLElBQUksR0FBRyxFQUFFO29CQUNQLHdEQUF3RDtvQkFDeEQsTUFBTSxPQUFPLEdBQUcsbUJBQW1CLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO3dCQUMvQyxPQUFPOzRCQUNMLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSTs0QkFDakIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPOzRCQUN2QixJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUk7eUJBQ2xCLENBQUM7b0JBQ0osQ0FBQyxDQUFDLENBQUM7b0JBQ0gsT0FBTyxNQUFNLENBQUMsSUFBSSwwQ0FBNkIsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7aUJBQ3JFO2dCQUVELE9BQU8sT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzNCLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFlLENBQUM7SUFDbkIsQ0FBQztDQUNGO0FBM0hELDRDQTJIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QVdTRXJyb3IsIER5bmFtb0RCLCBSZXF1ZXN0fSBmcm9tICdhd3Mtc2RrJztcbmltcG9ydCB7VHJhbnNhY3Rpb25DYW5jZWxsZWRFeGNlcHRpb259IGZyb20gJy4uL2V4Y2VwdGlvbnMnO1xuaW1wb3J0IHtEb2N1bWVudENsaWVudH0gZnJvbSAnLi9iYXNlLWRvY3VtZW50LWNsaWVudCc7XG5leHBvcnQgY2xhc3MgRG9jdW1lbnRDbGllbnRWMjxcbiAgRG9jdW1lbnRDbGllbnRUeXBlIGV4dGVuZHMgRHluYW1vREIuRG9jdW1lbnRDbGllbnQgPSBEeW5hbW9EQi5Eb2N1bWVudENsaWVudFxuPiBleHRlbmRzIERvY3VtZW50Q2xpZW50IHtcbiAgcmVhZG9ubHkgZG9jdW1lbnRDbGllbnQ6IERvY3VtZW50Q2xpZW50VHlwZTtcbiAgcmVhZG9ubHkgdmVyc2lvbiA9IDI7XG5cbiAgY29uc3RydWN0b3IoZHluYW1vREJDbGllbnQ6IERvY3VtZW50Q2xpZW50VHlwZSkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5kb2N1bWVudENsaWVudCA9IGR5bmFtb0RCQ2xpZW50O1xuICB9XG5cbiAgYXN5bmMgcHV0KFxuICAgIGlucHV0OiBEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5QdXRJdGVtSW5wdXRcbiAgKTogUHJvbWlzZTxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5QdXRJdGVtT3V0cHV0PiB7XG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRDbGllbnQucHV0KGlucHV0KS5wcm9taXNlKCk7XG4gIH1cblxuICBhc3luYyBnZXQoXG4gICAgaW5wdXQ6IER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkdldEl0ZW1JbnB1dFxuICApOiBQcm9taXNlPER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkdldEl0ZW1PdXRwdXQ+IHtcbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudENsaWVudC5nZXQoaW5wdXQpLnByb21pc2UoKTtcbiAgfVxuXG4gIGFzeW5jIHF1ZXJ5KFxuICAgIGlucHV0OiBEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5RdWVyeUlucHV0XG4gICk6IFByb21pc2U8RHluYW1vREIuRG9jdW1lbnRDbGllbnQuUXVlcnlPdXRwdXQ+IHtcbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudENsaWVudC5xdWVyeShpbnB1dCkucHJvbWlzZSgpO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlKFxuICAgIGlucHV0OiBEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5VcGRhdGVJdGVtSW5wdXRcbiAgKTogUHJvbWlzZTxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5VcGRhdGVJdGVtT3V0cHV0PiB7XG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRDbGllbnQudXBkYXRlKGlucHV0KS5wcm9taXNlKCk7XG4gIH1cblxuICBhc3luYyBkZWxldGUoXG4gICAgaW5wdXQ6IER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkRlbGV0ZUl0ZW1JbnB1dFxuICApOiBQcm9taXNlPER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkRlbGV0ZUl0ZW1PdXRwdXQ+IHtcbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudENsaWVudC5kZWxldGUoaW5wdXQpLnByb21pc2UoKTtcbiAgfVxuXG4gIGFzeW5jIGJhdGNoV3JpdGUoXG4gICAgaW5wdXQ6IER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkJhdGNoV3JpdGVJdGVtSW5wdXRcbiAgKTogUHJvbWlzZTxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5CYXRjaFdyaXRlSXRlbU91dHB1dD4ge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50Q2xpZW50LmJhdGNoV3JpdGUoaW5wdXQpLnByb21pc2UoKTtcbiAgfVxuXG4gIGFzeW5jIGJhdGNoR2V0KFxuICAgIGlucHV0OiBEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5CYXRjaEdldEl0ZW1JbnB1dFxuICApOiBQcm9taXNlPER5bmFtb0RCLkRvY3VtZW50Q2xpZW50LkJhdGNoR2V0SXRlbU91dHB1dD4ge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50Q2xpZW50LmJhdGNoR2V0KGlucHV0KS5wcm9taXNlKCk7XG4gIH1cblxuICBhc3luYyB0cmFuc2FjdEdldChcbiAgICBpbnB1dDogRHluYW1vREIuRG9jdW1lbnRDbGllbnQuVHJhbnNhY3RHZXRJdGVtc0lucHV0XG4gICk6IFByb21pc2U8RHluYW1vREIuRG9jdW1lbnRDbGllbnQuVHJhbnNhY3RHZXRJdGVtc091dHB1dD4ge1xuICAgIGNvbnN0IHRyYW5zYWN0aW9uUmVzdWx0ID0gdGhpcy50cmFuc2FjdEdldFJhdyhpbnB1dCk7XG4gICAgcmV0dXJuIHRoaXMuaGFuZGxlVHJhbnNhY3Rpb25SZXN1bHQodHJhbnNhY3Rpb25SZXN1bHQpO1xuICB9XG5cbiAgYXN5bmMgdHJhbnNhY3RXcml0ZShcbiAgICBpbnB1dDogRHluYW1vREIuRG9jdW1lbnRDbGllbnQuVHJhbnNhY3RXcml0ZUl0ZW1zSW5wdXRcbiAgKTogUHJvbWlzZTxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5UcmFuc2FjdFdyaXRlSXRlbXNPdXRwdXQ+IHtcbiAgICBjb25zdCB0cmFuc2FjdGlvblJlc3VsdCA9IHRoaXMudHJhbnNhY3RXcml0ZVJhdyhpbnB1dCk7XG4gICAgcmV0dXJuIHRoaXMuaGFuZGxlVHJhbnNhY3Rpb25SZXN1bHQodHJhbnNhY3Rpb25SZXN1bHQpO1xuICB9XG5cbiAgYXN5bmMgc2NhbihcbiAgICBpbnB1dDogRHluYW1vREIuRG9jdW1lbnRDbGllbnQuU2NhbklucHV0XG4gICk6IFByb21pc2U8RHluYW1vREIuRG9jdW1lbnRDbGllbnQuU2Nhbk91dHB1dD4ge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50Q2xpZW50LnNjYW4oaW5wdXQpLnByb21pc2UoKTtcbiAgfVxuXG4gIC8vL1xuICAvLy8gUHJpdmF0ZSBNZXRob2RzXG4gIC8vL1xuICBwcml2YXRlIHRyYW5zYWN0R2V0UmF3KFxuICAgIGlucHV0OiBEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5UcmFuc2FjdEdldEl0ZW1zSW5wdXRcbiAgKTogUmVxdWVzdDxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5UcmFuc2FjdEdldEl0ZW1zT3V0cHV0LCBBV1NFcnJvcj4ge1xuICAgIHJldHVybiB0aGlzLmRvY3VtZW50Q2xpZW50LnRyYW5zYWN0R2V0KGlucHV0KTtcbiAgfVxuXG4gIHByaXZhdGUgdHJhbnNhY3RXcml0ZVJhdyhcbiAgICBpbnB1dDogRHluYW1vREIuRG9jdW1lbnRDbGllbnQuVHJhbnNhY3RXcml0ZUl0ZW1zSW5wdXRcbiAgKTogUmVxdWVzdDxEeW5hbW9EQi5Eb2N1bWVudENsaWVudC5UcmFuc2FjdFdyaXRlSXRlbXNPdXRwdXQsIEFXU0Vycm9yPiB7XG4gICAgcmV0dXJuIHRoaXMuZG9jdW1lbnRDbGllbnQudHJhbnNhY3RXcml0ZShpbnB1dCk7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVRyYW5zYWN0aW9uUmVzdWx0PFQ+KHRyYW5zYWN0aW9uUmVxdWVzdDogUmVxdWVzdDxULCBBV1NFcnJvcj4pIHtcbiAgICBsZXQgY2FuY2VsbGF0aW9uUmVhc29uczoge1xuICAgICAgQ29kZTogc3RyaW5nO1xuICAgICAgTWVzc2FnZTogc3RyaW5nO1xuICAgICAgSXRlbTogRHluYW1vREIuRG9jdW1lbnRDbGllbnQuQXR0cmlidXRlTWFwO1xuICAgIH1bXTtcbiAgICB0cmFuc2FjdGlvblJlcXVlc3Qub24oJ2V4dHJhY3RFcnJvcicsIHJlc3BvbnNlID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbmNlbGxhdGlvblJlYXNvbnMgPSBKU09OLnBhcnNlKFxuICAgICAgICAgIHJlc3BvbnNlLmh0dHBSZXNwb25zZS5ib2R5LnRvU3RyaW5nKClcbiAgICAgICAgKS5DYW5jZWxsYXRpb25SZWFzb25zO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIC8vIHN1cHByZXNzIHRoaXMganVzdCBpbiBjYXNlIHNvbWUgdHlwZXMgb2YgZXJyb3JzIGFyZW4ndCBKU09OIHBhcnNhYmxlXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGV4dHJhY3RpbmcgY2FuY2VsbGF0aW9uIGVycm9yJywgZXJyKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cmFuc2FjdGlvblJlcXVlc3Quc2VuZCgoZXJyLCByZXNwb25zZSkgPT4ge1xuICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgLy8gcHVsbCBhbGwgcmVhc29ucyBmcm9tIHJlc3BvbnNlIGFuZCBtYXAgdGhlbSB0byBlcnJvcnNcbiAgICAgICAgICBjb25zdCByZWFzb25zID0gY2FuY2VsbGF0aW9uUmVhc29ucy5tYXAocmVhc29uID0+IHtcbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgIGNvZGU6IHJlYXNvbi5Db2RlLFxuICAgICAgICAgICAgICBtZXNzYWdlOiByZWFzb24uTWVzc2FnZSxcbiAgICAgICAgICAgICAgaXRlbTogcmVhc29uLkl0ZW0sXG4gICAgICAgICAgICB9O1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIHJldHVybiByZWplY3QobmV3IFRyYW5zYWN0aW9uQ2FuY2VsbGVkRXhjZXB0aW9uKGVyci5jb2RlLCByZWFzb25zKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICB9KTtcbiAgICB9KSBhcyBQcm9taXNlPFQ+O1xuICB9XG59XG4iXX0=